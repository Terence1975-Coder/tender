<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Bootcamp Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!--
    ü§ñ BOT INTEGRATION INSTRUCTIONS
    ================================
    
    Your bot at https://terence1975-coder.github.io/tender/bot.html can send reports to this dashboard using these methods:
    
    METHOD 1: PostMessage (Recommended)
    -----------------------------------
    From your bot, use:
    
    const reportData = {
        name: "John Doe",
        email: "john@example.com", 
        phone: "+1 (555) 123-4567",
        score: 85,
        bootcamp: "AI Fundamentals",
        responses: ["Correct", "Correct", "Incorrect", "Correct", "Correct"],
        autoShow: true  // Optional: auto-display the report
    };
    
    // Send to dashboard
    window.parent.postMessage(reportData, '*');
    
    METHOD 2: Direct Function Call
    ------------------------------
    If dashboard is in same window/iframe:
    
    parent.addApplicantReport(reportData);
    
    METHOD 3: URL Parameters
    ------------------------
    Redirect to dashboard with data:
    
    const encoded = encodeURIComponent(JSON.stringify(reportData));
    window.location.href = 'dashboard.html?report=' + encoded;
    
    SCORING RULES:
    - Score 80+ = Passed (Green)
    - Score 60-79 = Waitlist (Yellow) 
    - Score <60 = Failed (Red)
    
    The dashboard will automatically categorize and display the reports!
    -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
        .tab-inactive:hover { color: #374151; border-bottom-color: #d1d5db; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; }
        .modal.show { display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: all 0.2s; cursor: pointer; border: none; }
        .btn-green { background: #16a34a; color: white; } .btn-green:hover { background: #15803d; }
        .btn-blue { background: #2563eb; color: white; } .btn-blue:hover { background: #1d4ed8; }
        .btn-yellow { background: #ca8a04; color: white; } .btn-yellow:hover { background: #a16207; }
        .btn-red { background: #dc2626; color: white; } .btn-red:hover { background: #b91c1c; }
        .btn-gray { background: #f3f4f6; color: #374151; } .btn-gray:hover { background: #e5e7eb; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-passed { background: #dcfce7; color: #166534; }
        .status-failed { background: #fecaca; color: #991b1b; }
        .status-waitlist { background: #fef3c7; color: #92400e; }
        .status-processed { background: #dbeafe; color: #1e40af; }
        .upload-zone { border: 2px dashed #d1d5db; transition: border-color 0.2s; }
        .upload-zone:hover { border-color: #9ca3af; }
        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .firebase-connected {
            background: #27ae60;
            box-shadow: 0 2px 10px rgba(39, 174, 96, 0.3);
        }
        .firebase-disconnected {
            background: #e74c3c;
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
        }
        .firebase-saving {
            background: #f39c12;
            box-shadow: 0 2px 10px rgba(243, 156, 18, 0.3);
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Firebase Status Indicator -->
    <div id="firebase-status" class="firebase-status firebase-disconnected">
        üî¥ Firebase Disconnected
    </div>

    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">ü§ñ AI Bootcamp Dashboard</h1>
                    <p class="text-gray-600">Manage screening applications and chatbots</p>
                    <div id="connection-status" class="mt-2">
                        <!-- Bot connection status will be populated here -->
                    </div>
                </div>
                <div class="flex flex-col space-y-2">
                    <div class="flex space-x-2">
                        <button onclick="showCSVData()" class="btn btn-green">
                            üì• Show Excel Data
                        </button>
                        <button onclick="testBotIntegration()" class="btn btn-blue text-sm">
                            üîó Test Bot Connection
                        </button>
                        <button onclick="pingBotURL()" class="btn btn-yellow text-sm">
                            üì° Ping Bot URL
                        </button>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="saveToFirebase()" class="btn btn-blue text-sm">
                            ‚òÅÔ∏è Save to Cloud
                        </button>
                        <button onclick="loadFromFirebase()" class="btn btn-gray text-sm">
                            üì• Load from Cloud
                        </button>
                        <button onclick="testFirebase()" class="btn btn-yellow text-sm">
                            üß™ Test Firebase
                        </button>
                        <button onclick="clearFirebaseData()" class="btn btn-red text-sm">
                            üóëÔ∏è Clear Firebase
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-active py-2 px-1 font-medium text-sm flex items-center space-x-2">
                    üìä Overview
                </button>
                <button onclick="switchTab('applicants')" id="tab-applicants" class="tab-inactive py-2 px-1 font-medium text-sm flex items-center space-x-2">
                    üë• Applicant Reports
                </button>
                <button onclick="switchTab('chatbots')" id="tab-chatbots" class="tab-inactive py-2 px-1 font-medium text-sm flex items-center space-x-2">
                    ‚öôÔ∏è Manage Chatbots
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Overview Tab -->
        <div id="content-overview" class="space-y-6">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="text-3xl">üë•</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Applicants</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-total">8</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="text-3xl">‚úÖ</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Passed</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-passed">4</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="text-3xl">‚ùå</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Failed</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-failed">2</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="text-3xl">‚è≥</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Waitlist</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-waitlist">2</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="text-3xl">‚úîÔ∏è</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Processed</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-processed">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="px-6 py-4 border-b">
                    <h3 class="text-lg font-medium text-gray-900">üìù Recent Applications</h3>
                </div>
                <div class="divide-y divide-gray-200" id="recent-applicants">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Applicants Tab -->
        <div id="content-applicants" class="space-y-6" style="display: none;">
            <!-- Filter Controls -->
            <div class="card p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">üìä Applicant Reports</h3>
                        <p class="text-sm text-gray-500">Individual reports grouped by status</p>
                    </div>
                    <button onclick="showCSVData()" class="btn btn-blue">
                        üì• Show All Data
                    </button>
                </div>
            </div>

            <!-- Passed Applicants -->
            <div class="card overflow-hidden">
                <div class="bg-green-50 px-6 py-4 border-b border-green-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-green-800">‚úÖ Passed Applicants (<span id="passed-count">4</span>)</h3>
                        <button onclick="showCategoryData('passed')" class="text-green-700 hover:text-green-900 text-sm flex items-center space-x-1 transition-colors">
                            <div class="text-lg">üì•</div>
                            <span>Export Data</span>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="passed-applicants">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Waitlist Applicants -->
            <div class="card overflow-hidden">
                <div class="bg-yellow-50 px-6 py-4 border-b border-yellow-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-yellow-800">‚è≥ Waitlist Applicants (<span id="waitlist-count">2</span>)</h3>
                        <button onclick="showCategoryData('waitlist')" class="text-yellow-700 hover:text-yellow-900 text-sm flex items-center space-x-1 transition-colors">
                            <div class="text-lg">üì•</div>
                            <span>Export Data</span>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="waitlist-applicants">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Failed Applicants -->
            <div class="card overflow-hidden">
                <div class="bg-red-50 px-6 py-4 border-b border-red-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-red-800">‚ùå Failed Applicants (<span id="failed-count">2</span>)</h3>
                        <button onclick="showCategoryData('failed')" class="text-red-700 hover:text-red-900 text-sm flex items-center space-x-1 transition-colors">
                            <div class="text-lg">üì•</div>
                            <span>Export Data</span>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="failed-applicants">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Processed Applicants Section -->
            <div class="card overflow-hidden">
                <div class="bg-blue-50 px-6 py-4 border-b border-blue-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-blue-800">‚úîÔ∏è Processed Applicants (<span id="processed-count">0</span>)</h3>
                        <button onclick="showCategoryData('processed')" class="text-blue-700 hover:text-blue-900 text-sm flex items-center space-x-1 transition-colors">
                            <div class="text-lg">üì•</div>
                            <span>Export Data</span>
                        </button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="processed-applicants">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Chatbots Tab -->
        <div id="content-chatbots" class="space-y-6" style="display: none;">
            <!-- Create New Chatbot -->
            <div class="card p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">ü§ñ Create New Screening Chatbot</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chatbot Name</label>
                        <input type="text" id="chatbot-name" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter chatbot name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Course/Bootcamp</label>
                        <select id="chatbot-course" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option>AI Fundamentals</option>
                            <option>Machine Learning</option>
                            <option>Data Science</option>
                            <option>Deep Learning</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="createChatbot()" class="btn btn-blue">
                        ‚ûï Create Chatbot
                    </button>
                </div>
            </div>

            <!-- Upload Script -->
            <div class="card p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">üìù Upload New Script</h3>
                <div class="upload-zone rounded-lg p-6 text-center">
                    <div class="text-4xl mb-4">üì§</div>
                    <p class="text-sm text-gray-600 mb-2">Drop your script file here or click to upload</p>
                    <p class="text-xs text-gray-500 mb-4">Supported formats: .js, .json, .txt</p>
                    <input type="file" id="script-upload" style="display: none" accept=".js,.json,.txt" onchange="handleFileUpload(this, 'Script')">
                    <button onclick="document.getElementById('script-upload').click()" class="btn btn-gray">
                        Choose File
                    </button>
                </div>
            </div>

            <!-- Upload Course Info -->
            <div class="card p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">üìö Upload Bootcamp/Course Info</h3>
                <div class="upload-zone rounded-lg p-6 text-center">
                    <div class="text-4xl mb-4">üì§</div>
                    <p class="text-sm text-gray-600 mb-2">Drop your course information file here or click to upload</p>
                    <p class="text-xs text-gray-500 mb-4">Supported formats: .pdf, .doc, .docx, .txt</p>
                    <input type="file" id="course-upload" style="display: none" accept=".pdf,.doc,.docx,.txt" onchange="handleFileUpload(this, 'Course Info')">
                    <button onclick="document.getElementById('course-upload').click()" class="btn btn-gray">
                        Choose File
                    </button>
                </div>
            </div>

            <!-- Existing Chatbots -->
            <div class="card overflow-hidden">
                <div class="px-6 py-4 border-b">
                    <h3 class="text-lg font-medium text-gray-900">ü§ñ Existing Chatbots</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Course</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="chatbots-table">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="flex justify-between items-center p-6 border-b bg-gray-50">
                <h2 id="modal-title" class="text-xl font-semibold text-gray-900">Modal Title</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">‚ùå</button>
            </div>
            <div class="p-6 overflow-auto max-h-[70vh]">
                <textarea id="modal-content" readonly class="w-full h-96 p-4 border border-gray-300 rounded-md font-mono text-sm bg-gray-50 resize-none" placeholder="Content will appear here..."></textarea>
                <div class="mt-4 flex justify-between items-center">
                    <p class="text-sm text-gray-600">üí° Select all content above (Ctrl+A) and copy (Ctrl+C) to save</p>
                    <button onclick="copyToClipboard()" id="copy-btn" class="btn btn-blue">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dynamic applicants array - will receive new data from bot
        let applicants = [
            { 
                id: 1, 
                name: 'John Smith', 
                email: 'john@email.com', 
                phone: '+1 (555) 123-4567', 
                date: '2025-01-15', 
                status: 'passed', 
                score: 85, 
                bootcamp: 'AI Fundamentals', 
                responses: ['Correct', 'Correct', 'Incorrect', 'Correct', 'Correct'] 
            },
            { 
                id: 2, 
                name: 'Sarah Johnson', 
                email: 'sarah@email.com', 
                phone: '+1 (555) 234-5678', 
                date: '2025-01-14', 
                status: 'failed', 
                score: 45, 
                bootcamp: 'AI Fundamentals', 
                responses: ['Incorrect', 'Correct', 'Incorrect', 'Incorrect', 'Correct'] 
            },
            { 
                id: 3, 
                name: 'Mike Chen', 
                email: 'mike@email.com', 
                phone: '+1 (555) 345-6789', 
                date: '2025-01-13', 
                status: 'waitlist', 
                score: 65, 
                bootcamp: 'AI Fundamentals', 
                responses: ['Correct', 'Incorrect', 'Correct', 'Correct', 'Incorrect'] 
            },
            { 
                id: 4, 
                name: 'Emily Davis', 
                email: 'emily@email.com', 
                phone: '+1 (555) 456-7890', 
                date: '2025-01-12', 
                status: 'passed', 
                score: 92, 
                bootcamp: 'Machine Learning', 
                responses: ['Correct', 'Correct', 'Correct', 'Correct', 'Incorrect'] 
            },
            { 
                id: 5, 
                name: 'Alex Rodriguez', 
                email: 'alex@email.com', 
                phone: '+1 (555) 567-8901', 
                date: '2025-01-11', 
                status: 'passed', 
                score: 78, 
                bootcamp: 'AI Fundamentals', 
                responses: ['Correct', 'Correct', 'Incorrect', 'Correct', 'Correct'] 
            },
            { 
                id: 6, 
                name: 'Lisa Wang', 
                email: 'lisa@email.com', 
                phone: '+1 (555) 678-9012', 
                date: '2025-01-10', 
                status: 'waitlist', 
                score: 68, 
                bootcamp: 'Machine Learning', 
                responses: ['Correct', 'Correct', 'Incorrect', 'Correct', 'Incorrect'] 
            },
            { 
                id: 7, 
                name: 'David Brown', 
                email: 'david@email.com', 
                phone: '+1 (555) 789-0123', 
                date: '2025-01-09', 
                status: 'failed', 
                score: 42, 
                bootcamp: 'AI Fundamentals', 
                responses: ['Incorrect', 'Incorrect', 'Correct', 'Incorrect', 'Correct'] 
            },
            { 
                id: 8, 
                name: 'Jennifer Lee', 
                email: 'jennifer@email.com', 
                phone: '+1 (555) 890-1234', 
                date: '2025-01-08', 
                status: 'passed', 
                score: 89, 
                bootcamp: 'Machine Learning', 
                responses: ['Correct', 'Correct', 'Correct', 'Incorrect', 'Correct'] 
            }
        ];

        // Bot Integration - Statistics tracking
        let botStats = {
            totalReceived: 0,
            lastReceived: null,
            connectionStatus: 'Ready'
        };

        // üî• FIREBASE INTEGRATION
        const firebaseConfig = {
            apiKey: "AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
            authDomain: "prospecting-f2f42.firebaseapp.com",
            databaseURL: "https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "prospecting-f2f42",
            storageBucket: "prospecting-f2f42.firebasestorage.app",
            messagingSenderId: "292034226428",
            appId: "1:292034226428:web:878b867e3eb4d3e0098f79",
            measurementId: "G-WWB0JTX2L2"
        };

        let database = null;
        let firebaseApp = null;

        // Initialize Firebase
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    updateFirebaseStatus('connected');
                    console.log('üî• Firebase initialized successfully');
                    
                    // DON'T auto-load data on startup to prevent overwriting bot data
                    // User must manually click "Load from Cloud" to restore saved data
                    console.log('‚ÑπÔ∏è Firebase ready - Click "Load from Cloud" to restore saved data');
                    
                    // Set up auto-save every 60 seconds
                    setInterval(autoSaveToFirebase, 60000);
                } else {
                    console.log('Firebase not available - running in offline mode');
                    updateFirebaseStatus('disconnected');
                }
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                updateFirebaseStatus('disconnected');
                console.log('Continuing in offline mode');
            }
        }

        // Update Firebase status indicator
        function updateFirebaseStatus(status) {
            const statusElement = document.getElementById('firebase-status');
            if (!statusElement) return;
            
            if (status === 'connected') {
                statusElement.className = 'firebase-status firebase-connected';
                statusElement.innerHTML = 'üü¢ Firebase Connected';
            } else if (status === 'saving') {
                statusElement.className = 'firebase-status firebase-saving';
                statusElement.innerHTML = 'üü° Saving to Cloud...';
            } else {
                statusElement.className = 'firebase-status firebase-disconnected';
                statusElement.innerHTML = 'üî¥ Firebase Disconnected';
            }
        }

        // Collect all dashboard data for Firebase (with proper serialization)
        function getAllDashboardData() {
            // Clean the applicants data to remove any functions or non-serializable properties
            const cleanApplicants = applicants.map(applicant => {
                const cleanApplicant = {};
                // Copy only serializable properties
                for (const key in applicant) {
                    if (applicant.hasOwnProperty(key) && typeof applicant[key] !== 'function') {
                        cleanApplicant[key] = applicant[key];
                    }
                }
                return cleanApplicant;
            });

            return {
                applicants: cleanApplicants,
                botStats: {
                    totalReceived: botStats.totalReceived,
                    lastReceived: botStats.lastReceived,
                    connectionStatus: botStats.connectionStatus,
                    lastPing: botStats.lastPing
                },
                metadata: {
                    totalApplicants: cleanApplicants.length,
                    passed: cleanApplicants.filter(a => a.status === 'passed').length,
                    failed: cleanApplicants.filter(a => a.status === 'failed').length,
                    waitlist: cleanApplicants.filter(a => a.status === 'waitlist').length,
                    processed: cleanApplicants.filter(a => a.status === 'processed').length,
                    lastUpdated: new Date().toISOString()
                }
            };
        }

        // Save to Firebase (improved with better error handling)
        function saveToFirebase() {
            if (!database) {
                showNotification('‚ùå Firebase not connected. Please check your configuration.', 'error');
                return;
            }

            updateFirebaseStatus('saving');
            
            try {
                const allData = getAllDashboardData();
                const timestamp = new Date().toISOString();

                console.log('üíæ Saving to Firebase:', allData.applicants.length, 'applicants');

                database.ref('aiBootcampDashboard').set({
                    ...allData,
                    lastSaved: timestamp,
                    version: '2.0'
                }).then(() => {
                    updateFirebaseStatus('connected');
                    showNotification('‚úÖ Dashboard data saved to Firebase successfully!', 'success');
                    console.log('üî• Dashboard data saved to Firebase at:', timestamp);
                }).catch((error) => {
                    updateFirebaseStatus('disconnected');
                    showNotification('‚ùå Failed to save to Firebase: ' + error.message, 'error');
                    console.error('‚ùå Firebase save error:', error);
                });
            } catch (error) {
                updateFirebaseStatus('disconnected');
                showNotification('‚ùå Failed to prepare data for Firebase: ' + error.message, 'error');
                console.error('‚ùå Data preparation error:', error);
            }
        }

        // Clear Firebase data (for testing and debugging)
        function clearFirebaseData() {
            if (!database) {
                showNotification('‚ùå Firebase not connected - cannot clear data', 'error');
                return;
            }

            if (confirm('‚ö†Ô∏è Are you sure you want to PERMANENTLY DELETE all data from Firebase?\n\nThis will:\n- Delete all saved applicant data\n- Delete all bot statistics\n- Cannot be undone\n\nLocal data will remain unchanged.')) {
                console.log('üóëÔ∏è Clearing Firebase data...');
                
                database.ref('aiBootcampDashboard').remove().then(() => {
                    showNotification('‚úÖ Firebase data cleared successfully', 'success');
                    console.log('üî• Firebase data cleared');
                }).catch((error) => {
                    showNotification('‚ùå Failed to clear Firebase data: ' + error.message, 'error');
                    console.error('‚ùå Firebase clear error:', error);
                });
            }
        }

        // Test Firebase functionality
        function testFirebase() {
            console.log('üß™ Testing Firebase functionality...');
            
            if (!database) {
                showNotification('‚ùå Firebase not connected - cannot test', 'error');
                return;
            }

            const testData = {
                currentApplicants: applicants.length,
                botStats: botStats,
                timestamp: new Date().toISOString(),
                testId: 'TEST_' + Date.now()
            };

            console.log('üìä Current dashboard state:', testData);

            // Test Firebase write
            database.ref('aiBootcampDashboard/test').set(testData).then(() => {
                console.log('‚úÖ Firebase write test successful');
                
                // Test Firebase read
                return database.ref('aiBootcampDashboard/test').once('value');
            }).then((snapshot) => {
                const readData = snapshot.val();
                console.log('‚úÖ Firebase read test successful:', readData);
                
                // Test current data integrity
                database.ref('aiBootcampDashboard').once('value').then((snapshot) => {
                    const currentFirebaseData = snapshot.val();
                    
                    const report = `üß™ FIREBASE TEST RESULTS
============================

CONNECTION STATUS: ‚úÖ Connected
WRITE TEST: ‚úÖ Successful
READ TEST: ‚úÖ Successful

CURRENT LOCAL DATA:
- Applicants: ${applicants.length}
- Bot Stats: ${JSON.stringify(botStats, null, 2)}
- Last Received: ${botStats.lastReceived || 'Never'}

FIREBASE STORED DATA:
- Stored Applicants: ${currentFirebaseData?.applicants?.length || 0}
- Last Saved: ${currentFirebaseData?.lastSaved || 'Never'}
- Last Auto-Saved: ${currentFirebaseData?.lastAutoSaved || 'Never'}
- Metadata: ${JSON.stringify(currentFirebaseData?.metadata || {}, null, 2)}

POTENTIAL ISSUES:
${applicants.length !== (currentFirebaseData?.applicants?.length || 0) ? 
'‚ö†Ô∏è LOCAL/FIREBASE DATA MISMATCH DETECTED!' : '‚úÖ Data counts match'}

RECOMMENDATIONS:
1. Click "Save to Cloud" to sync current data
2. Check console for detailed logs
3. If issues persist, try "Load from Cloud" to reset

Test completed: ${new Date().toLocaleString()}`;

                    showModal('üß™ Firebase Test Results', report);
                    showNotification('üß™ Firebase test completed - Check modal for details', 'success');
                });

            }).catch((error) => {
                console.error('‚ùå Firebase test failed:', error);
                showNotification('‚ùå Firebase test failed: ' + error.message, 'error');
            });
        }

        // Improved auto-save with better error handling and conflict detection
        function autoSaveToFirebase() {
            if (!database || applicants.length === 0) {
                console.log('üîÑ Auto-save skipped: Firebase not connected or no data');
                return;
            }

            console.log('üîÑ Auto-saving to Firebase...');
            updateFirebaseStatus('saving');
            
            try {
                const saveData = getAllDashboardData();
                const saveTimestamp = new Date().toISOString();

                // Use set instead of update to avoid function serialization issues
                database.ref('aiBootcampDashboard').set({
                    ...saveData,
                    lastAutoSaved: saveTimestamp,
                    version: '2.0'
                }).then(() => {
                    updateFirebaseStatus('connected');
                    console.log('üî• Auto-saved dashboard to Firebase successfully at:', saveTimestamp);
                    showSaveConfirmation();
                }).catch((error) => {
                    updateFirebaseStatus('disconnected');
                    console.error('‚ùå Auto-save failed:', error);
                    showNotification('‚ö†Ô∏è Auto-save failed: ' + error.message, 'error');
                });
            } catch (error) {
                updateFirebaseStatus('disconnected');
                console.error('‚ùå Auto-save preparation failed:', error);
                showNotification('‚ö†Ô∏è Auto-save preparation failed: ' + error.message, 'error');
            }
        }

        // Save confirmation visual feedback
        function showSaveConfirmation() {
            const confirmation = document.createElement('div');
            confirmation.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #27ae60;
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-weight: 600;
                z-index: 1001;
                box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
                transition: all 0.3s ease;
            `;
            confirmation.textContent = '‚úì Auto-Saved';
            document.body.appendChild(confirmation);

            setTimeout(() => {
                confirmation.style.opacity = '0';
                confirmation.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (confirmation.parentNode) {
                        confirmation.parentNode.removeChild(confirmation);
                    }
                }, 300);
            }, 2000);
        }

        // Load from Firebase (improved with better timing and conflict resolution)
        function loadFromFirebase() {
            if (!database) {
                showNotification('‚ùå Firebase not connected. Please check your configuration.', 'error');
                return;
            }

            console.log('üîÑ Loading data from Firebase...');
            showNotification('üîÑ Loading data from Firebase...', 'info');

            database.ref('aiBootcampDashboard').once('value').then((snapshot) => {
                const firebaseData = snapshot.val();

                if (!firebaseData || !firebaseData.applicants) {
                    console.log('‚ÑπÔ∏è No dashboard data found in Firebase - using local data');
                    showNotification('‚ÑπÔ∏è No saved data found in Firebase - using local data', 'info');
                    return;
                }

                // Store current applicants temporarily
                const currentApplicants = [...applicants];
                const currentCount = currentApplicants.length;

                // Load applicants data from Firebase
                applicants.length = 0; // Clear existing data
                applicants.push(...firebaseData.applicants);

                // Load bot stats if available
                if (firebaseData.botStats) {
                    Object.assign(botStats, firebaseData.botStats);
                }

                // Check if we loaded different data
                const loadedCount = applicants.length;
                const lastSaved = firebaseData.lastSaved || firebaseData.lastAutoSaved;

                // Refresh the entire UI
                refreshAllSections();

                showNotification(`‚úÖ Loaded ${loadedCount} applicants from Firebase (was ${currentCount} locally)`, 'success');
                console.log(`üî• Firebase data loaded:
- Loaded: ${loadedCount} applicants
- Previous local: ${currentCount} applicants  
- Last saved: ${lastSaved}
- Data timestamp: ${firebaseData.metadata?.lastUpdated || 'Unknown'}`);

                // Log the difference for debugging
                if (loadedCount !== currentCount) {
                    console.log('‚ö†Ô∏è Data count mismatch detected - Firebase may have overwritten local changes');
                }

            }).catch((error) => {
                showNotification('‚ùå Failed to load from Firebase: ' + error.message, 'error');
                console.error('Firebase load error:', error);
            });
        }

        // ü§ñ BOT INTEGRATION FUNCTIONS
        
        // Enhanced listener for messages from bot.html with security and message types
        window.addEventListener('message', function(event) {
            console.log('üì® Received message from:', event.origin, 'Data:', event.data);
            
            // Security check - specifically allow your bot URL and localhost for testing
            const allowedOrigins = [
                'https://terence1975-coder.github.io',
                'http://localhost',
                'https://localhost',
                'http://127.0.0.1',
                'https://127.0.0.1'
            ];
            
            const isAllowed = allowedOrigins.some(origin => event.origin.startsWith(origin));
            
            if (!isAllowed) {
                console.log('üö´ Rejected message from unauthorized origin:', event.origin);
                showNotification(`üö´ Rejected message from unauthorized origin: ${event.origin}`, 'error');
                return;
            }
            
            console.log('‚úÖ Message accepted from authorized origin:', event.origin);
            
            // Handle structured messages with messageType (new format)
            if (event.data && event.data.messageType) {
                console.log('üìä Processing structured message:', event.data.messageType);
                
                if (event.data.messageType === 'CANDIDATE_REPORT') {
                    console.log('‚úÖ Candidate assessment received:', event.data.name, 'Status:', event.data.status);
                    displayCandidateReport(event.data);
                    
                    // Auto-show modal if requested
                    if (event.data.autoShow) {
                        showCandidateModal(event.data);
                    }
                    
                    return;
                }
                
                if (event.data.messageType === 'CONNECTION_TEST') {
                    console.log('üîß Connection test successful from bot.html');
                    showNotification('‚úÖ Connection test successful! bot.html can communicate with dashboard', 'success');
                    alert('‚úÖ Connection working! Bot.html ‚Üí Dashboard communication confirmed');
                    return;
                }
            }
            
            // Handle legacy format (backwards compatibility)
            if (event.data && (event.data.name || event.data.email)) {
                console.log('üì® Processing legacy format message');
                processIncomingReport(event.data);
            }
        });

        // Function to display candidate data (enhanced with new fields)
        function displayCandidateReport(candidateData) {
            console.log('üéØ Displaying candidate assessment:', candidateData);
            
            // Map bot status to dashboard status
            let dashboardStatus = 'failed'; // Default
            let score = 0;
            
            if (candidateData.status === 'HIGHLY_SUITABLE') {
                dashboardStatus = 'passed';
                score = candidateData.score ? candidateData.score * 10 : 90; // Convert to percentage
            } else if (candidateData.status === 'SUITABLE') {
                dashboardStatus = 'waitlist';
                score = candidateData.score ? candidateData.score * 10 : 70; // Convert to percentage
            } else {
                dashboardStatus = 'failed';
                score = candidateData.score ? candidateData.score * 10 : 40; // Convert to percentage
            }
            
            // Convert structured format to our internal format with enhanced fields
            const reportData = {
                name: candidateData.name || 'Unknown Candidate',
                email: candidateData.email || 'no-email@example.com',
                phone: candidateData.phone || '+1 (555) 000-0000',
                score: score,
                bootcamp: candidateData.course || candidateData.bootcamp || 'AI Fundamentals',
                responses: candidateData.responses || candidateData.answers || ['Assessment', 'Based', 'On', 'Bot', 'Interaction'],
                autoShow: candidateData.autoShow || false,
                messageType: candidateData.messageType,
                
                // Enhanced fields from bot assessment
                location: candidateData.location || 'Not specified',
                employmentStatus: candidateData.employmentStatus || 'Not specified',
                ukResidency: candidateData.ukResidency || 'Not specified',
                interviewStatus: candidateData.interviewStatus || 'Not scheduled',
                interviewBooked: candidateData.interviewBooked || false,
                sessionId: candidateData.sessionId || 'N/A',
                timestamp: candidateData.timestamp || new Date().toISOString(),
                botStatus: candidateData.status, // Original bot status
                originalScore: candidateData.score || 0
            };
            
            // Process using existing system with enhanced data
            processEnhancedIncomingReport(reportData, dashboardStatus);
            
            // Show additional notification for structured reports
            const statusEmoji = dashboardStatus === 'passed' ? '‚úÖ' : dashboardStatus === 'waitlist' ? '‚è≥' : '‚ùå';
            showNotification(`üìä Assessment completed: ${reportData.name} ${statusEmoji} ${candidateData.status} (${score}%)`, 'success');
            
            // Update page title with candidate count
            updatePageTitle();
        }

        // Function to show candidate modal (enhanced)
        function showCandidateModal(candidateData) {
            console.log('üìã Showing modal for candidate:', candidateData.name);
            
            // Create a temporary applicant object for the modal
            const tempApplicant = {
                id: Date.now(),
                name: candidateData.name || 'Unknown Candidate',
                email: candidateData.email || 'no-email@example.com',
                phone: candidateData.phone || '+1 (555) 000-0000',
                date: new Date().toISOString().split('T')[0],
                status: determineStatus(candidateData.score || 0),
                score: candidateData.score || 0,
                bootcamp: candidateData.course || candidateData.bootcamp || 'AI Fundamentals',
                responses: candidateData.responses || candidateData.answers || ['Unknown', 'Unknown', 'Unknown', 'Unknown', 'Unknown'],
                submissionTime: new Date().toLocaleString(),
                source: 'Bot Submission (Structured)',
                messageType: candidateData.messageType
            };
            
            // Show the individual report modal
            showIndividualReport(tempApplicant);
        }

        // Process URL parameters for direct report submission
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('report')) {
                try {
                    const reportData = JSON.parse(decodeURIComponent(urlParams.get('report')));
                    processIncomingReport(reportData);
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) {
                    console.error('Error parsing URL report data:', e);
                }
            }
        }

        // Enhanced function to process incoming reports with additional bot data
        function processEnhancedIncomingReport(data, status) {
            console.log('üîÑ Processing enhanced assessment report:', data);
            
            // Update connection status
            botStats.connectionStatus = 'Connected';
            botStats.lastReceived = new Date().toLocaleString();
            botStats.totalReceived++;
            updateConnectionStatus();
            
            // Create comprehensive applicant object with enhanced fields
            const newApplicant = {
                id: Date.now() + Math.random(), // Ensure unique ID
                name: data.name || 'Unknown Candidate',
                email: data.email || 'no-email@example.com',
                phone: data.phone || '+1 (555) 000-0000',
                date: new Date().toISOString().split('T')[0],
                status: status, // Use the mapped status
                score: data.score || 0,
                bootcamp: data.bootcamp || 'AI Fundamentals',
                responses: Array.isArray(data.responses) ? data.responses : [data.responses],
                submissionTime: new Date().toLocaleString(),
                source: 'Bot Assessment - Enhanced',
                
                // Enhanced fields from bot
                location: data.location || 'Not specified',
                employmentStatus: data.employmentStatus || 'Not specified',
                ukResidency: data.ukResidency || 'Not specified',
                interviewStatus: data.interviewStatus || 'Not scheduled',
                interviewBooked: data.interviewBooked || false,
                sessionId: data.sessionId || 'N/A',
                timestamp: data.timestamp || new Date().toISOString(),
                botStatus: data.botStatus || 'Unknown',
                originalScore: data.originalScore || 0,
                
                rawData: data // Store original data for debugging
            };
            
            console.log('‚úÖ Created enhanced applicant object:', newApplicant);
            
            // Add to applicants array
            applicants.push(newApplicant);
            
            // Update UI immediately
            refreshAllSections();
            
            // Show detailed success notification
            const statusEmoji = status === 'passed' ? '‚úÖ' : status === 'waitlist' ? '‚è≥' : '‚ùå';
            showNotification(`${statusEmoji} Assessment completed: ${newApplicant.name} - ${newApplicant.botStatus} (${newApplicant.score}%)`, 'success');
            
            // Auto-save to Firebase
            if (database) {
                setTimeout(autoSaveToFirebase, 2000);
            }
            
            // Auto-show report if requested
            if (data.autoShow) {
                setTimeout(() => showIndividualReport(newApplicant), 1000);
            }
            
            console.log('‚úÖ Successfully processed enhanced assessment - Total applicants:', applicants.length);
        }

        // Update page title with candidate count
        function updatePageTitle() {
            const totalCandidates = applicants.length;
            const passedCount = applicants.filter(a => a.status === 'passed').length;
            const waitlistCount = applicants.filter(a => a.status === 'waitlist').length;
            const failedCount = applicants.filter(a => a.status === 'failed').length;
            
            document.title = `ü§ñ AI Bootcamp Dashboard (${totalCandidates} candidates: ${passedCount} passed, ${waitlistCount} waitlist, ${failedCount} failed)`;
        }
        function processIncomingReport(data) {
            console.log('üîÑ Processing incoming assessment report:', data);
            
            // Update connection status
            botStats.connectionStatus = 'Connected';
            botStats.lastReceived = new Date().toLocaleString();
            botStats.totalReceived++;
            updateConnectionStatus();
            
            // Enhanced validation for assessment data
            if (!data || (!data.name && !data.candidate_name)) {
                console.error('‚ùå Invalid assessment data - missing name:', data);
                showNotification('‚ùå Invalid assessment data received - missing candidate name', 'error');
                return;
            }
            
            // Handle different data formats from bot.html
            const candidateName = data.name || data.candidate_name || 'Unknown Candidate';
            const candidateEmail = data.email || data.candidate_email || `${candidateName.toLowerCase().replace(/\s+/g, '.')}@example.com`;
            const candidatePhone = data.phone || data.candidate_phone || '+1 (555) 000-0000';
            const assessmentScore = parseInt(data.score || data.assessment_score || data.final_score || 0);
            const courseName = data.bootcamp || data.course || data.program || 'AI Fundamentals';
            const assessmentResponses = data.responses || data.answers || data.assessment_answers || ['Unknown', 'Unknown', 'Unknown', 'Unknown', 'Unknown'];
            
            // Create comprehensive applicant object
            const newApplicant = {
                id: Date.now() + Math.random(), // Ensure unique ID
                name: candidateName,
                email: candidateEmail,
                phone: candidatePhone,
                date: new Date().toISOString().split('T')[0],
                status: determineStatus(assessmentScore),
                score: assessmentScore,
                bootcamp: courseName,
                responses: Array.isArray(assessmentResponses) ? assessmentResponses : [assessmentResponses],
                submissionTime: new Date().toLocaleString(),
                source: 'Bot Assessment - terence1975-coder.github.io',
                rawData: data // Store original data for debugging
            };
            
            console.log('‚úÖ Created new applicant object:', newApplicant);
            
            // Add to applicants array
            applicants.push(newApplicant);
            
            // Update UI immediately
            refreshAllSections();
            
            // Show detailed success notification
            showNotification(`‚úÖ Assessment received: ${newApplicant.name} scored ${assessmentScore}% (${newApplicant.status})`, 'success');
            
            // Auto-save to Firebase
            if (database) {
                setTimeout(autoSaveToFirebase, 2000);
            }
            
            // Auto-show report if requested
            if (data.autoShow || data.auto_show) {
                setTimeout(() => showIndividualReport(newApplicant), 1000);
            }
            
            console.log('‚úÖ Successfully processed assessment from bot.html - Total applicants:', applicants.length);
        }

        // Determine status based on score
        function determineStatus(score) {
            if (score >= 80) return 'passed';
            if (score >= 60) return 'waitlist';
            return 'failed';
        }

        // Function to ping the bot URL and test connectivity
        function pingBotURL() {
            const botURL = 'https://terence1975-coder.github.io/tender/bot.html';
            
            console.log('üì° Pinging bot URL:', botURL);
            showNotification('üì° Testing connection to bot.html...', 'info');
            
            // Try to fetch the bot URL to test connectivity
            fetch(botURL, { mode: 'no-cors' })
                .then(() => {
                    console.log('‚úÖ Bot URL is reachable');
                    showNotification('‚úÖ Bot URL is reachable - Ready to receive assessments!', 'success');
                    
                    // Update bot stats
                    botStats.connectionStatus = 'URL Verified';
                    botStats.lastPing = new Date().toLocaleString();
                    updateConnectionStatus();
                })
                .catch((error) => {
                    console.log('‚ö†Ô∏è Bot URL ping failed (this is normal due to CORS):', error);
                    showNotification('‚ö†Ô∏è Bot URL ping failed (normal due to CORS) - Dashboard still ready!', 'info');
                    
                    botStats.connectionStatus = 'Ready (CORS limited)';
                    botStats.lastPing = new Date().toLocaleString();
                    updateConnectionStatus();
                });
        }

        // Enhanced connection status display
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            if (statusEl) {
                const firebaseStatus = database ? 'üü¢ Firebase Connected' : 'üî¥ Firebase Offline';
                const botStatus = getBotStatusIcon(botStats.connectionStatus);
                
                statusEl.innerHTML = `
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-600">${botStatus} Bot: ${botStats.connectionStatus}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-gray-600">${firebaseStatus}</span>
                        </div>
                        <div class="text-gray-500">
                            Assessments: ${botStats.totalReceived} | Last: ${botStats.lastReceived || 'Never'}
                        </div>
                        ${botStats.lastPing ? `<div class="text-gray-500">Last Ping: ${botStats.lastPing}</div>` : ''}
                    </div>
                `;
            }
        }

        // Get bot status icon based on connection status
        function getBotStatusIcon(status) {
            switch(status) {
                case 'Connected': return 'üü¢';
                case 'URL Verified': return 'üü¢';
                case 'Ready (CORS limited)': return 'üü°';
                case 'Ready': return 'üü°';
                default: return 'üî¥';
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-md ${
                type === 'success' ? 'bg-green-500 text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">‚úï</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }

        // Refresh all UI sections with new data
        function refreshAllSections() {
            // Update statistics
            updateStatistics();
            
            // Update page title
            updatePageTitle();
            
            // Clear and repopulate all sections
            document.getElementById('recent-applicants').innerHTML = '';
            document.getElementById('passed-applicants').innerHTML = '';
            document.getElementById('waitlist-applicants').innerHTML = '';
            document.getElementById('failed-applicants').innerHTML = '';
            document.getElementById('processed-applicants').innerHTML = '';
            
            // Re-initialize with updated data
            populateRecentApplicants();
            populateApplicantSections();
            updateSectionCounts();
        }

        // Update statistics cards
        function updateStatistics() {
            const totalCount = applicants.length;
            const passedCount = applicants.filter(a => a.status === 'passed').length;
            const failedCount = applicants.filter(a => a.status === 'failed').length;
            const waitlistCount = applicants.filter(a => a.status === 'waitlist').length;
            const processedCount = applicants.filter(a => a.status === 'processed').length;

            console.log('üìä Updating statistics:', { totalCount, passedCount, failedCount, waitlistCount, processedCount });

            // Update the numbers in statistics cards
            const statTotal = document.getElementById('stat-total');
            const statPassed = document.getElementById('stat-passed');
            const statFailed = document.getElementById('stat-failed');
            const statWaitlist = document.getElementById('stat-waitlist');
            const statProcessed = document.getElementById('stat-processed');

            if (statTotal) statTotal.textContent = totalCount;
            if (statPassed) statPassed.textContent = passedCount;
            if (statFailed) statFailed.textContent = failedCount;
            if (statWaitlist) statWaitlist.textContent = waitlistCount;
            if (statProcessed) statProcessed.textContent = processedCount;

            console.log('‚úÖ Statistics updated successfully');
        }

        // Update section count headers
        function updateSectionCounts() {
            const passedCount = applicants.filter(a => a.status === 'passed').length;
            const waitlistCount = applicants.filter(a => a.status === 'waitlist').length;
            const failedCount = applicants.filter(a => a.status === 'failed').length;
            const processedCount = applicants.filter(a => a.status === 'processed').length;

            // Update count displays
            const processedCountEl = document.getElementById('processed-count');
            if (processedCountEl) processedCountEl.textContent = processedCount;
        }

        // Tab switching
        function switchTab(tabName) {
            console.log('üîÑ Switching to tab:', tabName);
            
            // Hide all content
            document.querySelectorAll('[id^="content-"]').forEach(el => el.style.display = 'none');
            
            // Show selected content
            const selectedContent = document.getElementById('content-' + tabName);
            if (selectedContent) {
                selectedContent.style.display = 'block';
            }
            
            // Update tab styles
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.className = el.className.replace('tab-active', 'tab-inactive');
            });
            
            const selectedTab = document.getElementById('tab-' + tabName);
            if (selectedTab) {
                selectedTab.className = selectedTab.className.replace('tab-inactive', 'tab-active');
            }
            
            console.log('‚úÖ Tab switched to:', tabName);
        }

        // Modal functions
        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').value = content;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        function copyToClipboard() {
            const content = document.getElementById('modal-content').value;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.getElementById('copy-btn');
                btn.textContent = '‚úÖ Copied!';
                btn.className = btn.className.replace('btn-blue', 'btn-green');
                setTimeout(() => {
                    btn.textContent = 'Copy to Clipboard';
                    btn.className = btn.className.replace('btn-green', 'btn-blue');
                }, 2000);
            }).catch(() => {
                // Fallback if clipboard API fails
                console.log('Clipboard API failed, manual copy required');
            });
        }

        // Delete applicant (improved with immediate Firebase sync)
        function deleteApplicant(applicantId) {
            const applicant = applicants.find(a => a.id === applicantId);
            if (!applicant) {
                showNotification('‚ùå Applicant not found', 'error');
                return;
            }

            if (confirm(`Are you sure you want to permanently delete this applicant?\n\nName: ${applicant.name}\nEmail: ${applicant.email}\n\nThis action cannot be undone.`)) {
                const index = applicants.findIndex(a => a.id === applicantId);
                if (index !== -1) {
                    const deletedApplicant = applicants[index];
                    applicants.splice(index, 1);
                    
                    console.log('üóëÔ∏è Deleted applicant:', deletedApplicant.name, 'ID:', deletedApplicant.id);
                    console.log('üìä Remaining applicants:', applicants.length);
                    
                    refreshAllSections();
                    showNotification(`üóëÔ∏è Deleted applicant: ${deletedApplicant.name}`, 'success');
                    
                    // Immediate save to Firebase to prevent data loss
                    if (database) {
                        console.log('üíæ Immediately saving to Firebase after deletion...');
                        try {
                            saveToFirebase();
                            console.log('‚úÖ Deletion saved to Firebase');
                        } catch (error) {
                            console.error('‚ùå Failed to save deletion to Firebase:', error);
                            showNotification('‚ö†Ô∏è Deletion saved locally but failed to sync to Firebase', 'error');
                        }
                    } else {
                        console.log('‚ö†Ô∏è Firebase not available - deletion only saved locally');
                        showNotification('‚ö†Ô∏è Deletion saved locally only - Firebase not connected', 'error');
                    }
                }
            }
        }

        // Move applicant to processed
        function moveToProcessed(applicantId) {
            if (confirm('Mark this applicant as processed? This means the application has been reviewed and actioned.')) {
                const applicant = applicants.find(a => a.id === applicantId);
                if (applicant) {
                    applicant.status = 'processed';
                    applicant.processedDate = new Date().toLocaleString();
                    applicant.processedBy = 'Dashboard User';
                    
                    refreshAllSections();
                    showNotification(`‚úîÔ∏è Moved ${applicant.name} to Processed`, 'success');
                    
                    // Auto-save to Firebase
                    if (database) {
                        setTimeout(autoSaveToFirebase, 2000);
                    }
                }
            }
        }

        // Restore from processed
        function restoreFromProcessed(applicantId) {
            if (confirm('Restore this applicant to active status? They will be moved back to their original category.')) {
                const applicant = applicants.find(a => a.id === applicantId);
                if (applicant) {
                    applicant.status = determineStatus(applicant.score);
                    delete applicant.processedDate;
                    delete applicant.processedBy;
                    
                    refreshAllSections();
                    showNotification(`‚Ü©Ô∏è Restored ${applicant.name} to ${applicant.status}`, 'success');
                    
                    // Auto-save to Firebase
                    if (database) {
                        setTimeout(autoSaveToFirebase, 2000);
                    }
                }
            }
        }

        // Utility functions
        const getStatusColor = (status) => {
            switch(status) {
                case 'passed': return 'text-green-600 bg-green-100';
                case 'failed': return 'text-red-600 bg-red-100';
                case 'waitlist': return 'text-yellow-600 bg-yellow-100';
                case 'processed': return 'text-blue-600 bg-blue-100';
                default: return 'text-gray-600 bg-gray-100';
            }
        };

        const getStatusIcon = (status) => {
            switch(status) {
                case 'passed': return '‚úÖ';
                case 'failed': return '‚ùå';
                case 'waitlist': return '‚è≥';
                case 'processed': return '‚úîÔ∏è';
                default: return null;
            }
        };

        // Data functions
        function showCSVData() {
            const csv = [
                ['Name', 'Email', 'Phone', 'Date', 'Status', 'Score', 'Bootcamp'],
                ...applicants.map(a => [a.name, a.email, a.phone, a.date, a.status, a.score, a.bootcamp])
            ].map(row => row.join(',')).join('\n');
            showModal('üìä CSV Data - All Applicants', csv);
        }

        function showCategoryData(status) {
            const filtered = applicants.filter(a => a.status === status);
            const csv = [
                ['Name', 'Email', 'Phone', 'Date', 'Status', 'Score', 'Bootcamp'],
                ...filtered.map(a => [a.name, a.email, a.phone, a.date, a.status, a.score, a.bootcamp])
            ].map(row => row.join(',')).join('\n');
            showModal(`üìä CSV Data - ${status.charAt(0).toUpperCase() + status.slice(1)} Applicants`, csv);
        }

        function showIndividualReport(applicant) {
            const report = `AI BOOTCAMP SCREENING REPORT
============================

APPLICANT INFORMATION
Name: ${applicant.name}
Email: ${applicant.email}
Phone: ${applicant.phone}
Application Date: ${applicant.date}
Bootcamp: ${applicant.bootcamp}
${applicant.submissionTime ? `Submission Time: ${applicant.submissionTime}` : ''}
${applicant.source ? `Source: ${applicant.source}` : ''}

ENHANCED CANDIDATE DETAILS
${applicant.location ? `Location: ${applicant.location}` : ''}
${applicant.employmentStatus ? `Employment Status: ${applicant.employmentStatus}` : ''}
${applicant.ukResidency ? `UK Residency: ${applicant.ukResidency}` : ''}
${applicant.interviewStatus ? `Interview Status: ${applicant.interviewStatus}` : ''}
${applicant.interviewBooked ? `Interview Booked: ${applicant.interviewBooked ? 'Yes' : 'No'}` : ''}
${applicant.sessionId ? `Session ID: ${applicant.sessionId}` : ''}

SCREENING RESULTS
Overall Score: ${applicant.score}%
${applicant.originalScore ? `Original Bot Score: ${applicant.originalScore}/10` : ''}
${applicant.botStatus ? `Bot Assessment: ${applicant.botStatus}` : ''}
Status: ${applicant.status.toUpperCase()}
${applicant.processedDate ? `Processed Date: ${applicant.processedDate}` : ''}
${applicant.processedBy ? `Processed By: ${applicant.processedBy}` : ''}

ASSESSMENT RESPONSES
${applicant.responses.map((response, index) => `Response ${index + 1}: ${response}`).join('\n')}

RECOMMENDATION
${applicant.status === 'passed' ? 'HIGHLY SUITABLE - Candidate meets all requirements and shows excellent potential for the bootcamp.' :
  applicant.status === 'waitlist' ? 'SUITABLE - Candidate shows good potential but may need additional preparation or interview.' :
  applicant.status === 'failed' ? 'NOT SUITABLE - Candidate needs to strengthen foundational knowledge before reapplying.' :
  'PROCESSED - This application has been reviewed and appropriate action has been taken.'}

TECHNICAL DETAILS
Applicant ID: ${applicant.id}
${applicant.timestamp ? `Original Timestamp: ${new Date(applicant.timestamp).toLocaleString()}` : ''}
${applicant.source === 'Bot Assessment - Enhanced' ? 'Received via enhanced bot integration with full candidate data' : 'Standard assessment data'}

Generated on: ${new Date().toLocaleString()}`;
            showModal(`üìã Enhanced Screening Report - ${applicant.name}`, report);
        }

        function createChatbot() {
            const name = document.getElementById('chatbot-name').value;
            const course = document.getElementById('chatbot-course').value;
            
            if (name.trim()) {
                const report = `ü§ñ Chatbot Created Successfully!

Configuration:
- Name: ${name}
- Course: ${course}
- Created: ${new Date().toLocaleString()}
- Status: Active
- ID: CB${Date.now().toString().slice(-6)}

Features Enabled:
‚úì Applicant Screening
‚úì Automated Responses
‚úì Score Calculation
‚úì Report Generation

(This is a demo - in production, the chatbot would be configured in your AI platform)`;
                showModal('ü§ñ Chatbot Created Successfully', report);
                document.getElementById('chatbot-name').value = '';
            } else {
                showModal('‚ö†Ô∏è Validation Error', 'Please enter a chatbot name before creating.');
            }
        }

        function handleFileUpload(input, type) {
            const file = input.files[0];
            if (file) {
                const report = `‚úÖ ${type} File Upload Success!

File Details:
- Name: ${file.name}
- Size: ${(file.size / 1024).toFixed(2)} KB
- Type: ${file.type}
- Last Modified: ${new Date(file.lastModified).toLocaleString()}

(This is a demo - in production, the file would be processed on your server)`;
                showModal('‚úÖ File Upload Success', report);
                input.value = '';
            }
        }

        function editChatbot(chatbot) {
            const report = `‚öôÔ∏è Edit Chatbot Configuration

Current Settings:
- Name: ${chatbot.name}
- Course: ${chatbot.course}
- Created: ${chatbot.created}
- Status: ${chatbot.active ? 'Active' : 'Inactive'}

(This is demo functionality - in production, this would open a configuration interface)`;
            showModal(`‚öôÔ∏è Edit Chatbot - ${chatbot.name}`, report);
        }

        function deleteChatbot(chatbot) {
            const report = `üóëÔ∏è Delete Chatbot Confirmation

‚ö†Ô∏è Are you sure you want to delete "${chatbot.name}"?

This action will:
- Permanently remove the chatbot
- Delete all configuration data
- Stop any active screening sessions

Chatbot Details:
- Course: ${chatbot.course}
- Created: ${chatbot.created}
- Status: ${chatbot.active ? 'Active' : 'Inactive'}

This action CANNOT be undone!`;
            showModal(`üóëÔ∏è Delete Chatbot - ${chatbot.name}`, report);
        }

        // Test bot integration (enhanced for terence1975-coder.github.io)
        function testBotIntegration() {
            console.log('üß™ Testing bot integration with terence1975-coder.github.io');
            
            // Test both assessment formats that the bot might send
            const testFormats = [
                {
                    name: 'Assessment Test User',
                    email: 'test.user@example.com',
                    phone: '+1 (555) 123-4567',
                    score: 87,
                    bootcamp: 'AI Fundamentals',
                    responses: ['Correct', 'Correct', 'Incorrect', 'Correct', 'Correct'],
                    autoShow: true
                },
                {
                    candidate_name: 'Bot Assessment Test',
                    candidate_email: 'bot.test@example.com',
                    candidate_phone: '+1 (555) 987-6543',
                    assessment_score: 72,
                    course: 'Machine Learning',
                    assessment_answers: ['Correct', 'Incorrect', 'Correct', 'Correct', 'Incorrect'],
                    auto_show: false
                }
            ];
            
            const testData = testFormats[Math.floor(Math.random() * testFormats.length)];
            
            console.log('üß™ Testing with assessment data:', testData);
            processIncomingReport(testData);
            
            // Show test completion message
            showNotification('üß™ Bot integration test completed - Check console for details', 'success');
            
            // Log instructions for bot.html
            console.log(`
ü§ñ BOT INTEGRATION INSTRUCTIONS FOR terence1975-coder.github.io/tender/bot.html
================================================================================

To send assessment data to this dashboard, use either format:

FORMAT 1 (Simple):
const assessmentData = {
    name: "John Doe",
    email: "john@example.com",
    phone: "+1 (555) 123-4567",
    score: 85,
    bootcamp: "AI Fundamentals",
    responses: ["Correct", "Correct", "Incorrect", "Correct", "Correct"],
    autoShow: true
};

FORMAT 2 (Structured):
const assessmentData = {
    candidate_name: "John Doe",
    candidate_email: "john@example.com", 
    candidate_phone: "+1 (555) 123-4567",
    assessment_score: 85,
    course: "AI Fundamentals",
    assessment_answers: ["Correct", "Correct", "Incorrect", "Correct", "Correct"],
    auto_show: true
};

SEND TO DASHBOARD:
window.parent.postMessage(assessmentData, '*');

OR (if dashboard is in same window):
parent.addApplicantReport(assessmentData);

SCORING:
- 80+ = Passed (Green)
- 60-79 = Waitlist (Yellow)
- <60 = Failed (Red)

The dashboard will automatically update and show the results!
            `);
        }

        // Initialize page
        function init() {
            console.log('üöÄ Initializing AI Bootcamp Dashboard with Bot Integration');
            
            // Check for URL parameters first
            checkURLParams();
            
            // Update statistics immediately
            updateStatistics();
            
            // Populate all sections
            populateRecentApplicants();
            populateApplicantSections();
            populateChatbotsTable();
            updateConnectionStatus();
            updateSectionCounts();
            
            console.log('‚úÖ Dashboard initialized successfully with', applicants.length, 'applicants');
        }

        // Populate recent applicants
        function populateRecentApplicants() {
            const recentContainer = document.getElementById('recent-applicants');
            if (!recentContainer) {
                console.log('‚ö†Ô∏è Recent applicants container not found');
                return;
            }
            
            recentContainer.innerHTML = '';
            console.log('üîÑ Populating recent applicants section');
            
            applicants.slice(0, 5).forEach(applicant => {
                const statusClass = getStatusColor(applicant.status);
                const statusEmoji = getStatusIcon(applicant.status);
                
                recentContainer.innerHTML += `
                    <div class="px-6 py-4 flex items-center justify-between hover:bg-gray-50">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-sm font-medium text-gray-600">${applicant.name.split(' ').map(n => n[0]).join('')}</span>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">${applicant.name}</p>
                                <p class="text-sm text-gray-500">${applicant.email}</p>
                                <p class="text-sm text-gray-500">${applicant.phone}</p>
                                ${applicant.source ? `<p class="text-xs text-blue-600">${applicant.source}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-500">${applicant.bootcamp}</span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                                ${statusEmoji} ${applicant.status}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            console.log('‚úÖ Populated recent applicants with', Math.min(5, applicants.length), 'entries');
        }

        // Populate applicant sections
        function populateApplicantSections() {
            console.log('üîÑ Populating applicant sections with', applicants.length, 'total applicants');
            
            ['passed', 'waitlist', 'failed', 'processed'].forEach(status => {
                const container = document.getElementById(status + '-applicants');
                if (!container) {
                    console.log('‚ö†Ô∏è Container not found for status:', status);
                    return;
                }
                
                container.innerHTML = '';
                const filtered = applicants.filter(a => a.status === status);
                console.log(`üìä Found ${filtered.length} applicants with status: ${status}`);
                
                const colorClass = status === 'passed' ? 'green' : 
                                  status === 'failed' ? 'red' : 
                                  status === 'waitlist' ? 'yellow' : 'blue';
                
                filtered.forEach(applicant => {
                    const actionButtons = status === 'processed' ? 
                        `<button onclick="restoreFromProcessed(${applicant.id})" class="w-full btn btn-gray mb-2 text-sm">
                            ‚Ü©Ô∏è Restore to Active
                        </button>
                        <button onclick="deleteApplicant(${applicant.id})" class="w-full btn btn-red text-sm">
                            üóëÔ∏è Delete Permanently
                        </button>` :
                        `<div class="space-y-2">
                            <button onclick="showIndividualReport(${JSON.stringify(applicant).replace(/"/g, '&quot;')})" class="w-full btn btn-${colorClass}">
                                üìã View Report
                            </button>
                            <div class="flex space-x-2">
                                <button onclick="moveToProcessed(${applicant.id})" class="flex-1 btn btn-blue text-sm">
                                    ‚úîÔ∏è Mark Processed
                                </button>
                                <button onclick="deleteApplicant(${applicant.id})" class="flex-1 btn btn-red text-sm">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>`;

                    container.innerHTML += `
                        <div class="border border-${colorClass}-200 rounded-lg p-4 bg-${colorClass}-50 hover:shadow-md transition-shadow">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-grow">
                                    <h4 class="font-medium text-gray-900">${applicant.name}</h4>
                                    <p class="text-sm text-gray-600">${applicant.email}</p>
                                    <p class="text-sm text-gray-600">${applicant.phone}</p>
                                    ${applicant.location && applicant.location !== 'Not specified' ? `<p class="text-sm text-blue-600">üìç ${applicant.location}</p>` : ''}
                                    ${applicant.employmentStatus && applicant.employmentStatus !== 'Not specified' ? `<p class="text-xs text-gray-500">üíº ${applicant.employmentStatus}</p>` : ''}
                                    ${applicant.ukResidency && applicant.ukResidency !== 'Not specified' ? `<p class="text-xs text-gray-500">üè† UK: ${applicant.ukResidency}</p>` : ''}
                                    ${applicant.interviewBooked ? `<p class="text-xs text-green-600 font-medium">üìÖ Interview Booked</p>` : ''}
                                    ${applicant.botStatus ? `<p class="text-xs text-blue-600 font-medium">ü§ñ ${applicant.botStatus}</p>` : ''}
                                    ${applicant.source ? `<p class="text-xs text-blue-600 font-medium">${applicant.source}</p>` : ''}
                                    ${applicant.processedDate ? `<p class="text-xs text-blue-600">Processed: ${applicant.processedDate}</p>` : ''}
                                </div>
                                <div class="text-right">
                                    <span class="text-lg font-bold text-${colorClass}-600">${applicant.score}%</span>
                                    ${applicant.originalScore ? `<p class="text-xs text-gray-500">${applicant.originalScore}/10</p>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-sm text-gray-500 mb-3">
                                <span>${applicant.bootcamp}</span>
                                <span>${applicant.date}</span>
                            </div>
                            ${applicant.sessionId && applicant.sessionId !== 'N/A' ? `<p class="text-xs text-gray-400 mb-3">Session: ${applicant.sessionId}</p>` : ''}
                            ${actionButtons}
                        </div>
                    `;
                });
            });
            
            console.log('‚úÖ Completed populating all applicant sections');
        }

        // Populate chatbots table
        function populateChatbotsTable() {
            const chatbotsContainer = document.getElementById('chatbots-table');
            if (!chatbotsContainer) {
                console.log('‚ö†Ô∏è Chatbots table container not found');
                return;
            }
            
            chatbotsContainer.innerHTML = '';
            
            chatbots.forEach(chatbot => {
                chatbotsContainer.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${chatbot.name}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${chatbot.course}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${chatbot.created}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${chatbot.active ? 'text-green-800 bg-green-100' : 'text-gray-800 bg-gray-100'}">
                                ${chatbot.active ? 'üü¢ Active' : 'üî¥ Inactive'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium space-x-2">
                            <button onclick="editChatbot(${JSON.stringify(chatbot).replace(/"/g, '&quot;')})" class="text-blue-600 hover:text-blue-900">Edit</button>
                            <button onclick="deleteChatbot(${JSON.stringify(chatbot).replace(/"/g, '&quot;')})" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `;
            });
            
            console.log('‚úÖ Populated chatbots table with', chatbots.length, 'chatbots');
        }

        // Export function for bot integration
        window.getDashboardStats = function() {
            return {
                totalApplicants: applicants.length,
                passed: applicants.filter(a => a.status === 'passed').length,
                failed: applicants.filter(a => a.status === 'failed').length,
                waitlist: applicants.filter(a => a.status === 'waitlist').length,
                processed: applicants.filter(a => a.status === 'processed').length,
                botStats: botStats
            };
        };

        // API endpoint simulation for bot integration (enhanced for terence1975-coder.github.io)
        window.addApplicantReport = function(reportData) {
            console.log('üîó Direct API call received from bot.html:', reportData);
            
            // Add source information
            reportData.source = 'Direct API - terence1975-coder.github.io';
            
            if (reportData.messageType === 'CANDIDATE_REPORT') {
                displayCandidateReport(reportData);
            } else {
                processIncomingReport(reportData);
            }
            
            return {
                status: 'success',
                message: 'Assessment received successfully',
                applicantId: Date.now(),
                timestamp: new Date().toISOString()
            };
        };

        // Connection verification function specifically for terence1975-coder.github.io/tender/bot.html
        window.verifyDashboardConnection = function() {
            console.log('üîß Dashboard connection verification requested from bot.html');
            
            const connectionInfo = {
                status: 'connected',
                timestamp: new Date().toISOString(),
                dashboardReady: true,
                acceptedOrigin: 'https://terence1975-coder.github.io',
                supportedFormats: ['simple', 'structured', 'legacy'],
                totalApplicants: applicants.length,
                firebaseConnected: !!database,
                version: '2.0'
            };
            
            showNotification('‚úÖ Connection verified with bot.html - Dashboard ready!', 'success');
            console.log('üìä Dashboard connection info:', connectionInfo);
            
            return connectionInfo;
        };

        // Function for bot.html to check if dashboard is ready
        window.isDashboardReady = function() {
            return {
                ready: true,
                applicantCount: applicants.length,
                firebaseStatus: database ? 'connected' : 'offline',
                lastUpdate: new Date().toISOString()
            };
        };

        // Connection test function for bot.html
        window.testConnection = function() {
            console.log('üîß Connection test initiated');
            showNotification('‚úÖ Connection test successful! Dashboard is ready to receive reports.', 'success');
            return {
                status: 'connected',
                timestamp: new Date().toISOString(),
                dashboardReady: true,
                supportedFormats: ['legacy', 'structured']
            };
        };

        // Setup auto-save triggers (REMOVED - was causing Firebase function serialization error)
        function setupAutoSaveTriggers() {
            // This function is now disabled to prevent Firebase serialization errors
            console.log('üîß Auto-save triggers disabled to prevent Firebase function serialization errors');
        }

        const chatbots = [
            { 
                id: 1, 
                name: 'AI Fundamentals Screener', 
                course: 'AI Fundamentals', 
                created: '2025-01-01', 
                active: true 
            },
            { 
                id: 2, 
                name: 'Machine Learning Screener', 
                course: 'Machine Learning', 
                created: '2025-01-05', 
                active: true 
            },
            { 
                id: 3, 
                name: 'Data Science Screener', 
                course: 'Data Science', 
                created: '2025-01-10', 
                active: false 
            }
        ];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing AI Bootcamp Dashboard with Firebase & Bot Integration');
            
            // Add global error handler
            window.addEventListener('error', function(event) {
                console.error('üö® Global error caught:', event.error);
                showNotification('üö® An error occurred. Check console for details.', 'error');
            });
            
            // Add unhandled promise rejection handler
            window.addEventListener('unhandledrejection', function(event) {
                console.error('üö® Unhandled promise rejection:', event.reason);
                showNotification('üö® Promise rejection error. Check console for details.', 'error');
            });
            
            // Initialize Firebase first
            initializeFirebase();
            
            // Setup auto-save triggers (disabled to prevent Firebase serialization errors)
            setupAutoSaveTriggers();
            
            // Initialize dashboard - CRITICAL: This must run to show applicants
            init();
            
            // Setup modal event listener
            const modal = document.getElementById('modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) closeModal();
                });
            }
            
            // Force update statistics after short delay to ensure DOM is ready
            setTimeout(() => {
                updateStatistics();
                updateSectionCounts();
                updatePageTitle(); // Set initial page title
                console.log('üîÑ Force-updated statistics, sections, and page title');
            }, 500);
            
            // Show startup notification about Firebase behavior
            setTimeout(() => {
                if (database) {
                    showNotification('üî• Firebase connected! New bot assessments auto-save. Use "Load from Cloud" to restore saved data.', 'success', 8000);
                } else {
                    showNotification('‚ö†Ô∏è Firebase not connected - running in offline mode', 'error');
                }
            }, 2000);
            
            // Console welcome message for enhanced bot integration
            console.log(`
ü§ñ AI BOOTCAMP DASHBOARD - FIXED FIREBASE INTEGRATION
======================================================

‚úÖ Dashboard loaded successfully
‚úÖ Firebase integration active (with serialization fixes)
‚úÖ Auto-save enabled (every 60 seconds) - FIXED: No more function serialization errors
‚úÖ Enhanced bot listener ready for comprehensive candidate data
‚úÖ Security configured for your GitHub Pages domain
‚úÖ Data cleaning implemented to prevent Firebase errors
‚úÖ Global error handling enabled

üî• FIREBASE FIXES APPLIED:
- ‚úÖ Fixed function serialization error in auto-save
- ‚úÖ Improved data cleaning before Firebase saves
- ‚úÖ Better error handling and logging
- ‚úÖ Immediate saves for bot assessments and deletions
- ‚úÖ Manual control over data loading
- ‚úÖ Clear Firebase option for debugging

üö® TROUBLESHOOTING GUIDE:
1. Firebase errors: Click "üóëÔ∏è Clear Firebase" then "‚òÅÔ∏è Save to Cloud"
2. Deleted applicants return: Don't click "üì• Load from Cloud" after deletions
3. Bot data disappears: Check console - data saves within 1 second
4. Data corruption: Use "üß™ Test Firebase" to diagnose
5. Persistent issues: Use "üóëÔ∏è Clear Firebase" to reset

üì® FROM YOUR BOT.HTML:
const candidateData = {
    messageType: 'CANDIDATE_REPORT',
    name: "John Doe",
    email: "john@example.com", 
    phone: "+1 (555) 123-4567",
    status: "HIGHLY_SUITABLE", // SUITABLE, NOT_SUITABLE
    score: 8.5, // Out of 10
    course: "AI Fundamentals",
    location: "London, UK",
    employmentStatus: "Unemployed",
    ukResidency: "Yes",
    interviewStatus: "Scheduled",
    interviewBooked: true,
    sessionId: "SESSION_12345",
    timestamp: new Date().toISOString()
};
window.parent.postMessage(candidateData, '*');

Current stats: ${applicants.length} applicants loaded
üî• Firebase: ${database ? 'Connected & Fixed' : 'Offline'}
üß™ Use "Test Firebase" and "Clear Firebase" for debugging

All Firebase errors should now be resolved! üöÄ
            `);
            
            // Additional ready message for bot sync
            console.log('üéØ Enhanced bot integration active with FIXED Firebase sync - No more serialization errors!');
        });
    </script>
</body>
</html>
