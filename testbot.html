<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Bootcamp Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
        .tab-inactive:hover { color: #374151; border-bottom-color: #d1d5db; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; }
        .modal.show { display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: all 0.2s; cursor: pointer; border: none; }
        .btn-green { background: #16a34a; color: white; } .btn-green:hover { background: #15803d; }
        .btn-blue { background: #2563eb; color: white; } .btn-blue:hover { background: #1d4ed8; }
        .btn-yellow { background: #ca8a04; color: white; } .btn-yellow:hover { background: #a16207; }
        .btn-red { background: #dc2626; color: white; } .btn-red:hover { background: #b91c1c; }
        .btn-gray { background: #f3f4f6; color: #374151; } .btn-gray:hover { background: #e5e7eb; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .firebase-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .firebase-connected { background: #27ae60; box-shadow: 0 2px 10px rgba(39, 174, 96, 0.3); }
        .firebase-disconnected { background: #e74c3c; box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3); }
        .firebase-saving { background: #f39c12; box-shadow: 0 2px 10px rgba(243, 156, 18, 0.3); }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <!-- Firebase Status Indicator -->
    <div id="firebase-status" class="firebase-status firebase-disconnected">
        üî¥ Firebase Disconnected
    </div>

    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">ü§ñ AI Bootcamp Dashboard</h1>
                    <p class="text-gray-600">Manage screening applications and chatbots</p>
                    <p class="text-sm text-blue-600">üîó Connected to: https://terence1975-coder.github.io/tender/bot.html</p>
                    <div id="connection-status" class="mt-2"></div>
                </div>
                <div class="flex flex-col space-y-2">
                    <div class="flex space-x-2">
                        <button onclick="showCSVData()" class="btn btn-green">üì• Show Excel Data</button>
                        <button onclick="testBotIntegration()" class="btn btn-blue text-sm">üîó Test Bot Connection</button>
                        <button onclick="debugBotConnection()" class="btn btn-red text-sm">üîß Debug Bot</button>
                        <button onclick="testRealBotData()" class="btn btn-green text-sm">üéØ Test Real Bot Data</button>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="saveToFirebase()" class="btn btn-blue text-sm">‚òÅÔ∏è Save to Cloud</button>
                        <button onclick="loadFromFirebase()" class="btn btn-gray text-sm">üì• Load from Cloud</button>
                        <button onclick="testFirebase()" class="btn btn-yellow text-sm">üß™ Test Firebase</button>
                        <button onclick="resetToTestData()" class="btn btn-gray text-sm">üîÑ Reset Demo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8">
                <button onclick="switchTab('overview')" id="tab-overview" class="tab-active py-2 px-1 font-medium text-sm">üìä Overview</button>
                <button onclick="switchTab('applicants')" id="tab-applicants" class="tab-inactive py-2 px-1 font-medium text-sm">üë• Applicant Reports</button>
                <button onclick="switchTab('chatbots')" id="tab-chatbots" class="tab-inactive py-2 px-1 font-medium text-sm">‚öôÔ∏è Manage Chatbots</button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Overview Tab -->
        <div id="content-overview" class="space-y-6">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="text-3xl">üë•</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Applicants</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-total">0</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="text-3xl">‚úÖ</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Passed</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-passed">0</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="text-3xl">‚ùå</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Failed</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-failed">0</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="text-3xl">‚è≥</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Waitlist</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-waitlist">0</p>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <div class="flex items-center">
                        <div class="text-3xl">‚úîÔ∏è</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Processed</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-processed">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="px-6 py-4 border-b">
                    <h3 class="text-lg font-medium text-gray-900">üìù Recent Applications</h3>
                </div>
                <div class="divide-y divide-gray-200" id="recent-applicants"></div>
            </div>

            <!-- BroadcastChannel Debug Output -->
            <div class="card">
                <div class="px-6 py-4 border-b">
                    <h3 class="text-lg font-medium text-gray-900">üîó Bot Communication Channel</h3>
                    <p class="text-sm text-gray-500">Real-time data from bot.html via BroadcastChannel</p>
                </div>
                <div class="p-6">
                    <pre id="output" class="bg-gray-100 p-4 rounded-md text-sm overflow-auto max-h-48">Waiting for data from bot.html...</pre>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="testBroadcastChannel()" class="btn btn-blue text-sm">üì° Test Broadcast</button>
                        <button onclick="testRealBotDataBroadcast()" class="btn btn-green text-sm">üéØ Test Real Bot Data</button>
                        <button onclick="clearOutput()" class="btn btn-gray text-sm">üóëÔ∏è Clear Output</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applicants Tab -->
        <div id="content-applicants" class="space-y-6" style="display: none;">
            <!-- Passed Applicants -->
            <div class="card overflow-hidden">
                <div class="bg-green-50 px-6 py-4 border-b border-green-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-green-800">‚úÖ Passed Applicants (<span id="passed-count">0</span>)</h3>
                        <button onclick="showCategoryData('passed')" class="text-green-700 hover:text-green-900 text-sm">üì• Export Data</button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="passed-applicants"></div>
                </div>
            </div>

            <!-- Waitlist Applicants -->
            <div class="card overflow-hidden">
                <div class="bg-yellow-50 px-6 py-4 border-b border-yellow-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-yellow-800">‚è≥ Waitlist Applicants (<span id="waitlist-count">0</span>)</h3>
                        <button onclick="showCategoryData('waitlist')" class="text-yellow-700 hover:text-yellow-900 text-sm">üì• Export Data</button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="waitlist-applicants"></div>
                </div>
            </div>

            <!-- Failed Applicants -->
            <div class="card overflow-hidden">
                <div class="bg-red-50 px-6 py-4 border-b border-red-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-red-800">‚ùå Failed Applicants (<span id="failed-count">0</span>)</h3>
                        <button onclick="showCategoryData('failed')" class="text-red-700 hover:text-red-900 text-sm">üì• Export Data</button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="failed-applicants"></div>
                </div>
            </div>

            <!-- Processed Applicants -->
            <div class="card overflow-hidden">
                <div class="bg-blue-50 px-6 py-4 border-b border-blue-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-medium text-blue-800">‚úîÔ∏è Processed Applicants (<span id="processed-count">0</span>)</h3>
                        <button onclick="showCategoryData('processed')" class="text-blue-700 hover:text-blue-900 text-sm">üì• Export Data</button>
                    </div>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="processed-applicants"></div>
                </div>
            </div>
        </div>

        <!-- Chatbots Tab -->
        <div id="content-chatbots" class="space-y-6" style="display: none;">
            <div class="card p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">ü§ñ Create New Screening Chatbot</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chatbot Name</label>
                        <input type="text" id="chatbot-name" class="w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter chatbot name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Course/Bootcamp</label>
                        <select id="chatbot-course" class="w-full border border-gray-300 rounded-md px-3 py-2">
                            <option>AI Fundamentals</option>
                            <option>Machine Learning</option>
                            <option>Data Science</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <button onclick="createChatbot()" class="btn btn-blue">‚ûï Create Chatbot</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="flex justify-between items-center p-6 border-b bg-gray-50">
                <h2 id="modal-title" class="text-xl font-semibold text-gray-900">Modal Title</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">‚ùå</button>
            </div>
            <div class="p-6 overflow-auto max-h-[70vh]">
                <textarea id="modal-content" readonly class="w-full h-96 p-4 border border-gray-300 rounded-md font-mono text-sm bg-gray-50 resize-none"></textarea>
                <div class="mt-4 flex justify-between items-center">
                    <p class="text-sm text-gray-600">üí° Select all content above (Ctrl+A) and copy (Ctrl+C) to save</p>
                    <button onclick="copyToClipboard()" id="copy-btn" class="btn btn-blue">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // üî• CORE DATA STRUCTURES
        let applicants = [];
        let botStats = { totalReceived: 0, lastReceived: 'Never', connectionStatus: 'Ready', lastPing: 'Never' };
        let messageLog = [];
        let database = null;
        let firebaseApp = null;

        // Original test data
        const originalTestData = [
            { id: 1, name: 'John Smith', email: 'john@email.com', phone: '+1 (555) 123-4567', date: '2025-01-15', status: 'passed', score: 85, bootcamp: 'AI Fundamentals', responses: ['Correct', 'Correct', 'Incorrect', 'Correct', 'Correct'] },
            { id: 2, name: 'Sarah Johnson', email: 'sarah@email.com', phone: '+1 (555) 234-5678', date: '2025-01-14', status: 'failed', score: 45, bootcamp: 'AI Fundamentals', responses: ['Incorrect', 'Correct', 'Incorrect', 'Incorrect', 'Correct'] },
            { id: 3, name: 'Mike Chen', email: 'mike@email.com', phone: '+1 (555) 345-6789', date: '2025-01-13', status: 'waitlist', score: 65, bootcamp: 'AI Fundamentals', responses: ['Correct', 'Incorrect', 'Correct', 'Correct', 'Incorrect'] },
            { id: 4, name: 'Emily Davis', email: 'emily@email.com', phone: '+1 (555) 456-7890', date: '2025-01-12', status: 'passed', score: 92, bootcamp: 'Machine Learning', responses: ['Correct', 'Correct', 'Correct', 'Correct', 'Incorrect'] }
        ];

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
            authDomain: "prospecting-f2f42.firebaseapp.com",
            databaseURL: "https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "prospecting-f2f42",
            storageBucket: "prospecting-f2f42.firebasestorage.app",
            messagingSenderId: "292034226428",
            appId: "1:292034226428:web:878b867e3eb4d3e0098f79"
        };

        // üîó BROADCASTCHANNEL INTEGRATION - Cross-tab communication
        let botChannel = null;
        
        function initializeBroadcastChannel() {
            try {
                // Create BroadcastChannel for cross-tab communication
                botChannel = new BroadcastChannel('bot_channel');
                
                botChannel.onmessage = (event) => {
                    const data = event.data;
                    console.log('üì° Received from bot.html via BroadcastChannel:', data);
                    
                    // Update debug output
                    const output = document.getElementById('output');
                    if (output) {
                        output.textContent = `üì° RECEIVED: ${new Date().toLocaleTimeString()}\n${JSON.stringify(data, null, 2)}`;
                    }
                    
                    // Process the candidate data
                    if (data && typeof data === 'object') {
                        if (data.messageType === 'CONNECTION_TEST') {
                            showNotification('‚úÖ BroadcastChannel connection test successful!', 'success');
                            return;
                        }
                        
                        // Look for any candidate data - be very permissive
                        const hasName = data.name || data.candidate_name || data.candidateName;
                        const hasEmail = data.email || data.candidate_email;
                        const hasScore = data.score !== undefined || data.assessment_score !== undefined;
                        const hasStatus = data.status || data.assessment_status;
                        
                        if (hasName || hasEmail || hasScore || hasStatus) {
                            console.log('üéØ Processing candidate data from BroadcastChannel');
                            
                            // Enhanced candidate data extraction specifically for BroadcastChannel
                            const candidateData = extractBroadcastChannelData(data);
                            console.log('üîç Extracted candidate data:', candidateData);
                            
                            if (candidateData.name) {
                                addNewApplicant(candidateData);
                                showNotification(`‚úÖ BroadcastChannel: Added ${candidateData.name} to ${candidateData.status} section (${candidateData.score}%)`, 'success', 8000);
                                
                                // Force UI refresh to ensure it appears
                                setTimeout(() => {
                                    refreshUI();
                                    console.log('üîÑ UI refreshed after BroadcastChannel data');
                                }, 500);
                            } else {
                                console.log('‚ö†Ô∏è Could not extract name from candidate data');
                                showNotification('‚ö†Ô∏è Received data but could not extract candidate name', 'error');
                            }
                        } else {
                            console.log('‚ÑπÔ∏è BroadcastChannel message received but no candidate data found');
                            showNotification(`‚ÑπÔ∏è BroadcastChannel: ${JSON.stringify(data)}`, 'info', 3000);
                        }
                    }
                };
                
                console.log('üì° BroadcastChannel initialized successfully');
                showNotification('üì° BroadcastChannel ready for bot communication', 'info', 3000);
                
            } catch (error) {
                console.error('‚ùå BroadcastChannel failed to initialize:', error);
                showNotification('‚ùå BroadcastChannel not supported in this browser', 'error');
            }
        }
        
        function testRealBotDataBroadcast() {
            if (botChannel) {
                console.log('üéØ Testing BroadcastChannel with REAL bot data...');
                
                // Exact data format your bot is likely sending
                const realBotData = {
                    name: 'Terence Edwin Herbert',
                    email: 'terence.herbert75@gmail.com',
                    mobile: '07857553275',
                    phone: '07857553275',
                    score: '10/10',
                    status: 'HIGHLY_SUITABLE',
                    interviewBooked: true,
                    sessionId: '1752709265754',
                    course: 'AI Business Productivity Bootcamp',
                    source: 'BroadcastChannel Test'
                };
                
                console.log('üì° Sending real bot data via BroadcastChannel:', realBotData);
                botChannel.postMessage(realBotData);
                
                showNotification('üéØ Sent real bot data via BroadcastChannel - Check Applicant Reports tab!', 'success', 8000);
                
                // Auto-switch to applicant reports tab after delay
                setTimeout(() => {
                    switchTab('applicants');
                    showNotification('üìç Switched to Applicant Reports - Look for Terence Edwin Herbert in Passed section!', 'info', 5000);
                }, 2000);
            } else {
                showNotification('‚ùå BroadcastChannel not initialized', 'error');
            }
        }

        function testBroadcastChannel() {
            if (botChannel) {
                // Send test message to any listening bots
                const testMessage = { messageType: 'DASHBOARD_TEST', timestamp: new Date().toISOString() };
                botChannel.postMessage(testMessage);
                
                // Also test receiving our own test data
                setTimeout(() => {
                    const testData = {
                        name: 'BroadcastChannel Test',
                        email: 'broadcast@test.com',
                        score: '9/10',
                        status: 'HIGHLY_SUITABLE',
                        source: 'BroadcastChannel Test'
                    };
                    botChannel.postMessage(testData);
                }, 500);
                
                showNotification('üì° BroadcastChannel test sent', 'info');
            } else {
                showNotification('‚ùå BroadcastChannel not initialized', 'error');
            }
        }
        
        function clearOutput() {
            const output = document.getElementById('output');
            if (output) {
                output.textContent = 'Waiting for data from bot.html...';
            }
        }

        // ü§ñ BOT INTEGRATION - Enhanced Message Listener
        window.addEventListener('message', function(event) {
            console.log('üì® Bot message received:', event.origin, event.data);
            messageLog.push({ timestamp: new Date().toISOString(), origin: event.origin, data: event.data });
            
            // Very permissive for debugging - accept from any GitHub Pages origin
            const allowedOrigins = [
                'https://terence1975-coder.github.io',
                'http://localhost', 
                'https://localhost',
                'null' // For file:// protocol
            ];
            const isAllowed = allowedOrigins.some(origin => 
                event.origin.startsWith(origin) || 
                event.origin.includes('github.io') ||
                event.origin === 'null'
            );
            
            if (!isAllowed) {
                console.log('üö´ Origin not whitelisted, processing anyway for debug:', event.origin);
            }
            
            // Log detailed message info for debugging
            console.log('üîç Message details:', {
                origin: event.origin,
                dataType: typeof event.data,
                dataKeys: event.data ? Object.keys(event.data) : [],
                fullData: event.data
            });
            
            // Process any message with candidate data
            if (event.data && typeof event.data === 'object') {
                if (event.data.messageType === 'CONNECTION_TEST') {
                    console.log('‚úÖ Connection test successful');
                    showNotification('‚úÖ Bot connection test successful!', 'success');
                    return;
                }
                
                // Look for candidate data in the message
                const hasName = event.data.name || event.data.candidate_name || event.data.candidateName;
                const hasScore = event.data.score !== undefined || event.data.assessment_score !== undefined;
                const hasStatus = event.data.status || event.data.assessment_status;
                
                if (hasName || hasScore || hasStatus) {
                    console.log('üéØ Processing candidate data from bot');
                    const candidateData = extractCandidateData(event.data);
                    if (candidateData.name) {
                        addNewApplicant(candidateData);
                        showNotification(`‚úÖ New candidate: ${candidateData.name} (${candidateData.status}) - Score: ${candidateData.score}%`, 'success', 8000);
                    }
                } else {
                    console.log('‚ö†Ô∏è Message received but no recognizable candidate data found');
                    showNotification(`‚ÑπÔ∏è Message received from bot but no candidate data found: ${JSON.stringify(event.data)}`, 'info', 5000);
                }
            }
        });

        // Enhanced candidate data extraction specifically for BroadcastChannel
        function extractBroadcastChannelData(data) {
            console.log('üîç Extracting BroadcastChannel candidate data from:', data);
            
            // Extract basic info with multiple fallbacks
            const name = data.name || data.candidate_name || data.candidateName || 
                        data.candidateDetails?.name || '';
            
            const email = data.email || data.candidate_email || data.candidateEmail || 
                         data.candidateDetails?.email || 
                         (name ? `${name.toLowerCase().replace(/\s+/g, '.')}@example.com` : '');
            
            const phone = data.phone || data.mobile || data.candidate_phone || 
                         data.candidatePhone || data.candidateDetails?.phone || '+44 0000 000000';
            
            // Handle score extraction with multiple formats
            let score = 0;
            let mappedScore = 0;
            let status = 'failed';
            
            // Handle different score formats
            if (data.score !== undefined) {
                if (typeof data.score === 'string' && data.score.includes('/')) {
                    // Handle "10/10" format
                    const parts = data.score.split('/');
                    const numerator = parseInt(parts[0]);
                    const denominator = parseInt(parts[1]);
                    score = (numerator / denominator) * 100;
                } else {
                    score = parseInt(data.score);
                }
            } else if (data.assessment_score !== undefined) {
                score = parseInt(data.assessment_score);
            } else if (data.finalScore !== undefined) {
                score = parseInt(data.finalScore);
            }
            
            // Map bot status to dashboard status and score
            if (data.status === 'HIGHLY_SUITABLE' || (score >= 90 && score <= 100)) {
                mappedScore = Math.max(score, 90);
                status = 'passed';
            } else if (data.status === 'SUITABLE' || (score >= 70 && score < 90)) {
                mappedScore = Math.max(score, 70);
                status = 'waitlist';
            } else if (data.status === 'NOT_SUITABLE' || score < 70) {
                mappedScore = Math.min(score, 60);
                status = 'failed';
            } else {
                // Default mapping based on score
                mappedScore = score > 10 ? score : score * 10; // Convert if needed
                status = mappedScore >= 80 ? 'passed' : mappedScore >= 60 ? 'waitlist' : 'failed';
            }
            
            const result = {
                name,
                email,
                phone,
                score: mappedScore,
                status,
                bootcamp: data.course || data.bootcamp || data.program || 'AI Business Productivity Bootcamp',
                responses: data.responses || data.answers || data.assessment_answers || ['BroadcastChannel', 'Assessment', 'Completed'],
                location: data.location || 'Not specified',
                employmentStatus: data.employmentStatus || data.employment || 'Not specified',
                ukResidency: data.ukResidency || data.uk_residency || 'Not specified',
                interviewBooked: data.interviewBooked || data.interview_booked || data.interviewConfirmed || false,
                sessionId: data.sessionId || data.session_id || data.sessionID || 'N/A',
                source: 'Bot Assessment - BroadcastChannel',
                originalData: data,
                botStatus: data.status || 'Unknown',
                originalScore: data.score || 0
            };
            
            console.log('‚úÖ BroadcastChannel data extracted:', result);
            return result;
        }

        // Enhanced candidate data extraction for regular messages
        function extractCandidateData(data) {
            console.log('üîç Extracting candidate data from:', data);
            
            // Extract basic info
            const name = data.name || data.candidate_name || data.candidateName || data.candidateDetails?.name || '';
            const email = data.email || data.candidate_email || data.candidateEmail || data.candidateDetails?.email || 
                         (name ? `${name.toLowerCase().replace(/\s+/g, '.')}@example.com` : '');
            const phone = data.phone || data.mobile || data.candidate_phone || data.candidatePhone || 
                         data.candidateDetails?.phone || '+44 0000 000000';
            
            // Extract score - handle different formats
            let score = 0;
            if (data.score !== undefined) {
                score = typeof data.score === 'string' && data.score.includes('/') ? 
                       (parseInt(data.score.split('/')[0]) / parseInt(data.score.split('/')[1])) * 100 :
                       parseInt(data.score);
            } else if (data.assessment_score !== undefined) {
                score = parseInt(data.assessment_score);
            } else if (data.finalScore !== undefined) {
                score = parseInt(data.finalScore);
            }
            
            // Handle bot status mapping from your bot
            let mappedScore = score;
            let status = 'failed';
            
            if (data.status === 'HIGHLY_SUITABLE' || score === 10 || (typeof data.score === 'string' && data.score === '10/10')) {
                mappedScore = 95; // High pass
                status = 'passed';
            } else if (data.status === 'SUITABLE' || score >= 7) {
                mappedScore = 75; // Waitlist
                status = 'waitlist';
            } else if (data.status === 'NOT_SUITABLE' || score < 7) {
                mappedScore = 45; // Fail
                status = 'failed';
            } else {
                // Use numeric score to determine status
                mappedScore = score > 10 ? score : score * 10; // Convert if needed
                status = mappedScore >= 80 ? 'passed' : mappedScore >= 60 ? 'waitlist' : 'failed';
            }
            
            const result = {
                name,
                email,
                phone,
                score: mappedScore,
                status,
                bootcamp: data.course || data.bootcamp || data.program || 'AI Fundamentals',
                responses: data.responses || data.answers || data.assessment_answers || ['Bot', 'Assessment', 'Completed'],
                location: data.location || 'Not specified',
                employmentStatus: data.employmentStatus || data.employment || 'Not specified',
                ukResidency: data.ukResidency || data.uk_residency || 'Not specified',
                interviewBooked: data.interviewBooked || data.interview_booked || data.interviewConfirmed || false,
                sessionId: data.sessionId || data.session_id || data.sessionID || 'N/A',
                source: 'Bot Assessment - GitHub Pages',
                originalData: data,
                botStatus: data.status || 'Unknown'
            };
            
            console.log('‚úÖ Extracted candidate data:', result);
            return result;
        }

        // Add new applicant (enhanced for BroadcastChannel debugging)
        function addNewApplicant(candidateData) {
            console.log('üìù Adding new applicant:', candidateData);
            
            const newApplicant = {
                id: Date.now() + Math.random(),
                ...candidateData,
                date: new Date().toISOString().split('T')[0],
                submissionTime: new Date().toLocaleString()
            };
            
            // Add to applicants array
            applicants.push(newApplicant);
            console.log(`üìä Total applicants after adding: ${applicants.length}`);
            console.log(`üìä New applicant details:`, {
                name: newApplicant.name,
                status: newApplicant.status,
                score: newApplicant.score,
                email: newApplicant.email,
                source: newApplicant.source
            });
            
            // Update statistics immediately
            updateStats();
            
            // Save to localStorage immediately
            saveToLocalStorage();
            
            // Refresh UI with detailed logging
            console.log('üîÑ Refreshing UI after adding applicant...');
            refreshUI();
            
            // Update bot stats
            botStats.totalReceived++;
            botStats.lastReceived = new Date().toLocaleString();
            botStats.connectionStatus = 'Connected';
            updateConnectionStatus();
            
            // Auto-save to Firebase
            if (database) {
                console.log('‚òÅÔ∏è Scheduling Firebase save...');
                setTimeout(saveToFirebase, 2000);
            }
            
            console.log(`‚úÖ Successfully added applicant: ${newApplicant.name} to ${newApplicant.status} section`);
            
            // Force scroll to applicant reports tab if not already there
            setTimeout(() => {
                const applicantTab = document.getElementById('tab-applicants');
                if (applicantTab && !applicantTab.classList.contains('tab-active')) {
                    console.log('üìç Switching to Applicant Reports tab to show new applicant');
                    switchTab('applicants');
                }
            }, 1000);
        }

        // üíæ DATA PERSISTENCE
        function saveToLocalStorage() {
            try {
                const data = { applicants, botStats, lastSaved: new Date().toISOString() };
                localStorage.setItem('aiBootcampDashboard', JSON.stringify(data));
                console.log('üíæ Saved to localStorage');
            } catch (error) {
                console.error('‚ùå localStorage save failed:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('aiBootcampDashboard');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.applicants) {
                        applicants.length = 0;
                        applicants.push(...data.applicants);
                        if (data.botStats) Object.assign(botStats, data.botStats);
                        console.log('üì• Loaded from localStorage:', applicants.length, 'applicants');
                        return true;
                    }
                }
            } catch (error) {
                console.error('‚ùå localStorage load failed:', error);
            }
            return false;
        }

        // üî• FIREBASE INTEGRATION
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    firebaseApp = firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    updateFirebaseStatus('connected');
                    console.log('üî• Firebase initialized');
                    setInterval(() => { if (applicants.length > 0) saveToFirebase(); }, 60000);
                } else {
                    updateFirebaseStatus('disconnected');
                }
            } catch (error) {
                console.error('‚ùå Firebase init failed:', error);
                updateFirebaseStatus('disconnected');
            }
        }

        function updateFirebaseStatus(status) {
            const el = document.getElementById('firebase-status');
            if (el) {
                el.className = `firebase-status firebase-${status}`;
                el.innerHTML = status === 'connected' ? 'üü¢ Firebase Connected' : 
                              status === 'saving' ? 'üü° Saving...' : 'üî¥ Firebase Offline';
            }
        }

        function saveToFirebase() {
            if (!database) return;
            updateFirebaseStatus('saving');
            
            const cleanData = {
                applicants: applicants.map(a => ({ ...a, responses: a.responses || [] })),
                botStats: { ...botStats },
                metadata: { totalApplicants: applicants.length, lastUpdated: new Date().toISOString() }
            };
            
            database.ref('aiBootcampDashboard').set(cleanData)
                .then(() => {
                    updateFirebaseStatus('connected');
                    console.log('‚òÅÔ∏è Saved to Firebase');
                })
                .catch(error => {
                    console.error('‚ùå Firebase save failed:', error);
                    updateFirebaseStatus('disconnected');
                });
        }

        function loadFromFirebase() {
            if (!database) return;
            
            database.ref('aiBootcampDashboard').once('value')
                .then(snapshot => {
                    const data = snapshot.val();
                    if (data && data.applicants) {
                        applicants.length = 0;
                        applicants.push(...data.applicants);
                        if (data.botStats) Object.assign(botStats, data.botStats);
                        saveToLocalStorage();
                        refreshUI();
                        showNotification(`üì• Loaded ${applicants.length} applicants from Firebase`, 'success');
                    } else {
                        showNotification('‚ÑπÔ∏è No data found in Firebase', 'info');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Firebase load failed:', error);
                    showNotification('‚ùå Firebase load failed', 'error');
                });
        }

        // üìä UI FUNCTIONS
        function updateStats() {
            const total = applicants.length;
            const passed = applicants.filter(a => a.status === 'passed').length;
            const failed = applicants.filter(a => a.status === 'failed').length;
            const waitlist = applicants.filter(a => a.status === 'waitlist').length;
            const processed = applicants.filter(a => a.status === 'processed').length;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-passed').textContent = passed;
            document.getElementById('stat-failed').textContent = failed;
            document.getElementById('stat-waitlist').textContent = waitlist;
            document.getElementById('stat-processed').textContent = processed;
            
            document.getElementById('passed-count').textContent = passed;
            document.getElementById('waitlist-count').textContent = waitlist;
            document.getElementById('failed-count').textContent = failed;
            document.getElementById('processed-count').textContent = processed;
            
            document.title = `ü§ñ AI Bootcamp Dashboard (${total} applicants)`;
        }

        function refreshUI() {
            updateStats();
            populateRecentApplicants();
            populateApplicantSections();
            updateConnectionStatus();
        }

        function populateRecentApplicants() {
            const container = document.getElementById('recent-applicants');
            container.innerHTML = '';
            
            applicants.slice(0, 5).forEach(applicant => {
                const statusColor = applicant.status === 'passed' ? 'text-green-600 bg-green-100' :
                                   applicant.status === 'failed' ? 'text-red-600 bg-red-100' :
                                   applicant.status === 'waitlist' ? 'text-yellow-600 bg-yellow-100' :
                                   'text-blue-600 bg-blue-100';
                
                container.innerHTML += `
                    <div class="px-6 py-4 flex items-center justify-between hover:bg-gray-50">
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                                <span class="text-sm font-medium text-gray-600">${applicant.name.split(' ').map(n => n[0]).join('')}</span>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">${applicant.name}</p>
                                <p class="text-sm text-gray-500">${applicant.email}</p>
                                ${applicant.source ? `<p class="text-xs text-blue-600">${applicant.source}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-500">${applicant.bootcamp}</span>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                                ${applicant.status}
                            </span>
                        </div>
                    </div>
                `;
            });
        }

        function populateApplicantSections() {
            ['passed', 'waitlist', 'failed', 'processed'].forEach(status => {
                const container = document.getElementById(status + '-applicants');
                container.innerHTML = '';
                
                const filtered = applicants.filter(a => a.status === status);
                const colorClass = status === 'passed' ? 'green' : status === 'failed' ? 'red' : status === 'waitlist' ? 'yellow' : 'blue';
                
                filtered.forEach(applicant => {
                    const actionButtons = status === 'processed' ? 
                        `<button onclick="restoreFromProcessed(${applicant.id})" class="w-full btn btn-gray mb-2 text-sm">‚Ü©Ô∏è Restore</button>
                         <button onclick="deleteApplicant(${applicant.id})" class="w-full btn btn-red text-sm">üóëÔ∏è Delete</button>` :
                        `<button onclick="showIndividualReport(${JSON.stringify(applicant).replace(/"/g, '&quot;')})" class="w-full btn btn-${colorClass} mb-2">üìã View Report</button>
                         <div class="flex space-x-2">
                             <button onclick="moveToProcessed(${applicant.id})" class="flex-1 btn btn-blue text-sm">‚úîÔ∏è Process</button>
                             <button onclick="deleteApplicant(${applicant.id})" class="flex-1 btn btn-red text-sm">üóëÔ∏è Delete</button>
                         </div>`;

                    container.innerHTML += `
                        <div class="border border-${colorClass}-200 rounded-lg p-4 bg-${colorClass}-50 hover:shadow-md transition-shadow">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-grow">
                                    <h4 class="font-medium text-gray-900">${applicant.name}</h4>
                                    <p class="text-sm text-gray-600">${applicant.email}</p>
                                    <p class="text-sm text-gray-600">${applicant.phone}</p>
                                    ${applicant.location && applicant.location !== 'Not specified' ? `<p class="text-sm text-blue-600">üìç ${applicant.location}</p>` : ''}
                                    ${applicant.source ? `<p class="text-xs text-blue-600">${applicant.source}</p>` : ''}
                                </div>
                                <span class="text-lg font-bold text-${colorClass}-600">${applicant.score}%</span>
                            </div>
                            <div class="flex items-center justify-between text-sm text-gray-500 mb-3">
                                <span>${applicant.bootcamp}</span>
                                <span>${applicant.date}</span>
                            </div>
                            ${actionButtons}
                        </div>
                    `;
                });
            });
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            const firebaseStatus = database ? 'üü¢ Firebase' : 'üî¥ Offline';
            const botIcon = botStats.connectionStatus === 'Connected' ? 'üü¢' : 'üü°';
            
            statusEl.innerHTML = `
                <div class="flex items-center space-x-4 text-sm">
                    <span class="text-gray-600">${botIcon} Bot: ${botStats.connectionStatus}</span>
                    <span class="text-gray-600">${firebaseStatus}</span>
                    <span class="text-gray-500">Messages: ${botStats.totalReceived} | Last: ${botStats.lastReceived}</span>
                    <button onclick="showMessageLog()" class="text-blue-600 hover:text-blue-800 text-xs underline">View Log</button>
                </div>
            `;
        }

        // üîß UTILITY FUNCTIONS
        function switchTab(tabName) {
            document.querySelectorAll('[id^="content-"]').forEach(el => el.style.display = 'none');
            document.getElementById('content-' + tabName).style.display = 'block';
            
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.className = el.className.replace('tab-active', 'tab-inactive'));
            document.getElementById('tab-' + tabName).className = document.getElementById('tab-' + tabName).className.replace('tab-inactive', 'tab-active');
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').value = content;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        function copyToClipboard() {
            const content = document.getElementById('modal-content').value;
            navigator.clipboard.writeText(content).then(() => {
                const btn = document.getElementById('copy-btn');
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = 'Copy to Clipboard', 2000);
            });
        }

        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            notification.className = `fixed top-4 left-4 ${bgColor} text-white p-4 rounded-lg shadow-lg z-50 max-w-md`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">‚úï</button>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), duration);
        }

        // üîß ACTION FUNCTIONS
        function deleteApplicant(applicantId) {
            if (confirm('Delete this applicant permanently?')) {
                const index = applicants.findIndex(a => a.id === applicantId);
                if (index !== -1) {
                    const deleted = applicants[index];
                    applicants.splice(index, 1);
                    saveToLocalStorage();
                    refreshUI();
                    showNotification(`üóëÔ∏è Deleted ${deleted.name}`, 'success');
                    if (database) setTimeout(saveToFirebase, 1000);
                }
            }
        }

        function moveToProcessed(applicantId) {
            if (confirm('Mark this applicant as processed?')) {
                const applicant = applicants.find(a => a.id === applicantId);
                if (applicant) {
                    applicant.status = 'processed';
                    applicant.processedDate = new Date().toLocaleString();
                    saveToLocalStorage();
                    refreshUI();
                    showNotification(`‚úîÔ∏è Moved ${applicant.name} to processed`, 'success');
                    if (database) setTimeout(saveToFirebase, 1000);
                }
            }
        }

        function restoreFromProcessed(applicantId) {
            if (confirm('Restore this applicant to active status?')) {
                const applicant = applicants.find(a => a.id === applicantId);
                if (applicant) {
                    applicant.status = applicant.score >= 80 ? 'passed' : applicant.score >= 60 ? 'waitlist' : 'failed';
                    delete applicant.processedDate;
                    saveToLocalStorage();
                    refreshUI();
                    showNotification(`‚Ü©Ô∏è Restored ${applicant.name}`, 'success');
                    if (database) setTimeout(saveToFirebase, 1000);
                }
            }
        }

        function showCSVData() {
            const csv = [
                ['Name', 'Email', 'Phone', 'Date', 'Status', 'Score', 'Bootcamp'],
                ...applicants.map(a => [a.name, a.email, a.phone, a.date, a.status, a.score, a.bootcamp])
            ].map(row => row.join(',')).join('\n');
            showModal('üìä CSV Data - All Applicants', csv);
        }

        function showCategoryData(status) {
            const filtered = applicants.filter(a => a.status === status);
            const csv = [
                ['Name', 'Email', 'Phone', 'Date', 'Status', 'Score', 'Bootcamp'],
                ...filtered.map(a => [a.name, a.email, a.phone, a.date, a.status, a.score, a.bootcamp])
            ].map(row => row.join(',')).join('\n');
            showModal(`üìä ${status.charAt(0).toUpperCase() + status.slice(1)} Applicants`, csv);
        }

        function showIndividualReport(applicant) {
            const report = `AI BOOTCAMP SCREENING REPORT
============================

APPLICANT INFORMATION
Name: ${applicant.name}
Email: ${applicant.email}
Phone: ${applicant.phone}
Date: ${applicant.date}
Bootcamp: ${applicant.bootcamp}
Source: ${applicant.source || 'Manual Entry'}

ENHANCED DETAILS
${applicant.location ? `Location: ${applicant.location}` : ''}
${applicant.employmentStatus ? `Employment: ${applicant.employmentStatus}` : ''}
${applicant.ukResidency ? `UK Residency: ${applicant.ukResidency}` : ''}
${applicant.interviewBooked ? `Interview Booked: Yes` : ''}
${applicant.sessionId ? `Session ID: ${applicant.sessionId}` : ''}

ASSESSMENT RESULTS
Score: ${applicant.score}%
Status: ${applicant.status.toUpperCase()}
${applicant.processedDate ? `Processed: ${applicant.processedDate}` : ''}

RESPONSES
${applicant.responses ? applicant.responses.map((r, i) => `${i+1}. ${r}`).join('\n') : 'No responses recorded'}

RECOMMENDATION
${applicant.status === 'passed' ? 'ACCEPTED - Candidate meets requirements' :
  applicant.status === 'waitlist' ? 'WAITLIST - Candidate shows potential' :
  applicant.status === 'failed' ? 'NOT ACCEPTED - Candidate needs improvement' :
  'PROCESSED - Application has been reviewed'}

Generated: ${new Date().toLocaleString()}`;
            showModal(`üìã Report - ${applicant.name}`, report);
        }

        function testRealBotData() {
            console.log('üéØ Testing with REAL bot data from your screenshot...');
            
            // Exact data from your bot screenshot
            const realBotData = {
                name: 'Terence Edwin Herbert',
                email: 'terence.herbert75@gmail.com',
                mobile: '07857553275',
                phone: '07857553275',
                score: '10/10',
                status: 'HIGHLY_SUITABLE',
                interviewBooked: true,
                sessionId: '1752709265754',
                course: 'AI Business Productivity Bootcamp',
                from: 'bot.html',
                to: 'testbot.html'
            };
            
            console.log('üì® Simulating exact bot message:', realBotData);
            
            // Test the extraction
            const extracted = extractCandidateData(realBotData);
            console.log('üîç Extracted data:', extracted);
            
            if (extracted.name) {
                addNewApplicant(extracted);
                showNotification(`üéØ SUCCESS! Added real bot data: ${extracted.name} - ${extracted.status} (${extracted.score}%)`, 'success', 8000);
                
                // Show detailed success report
                setTimeout(() => {
                    showModal('üéØ Real Bot Data Test Results', `‚úÖ SUCCESS! Dashboard can process your bot data correctly.

ORIGINAL BOT DATA:
${JSON.stringify(realBotData, null, 2)}

PROCESSED AS:
- Name: ${extracted.name}
- Email: ${extracted.email}  
- Phone: ${extracted.phone}
- Score: ${extracted.score}% (from "${realBotData.score}")
- Status: ${extracted.status} (from "${realBotData.status}")
- Interview Booked: ${extracted.interviewBooked}
- Session ID: ${extracted.sessionId}

üîß ISSUE IDENTIFIED:
Your bot is working perfectly and sending the right data! 
The issue is likely that your bot is configured to send to "testbot.html" 
but you're using a different dashboard filename.

üöÄ SOLUTIONS:
1. Save this dashboard as "testbot.html" and upload it
2. Or update your bot configuration to use this dashboard's URL
3. Make sure you open the dashboard from your bot page (parent/child relationship)

The dashboard IS receiving and CAN process your bot data correctly!`);
                }, 1000);
            } else {
                showNotification('‚ùå Failed to process real bot data - check extraction logic', 'error');
            }
        }

        function testBotIntegration() {
            const testData = {
                name: 'Test Candidate ' + Math.floor(Math.random() * 1000),
                email: 'test' + Math.floor(Math.random() * 1000) + '@example.com',
                phone: '+1 (555) 999-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0'),
                score: Math.floor(Math.random() * 100),
                bootcamp: 'Test Course',
                responses: ['Test', 'Data', 'From', 'Dashboard'],
                source: 'Dashboard Test'
            };
            
            addNewApplicant(testData);
            showNotification('üß™ Test applicant added successfully!', 'success');
        }

        function debugBotConnection() {
            const report = `üîß BOT CONNECTION DEBUG
============================

DASHBOARD STATUS:
- URL: ${window.location.href}
- Origin: ${window.location.origin}
- Has Parent: ${window.parent !== window}
- In Frame: ${window !== window.top}

CONNECTION STATS:
- Messages Received: ${messageLog.length}
- Bot Status: ${botStats.connectionStatus}
- Last Message: ${botStats.lastReceived}
- Total Applicants: ${applicants.length}

MESSAGE LOG (Last 10):
${messageLog.slice(-10).map(log => 
    `${log.timestamp.split('T')[1].slice(0,8)} | ${log.origin} | ${JSON.stringify(log.data).slice(0, 100)}...`
).join('\n')}

INTEGRATION CODE FOR BOT.HTML:
// Test connection
window.parent.postMessage({messageType: 'CONNECTION_TEST'}, '*');

// Send candidate data
window.parent.postMessage({
    name: 'John Doe',
    email: 'john@example.com',
    score: 85,
    bootcamp: 'AI Fundamentals'
}, '*');

TROUBLESHOOTING:
1. Check browser console for errors
2. Ensure dashboard is parent window
3. Verify postMessage syntax
4. Check CORS/security restrictions`;
            showModal('üîß Bot Connection Debug', report);
        }

        function showMessageLog() {
            const logContent = messageLog.length === 0 ? 'No messages received yet.' :
                messageLog.slice(-20).map(log => 
                    `${log.timestamp} | ${log.origin} | ${JSON.stringify(log.data)}`
                ).join('\n');
            showModal('üì® Message Log (Last 20)', logContent);
        }

        function testFirebase() {
            if (!database) {
                showNotification('‚ùå Firebase not connected', 'error');
                return;
            }
            
            const testData = { test: true, timestamp: new Date().toISOString() };
            database.ref('test').set(testData)
                .then(() => showNotification('‚úÖ Firebase test successful', 'success'))
                .catch(error => showNotification('‚ùå Firebase test failed: ' + error.message, 'error'));
        }

        function resetToTestData() {
            if (confirm('Reset to demo data? This will delete all current applicants.')) {
                applicants.length = 0;
                applicants.push(...originalTestData);
                botStats = { totalReceived: 0, lastReceived: 'Never', connectionStatus: 'Ready', lastPing: 'Never' };
                saveToLocalStorage();
                refreshUI();
                showNotification('üîÑ Reset to demo data complete', 'success');
            }
        }

        function createChatbot() {
            const name = document.getElementById('chatbot-name').value;
            if (name.trim()) {
                showModal('ü§ñ Chatbot Created', `Chatbot "${name}" created successfully!\n\nThis is a demo feature.`);
                document.getElementById('chatbot-name').value = '';
            }
        }

        // üöÄ INITIALIZATION
        function initializeDashboard() {
            console.log('üöÄ Initializing AI Bootcamp Dashboard with BroadcastChannel');
            
            // Check if this is the expected testbot.html file
            const currentPath = window.location.pathname;
            const isTestbotFile = currentPath.includes('testbot.html');
            
            if (!isTestbotFile) {
                console.log('‚ö†Ô∏è Dashboard not running as testbot.html - bot may not connect');
                setTimeout(() => {
                    showNotification(`‚ö†Ô∏è IMPORTANT: Your bot expects "testbot.html" but this is "${currentPath.split('/').pop()}". Click "üîß Debug Bot" for solutions.`, 'error', 10000);
                }, 3000);
            }
            
            // Initialize BroadcastChannel for cross-tab communication
            initializeBroadcastChannel();
            
            // Load data
            if (!loadFromLocalStorage()) {
                applicants.push(...originalTestData);
                saveToLocalStorage();
                showNotification('üëã Welcome! Demo data loaded.', 'info');
            } else {
                showNotification('üì• Loaded saved data', 'success');
            }
            
            // Initialize Firebase
            initializeFirebase();
            
            // Setup UI
            refreshUI();
            
            // Setup API for bot
            window.addApplicantReport = function(data) {
                console.log('üîó Direct API call:', data);
                const candidateData = extractCandidateData(data);
                if (candidateData.name) addNewApplicant(candidateData);
                return { status: 'success', timestamp: new Date().toISOString() };
            };
            
            // Add verification function for bot
            window.verifyDashboardConnection = function() {
                console.log('üîß Bot verification request received');
                showNotification('‚úÖ Bot verification successful - Dashboard ready!', 'success');
                return {
                    status: 'connected',
                    dashboardReady: true,
                    url: window.location.href,
                    timestamp: new Date().toISOString()
                };
            };
            
            console.log('‚úÖ Dashboard ready for bot integration with BroadcastChannel!');
            console.log(`üìç Dashboard URL: ${window.location.href}`);
            console.log(`üì° BroadcastChannel: bot_channel`);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
