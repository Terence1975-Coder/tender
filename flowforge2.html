<!-- file: flowforge.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Launch Control â€” Business Launch Companion</title>
<meta name="description" content="Checklist/Kanban + Playbook + Repository + Plan & Rollout wizard with Firebase sync and offline fallback."/>

<!-- React 18 UMD + Firebase compat -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<style>
  :root{
    --bg:#0b1020;--card:#0f172a;--text:#e6f0ff;--dim:#a9b6d3;--border:#1f2a44;
    --blue:#3b82f6;--green:#10b981;--purple:#8b5cf6;--red:#ef4444;
    --grad:linear-gradient(135deg,var(--blue),var(--green),var(--purple));
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 800px at 15% -10%,rgba(59,130,246,.18),transparent),
      radial-gradient(1200px 800px at 85% 110%,rgba(139,92,246,.16),transparent),
      #0b1020;
    color:var(--text);
    font:14px/1.5 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  a{color:#cfe1ff}
  .wrap{max-width:1100px;margin:0 auto;padding:14px}
  .header{
    position:sticky;top:0;z-index:5;padding:10px 0 8px;margin-bottom:12px;
    background:linear-gradient(180deg,rgba(11,16,32,.95),rgba(11,16,32,.65) 60%, transparent);
    backdrop-filter: blur(6px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:28px;height:28px;border-radius:8px;background:var(--grad)}
  .title{font-weight:700}
  .nav{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
  .btn{
    all:unset;cursor:pointer;
    padding:8px 12px;border-radius:10px;border:1px solid var(--border);
    background:#0e162b;color:#cfe1ff;display:inline-flex;align-items:center;gap:6px
  }
  .btn.primary{background:var(--grad);border:none;color:#fff}
  .btn.active{background:var(--grad);border:none;color:#fff}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;font-size:12px;border-radius:999px;border:1px solid var(--border);background:#0e162b;color:#cfe1ff}
  .pill.ok{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35)}
  .pill.err{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#ffd0d0}
  .grid{display:grid;grid-template-columns:330px 1fr;gap:16px}
  .card{
    background:linear-gradient(180deg,rgba(16,22,42,.65),rgba(6,12,24,.65));
    border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow)
  }
  .sticky{position:sticky;top:14px}
  .h{margin:0 0 10px;font-size:13px;color:#cfe1ff;letter-spacing:.3px;text-transform:uppercase}
  .muted{color:#a9b6d3;font-size:12px}
  input[type="text"],input[type="email"],textarea,.input,.search{
    width:100%;background:#0e162b;border:1px solid var(--border);border-radius:10px;color:#e6f0ff;padding:10px
  }

  /* Checklist / Kanban */
  .day{border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:12px}
  .task{display:flex;gap:12px;align-items:flex-start;padding:12px;border-top:1px solid var(--border);background:rgba(10,16,32,.35)}
  .task-title{font-weight:600}
  .list{display:grid;gap:6px}
  .sub{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:10px;background:#0b1429;border:1px solid var(--border)}
  .sub input{accent-color:#10b981;width:16px;height:16px}
  .badge{font-size:10px;padding:2px 6px;border-radius:999px;background:#0c1530;border:1px solid var(--border);color:#cfe1ff}
  .kanban{display:flex;gap:12px}
  .col{flex:1;min-height:240px;padding:10px;border-radius:12px;background:#0b1429;border:1px dashed #2a3b63}
  .card-k{border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px;background:#0e162b}

  /* Repo */
  .repo-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .repo-list{display:grid;gap:8px}
  .link{display:flex;gap:8px;align-items:center}
  .code{background:#0a1328;border:1px solid var(--border);border-radius:10px;padding:10px;overflow:auto;white-space:pre-wrap}

  /* --- Plan & Rollout (new) --- */
  .split2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .split2 .left,.split2 .right{display:grid;gap:12px}
  .panel{background:linear-gradient(180deg,rgba(16,22,42,.65),rgba(6,12,24,.65));border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .panel h3{margin:0 0 8px;font-size:14px;color:#cfe1ff;letter-spacing:.2px;text-transform:uppercase}
  .fields{display:grid;grid-template-columns:1fr;gap:8px}
  .field{display:grid;gap:6px}
  .progress-pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;background:#0e162b;border:1px solid var(--border);border-radius:999px;color:#cfe1ff;font-size:12px}
  .mini{font-size:12px;color:#a9b6d3}
  .input-sm{padding:8px;border-radius:10px;background:#0e162b;border:1px solid var(--border);color:#e6f0ff;width:100%}

  .chat{display:flex;flex-direction:column;gap:8px}
  .chat-log{max-height:420px;overflow:auto;border:1px solid var(--border);border-radius:12px;background:#0b1429;padding:10px}
  .msg{display:grid;gap:4px;margin-bottom:8px}
  .msg .role{font-size:11px;color:#cfe1ff;text-transform:uppercase;letter-spacing:.2px}
  .msg.user{background:rgba(59,130,246,.08);border:1px solid rgba(59,130,246,.25);border-radius:10px;padding:8px}
  .msg.assistant{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.25);border-radius:10px;padding:8px}
  .chat-input{display:flex;gap:8px}
  .chat-input textarea{flex:1;min-height:42px;max-height:120px}
  .kbd:focus{outline:2px solid rgba(59,130,246,.6);outline-offset:2px}

  .info{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;background:#0e162b;border:1px solid var(--border);font-size:12px;color:#cfe1ff;cursor:pointer}
  .popover{position:absolute;z-index:10;min-width:260px;max-width:320px;background:#0b1429;border:1px solid var(--border);border-radius:10px;padding:10px;box-shadow:var(--shadow)}
  .popover p{margin:0 0 6px;color:#a9b6d3;font-size:12px}

  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center}
  .dialog{width:min(720px,92vw);background:#0f172a;border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .dialog h4{margin:0 0 8px;font-size:14px;color:#cfe1ff;text-transform:uppercase}
  .dialog .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}

  .footer{margin:24px 0 16px;color:#a9b6d3;text-align:center}
  .error-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);color:#fff;z-index:99999;padding:18px;overflow:auto}
</style>
</head>
<body>
<div class="wrap header">
  <div style="display:flex;gap:12px;align-items:center">
    <div class="logo"></div>
    <div class="title">Launch Control â€” Business Launch Companion</div>
    <div id="progress-pill" class="pill muted" title="Plan completion progress">Plan: 0%</div>
    <div class="nav" id="nav"></div>
  </div>
</div>
<div class="wrap"><div id="root"></div></div>
<div id="err" class="error-overlay"></div>

<script>
/* ---------------- error overlay (why: fast diagnostics) ---------------- */
addEventListener("error", e=>{
  const el=document.getElementById("err");
  el.innerHTML=`<h2>Script error</h2><pre>${(e.error?.stack||"")}</pre><div>${e.message||""}</div>`;
  el.style.display="block";
});

/* ---------------- utils ---------------- */
const h = React.createElement;
const {useState,useEffect,useMemo,useRef} = React;
const deepClone = (v)=>JSON.parse(JSON.stringify(v));
const debounce = (fn,ms=500)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}};
const nowIso=()=>new Date().toISOString();
const slugify=(s,used=new Set())=>{
  let x=(s||"project").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"").slice(0,40)||"project";
  let i=2,base=x; while(used.has(x)) x=`${base}-${i++}`; return x;
};

/* ---------------- seed data ---------------- */
const PLAYBOOK_MD = `# 14-Day Zero-Capex AI Business (Concise)
- Stack: Notion/Carrd â€¢ Tally â€¢ Buttondown â€¢ Stripe/Payhip â€¢ Zapier â€¢ GA â€¢ Spreadsheet CRM
- Guarantees: 1 mini-offer + 5 leads in 14 days (scope-capped)
- Focus: Landing + Lead magnet + Nurture + Checkout + Automations + Dashboard + Legal`;

function makeSeedDays(){
  const mk=(day,title,tasks)=>({day,title,tasks});
  const st=(id,t,subs)=>({id,title:t,desc:"",note:"",subtasks:subs.map((s,i)=>({id:`${id}s${i+1}`,t:s,done:false,status:"backlog"}))});
  return [
    mk(1,"Foundations",[
      st("d1t1","Define ICP & Offer",["ICP notes","Mini-offer outline","Pricing sketch","Competitors list"]),
      st("d1t2","Landing Skeleton",["Headline","Value bullets","Opt-in form","CTA block"])
    ]),
    mk(2,"Assets",[
      st("d2t1","Lead Magnet",["Outline","Draft","Design","Delivery"]),
      st("d2t2","Email Nurture",["3-seq draft","ESP setup","Test send"])
    ]),
    mk(3,"Legal & Ops",[
      st("d3t1","Legal Basics",["Privacy Policy","Terms of Service","Cookie banner"]),
      st("d3t2","Payment",["Stripe/Payhip","Test charge","Invoices"])
    ]),
    mk(4,"Traffic Prep",[
      st("d4t1","Content Pack",["3 posts","2 shorts","1 longform"]),
      st("d4t2","Analytics",["GA tags","UTM sheet","Dashboard"])
    ]),
    mk(5,"Outreach",[
      st("d5t1","Warm DM",["List 25","DM 10","Book 3 calls"]),
      st("d5t2","Community Value",["Answer 5 threads","Save links","Log learnings"])
    ]),
    mk(6,"Soft Launch",[
      st("d6t1","Friction Hunt",["QA flows","Fix blockers","Re-test"]),
      st("d6t2","DFY Upsell",["Scope doc","CTA on hub","Reply templates"])
    ]),
    mk(7,"Public Launch",[
      st("d7t1","Launch Day",["Post threads","Emails","DMs & replies"]),
      st("d7t2","Referral Loop",["2 referrals","Thank-you notes","Plan v1.2"])
    ])
  ];
}

/* ---------------- firebase ---------------- */
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
  authDomain:"prospecting-f2f42.firebaseapp.com",
  databaseURL:"https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId:"prospecting-f2f42",
  storageBucket:"prospecting-f2f42.appspot.com",
  messagingSenderId:"292034226428",
  appId:"1:292034226428:web:878b867e3eb4d3e0098f79",
  measurementId:"G-WWB0JTX2L2"
};
const LS_INDEX="lc-index", LS_ACTIVE="lc-active", LS_PROJECT_PREFIX="lc-project:", LS_PROFILE="lc-profile", LS_MODE="lc-mode";
function ensureFirebase(){
  if(!window.firebase) return {available:false,auth:null,db:null,st:null};
  if(!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
  return {available:true,auth:firebase.auth(),db:firebase.database(),st:firebase.storage()};
}

/* ---------------- Info popover ---------------- */
function InfoIcon({label="Info", text}){
  const [open,setOpen]=useState(false);
  const ref=useRef(null);
  useEffect(()=>{
    const onDoc=(e)=>{ if(open && ref.current && !ref.current.contains(e.target)) setOpen(false); };
    document.addEventListener('mousedown',onDoc);
    return ()=>document.removeEventListener('mousedown',onDoc);
  },[open]);
  return h("span",{ref,style:{position:"relative",display:"inline-flex",alignItems:"center",gap:6}},
    h("span",{className:"info",title:label,tabIndex:0,onClick:()=>setOpen(v=>!v),onKeyDown:(e)=>{if(e.key==="Enter")setOpen(v=>!v);}},"i"),
    open && h("div",{className:"popover",style:{top:22,left:0}}, h("p",null,text))
  );
}

/* ---------------- Plan model ---------------- */
const PLAN_FIELDS_KEYS = [
  "businessName","problem","solution","targetCustomer","marketSize","competitors",
  "differentiation","pricingModel","goToMarket","channels","legalConsiderations",
  "budget","timeline","successMetrics","risks","teamRoles"
];
function defaultPlan(){
  const fields={}; PLAN_FIELDS_KEYS.forEach(k=>fields[k]={value:"",complete:false});
  return { sources:[], fields, chatLog:[], status:"draft" };
}
function ensurePlanShape(p){
  const next = deepClone(p||{});
  next.plan = next.plan && typeof next.plan==="object" ? next.plan : defaultPlan();
  next.plan.sources = Array.isArray(next.plan.sources)? next.plan.sources : [];
  next.plan.fields = next.plan.fields && typeof next.plan.fields==="object" ? next.plan.fields : {};
  PLAN_FIELDS_KEYS.forEach(k=>{
    if(!next.plan.fields[k]) next.plan.fields[k]={value:"",complete:false};
    if(typeof next.plan.fields[k].complete!=="boolean") next.plan.fields[k].complete=!!next.plan.fields[k].value;
  });
  next.plan.chatLog = Array.isArray(next.plan.chatLog)? next.plan.chatLog : [];
  next.plan.status = next.plan.status || "draft";
  return next;
}

/* ---------------- Local mini-model (heuristics) ---------------- */
class LocalLLMProvider{
  id(){return "local-mini";}
  summarize(text="", max=5){
    const s=(text||"").split(/[\.\n]+/).map(x=>x.trim()).filter(Boolean);
    return s.slice(0,max).join(". ") || "No textual content to summarize.";
  }
  followups(fields){
    const prompts={
      businessName:"What's the business name?",
      problem:"What customer problem do you solve?",
      solution:"Briefly describe your solution.",
      targetCustomer:"Who is the target customer?",
      marketSize:"Estimated market size?",
      competitors:"Who are the competitors?",
      differentiation:"What makes you different?",
      pricingModel:"Pricing model (e.g., subscription, one-off, tiers)?",
      goToMarket:"Your go-to-market approach?",
      channels:"Primary channels (e.g., SEO, Ads, Partners)?",
      legalConsiderations:"Any legal/regulatory considerations?",
      budget:"Initial budget and monthly run rate?",
      timeline:"Expected timeline to launch?",
      successMetrics:"Success metrics (KPIs)?",
      risks:"Top 3 risks + mitigations?",
      teamRoles:"Team roles/owners?"
    };
    const missing = PLAN_FIELDS_KEYS.filter(k=>!fields[k]?.complete);
    return missing.map(k=>({field:k,question:prompts[k]}));
  }
  extract(text){
    const hints={}; const T=(k)=>new RegExp(`\\b${k}\\b\\s*[:\\-]\\s*([^\\n\\r]+)`,"i");
    const tryKey=(key,label)=>{ const m=(text||"").match(T(label)); if(m) hints[key]=m[1].trim(); };
    tryKey("businessName","business name");
    tryKey("pricingModel","pricing");
    tryKey("targetCustomer","target customer");
    tryKey("goToMarket","go to market");
    tryKey("channels","channels");
    tryKey("budget","budget");
    tryKey("timeline","timeline");
    tryKey("successMetrics","success metrics");
    return hints;
  }
}

/* ---------------- Cloud LLM (OpenAI-style, opt-in) ---------------- */
class CloudLLMProvider{
  id(){return "cloud-generic";}
  getSettings(){ try{ return JSON.parse(localStorage.getItem("lc-llm-cloud")||"{}"); }catch{return{};} }
  setSettings(s){ localStorage.setItem("lc-llm-cloud", JSON.stringify(s||{})); }
  async invoke(messages, system="You are an assistant that asks only for missing business plan fields, one at a time."){
    const {apiKey, endpoint, model="gpt-4o-mini"} = this.getSettings();
    if(!apiKey || !endpoint) throw new Error("Cloud LLM not configured.");
    const body={model,messages:[{role:"system",content:system},...messages]};
    const res=await fetch(endpoint,{method:"POST",headers:{"Authorization":"Bearer "+apiKey,"Content-Type":"application/json"},body:JSON.stringify(body)});
    if(!res.ok){ const t=await res.text(); throw new Error("Cloud LLM error: "+t.slice(0,200)); }
    const j=await res.json();
    return j.choices?.[0]?.message?.content || "";
  }
}

/* ---------------- Rollout generator ---------------- */
function generateRolloutFromPlan(plan){
  const f=plan.fields;
  const v=(k)=> (f[k]?.value||"TBD").slice(0,140);
  const ref=(plan.sources||[]).map(s=>s.name).join(", ")||"user inputs";
  const tasks = [
    { id:"r1", title:"Validation", subs:[
      "Define hypotheses & success metrics",
      `Pre-launch survey targeting ${v("targetCustomer")}`,
      "Landing smoke test (opt-ins/interest)"] },
    { id:"r2", title:"Brand", subs:[
      `Finalize name: ${v("businessName")}`,
      "Tagline & palette; lightweight logo",
      "Brand/voice guide"]},
    { id:"r3", title:"Legal", subs:[
      `Check legal considerations: ${v("legalConsiderations")}`,
      "Policies (ToS/PP/Cookie); company info",
      "Payment/Tax settings"]},
    { id:"r4", title:"Ops", subs:[
      `Budget: ${v("budget")}`,
      `Timeline: ${v("timeline")}`,
      "Run Log + dashboards"]},
    { id:"r5", title:"Marketing", subs:[
      `Go-to-market: ${v("goToMarket")}`,
      `Channels: ${v("channels")}`,
      "Content pack + schedule"]},
    { id:"r6", title:"Sales", subs:[
      `Pricing model: ${v("pricingModel")}`,
      "Offers page + checkout + receipts",
      "Onboarding & follow-ups"]},
    { id:"r7", title:"Launch", subs:[
      "Soft launch QA",
      "Public launch posts & tracking",
      `Success metrics: ${v("successMetrics")}`]},
  ];
  return {
    day: 0, title: "Rollout",
    tasks: tasks.map(t=>({
      id:t.id, title:t.title, desc:"", note:`Source(s): ${ref}`,
      subtasks: t.subs.map((s,i)=>({id:`${t.id}s${i+1}`,t:s,done:false,status:"backlog"}))
    }))
  };
}

/* ---------------- Plan & Rollout mode ---------------- */
function PlanRolloutMode({project,setProject,uid,fb,active}){
  const [preview,setPreview]=useState(null);
  const [useLocal,setUseLocal]=useState(true);
  const [useCloud,setUseCloud]=useState(false);
  const [awaitingField,setAwaitingField]=useState(null);
  const [input,setInput]=useState("");
  const localLLM=React.useMemo(()=>new LocalLLMProvider(),[]);
  const cloudLLM=React.useMemo(()=>new CloudLLMProvider(),[]);
  const plan=project.plan||defaultPlan();

  const fields = plan.fields;
  const missingKeys = PLAN_FIELDS_KEYS.filter(k=>!fields[k].complete);
  const progress = {done: PLAN_FIELDS_KEYS.length - missingKeys.length, total: PLAN_FIELDS_KEYS.length};
  const percent = Math.round(progress.done*100/Math.max(1,progress.total));

  /* Progress pill update must be an effect (no side-effects in render) */
  useEffect(()=>{
    const pillEl=document.getElementById("progress-pill");
    if(pillEl) pillEl.textContent=`Plan: ${percent}%`;
  },[percent]);

  function updateField(key, value, complete){
    const next=deepClone(project);
    next.plan.fields[key].value=value;
    if(typeof complete==="boolean") next.plan.fields[key].complete=complete;
    setProject(next);
  }
  function markAllComplete(){
    const next=deepClone(project);
    PLAN_FIELDS_KEYS.forEach(k=>{ next.plan.fields[k].complete = !!next.plan.fields[k].value; });
    setProject(next);
  }
  function addChat(role,text){
    const next=deepClone(project);
    next.plan.chatLog.push({id:`c_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,role,text,createdAt:nowIso()});
    setProject(next);
  }

  async function uploadPlanFiles(files){
    const day = "Day 1";
    for(const file of files){
      const safe=file.name.replace(/[^\w\-.]+/g,"_");
      let meta;
      if(uid && fb?.available){
        const path=`users/${uid}/projects/${active}/repo/${day}/${Date.now()}_${safe}`;
        const ref=fb.st.ref().child(path);
        await ref.put(file);
        const url=await ref.getDownloadURL();
        meta={ id:`plan_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, kind:"file",
          day, name:file.name, size:file.size, contentType:file.type||"", storagePath:path,
          downloadURL:url, tags:["business-plan"], notes:"Business plan", createdAt:nowIso()};
      }else{
        const url=URL.createObjectURL(file);
        meta={ id:`plan_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, kind:"file",
          day, name:file.name, size:file.size, contentType:file.type||"", storagePath:"local",
          downloadURL:url, tags:["business-plan"], notes:"Business plan (local)", createdAt:nowIso()};
      }
      const next=deepClone(project);
      next.repo = next.repo || {items:{}};
      next.repo.items = next.repo.items || {};
      next.repo.items[meta.id]=meta;
      next.plan.sources.push({ id:meta.id, kind:"file", name:meta.name, contentType:meta.contentType, downloadURL:meta.downloadURL, createdAt:meta.createdAt, tags:["business-plan"] });
      setProject(next);
      setPreview(meta);
    }
  }

  async function summarizePlan(){
    addChat("assistant","Summarizing uploaded planâ€¦");
    let textBody="";
    for(const s of plan.sources){
      if((s.contentType||"").includes("text") || (s.contentType||"").includes("markdown")){
        try{ const res=await fetch(s.downloadURL); textBody=await res.text(); break; }catch{}
      }
    }
    const summary = useLocal ? localLLM.summarize(textBody) : "Enable Local Mini-Model or Cloud LLM to summarize.";
    addChat("assistant", summary);
  }

  async function askNextMissing(){
    if(missingKeys.length===0){ addChat("assistant","All required fields are complete. Ready to generate the rollout plan."); return; }
    const q = localLLM.followups(fields)[0];
    if(!q){ addChat("assistant","No follow-ups needed."); return; }
    setAwaitingField(q.field);
    addChat("assistant", q.question + " (Reply then click â€œSave Answerâ€.)");
  }

  async function sendMessage(){
    const text=input.trim(); if(!text) return;
    addChat("user",text); setInput("");
    if(awaitingField) return; // wait explicit save

    if(useCloud){
      try{
        const reply = await cloudLLM.invoke(plan.chatLog.map(m=>({role:m.role,content:m.text})).concat([{role:"user",content:text}]));
        addChat("assistant", reply);
      }catch(e){ addChat("assistant","Cloud LLM unavailable: "+e.message); }
      return;
    }
    const hints=localLLM.extract(text);
    const keys=Object.keys(hints);
    if(keys.length){
      addChat("assistant","Detected possible values: "+keys.map(k=>`${k} â†’ â€œ${hints[k]}â€`).join("; ")+" â€” pick a field and Save Answer.");
      setAwaitingField(keys[0]); setInput(hints[keys[0]]);
    }else{
      addChat("assistant","Thanks! Use â€œSave Answerâ€ to map this to a field.");
    }
  }

  function saveAnswerToField(){
    if(!awaitingField){ alert("No active question. Click 'Ask About Missing Fields' or choose a field on the left."); return; }
    const text=input.trim(); if(!text){ alert("Type your answer first."); return; }
    updateField(awaitingField, text, true);
    addChat("assistant", `Saved ${awaitingField}.`);
    setAwaitingField(null); setInput("");
  }

  function clearDraft(){
    if(!confirm("Clear chat & plan draft? This cannot be undone.")) return;
    const next=deepClone(project);
    next.plan = defaultPlan();
    setProject(next);
    setPreview(null);
  }

  function openConfirm(){ const next=deepClone(project); next.plan.status="ready"; setProject(next); }
  function closeConfirm(){ const next=deepClone(project); next.plan.status="draft"; setProject(next); }

  function confirmGenerate(){
    const next=deepClone(project);
    const rollout = generateRolloutFromPlan(next.plan);
    const idx = (next.days||[]).findIndex(d=>d.day===0);
    if(idx>=0) next.days[idx]=rollout; else next.days=[rollout, ...(next.days||[])];
    const summaryLines = PLAN_FIELDS_KEYS.map(k=>`- **${k}**: ${next.plan.fields[k].value||"â€”"}`).join("\n");
    const dataUrl = "data:text/markdown;charset=utf-8,"+encodeURIComponent(`# Rollout Plan Summary\n\n${summaryLines}`);
    next.repo.items = next.repo.items || {};
    next.repo.items[`sum_${Date.now()}`]={ id:`sum_${Date.now()}`, kind:"link", day:"Day 0", name:"Rollout Plan Summary (md)", url:dataUrl, tags:["business-plan","rollout"], notes:"Auto-generated", createdAt:nowIso() };
    next.plan.status="draft";
    setProject(next);
    alert("Rollout plan generated into Checklist/Kanban (Day 0).");
  }

  const cloudSettings = new CloudLLMProvider().getSettings();

  return h("div",{className:"split2"},
    /* Left */
    h("div",{className:"left"},
      h("div",{className:"panel"},
        h("div",{className:"row"}, h("h3",null,"Plan Data"), h("span",{className:"progress-pill"}, `${progress.done}/${progress.total} â€¢ ${percent}%`) ),
        h("div",{className:"fields"},
          PLAN_FIELDS_KEYS.map(k=>h("div",{key:k,className:"field"},
            h("label",{className:"mini"},k),
            h("textarea",{className:"input-sm kbd",rows:2,value:fields[k].value,placeholder:"Enter "+k,onChange:e=>updateField(k,e.target.value)}),
            h("div",{className:"row"},
              h("label",null, h("input",{type:"checkbox",checked:fields[k].complete,onChange:e=>updateField(k,fields[k].value,e.target.checked)})," Mark complete")
            )
          )),
          h("div",{className:"row"}, h("button",{className:"btn",onClick:markAllComplete},"Mark complete where filled"))
        )
      ),
      h("div",{className:"panel"},
        h("div",{className:"row"},
          h("h3",null,"Business Plan Uploader"),
          h(InfoIcon,{text:"Upload .pdf, .docx, .md, or .txt. Stored in Firebase Storage when signed in; otherwise kept locally. Metadata goes into Repository (tag 'business-plan') and Plan Sources."})
        ),
        h("input",{type:"file",accept:".pdf,.docx,.md,.markdown,.txt,text/plain,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document",onChange:e=>{const fs=[...e.target.files]; if(fs.length) uploadPlanFiles(fs); e.target.value="";}}),
        !!preview && h("div",{style:{marginTop:10}},
          h("div",{className:"mini"},"Preview: ", preview.name," â€¢ ",preview.contentType||""),
          (preview.contentType||"").startsWith("image/") && h("img",{src:preview.downloadURL,alt:preview.name,style:{maxWidth:"100%",borderRadius:10,border:"1px solid var(--border)"}}),
          (preview.contentType||"").includes("pdf") && h("iframe",{src:preview.downloadURL,style:{width:"100%",height:"420px",border:"1px solid var(--border)",borderRadius:"10px"}}),
          ((preview.contentType||"").startsWith("text/") || (preview.contentType||"").includes("markdown")) && h("iframe",{src:preview.downloadURL,style:{width:"100%",height:"240px",border:"1px solid var(--border)",borderRadius:"10px"}})
        ),
        h("div",{className:"row",style:{marginTop:8}},
          h("button",{className:"btn",onClick:()=>setPreview(null)},"Clear preview")
        )
      ),
      h("div",{className:"panel"},
        h("div",{className:"row"},
          h("h3",null,"Safety"),
          h(InfoIcon,{text:"â€œClear Chat & Plan Draftâ€ deletes plan fields and chat history from the current project (and remote if syncing)."})
        ),
        h("button",{className:"btn",onClick:clearDraft,style:{borderColor:"rgba(239,68,68,.35)",color:"#ffd0d0"}},"Clear Chat & Plan Draft")
      )
    ),
    /* Right */
    h("div",{className:"right"},
      h("div",{className:"panel"},
        h("div",{className:"row"},
          h("h3",null,"Chat to Complete Plan"),
          h(InfoIcon,{text:"Asks for missing fields only. Local Mini-Model runs in your browser. Cloud LLM uses your endpoint & key (opt-in). Default: nothing is sent to the cloud."})
        ),
        h("div",{className:"row"},
          h("label",null, h("input",{type:"checkbox",checked:useLocal,onChange:()=>setUseLocal(v=>!v)})," Use Local Mini-Model (beta)"),
          h("label",null, h("input",{type:"checkbox",checked:useCloud,onChange:()=>setUseCloud(v=>!v)})," Use Cloud LLM"),
          h(InfoIcon,{text:"Cloud LLM is OpenAI-compatible. Configure below. When enabled, your chat messages will be sent to that provider."})
        ),
        h("div",{className:"row",style:{margin:"6px 0"}},
          h("button",{className:"btn",onClick:summarizePlan},"Summarize Plan"),
          h("button",{className:"btn",onClick:askNextMissing},"Ask About Missing Fields"),
          missingKeys.length===0 && h("button",{className:"btn primary",onClick:openConfirm},"Confirm & Generate")
        ),
        h("div",{className:"chat"},
          h("div",{className:"chat-log",id:"chat-log",role:"log","aria-live":"polite"},
            (plan.chatLog||[]).slice(-200).map(m=>h("div",{key:m.id,className:`msg ${m.role}`},
              h("div",{className:"role"},m.role),
              h("div",null,m.text)
            ))
          ),
          h("div",{className:"chat-input"},
            h("textarea",{className:"input kbd",placeholder: awaitingField?`Answer for: ${awaitingField}`:"Type messageâ€¦",value:input,onChange:e=>setInput(e.target.value),onKeyDown:(e)=>{ if(e.key==="Enter" && (e.ctrlKey||e.metaKey)) sendMessage(); }}),
            h("button",{className:"btn",onClick:sendMessage},"Send"),
            h("button",{className:"btn primary",onClick:saveAnswerToField,disabled:!awaitingField},"Save Answer")
          )
        )
      ),
      h("div",{className:"panel"},
        h("h3",null,"LLM Settings (Cloud, optional)"),
        h("form",{onSubmit:(e)=>{e.preventDefault(); const f=e.target; new CloudLLMProvider().setSettings({endpoint:f.endpoint.value.trim(), apiKey:f.apikey.value.trim(), model:f.model.value.trim()||"gpt-4o-mini"}); alert("Saved.");}},
          h("input",{name:"endpoint",className:"input-sm",placeholder:"API endpoint (OpenAI-compatible)",defaultValue:cloudSettings.endpoint||""}),
          h("input",{name:"apikey",className:"input-sm",placeholder:"API key",defaultValue:cloudSettings.apiKey||""}),
          h("input",{name:"model",className:"input-sm",placeholder:"Model (e.g., gpt-4o-mini)",defaultValue:cloudSettings.model||"gpt-4o-mini"}),
          h("div",{className:"row"}, h("button",{className:"btn primary",type:"submit"},"Save"),
            h(InfoIcon,{text:"Stored only in your browser (localStorage)."})
          )
        )
      )
    ),
    /* Confirm dialog */
    plan.status==="ready" && h("div",{className:"backdrop",role:"dialog","aria-modal":"true"},
      h("div",{className:"dialog"},
        h("h4",null,"Confirm & Generate Rollout Plan"),
        h("div",{className:"mini",style:{marginBottom:10}},"Review assumptions. This will inject a 'Day 0 â€” Rollout' into Checklist/Kanban."),
        h("div",{className:"grid2"},
          h("div",null,
            h("div",{className:"h"},"Assumptions"),
            PLAN_FIELDS_KEYS.map(k=>h("div",{key:k,style:{marginBottom:6}}, h("strong",null,k),": ", fields[k].value||"â€”"))
          ),
          h("div",null,
            h("div",{className:"h"},"Missing"),
            missingKeys.length? h("ul",null, missingKeys.map(k=>h("li",{key:k},k))) : h("div",null,"None ðŸŽ¯")
          )
        ),
        h("div",{className:"row",style:{marginTop:10,justifyContent:"flex-end"}},
          h("button",{className:"btn",onClick:closeConfirm},"Cancel"),
          h("button",{className:"btn primary",onClick:confirmGenerate,disabled:missingKeys.length>0},"Generate Rollout Plan")
        )
      )
    )
  );
}

/* ---------------- Nav & Progress portals ---------------- */
function PortalNav({mode,setMode}){
  const Modes=["Checklist","Playbook","Repository","Plan & Rollout"];
  const navNode = h("div",null, Modes.map(m=>h("button",{key:m,className:`btn ${mode===m?'active':''}`,onClick:()=>setMode(m)},m)));
  const mount=document.getElementById("nav");
  return mount? ReactDOM.createPortal(navNode, mount) : null;
}
function PortalProgress({percent}){
  const node = h("span",null); // placeholder (progress text set by PlanRolloutMode effect too)
  return ReactDOM.createPortal(node, document.getElementById("progress-pill")||document.body);
}

/* ---------------- App ---------------- */
function App(){
  const fb = ensureFirebase();
  const [uid,setUid]=useState(null);
  const [authErr,setAuthErr]=useState("");
  useEffect(()=>{
    if(!fb.available) return;
    fb.auth.signInAnonymously().then(cred=>setUid(cred.user.uid)).catch(e=>setAuthErr(e.message||"Auth error"));
  },[]);

  const [index,setIndex]=useState(()=> JSON.parse(localStorage.getItem(LS_INDEX)||"{}") || {});
  const [active,setActive]=useState(()=> localStorage.getItem(LS_ACTIVE) || "");
  const [project,setProject]=useState(null);
  const [mode,setMode]=useState(()=> localStorage.getItem(LS_MODE) || "Checklist");

  useEffect(()=>localStorage.setItem(LS_INDEX,JSON.stringify(index||{})),[index]);
  useEffect(()=>localStorage.setItem(LS_ACTIVE,active||""),[active]);
  useEffect(()=>localStorage.setItem(LS_MODE,mode||"Checklist"),[mode]);

  useEffect(()=>{
    (async function init(){
      if(!active){
        const slug=slugify("My Project", new Set(Object.keys(index)));
        const idx={...index,[slug]:"My Project"}; setIndex(idx); setActive(slug);
        const proj={slug,name:"My Project",days:makeSeedDays(),repo:{items:{}}};
        setProject(ensurePlanShape(proj));
        if(uid&&fb.available){ await fb.db.ref(`users/${uid}/projects/${slug}`).set(proj); await fb.db.ref(`users/${uid}/index`).set(idx); }
      }else{
        if(uid&&fb.available){
          const snap=await fb.db.ref(`users/${uid}/projects/${active}`).get();
          if(snap.exists()) setProject(ensurePlanShape(snap.val()));
          else{
            const proj={slug:active,name:index[active]||"Project",days:makeSeedDays(),repo:{items:{}}};
            setProject(ensurePlanShape(proj));
            await fb.db.ref(`users/${uid}/projects/${active}`).set(proj);
          }
        }else{
          const local = JSON.parse(localStorage.getItem(LS_PROJECT_PREFIX+active)||"null");
          if(local) setProject(ensurePlanShape(local));
          else{
            const proj={slug:active,name:index[active]||"Project",days:makeSeedDays(),repo:{items:{}}};
            setProject(ensurePlanShape(proj));
          }
        }
      }
    })();
  // eslint-disable-next-line
  },[uid,active]);

  const saveRemote = React.useMemo(()=>debounce(async (uid,slug,proj)=>{
    if(!uid || !fb.available) return;
    await fb.db.ref(`users/${uid}/projects/${slug}`).set(proj);
  },600),[]);
  useEffect(()=>{
    if(!project || !active) return;
    localStorage.setItem(LS_PROJECT_PREFIX+active, JSON.stringify(project));
    if(uid&&fb.available) saveRemote(uid,active,project);
  },[project,active,uid]);

  /* Repository UI state */
  const [repoDay,setRepoDay]=useState("All");
  const [repoFilter,setRepoFilter]=useState("All");
  const [repoSearch,setRepoSearch]=useState("");
  const [repoPreview,setRepoPreview]=useState(null);

  async function uploadFiles(files){
    if(!project) return;
    const day = repoDay==="All" ? "Unsorted" : repoDay;
    for(const file of files){
      const safe=file.name.replace(/[^\w\-.]+/g,"_");
      let meta;
      if(uid && fb.available){
        const path=`users/${uid}/projects/${active}/repo/${day}/${Date.now()}_${safe}`;
        const ref=fb.st.ref().child(path);
        await ref.put(file);
        const url=await ref.getDownloadURL();
        meta={ id:`f_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, kind:"file", day, name:file.name, size:file.size, contentType:file.type||"", storagePath:path, downloadURL:url, tags:[], notes:"", createdAt:nowIso()};
      }else{
        const url=URL.createObjectURL(file);
        meta={ id:`f_${Date.now()}_${Math.random().toString(36).slice(2,7)}`, kind:"file", day, name:file.name, size:file.size, contentType:file.type||"", storagePath:"local", downloadURL:url, tags:[], notes:"", createdAt:nowIso()};
      }
      const next=deepClone(project);
      next.repo.items = next.repo.items || {};
      next.repo.items[meta.id]=meta;
      setProject(next);
      setRepoPreview(meta);
    }
  }

  /* Checklist helpers */
  function toggleSub(di,ti,si){
    const next=deepClone(project); const s=next.days[di].tasks[ti].subtasks[si];
    s.done=!s.done; s.status = s.done ? "done" : (s.status==="done"?"backlog":s.status||"backlog"); setProject(next);
  }
  function setNote(di,ti,text){ const next=deepClone(project); next.days[di].tasks[ti].note=text; setProject(next); }

  const total=useMemo(()=>{ let sub=0,done=0; for(const d of project?.days||[]){ for(const t of d.tasks){ for(const s of t.subtasks){ sub++; if(s.done) done++; }}} return {sub,done,pct: sub? Math.round(done*100/sub):0}; },[project]);

  if(!project) return h("div",null,"Loading projectâ€¦");
  if(authErr) return h("div",{className:"pill err"},"Auth: ",authErr);

  /* local UI states for Checklist */
  const [dayView,setDayView]=useState("List");
  const [currentDayIdx,setCurrentDayIdx]=useState(0);

  function renderDayList(d,di){
    return h("div",{className:"day"},
      h("div",{style:{padding:12}}, h("div",{className:"h"}, `${d.title} (Day ${d.day})`) ),
      d.tasks.map((t,ti)=>h("div",{key:t.id,className:"task"},
        h("div",null,
          h("div",{className:"task-title"},t.title," ",h("span",{className:"badge"},(t.subtasks||[]).filter(s=>s.done).length,"/",(t.subtasks||[]).length)),
          h("div",{className:"muted"},t.desc||""),
          h("div",{className:"list"},
            (t.subtasks||[]).map((s,si)=>h("label",{key:s.id,className:"sub"},
              h("input",{type:"checkbox",checked:s.done,onChange:()=>toggleSub(di,ti,si)}),
              s.t, " ", h("span",{className:"badge"}, s.status||"backlog")
            ))
          ),
          h("div",{className:"muted",style:{marginTop:6}}, "Note"),
          h("textarea",{className:"input",rows:2,value:t.note||"",placeholder:"task notesâ€¦",onChange:e=>setNote(di,ti,e.target.value)})
        )
      ))
    );
  }

  const [dragRef,setDragRef]=useState(null);
  function onDragStart(e,meta){ e.dataTransfer.setData("text/plain",JSON.stringify(meta)); setDragRef(meta); }
  function onDrop(e,newStatus){
    e.preventDefault(); let meta; try{ meta=JSON.parse(e.dataTransfer.getData("text/plain")||"null"); }catch{ return; }
    const next=deepClone(project); const s=next.days[meta.di].tasks[meta.ti].subtasks[meta.si]; s.status=newStatus; s.done=(newStatus==="done"); setProject(next); setDragRef(null);
  }
  function renderDayKanban(d,di){
    const cards=[]; d.tasks.forEach((t,ti)=> (t.subtasks||[]).forEach((s,si)=>cards.push({di,ti,si,s,taskTitle:t.title})));
    const cols={backlog:[],doing:[],done:[]}; cards.forEach(c=>cols[c.s.status|| (c.s.done?'done':'backlog')].push(c));
    function Col({status,label}){ return h("div",{className:"col",onDragOver:(e)=>e.preventDefault(),onDrop:(e)=>onDrop(e,status)},
      h("h4",null,`${label} (${cols[status].length})`),
      cols[status].map(c=>h("div",{key:c.s.id,className:"card-k",draggable:true,onDragStart:(e)=>onDragStart(e,{di:c.di,ti:c.ti,si:c.si})},
        h("div",{style:{fontWeight:600}},c.s.t),
        h("div",{className:"muted",style:{fontSize:"11px"}},d.title," â€” ",c.taskTitle),
        h("div",{style:{marginTop:6,display:"flex",gap:6}},
          h("button",{className:"btn",onClick:()=>onDrop({preventDefault:()=>{},dataTransfer:{getData:()=>JSON.stringify({di:c.di,ti:c.ti,si:c.si})}},"backlog")},"Backlog"),
          h("button",{className:"btn",onClick:()=>onDrop({preventDefault:()=>{},dataTransfer:{getData:()=>JSON.stringify({di:c.di,ti:c.ti,si:c.si})}},"doing")},"Doing"),
          h("button",{className:"btn primary",onClick:()=>onDrop({preventDefault:()=>{},dataTransfer:{getData:()=>JSON.stringify({di:c.di,ti:c.ti,si:c.si})}},"done")},"Done")
        )
      ))
    );}
    return h("div",{className:"card"}, h("div",{className:"h"},`${d.title} â€” Kanban`),
      h("div",{className:"kanban"},
        h(Col,{status:"backlog",label:"Backlog"}),
        h(Col,{status:"doing",label:"Doing"}),
        h(Col,{status:"done",label:"Done"})
      )
    );
  }

  /* Repo view */
  function RepoView(){
    return h("div",{className:"grid"},
      h("aside",{className:"card sticky"},
        h("div",{className:"h"},"Upload files"),
        h("input",{type:"file",multiple:true,style:{marginBottom:8},onChange:e=>{const files=[...e.target.files]; if(files.length) uploadFiles(files); e.target.value="";}}),
        h("div",{className:"h",style:{marginTop:12}},"Add link"),
        h("input",{type:"text",className:"input",placeholder:"https://â€¦",id:"link-url"}),
        h("input",{type:"text",className:"input",placeholder:"Title (optional)",style:{marginTop:8},id:"link-title"}),
        h("button",{className:"btn primary",style:{marginTop:8},onClick:()=>{
          const url=document.getElementById('link-url').value.trim(); if(!url) return;
          const title=document.getElementById('link-title').value.trim()||url;
          const meta={ id:`l_${Date.now()}`, kind:"link", day: repoDay==="All"?"Unsorted":repoDay, name:title, url, tags:[], notes:"", createdAt:nowIso()};
          const next=deepClone(project); next.repo.items = next.repo.items || {}; next.repo.items[meta.id]=meta; setProject(next);
          document.getElementById('link-url').value=""; document.getElementById('link-title').value="";
        }},"Save link"),
        h("div",{className:"h",style:{marginTop:12}},"Search & Filter"),
        h("input",{className:"input",placeholder:"Search in name/typeâ€¦",value:repoSearch,onChange:e=>setRepoSearch(e.target.value)}),
        h("div",{style:{display:"flex",gap:6,marginTop:8,flexWrap:"wrap"}},
          ["All","Docs","Images","Links"].map(x=>h("button",{key:x,className:`btn ${repoFilter===x?'active':''}`,onClick:()=>setRepoFilter(x)},x))
        ),
        h("div",{className:"h",style:{marginTop:12}},"Firebase Setup"),
        h("div",{className:"code"},"Auth â†’ enable Anonymous.\nDB Rules â†’ per-user read/write on /users/{uid}/â€¦\nStorage Rules â†’ per-user folders.\nOffline fallback: localStorage/Object URLs.")
      ),
      h("main",null,
        h("div",{className:"repo-toolbar"},
          h("span",{className:"muted"},"Filter by day:"),
          h("select",{className:"input",style:{width:180},value:repoDay,onChange:e=>{setRepoDay(e.target.value); setRepoPreview(null);}},
            ["All",...new Set(Object.values(project.repo.items||{}).map(i=>i.day||"Unsorted"))].map(d=>h("option",{key:d,value:d},d))
          ),
          h("div",{style:{marginLeft:"auto"}}, repoPreview && h("span",{className:"badge"},"Preview: ",repoPreview.name))
        ),
        h("div",{className:"repo-list"},
          Object.values(project.repo.items||{})
            .filter(i=>repoDay==="All"||i.day===repoDay)
            .filter(i=>{
              if(repoFilter==="Docs") return (i.contentType||"").includes("pdf")||(i.contentType||"").includes("msword")||(i.contentType||"").includes("text")||(i.name||"").match(/\.(pdf|docx?|md|txt)$/i);
              if(repoFilter==="Images") return (i.contentType||"").startsWith("image/");
              if(repoFilter==="Links") return i.kind==="link";
              return true;
            })
            .filter(i=>(i.name||"").toLowerCase().includes(repoSearch.toLowerCase()))
            .sort((a,b)=> (a.createdAt>b.createdAt?-1:1))
            .map(i=>h("div",{key:i.id,className:"card"},
              h("div",{className:"link"},
                h("div",{className:"badge"}, i.kind==="file"?"File":"Link"),
                h("div",{style:{fontWeight:600}}, i.name),
                h("div",{className:"muted"},"â€¢ ", i.day||"Unsorted"," â€¢ ", (i.contentType||i.url||"").slice(0,60))
              ),
              i.kind==="file" && ((i.contentType||"").startsWith("image/") ? h("img",{src:i.downloadURL,alt:i.name,style:{maxWidth:"100%",borderRadius:10,border:"1px solid var(--border)",marginTop:8}})
                  : (i.contentType||"").includes("pdf") ? h("iframe",{src:i.downloadURL,style:{width:"100%",height:"320px",border:"1px solid var(--border)",borderRadius:"10px",marginTop:8}})
                  : ((i.contentType||"").startsWith("text/") || (i.contentType||"").includes("markdown")) ? h("iframe",{src:i.downloadURL,style:{width:"100%",height:"200px",border:"1px solid var(--border)",borderRadius:"10px",marginTop:8}}) : null),
              i.kind==="link" && h("div",{className:"row",style:{marginTop:8}},
                h("a",{href:i.url,target:"_blank",rel:"noopener",className:"btn"},"Open"),
                h("button",{className:"btn",onClick:()=>setRepoPreview(i)},"Preview (if embeddable)")
              )
            ))
        )
      )
    );
  }

  /* Main */
  return h("div",null,
    h(PortalNav,{mode,setMode}),
    h(PortalProgress,{percent:0}),
    h("div",{className:"row",style:{marginBottom:10}},
      h("span",{className:"pill ok"},"Progress: ", total.done,"/",total.sub," â€¢ ",total.pct,"%"),
      h("span",{className:"muted"},"Project: ", project.name),
      h("span",{className:"muted"}," | Mode: ", mode),
      h("span",null, h(InfoIcon,{text:"Modes: Checklist (List/Kanban), Playbook (notes), Repository (files & links), Plan & Rollout (wizard+chat+generator)."}))
    ),

    mode==="Checklist" && h("div",null,
      h("div",{className:"row",style:{marginBottom:8}},
        ["List","Kanban"].map(v=>h("button",{key:v,className:`btn ${dayView===v?'active':''}`,onClick:()=>setDayView(v)},v)),
        h("div",{style:{marginLeft:"auto"}}, h("span",{className:"muted"},"View: "), dayView)
      ),
      h("div",{className:"row",style:{marginBottom:8}},
        project.days.map((d,i)=>h("button",{key:d.day,className:`btn ${currentDayIdx===i?'active':''}`,onClick:()=>setCurrentDayIdx(i)},`Day ${d.day}`))
      ),
      dayView==='List' ? renderDayList(project.days[currentDayIdx], currentDayIdx)
                        : renderDayKanban(project.days[currentDayIdx], currentDayIdx)
    ),

    mode==="Playbook" && h("div",{className:"card"},
      h("div",{className:"h"},"Playbook"),
      h("div",{className:"muted"},"Reference playbook (editable)."),
      h("textarea",{className:"input",rows:16,defaultValue:PLAYBOOK_MD,onChange:e=>{/* local only */}})
    ),

    mode==="Repository" && h(RepoView,null),

    mode==="Plan & Rollout" && h(PlanRolloutMode,{project,setProject,uid,fb,active}),

    h("div",{className:"footer"},"Dashboard (v0): KPI tiles later â€” Leads | Checkouts | MRR | Churn | List size | UGC | Reviews")
  );
}

/* ---------------- mount ---------------- */
ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));

/* ---------------- cache-bust for GH Pages ---------------- */
(function(){ if(!location.search.includes("v=")){ const v=Date.now().toString(36); history.replaceState(null,"",location.pathname+"?v="+v); } })();
</script>
</body>
</html>
