<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Readiness-Assessment Canvas</title>
<style>
  :root{
    --bg:#0b1020; --card:#111831; --muted:#a8b3cf; --ink:#e9efff;
    --accent:#5eead4; --accent2:#60a5fa; --ok:#34d399; --warn:#f59e0b; --bad:#fb7185;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1d,#0b1020 60%,#0b1020);color:var(--ink);
       font:16px/1.45 system-ui,-apple-system,"Segoe UI",Inter,Roboto,"Helvetica Neue",Arial}
  .app{max-width:1200px;margin:28px auto;padding:0 16px 56px}
  header.appbar{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(10px)}
  .bar{display:flex;align-items:center;gap:12px;background:rgba(9,14,30,.7);
       border:1px solid rgba(255,255,255,.06);padding:10px 12px;border-radius:14px}
  .logo{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));
        display:grid;place-items:center;font-weight:800;color:#08121c}
  .title{font-size:18px;font-weight:700}
  .muted{color:var(--muted)} .spacer{flex:1}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.12);background:#0f1730;color:var(--ink);
       padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer;transition:.18s}
  .btn:hover{transform:translateY(-1px);border-color:rgba(255,255,255,.2)}
  .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#08121c;border-color:transparent}
  .btn.small{padding:6px 10px;font-size:14px}
  .grid{display:grid;gap:16px;grid-template-columns:330px 1fr;margin-top:16px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;
        box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .panel-title{font-size:14px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:10px}
  .stack{display:grid;gap:10px}
  label.lab{font-weight:600;display:block;margin-bottom:6px}
  input[type="text"],input[type="date"],textarea{width:100%;background:#0b1230;color:var(--ink);
        border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;outline:none}
  input:focus,textarea:focus{border-color:var(--accent2);box-shadow:0 0 0 3px rgba(96,165,250,.15)}
  textarea{min-height:90px;resize:vertical}
  .row{display:grid;gap:12px;grid-template-columns:1fr;margin-bottom:12px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 9px;border-radius:999px;background:#0c1536;
        border:1px solid rgba(255,255,255,.12);cursor:pointer;user-select:none}
  .chip input{accent-color:var(--accent2)}
  .kpi{display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;background:#0e1740;border:1px dashed rgba(255,255,255,.15)}
  .ring{width:120px;height:120px;border-radius:50%;display:grid;place-items:center;position:relative}
  .ring::after{content:"";position:absolute;inset:8px;background:var(--card);border-radius:50%;border:1px solid rgba(255,255,255,.08)}
  .ring .val{position:relative;font-size:22px;font-weight:800}
  .tag{font-size:12px;text-transform:uppercase;letter-spacing:.12em;padding:6px 8px;border-radius:999px;
       background:#0a132f;color:var(--muted);border:1px solid rgba(255,255,255,.12)}
  .tag.ok{color:#072;background:rgba(52,211,153,.15);border-color:rgba(52,211,153,.25)}
  .tag.warn{color:#6a3a00;background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.25)}
  .tag.bad{color:#5f0d1a;background:rgba(251,113,133,.18);border-color:rgba(251,113,133,.25)}
  .list{display:grid;gap:8px}
  .li{display:grid;grid-template-columns:1fr 170px 140px 36px;gap:8px;align-items:center}
  .li .x{display:grid;place-items:center;height:38px;border-radius:10px;background:#0b1230;border:1px solid rgba(255,255,255,.12);cursor:pointer}
  .footnote{color:var(--muted);font-size:12px}

  /* Roadmap */
  .roadmap-header{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .phase-bar{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
  .phase{background:#0e1740;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:10px;min-height:180px;color:var(--ink)}
  .phase-title{display:flex;align-items:center;gap:6px;font-weight:700;margin-bottom:8px;color:var(--ink)}
  .phase-title input{background:transparent;border:1px dashed rgba(255,255,255,.2);border-radius:8px;padding:6px 8px;color:var(--ink)}
  .item{background:#0b1230;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px;margin-bottom:8px;cursor:grab;color:var(--ink)}
  .item [contenteditable], .item input{color:var(--ink)}
  .item:active{cursor:grabbing}
  .ghost{opacity:.4;border:1px dashed rgba(255,255,255,.35)}
  .drop-hint{border:1px dashed rgba(255,255,255,.35);border-radius:10px;height:38px;margin:6px 0}

  /* Sketch board (Miro-lite) */
  .board-wrap{background:#0e1740;border:1px solid rgba(255,255,255,.12);border-radius:14px}
  .tools{display:flex;gap:8px;align-items:center;padding:8px;border-bottom:1px solid rgba(255,255,255,.08);flex-wrap:wrap}
  .tools .btn{background:#0b1230}
  .tools input[type="color"]{width:36px;height:36px;border:none;background:transparent}
  .canvas-area{position:relative}
  canvas#board{width:100%;height:420px;display:block;border-bottom-left-radius:14px;border-bottom-right-radius:14px;background:
    repeating-linear-gradient(0deg, #0f1633 0 24px, #111a3a 24px 25px),
    repeating-linear-gradient(90deg, #0f1633 0 24px, #111a3a 24px 25px);}
  /* Editable, draggable sticky notes */
  .sticky{
    position:absolute; min-width:180px; max-width:280px; padding:10px 12px; border-radius:10px;
    background:rgba(255,251,210,.95); color:#222; border:1px solid rgba(0,0,0,.25);
    box-shadow:0 6px 20px rgba(0,0,0,.3); cursor:move; user-select:none;
  }
  .sticky[contenteditable="true"]{cursor:text}
  .sticky:focus{outline:2px solid rgba(0,0,0,.25)}
  .sticky .bar{background:transparent;border:none;padding:0;margin:0;gap:8px}
  .sticky .bar .handle{font-weight:700;color:#555;cursor:move}
  .sticky .close{margin-left:auto}
  #boardPrint{display:none}

  .pdf-embed{width:100%;height:500px;border:1px solid rgba(255,255,255,.12);border-radius:12px}

  @media print{
    header.appbar,.no-print{display:none !important}
    body{background:#fff;color:#000}
    .app{max-width:none;padding:0}
    .card{box-shadow:none;border:1px solid #ddd;color:#000}
    input,textarea{border:1px solid #999 !important;color:#000 !important;background:#fff !important}
    .tag.ok,.tag.warn,.tag.bad{border-color:#999 !important;background:#fff !important;color:#000 !important}
    canvas#board{display:none}
    #boardPrint{display:block; width:100%; height:auto; border:1px solid #999; border-radius:8px}
    @page{size:A4;margin:12mm}
  }
  @media (max-width:1000px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="bar">
      <div class="logo">RC</div>
      <div class="title">Readiness-Assessment Canvas</div>
      <div class="muted">One per team — fill, sketch, roadmap, and export</div>
      <div class="spacer"></div>
      <button class="btn ghost small no-print" id="newCanvasBtn">New</button>
      <button class="btn small no-print" id="saveBtn">Save</button>
      <button class="btn small no-print" id="loadBtn">Load</button>
      <button class="btn small no-print" id="exportBtn">Export JSON</button>
      <label class="btn small no-print" for="importFile" style="cursor:pointer">Import</label>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button class="btn primary no-print" id="pdfBtn">Download PDF</button>
    </div>
  </header>

  <section class="grid">
    <!-- Left column -->
    <div class="card">
      <div class="panel-title">Team & Session</div>
      <div class="stack">
        <div class="row"><label class="lab">Team / Project</label><input type="text" id="team" placeholder="e.g., Data Platform Team" /></div>
        <div class="row"><label class="lab">Facilitator</label><input type="text" id="facilitator" placeholder="e.g., Jane Doe" /></div>
        <div class="row"><label class="lab">Date</label><input type="date" id="date" /></div>

        <div class="row kpi">
          <div class="ring" id="ring"><div class="val" id="score">0%</div></div>
          <div>
            <div class="panel-title" style="margin:0">Readiness Index</div>
            <div style="font-size:14px" id="readinessText">Complete the sections to calculate readiness.</div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <span class="tag" id="statusTag">—</span>
              <span class="tag">Autosaves</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column -->
    <div class="card">
      <div class="panel-title">Readiness-Assessment Canvas</div>
      <div id="sections"></div>
      <div class="row">
        <label class="lab">7) Confidence Level: <span id="confVal">5</span>/10</label>
        <input type="range" id="confidence" min="0" max="10" value="5" />
      </div>
    </div>
  </section>

  <!-- Roadmap Template -->
  <section class="card" style="margin-top:16px">
    <div class="panel-title">Phased Roadmap Template</div>
    <div class="roadmap-header">
      <label class="lab" style="margin:0">Roadmap Name</label>
      <input type="text" id="roadmapName" placeholder="e.g., Q1–Q3 Delivery Roadmap" style="max-width:360px" />
      <button class="btn small no-print" id="addPhaseBtn">Add Phase</button>
      <button class="btn small no-print" id="addItemBtn">New Item</button>
      <span class="muted">Drag items between phases</span>
    </div>
    <div id="phaseBar" class="phase-bar"></div>
  </section>

  <!-- Actions & Sign-off -->
  <section class="card" style="margin-top:16px">
    <div class="panel-title">Actions Before Starting</div>
    <div class="row">
      <div class="list" id="actionList"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap" class="no-print">
        <input type="text" id="actionInput" placeholder="Add action item..." />
        <input type="text" id="actionOwner" placeholder="Owner" />
        <input type="date" id="actionDate" />
        <button class="btn small" id="addAction">Add</button>
      </div>
    </div>
  </section>

  <!-- Miro-style Sketch Board + PDF -->
  <section class="card" style="margin-top:16px">
    <div class="panel-title">Overall Notes — Sketch Board (Miro-style)</div>
    <div class="board-wrap">
      <div class="tools no-print">
        <button class="btn small" data-tool="pen">Pen</button>
        <button class="btn small" data-tool="eraser">Eraser</button>
        <button class="btn small" id="noteTool">Sticky Note</button>
        <label class="muted">Color</label><input type="color" id="color" value="#ffffff" />
        <label class="muted">Size</label><input type="range" id="size" min="2" max="24" value="4" />
        <button class="btn small" id="undoBtn">Undo</button>
        <button class="btn small" id="redoBtn">Redo</button>
        <button class="btn small" id="clearBoard">Clear</button>
        <button class="btn small" id="downloadPng">Export PNG</button>
      </div>
      <div class="canvas-area" id="canvasArea">
        <canvas id="board" width="1200" height="420" aria-label="Sketch board"></canvas>
        <img id="boardPrint" alt="Sketchboard snapshot for print"/>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div style="display:grid;gap:8px" class="no-print">
        <label class="lab">Attach PDF (optional)</label>
        <input type="file" id="pdfInput" accept="application/pdf" />
        <label class="lab" style="margin-top:6px">Miro Board Link (optional)</label>
        <input type="text" id="miroLink" placeholder="https://miro.com/app/board/..." />
      </div>
      <div id="pdfViewerWrap" style="margin-top:12px;display:none">
        <object id="pdfViewer" class="pdf-embed" type="application/pdf"></object>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:16px">
    <div class="panel-title">Stakeholders & Sign-off</div>
    <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div><label class="lab">Team Representative</label><input type="text" id="rep" placeholder="Full name" /></div>
      <div><label class="lab">Sponsor / Product Owner</label><input type="text" id="sponsor" placeholder="Full name" /></div>
    </div>
  </section>

  <p class="footnote no-print" style="text-align:center;margin-top:14px">
    “Download PDF” composites the sketch board to an image so it appears in the PDF. Page is formatted for A4.
  </p>
</div>

<script>
/* ========= Base form + readiness scoring ========= */
const SECTION_DEFS = [
  { id:'vision',   title:'1) Vision & Alignment', q:'Shared understanding of goals?' },
  { id:'skills',   title:'2) Skills & Capabilities', q:'Right mix of skills on the team?' },
  { id:'tools',    title:'3) Tools & Infrastructure', q:'Environments, access & data in place?' },
  { id:'stake',    title:'4) Stakeholder Support', q:'Stakeholders understand & back this?' },
  { id:'process',  title:'5) Processes & Ways of Working', q:'Roles, responsibilities, decisions clear?' },
  { id:'risks',    title:'6) Risks & Dependencies', q:'Risks/dependencies mapped & managed?' },
];
const RADIO_VALS = { yes:2, partial:1, no:0 };
const $ = id=>document.getElementById(id);
const els = {
  sections: $('sections'), ring:$('ring'), score:$('score'), readinessText:$('readinessText'), statusTag:$('statusTag'),
  team:$('team'), facilitator:$('facilitator'), date:$('date'),
  confidence:$('confidence'), confVal:$('confVal'),
  actionInput:$('actionInput'), actionOwner:$('actionOwner'), actionDate:$('actionDate'), actionList:$('actionList'),
  rep:$('rep'), sponsor:$('sponsor'),
  roadmapName:$('roadmapName'), phaseBar:$('phaseBar'), addPhaseBtn:$('addPhaseBtn'), addItemBtn:$('addItemBtn'),
  pdfBtn:$('pdfBtn'), saveBtn:$('saveBtn'), loadBtn:$('loadBtn'), exportBtn:$('exportBtn'), importFile:$('importFile'), newCanvasBtn:$('newCanvasBtn'),
  // sketch board & notes
  board:$('board'), canvasArea:$('canvasArea'), color:$('color'), size:$('size'), undoBtn:$('undoBtn'), redoBtn:$('redoBtn'), clearBoard:$('clearBoard'), noteTool:$('noteTool'),
  pdfInput:$('pdfInput'), pdfViewer:$('pdfViewer'), pdfWrap:$('pdfViewerWrap'), miroLink:$('miroLink'),
  boardPrint:$('boardPrint')
};
function sectionMarkup(def){
  return `
    <div class="row card" style="padding:14px">
      <div class="lab" style="margin-bottom:10px">${def.title}</div>
      <div class="chip"><input type="radio" name="${def.id}-rad" value="yes"> Yes</div>
      <div class="chip"><input type="radio" name="${def.id}-rad" value="partial"> Partially</div>
      <div class="chip"><input type="radio" name="${def.id}-rad" value="no"> No</div>
      <div class="row"><label class="lab" for="${def.id}-notes">Notes</label>
        <textarea id="${def.id}-notes" placeholder="Context, gaps, evidence…"></textarea></div>
    </div>`;
}
els.sections.innerHTML = SECTION_DEFS.map(sectionMarkup).join("");

/* ========= Readiness score ========= */
function computeScore(){
  let earned=0, answered=0;
  SECTION_DEFS.forEach(def=>{
    const ch = document.querySelector(`input[name="${def.id}-rad"]:checked`);
    if(ch){ answered++; earned += RADIO_VALS[ch.value]; }
  });
  const base = answered ? (earned/(2*answered)) : 0;
  const conf = +els.confidence.value/10;
  const pct = Math.round((base*0.7 + conf*0.3)*100);
  updateRing(pct, answered);
}
function updateRing(pct, answered){
  els.score.textContent = `${pct}%`;
  let s='—', cls='';
  if(answered===0){s='Incomplete'}
  else if(pct>=75){s='Ready';cls='ok'}
  else if(pct>=55){s='Almost';cls='warn'}
  else {s='Not Ready';cls='bad'}
  els.statusTag.textContent=s; els.statusTag.className='tag ' + (cls||'');
  els.readinessText.textContent = answered===SECTION_DEFS.length ? 'All checks completed — review and export.' : `Complete all checks (${answered}/${SECTION_DEFS.length}).`;
  const okdeg = Math.min(360*(pct/100),360);
  els.ring.style.background = `conic-gradient(var(--ok) 0deg ${okdeg}deg, #263353 ${okdeg}deg 360deg)`;
}
document.addEventListener('change', e=>{ if(e.target.matches('input[type="radio"]')){computeScore(); autoSave();}});
els.confidence.addEventListener('input', ()=>{ $('confVal').textContent=els.confidence.value; computeScore(); autoSave();});

/* ========= Actions (now with date) ========= */
function addActionRow(item={text:'',owner:'',date:''}){
  const wrap=document.createElement('div'); wrap.className='li';
  wrap.innerHTML=`<input type="text" placeholder="Action" value="${item.text||''}">
                  <input type="text" placeholder="Owner" value="${item.owner||''}">
                  <input type="date" value="${item.date||''}">
                  <div class="x" title="Remove">✕</div>`;
  wrap.querySelector('.x').onclick=()=>{wrap.remove();autoSave();};
  wrap.querySelectorAll('input').forEach(i=>i.oninput=autoSave);
  els.actionList.appendChild(wrap);
}
$('addAction').addEventListener('click', ()=>{
  const text=els.actionInput.value.trim(), owner=els.actionOwner.value.trim(), date=els.actionDate.value;
  if(!text && !owner && !date) return;
  addActionRow({text, owner, date}); els.actionInput.value=''; els.actionOwner.value=''; els.actionDate.value=''; autoSave();
});
function getActions(){
  return Array.from(els.actionList.querySelectorAll('.li')).map(li=>{
    const [a,b,c]=li.querySelectorAll('input'); return {text:a.value.trim(), owner:b.value.trim(), date:c.value};
  }).filter(x=>x.text||x.owner||x.date);
}

/* ========= Roadmap (phases + drag) ========= */
let phases = [
  { id: uid('p1'), name:'Phase 1 — Discover', items:[] },
  { id: uid('p2'), name:'Phase 2 — Build', items:[] },
  { id: uid('p3'), name:'Phase 3 — Release', items:[] },
];
function uid(prefix){ return prefix + Math.random().toString(36).slice(2,9); }
function renderPhases(){
  els.phaseBar.innerHTML='';
  phases.forEach(ph=>{
    const el=document.createElement('div'); el.className='phase'; el.dataset.pid=ph.id;
    el.innerHTML=`
      <div class="phase-title">
        <input value="${ph.name.replace(/"/g,'&quot;')}" data-role="pname">
        <button class="btn small no-print" data-role="del">Remove</button>
      </div>
      <div class="bucket" data-role="bucket"></div>
    `;
    const bucket = el.querySelector('[data-role="bucket"]');
    ph.items.forEach(it=> bucket.appendChild(renderItem(it)) );
    el.addEventListener('dragover', ev=>{ ev.preventDefault(); bucket.classList.add('ghost'); });
    el.addEventListener('dragleave', ()=> bucket.classList.remove('ghost'));
    el.addEventListener('drop', ev=>{
      ev.preventDefault(); bucket.classList.remove('ghost');
      const jid = ev.dataTransfer.getData('text/plain');
      const itemEl = document.querySelector(`.item[data-iid="${jid}"]`);
      if(itemEl && bucket!==itemEl.parentNode){ bucket.appendChild(itemEl); moveItem(jid, ph.id); autoSave(); }
    });
    el.querySelector('[data-role="pname"]').addEventListener('input', e=>{ ph.name=e.target.value; autoSave(); });
    el.querySelector('[data-role="del"]').addEventListener('click', ()=>{
      if(confirm('Remove this phase?')){ phases = phases.filter(x=>x.id!==ph.id); renderPhases(); autoSave(); }
    });
    els.phaseBar.appendChild(el);
  });
}
function renderItem(it){
  const el=document.createElement('div'); el.className='item'; el.draggable=true; el.dataset.iid=it.id;
  el.innerHTML=`<div contenteditable="true" data-role="title" style="outline:none">${(it.title||'Roadmap item')}</div>
                <div class="muted" style="display:flex;gap:8px;align-items:center;margin-top:6px">
                  <input type="text" data-role="date" placeholder="YYYY-MM-DD" style="width:130px;background:transparent;border:1px dashed rgba(255,255,255,.2);border-radius:8px;padding:2px 6px">
                  <input type="text" data-role="owner" placeholder="Owner" style="width:140px;background:transparent;border:1px dashed rgba(255,255,255,.2);border-radius:8px;padding:2px 6px">
                  <button class="btn small no-print" data-role="del">✕</button>
                </div>`;
  el.querySelector('[data-role="title"]').oninput = e=>{ it.title=e.target.innerText; autoSave(); };
  el.querySelector('[data-role="date"]').value = it.date||''; el.querySelector('[data-role="date"]').oninput=e=>{ it.date=e.target.value; autoSave(); };
  el.querySelector('[data-role="owner"]').value = it.owner||''; el.querySelector('[data-role="owner"]').oninput=e=>{ it.owner=e.target.value; autoSave(); };
  el.querySelector('[data-role="del"]').onclick = ()=>{ removeItem(it.id); el.remove(); autoSave(); };
  el.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', it.id); });
  return el;
}
function addPhase(){ phases.push({ id:uid('p'), name:`Phase ${phases.length+1}`, items:[] }); renderPhases(); }
function addItem(){
  if(phases.length===0) addPhase();
  const it={ id:uid('i'), title:'New item', date:'', owner:'' };
  phases[0].items.push(it); renderPhases(); autoSave();
}
function moveItem(itemId, destPid){
  let found=null;
  phases.forEach(p=>{ const idx=p.items.findIndex(i=>i.id===itemId); if(idx>=0){ found=p.items[idx]; p.items.splice(idx,1); }});
  const dest = phases.find(p=>p.id===destPid);
  if(found && dest){ dest.items.push(found); }
}
function removeItem(itemId){ phases.forEach(p=>{ p.items = p.items.filter(i=>i.id!==itemId); }); }
$('addPhaseBtn').addEventListener('click', addPhase);
$('addItemBtn').addEventListener('click', addItem);
renderPhases();

/* ========= Sketch board (pen/eraser + editable draggable sticky notes) ========= */
const ctx = els.board.getContext('2d');
let drawing=false, tool='pen', strokes=[], undone=[], currentPath=null;
let notes=[]; // {id,x,y,text}
function resizeCanvasToDisplaySize(canvas){
  const {width, height} = canvas.getBoundingClientRect();
  const w = Math.round(width), h = Math.round(height);
  if(canvas.width !== w || canvas.height !== h){
    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    canvas.width = w; canvas.height = h;
    ctx.putImageData(img, 0, 0);
  }
}
window.addEventListener('resize', ()=> resizeCanvasToDisplaySize(els.board));
resizeCanvasToDisplaySize(els.board);

function startDraw(x,y){ drawing=true; currentPath={tool, color: els.color.value, size:+els.size.value, pts:[[x,y]]}; }
function moveDraw(x,y){ if(!drawing) return; currentPath.pts.push([x,y]); redraw(); }
function endDraw(){ if(!drawing) return; drawing=false; strokes.push(currentPath); undone=[]; currentPath=null; autoSave(); }
function redraw(){
  ctx.clearRect(0,0,els.board.width,els.board.height);
  const all = [...strokes]; if(currentPath) all.push(currentPath);
  all.forEach(p=>{
    ctx.strokeStyle = (p.tool==='eraser') ? '#0f1633' : p.color;
    ctx.lineWidth=p.size; ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.beginPath();
    p.pts.forEach(([px,py],i)=>{ if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); });
    ctx.stroke();
  });
}
els.board.addEventListener('mousedown', e=>{ if(tool!=='pen' && tool!=='eraser') return; const r=els.board.getBoundingClientRect(); startDraw(e.clientX-r.left, e.clientY-r.top); });
els.board.addEventListener('mousemove', e=>{ if(tool!=='pen' && tool!=='eraser') return; const r=els.board.getBoundingClientRect(); moveDraw(e.clientX-r.left, e.clientY-r.top); });
window.addEventListener('mouseup', endDraw);
els.board.addEventListener('touchstart', e=>{ if(tool!=='pen' && tool!=='eraser') return; const t=e.touches[0]; const r=els.board.getBoundingClientRect(); startDraw(t.clientX-r.left, t.clientY-r.top); });
els.board.addEventListener('touchmove', e=>{ if(tool!=='pen' && tool!=='eraser') return; const t=e.touches[0]; const r=els.board.getBoundingClientRect(); moveDraw(t.clientX-r.left, t.clientY-r.top); e.preventDefault(); }, {passive:false});
els.board.addEventListener('touchend', endDraw);

document.querySelectorAll('.tools [data-tool]').forEach(b=> b.addEventListener('click', ()=>{ tool=b.dataset.tool; toast('Tool: '+tool); }));
$('undoBtn').addEventListener('click', ()=>{ if(strokes.length){ undone.push(strokes.pop()); redraw(); autoSave(); }});
$('redoBtn').addEventListener('click', ()=>{ if(undone.length){ strokes.push(undone.pop()); redraw(); autoSave(); }});
$('clearBoard').addEventListener('click', ()=>{ if(confirm('Clear board drawings and notes?')){ strokes=[]; undone=[]; notes=[]; clearNotesDOM(); redraw(); autoSave(); }});
$('downloadPng').addEventListener('click', ()=>{ els.boardPrint.src = snapshotBoard(); const a=document.createElement('a'); a.href=els.boardPrint.src; a.download='sketchboard.png'; a.click(); });

/* ----- Sticky notes (DOM elements over canvas) ----- */
$('noteTool').addEventListener('click', ()=>{
  const txt = prompt('Sticky note text (you can edit later):') || 'Note';
  const x = 24 + Math.random()*60, y = 24 + Math.random()*40;
  const n = {id:uid('n'), x, y, text:txt};
  notes.push(n); makeNoteDOM(n); autoSave();
});
function makeNoteDOM(n){
  const d=document.createElement('div'); d.className='sticky'; d.dataset.nid=n.id; d.style.left=n.x+'px'; d.style.top=n.y+'px';
  d.innerHTML = `
    <div class="bar" style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
      <span class="handle">::</span>
      <button class="btn small close no-print" title="Delete">✕</button>
    </div>
    <div class="content" contenteditable="true" spellcheck="false">${escapeHTML(n.text)}</div>
  `;
  // Dragging
  let drag=false, sx=0, sy=0, ox=0, oy=0;
  d.querySelector('.handle').addEventListener('mousedown', e=>{ drag=true; sx=e.clientX; sy=e.clientY; ox=n.x; oy=n.y; e.preventDefault(); });
  window.addEventListener('mousemove', e=>{ if(!drag) return; const dx=e.clientX-sx, dy=e.clientY-sy; n.x = ox+dx; n.y = oy+dy; d.style.left=n.x+'px'; d.style.top=n.y+'px'; });
  window.addEventListener('mouseup', ()=>{ if(drag){ drag=false; autoSave(); }});
  // Touch drag
  d.querySelector('.handle').addEventListener('touchstart', e=>{ const t=e.touches[0]; drag=true; sx=t.clientX; sy=t.clientY; ox=n.x; oy=n.y; });
  window.addEventListener('touchmove', e=>{ if(!drag) return; const t=e.touches[0]; const dx=t.clientX-sx, dy=t.clientY-sy; n.x=ox+dx; n.y=oy+dy; d.style.left=n.x+'px'; d.style.top=n.y+'px'; }, {passive:false});
  window.addEventListener('touchend', ()=>{ if(drag){ drag=false; autoSave(); }});
  // Edit
  const content = d.querySelector('.content');
  content.addEventListener('input', ()=>{ n.text = content.innerText; autoSave(); });
  // Delete
  d.querySelector('.close').addEventListener('click', ()=>{ notes = notes.filter(x=>x.id!==n.id); d.remove(); autoSave(); });
  els.canvasArea.appendChild(d);
}
function clearNotesDOM(){ els.canvasArea.querySelectorAll('.sticky').forEach(e=>e.remove()); }
function restoreNotesDOM(){ clearNotesDOM(); notes.forEach(makeNoteDOM); }
function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ----- Snapshot to PNG including notes ----- */
function snapshotBoard(){
  // Create a temp canvas same size as visible canvas
  const rect = els.board.getBoundingClientRect();
  const temp = document.createElement('canvas'); temp.width = Math.round(rect.width); temp.height = Math.round(rect.height);
  const tctx = temp.getContext('2d');
  // Draw grid background (approx)
  tctx.fillStyle='#0f1633'; tctx.fillRect(0,0,temp.width,temp.height);
  // Draw strokes
  function drawPath(p){
    tctx.strokeStyle = (p.tool==='eraser') ? '#0f1633' : p.color;
    tctx.lineWidth=p.size; tctx.lineJoin='round'; tctx.lineCap='round';
    tctx.beginPath();
    p.pts.forEach(([px,py],i)=>{ if(i===0) tctx.moveTo(px,py); else tctx.lineTo(px,py); });
    tctx.stroke();
  }
  strokes.forEach(drawPath);
  // Draw notes
  notes.forEach(n=>{
    const w=220, h=120, r=12, x=n.x, y=n.y;
    tctx.fillStyle='rgba(255,251,210,1)'; tctx.strokeStyle='rgba(0,0,0,.25)'; tctx.lineWidth=1.5;
    tctx.beginPath();
    tctx.moveTo(x+r,y); tctx.arcTo(x+w,y,x+w,y+h,r); tctx.arcTo(x+w,y+h,x,y+h,r);
    tctx.arcTo(x,y+h,x,y,r); tctx.arcTo(x,y,x+w,y,r); tctx.closePath(); tctx.fill(); tctx.stroke();
    // Text
    tctx.fillStyle='#222'; tctx.font='14px system-ui';
    const words=(n.text||'').split(' '); let line='', yy=y+24; const maxW=w-20, lh=18, xx=x+10;
    for(let i=0;i<words.length;i++){ const test=line+words[i]+' '; if(tctx.measureText(test).width>maxW){ tctx.fillText(line,xx,yy); line=words[i]+' '; yy+=lh; } else line=test; }
    tctx.fillText(line,xx,yy);
  });
  return temp.toDataURL('image/png');
}

/* ========= PDF attach & print handling ========= */
els.pdfInput.addEventListener('change', (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  els.pdfViewer.data = url;
  $('pdfViewerWrap').style.display='block';
  autoSave();
});
// Before printing: capture snapshot of board (drawings + notes)
window.addEventListener('beforeprint', ()=>{
  els.boardPrint.src = snapshotBoard();
});
els.pdfBtn.addEventListener('click', ()=>window.print());

/* ========= Storage + export ========= */
function storageKey(){
  const t=(els.team.value||'team').toLowerCase().replace(/\s+/g,'-').slice(0,40);
  const d=(els.date.value||'date');
  return `readiness-canvas::${t}::${d}`;
}
function getChecks(){
  const checks={};
  SECTION_DEFS.forEach(def=>{
    const chosen=document.querySelector(`input[name="${def.id}-rad"]:checked`);
    checks[def.id]={ value:chosen?chosen.value:null, notes:($(`${def.id}-notes`).value||'') };
  });
  return checks;
}
function setChecks(checks={}){
  SECTION_DEFS.forEach(def=>{
    const v=checks[def.id]?.value; document.querySelectorAll(`input[name="${def.id}-rad"]`).forEach(r=>r.checked=false);
    if(v){ const el=document.querySelector(`input[name="${def.id}-rad"][value="${v}"]`); if(el) el.checked=true; }
    $(`${def.id}-notes`).value = checks[def.id]?.notes || '';
  });
}
function getData(){
  return {
    team:els.team.value, facilitator:els.facilitator.value, date:els.date.value,
    confidence:+els.confidence.value,
    checks:getChecks(),
    actions:getActions(),
    roadmapName:els.roadmapName.value,
    phases,
    strokes, undone, notes, // include notes
    miroLink:els.miroLink.value
  };
}
function setData(d){
  els.team.value=d.team||''; els.facilitator.value=d.facilitator||''; els.date.value=d.date||'';
  els.confidence.value = d.confidence ?? 5; els.confVal.textContent=els.confidence.value;
  setChecks(d.checks||{});
  els.actionList.innerHTML=''; (d.actions||[]).forEach(addActionRow);
  els.roadmapName.value=d.roadmapName||'';
  phases = Array.isArray(d.phases) && d.phases.length ? d.phases : phases; renderPhases();
  strokes = Array.isArray(d.strokes)? d.strokes : []; undone = Array.isArray(d.undone)? d.undone : []; redraw();
  notes = Array.isArray(d.notes)? d.notes : []; restoreNotesDOM();
  els.miroLink.value = d.miroLink||'';
  computeScore();
}
function saveLocal(){ localStorage.setItem(storageKey(), JSON.stringify(getData())); toast('Saved'); }
function loadLocal(){
  const raw=localStorage.getItem(storageKey());
  if(!raw){ toast('No saved data for this team/date'); return; }
  try{ setData(JSON.parse(raw)); toast('Loaded'); }catch{ alert('Could not load saved data.'); }
}
let autosaveTimer=null; function autoSave(){ clearTimeout(autosaveTimer); autosaveTimer=setTimeout(saveLocal,500); }
els.saveBtn.addEventListener('click', saveLocal);
els.loadBtn.addEventListener('click', loadLocal);
els.exportBtn.addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(getData(),null,2)],{type:'application/json'});
  const a=document.createElement('a'); const t=(els.team.value||'team').toLowerCase().replace(/\s+/g,'-');
  const d=els.date.value||new Date().toISOString().slice(0,10);
  a.href=URL.createObjectURL(blob); a.download=`readiness-canvas_${t}_${d}.json`; a.click(); URL.revokeObjectURL(a.href);
});
els.importFile.addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader(); reader.onload=ev=>{ try{ setData(JSON.parse(ev.target.result)); toast('Imported'); }catch{ alert('Invalid JSON'); } };
  reader.readAsText(f); e.target.value='';
});
els.newCanvasBtn.addEventListener('click', ()=>{
  if(confirm('Start a new, blank canvas? Unsaved changes will be lost.')){
    localStorage.removeItem(storageKey());
    phases=[{id:uid('p1'),name:'Phase 1 — Discover',items:[]},{id:uid('p2'),name:'Phase 2 — Build',items:[]},{id:uid('p3'),name:'Phase 3 — Release',items:[]}];
    setData({checks:{},actions:[],phases,notes:[]});
  }
});
['team','facilitator','date','roadmapName','rep','sponsor','miroLink'].forEach(id=>$(id)?.addEventListener('input', autoSave));

/* ========= Utils ========= */
function toast(msg){
  const t=document.createElement('div');
  t.textContent=msg; t.style.position='fixed'; t.style.bottom='20px'; t.style.left='50%';
  t.style.transform='translateX(-50%)'; t.style.background='rgba(15,23,42,.95)';
  t.style.border='1px solid rgba(255,255,255,.18)'; t.style.color='var(--ink)'; t.style.padding='10px 14px';
  t.style.borderRadius='10px'; t.style.zIndex='9999'; document.body.appendChild(t);
  setTimeout(()=>t.remove(),1600);
}

/* ========= Initialize ========= */
setData({checks:{},actions:[]}); computeScore();
</script>
</body>
</html>

