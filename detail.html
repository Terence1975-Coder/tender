<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Prospecting Prospect Locator (Single-File)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0d12; --card:#121521; --muted:#8ea3b0; --accent:#6ce1c0; --text:#e6eef3; --danger:#ff6b6b; }
    * { box-sizing: border-box; }
    body { margin:0; font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"; background: linear-gradient(180deg,#0b0d12 0,#0e111a 100%); color: var(--text); }
    header { padding: 28px 20px 10px; text-align: center; }
    h1 { margin:0; font-size: 26px; font-weight: 700; letter-spacing: .2px; }
    header p { margin: 6px 0 0; color: var(--muted); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .grid { display: grid; grid-template-columns: 1.1fr 1.4fr; gap: 16px; }
    .card { background: var(--card); border: 1px solid #22293a; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card h2 { margin:0; padding: 14px 16px; font-size: 16px; border-bottom: 1px solid #1b2132; }
    .card .body { padding: 16px; }
    label { display:block; margin:10px 0 6px; color: var(--muted); font-weight: 600; }
    input[type="text"], input[type="password"], input[type="file"], textarea, select {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #25314a; background:#0f1320; color: var(--text);
    }
    textarea { min-height: 80px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .actions { display:flex; gap:10px; margin-top: 16px; }
    button {
      border: 1px solid #2a364f; background: #141a2b; color: var(--text); padding: 10px 14px; border-radius: 12px; cursor: pointer;
      transition: transform .045s ease, background .2s ease, border-color .2s ease;
    }
    button:hover { background: #182036; border-color: #344469; }
    button.primary { background: linear-gradient(180deg,#1b7a62,#115a49); border: 1px solid #1c6a56; }
    button.primary:hover { transform: translateY(-1px); }
    button:disabled { opacity:.6; cursor:not-allowed; transform:none; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius: 999px; background:#0f1726; border:1px solid #243251; color:var(--muted); font-size:12px; }
    .switch { display:flex; align-items:center; gap:8px; margin-top:10px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding:10px 8px; border-bottom: 1px solid #1b2132; font-size: 13px; }
    th { text-align:left; color: var(--muted); font-weight: 600; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; color: #b2c3cf; background:#0f1320; border-radius:12px; padding:10px; min-height:70px; border:1px solid #243251; }
    .ok { color: var(--accent); }
    .warn { color: #ffd166; }
    .err { color: var(--danger); }
    footer { text-align:center; color: var(--muted); font-size: 12px; padding: 16px; }
    .tiny { font-size: 11px; color: var(--muted); }
    .progress { height: 6px; border-radius: 999px; background:#111728; overflow:hidden; border:1px solid #243251; }
    .bar { height:100%; width:0%; background: linear-gradient(90deg,#77ffd2,#6ce1c0); }
    .chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip { font-size: 11px; background:#0f1726; border:1px solid #243251; padding:4px 8px; border-radius:999px; color: var(--muted); }
    .note { font-size: 12px; color: var(--muted); }
    a { color: #82ffd9; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ”Ž Prospecting Prospect Locator â€” Single-File (HTML)</h1>
    <p>Find public contacts from a company domain (via Google Programmable Search + Hunter), then export your CRM CSV.</p>
  </header>

  <div class="wrap grid">
    <!-- LEFT: Settings -->
    <div class="card">
      <h2>API & Settings</h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Google API Key</label>
            <input id="googleKey" type="password" placeholder="AIza...">
          </div>
          <div>
            <label>Google CSE ID</label>
            <input id="googleCx" type="password" placeholder="your_cse_id">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Hunter API Key (optional)</label>
            <input id="hunterKey" type="password" placeholder="hunter_api_key">
            <div class="switch">
              <input id="useHunter" type="checkbox" checked>
              <label for="useHunter" style="margin:0">Use Hunter enrichment</label>
            </div>
          </div>
          <div>
            <label>User-Agent (for any proxied fetches)</label>
            <input id="userAgent" type="text" placeholder="ProspectingTool/1.0 (+you@example.com)">
            <div class="hint">This single-file version doesnâ€™t fetch cross-origin content by default (CORS). Use Hunter for contacts.</div>
          </div>
        </div>

        <div class="chips">
          <span class="chip">No Google scraping â€” uses official JSON API</span>
          <span class="chip">Client-side only (keys are visible client-side)</span>
          <span class="chip">Exports exact CSV schema</span>
        </div>

        <div class="note" style="margin-top:10px;">
          <strong>Privacy/Compliance:</strong> Use only public business data. Comply with Google & Hunter ToS and applicable laws (e.g., UK GDPR/PECR).
        </div>
      </div>
    </div>

    <!-- RIGHT: Run -->
    <div class="card">
      <h2>Run</h2>
      <div class="body">
        <div class="row">
          <div>
            <label>Mode</label>
            <select id="mode">
              <option>Single company</option>
              <option>Upload CSV</option>
            </select>
          </div>
          <div class="pill" title="Weâ€™ll guess the official site via Google CSE if Website is missing">Guide: Company Name + (optional) Website</div>
        </div>

        <div id="singleBox">
          <label>Company Name</label>
          <input id="companyName" type="text" placeholder="Acme Ltd">
          <label>Website (optional)</label>
          <input id="websiteHint" type="text" placeholder="https://www.acme.com">
          <div class="actions">
            <button id="runSingle" class="primary">Run</button>
          </div>
        </div>

        <div id="csvBox" style="display:none">
          <label>Upload CSV (must include a <em>Company Name</em> column; optional <em>Website</em>)</label>
          <input id="csvFile" type="file" accept=".csv">
          <div class="actions">
            <button id="runCsv" class="primary">Run Batch</button>
          </div>
        </div>

        <div style="margin-top:16px;">
          <div class="progress"><div id="progBar" class="bar"></div></div>
          <div id="status" class="hint" style="margin-top:8px;"></div>
        </div>

        <label style="margin-top:14px;">Log</label>
        <div id="log" class="log"></div>
      </div>
    </div>

    <!-- Results -->
    <div class="card" style="grid-column: 1 / -1;">
      <h2>Results</h2>
      <div class="body">
        <div class="actions">
          <button id="downloadCsv" disabled>Download CSV</button>
          <div class="tiny">CSV columns: Company Name, Website, Business Email, Address Line 1, Address Line 2, City, County, Postal Code, Country, Primary Contact First Name, Primary Contact Last Name, Primary Contact Email, Primary Contact Phone, Primary Contact Title, Primary Contact Role to us, Primary Contact Subscribed, Secondary Contact First Name, Secondary Contact Last Name, Secondary Contact Email, Secondary Contact Phone, Secondary Contact Title, Secondary Contact Role to us, Secondary Contact Subscribed, Notes</div>
        </div>
        <div style="overflow:auto; margin-top:12px;">
          <table id="resultsTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <footer>
    Built for single-file convenience. For site crawling and robots.txt-aware extraction, use a backend or the Streamlit version.
  </footer>

<script>
/* ========= Helpers ========= */
const CSV_COLUMNS = [
  "Company Name","Website","Business Email","Address Line 1","Address Line 2","City","County","Postal Code","Country",
  "Primary Contact First Name","Primary Contact Last Name","Primary Contact Email","Primary Contact Phone","Primary Contact Title",
  "Primary Contact Role to us","Primary Contact Subscribed",
  "Secondary Contact First Name","Secondary Contact Last Name","Secondary Contact Email","Secondary Contact Phone",
  "Secondary Contact Title","Secondary Contact Role to us","Secondary Contact Subscribed","Notes"
];

const el = (id) => document.getElementById(id);
const log = (...args) => {
  const box = el("log");
  box.innerHTML += args.map(x => typeof x === "string" ? x : JSON.stringify(x)).join(" ") + "<br/>";
  box.scrollTop = box.scrollHeight;
};
const setStatus = (msg) => el("status").textContent = msg || "";
const setProgress = (p) => el("progBar").style.width = Math.max(0, Math.min(100, p*100)) + "%";

function sanitizeDomain(input) {
  if (!input) return null;
  let u = String(input).trim().toLowerCase();
  if (!u) return null;
  if (!/^https?:\/\//.test(u)) u = "http://" + u;
  try {
    const a = document.createElement('a');
    a.href = u;
    const host = a.hostname;
    if (!host) return null;
    // strip common subdomains
    return host.replace(/^www\./,'');
  } catch { return null; }
}

function blankRow(company, website, note="") {
  const r = {};
  CSV_COLUMNS.forEach(c => r[c] = "");
  r["Company Name"] = company || "";
  r["Website"] = website || "";
  r["Notes"] = note || "";
  return r;
}

function toCsv(rows) {
  const esc = (v) => {
    let s = (v ?? "").toString();
    if (s.includes('"')) s = s.replace(/"/g,'""');
    if (/[",\n]/.test(s)) s = `"${s}"`;
    return s;
  };
  const lines = [];
  lines.push(CSV_COLUMNS.map(esc).join(","));
  for (const row of rows) {
    lines.push(CSV_COLUMNS.map(k => esc(row[k])).join(","));
  }
  return lines.join("\n");
}

function renderTable(rows) {
  const thead = el("resultsTable").querySelector("thead");
  const tbody = el("resultsTable").querySelector("tbody");
  thead.innerHTML = "<tr>" + CSV_COLUMNS.map(c => `<th>${c}</th>`).join("") + "</tr>";
  tbody.innerHTML = rows.map(r => {
    return "<tr>" + CSV_COLUMNS.map(c => `<td>${(r[c] ?? "")}</td>`).join("") + "</tr>";
  }).join("");
}

function download(filename, text) {
  const blob = new Blob([text], {type: "text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
}

/* ========= Google Custom Search ========= */
const GOOGLE_API = "https://www.googleapis.com/customsearch/v1";

async function cseRequest({key, cx, q, num=5}) {
  const u = new URL(GOOGLE_API);
  u.searchParams.set("key", key);
  u.searchParams.set("cx", cx);
  u.searchParams.set("q", q);
  u.searchParams.set("num", String(num));
  const res = await fetch(u.toString());
  if (!res.ok) {
    const txt = await res.text().catch(()=> "");
    throw new Error(`Google CSE error ${res.status}: ${txt}`);
  }
  return await res.json();
}

async function guessCompanyDomain(company, key, cx) {
  const q = `${company} official site`;
  const data = await cseRequest({key, cx, q, num: 5});
  const items = data.items || [];
  for (const it of items) {
    const link = it.link || "";
    const d = sanitizeDomain(link);
    if (d) return d;
  }
  return null;
}

/* ========= Hunter ========= */
const HUNTER_API = "https://api.hunter.io/v2";

async function hunterDomainSearch(domain, apiKey, limit=20) {
  const u = new URL(HUNTER_API + "/domain-search");
  u.searchParams.set("domain", domain);
  u.searchParams.set("limit", String(Math.max(1, Math.min(limit,100))));
  u.searchParams.set("api_key", apiKey);
  const res = await fetch(u.toString());
  if (!res.ok) {
    const txt = await res.text().catch(()=> "");
    throw new Error(`Hunter error ${res.status}: ${txt}`);
  }
  const data = await res.json();
  const emails = (data?.data?.emails) || [];
  return emails.map(e => ({
    first_name: e.first_name || "",
    last_name:  e.last_name || "",
    email:      e.value || "",
    phone:      e.phone_number || "",
    title:      e.position || "",
    department: e.department || "",
    seniority:  e.seniority || "",
    type:       e.type || ""
  }));
}

/* ========= Core pipeline ========= */
async function processOne({company, websiteHint, googleKey, googleCx, useHunter, hunterKey}) {
  const outRows = [];
  const domain = websiteHint ? sanitizeDomain(websiteHint) : null;
  let finalDomain = domain;

  if (!finalDomain) {
    setStatus(`Finding official site for ${company}â€¦`);
    try {
      finalDomain = await guessCompanyDomain(company, googleKey, googleCx);
      log(`<span class="ok">Google CSE:</span> ${company} â†’ ${finalDomain || "not found"}`);
    } catch (e) {
      log(`<span class="err">Google CSE failed:</span> ${e.message}`);
    }
  }

  const websiteUrl = finalDomain ? `https://${finalDomain}` : "";

  // If Hunter enabled and we have a domain, enrich
  if (useHunter && hunterKey && finalDomain) {
    setStatus(`Enriching ${finalDomain} via Hunterâ€¦`);
    try {
      const people = await hunterDomainSearch(finalDomain, hunterKey, 20);
      if (people.length === 0) {
        outRows.push(blankRow(company, websiteUrl, "No contacts found via Hunter"));
      } else {
        for (const p of people) {
          const r = blankRow(company, websiteUrl, "");
          r["Primary Contact First Name"] = p.first_name;
          r["Primary Contact Last Name"]  = p.last_name;
          r["Primary Contact Email"]      = p.email;
          r["Primary Contact Phone"]      = p.phone;
          r["Primary Contact Title"]      = p.title;
          outRows.push(r);
        }
      }
    } catch (e) {
      log(`<span class="err">Hunter failed:</span> ${e.message}`);
      outRows.push(blankRow(company, websiteUrl, "Hunter enrichment failed"));
    }
  } else {
    // No Hunter: still return a shell row so CSV has the company listed
    outRows.push(blankRow(company, websiteUrl, finalDomain ? "No enrichment enabled" : "Domain not found"));
  }

  // Deduplicate by Primary Contact Email (or Business Email) + Phone + Title + Names
  const seen = new Set();
  const unique = [];
  for (const r of outRows) {
    const ident = (r["Primary Contact Email"] || r["Business Email"] || "").toLowerCase().trim();
    const phone = (r["Primary Contact Phone"] || "").trim();
    const name  = (r["Primary Contact First Name"]+" "+r["Primary Contact Last Name"]).trim().toLowerCase();
    const title = (r["Primary Contact Title"] || "").trim().toLowerCase();
    const key = JSON.stringify([ident, phone, name, title]);
    if (seen.has(key)) continue;
    seen.add(key);
    unique.push(r);
  }

  return unique;
}

/* ========= UI wiring ========= */
(function init(){
  const modeSel = el("mode");
  const singleBox = el("singleBox");
  const csvBox = el("csvBox");
  const runSingle = el("runSingle");
  const runCsv = el("runCsv");
  const dlBtn = el("downloadCsv");
  let results = [];

  modeSel.addEventListener("change", ()=>{
    const single = modeSel.value === "Single company";
    singleBox.style.display = single ? "" : "none";
    csvBox.style.display = single ? "none" : "";
    setStatus("");
    setProgress(0);
  });

  dlBtn.addEventListener("click", ()=>{
    if (!results.length) return;
    download("prospects.csv", toCsv(results));
  });

  runSingle.addEventListener("click", async ()=>{
    results = [];
    renderTable(results);
    setProgress(0); setStatus("Startingâ€¦");
    el("downloadCsv").disabled = true;
    el("log").innerHTML = "";

    const company = el("companyName").value.trim();
    const websiteHint = el("websiteHint").value.trim();
    const googleKey = el("googleKey").value.trim();
    const googleCx  = el("googleCx").value.trim();
    const hunterKey = el("hunterKey").value.trim();
    const useHunter = el("useHunter").checked;

    if (!company) { setStatus("Please enter Company Name"); return; }
    if (!googleKey || !googleCx) { setStatus("Please provide Google API Key and CSE ID"); return; }

    try {
      setProgress(0.15);
      const rows = await processOne({company, websiteHint, googleKey, googleCx, useHunter, hunterKey});
      results = rows;
      setProgress(1.0);
      setStatus(`Done. Rows: ${rows.length}`);
      renderTable(results);
      el("downloadCsv").disabled = results.length === 0;
    } catch (e) {
      log(`<span class="err">Run failed:</span> ${e.message}`);
      setStatus("Failed. See log.");
      setProgress(0);
    }
  });

  runCsv.addEventListener("click", async ()=>{
    results = [];
    renderTable(results);
    setProgress(0); setStatus("Reading CSVâ€¦");
    el("downloadCsv").disabled = true;
    el("log").innerHTML = "";

    const file = el("csvFile").files[0];
    if (!file) { setStatus("Please choose a CSV file"); return; }
    const googleKey = el("googleKey").value.trim();
    const googleCx  = el("googleCx").value.trim();
    const hunterKey = el("hunterKey").value.trim();
    const useHunter = el("useHunter").checked;
    if (!googleKey || !googleCx) { setStatus("Please provide Google API Key and CSE ID"); return; }

    // Simple CSV read (UTF-8, header-based)
    const text = await file.text();
    // naive parse: split lines; handle simple quoted commas
    const lines = text.replace(/\r/g,'').split('\n').filter(s => s.trim().length>0);
    const headers = lines.shift().split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(h => h.replace(/^"|"$/g,'').trim());
    const idxCompany = headers.findIndex(h => /^company\s*name$/i.test(h));
    const idxWebsite = headers.findIndex(h => /^website$/i.test(h));
    if (idxCompany === -1) { setStatus("CSV must include a 'Company Name' column"); return; }

    const total = lines.length;
    let i = 0;
    for (const line of lines) {
      i++;
      setStatus(`Processing ${i} of ${total}â€¦`);
      setProgress(i/total);
      const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(v => v.replace(/^"|"$/g,'').trim());
      const company = (cols[idxCompany] || "").trim();
      const websiteHint = idxWebsite >= 0 ? (cols[idxWebsite] || "").trim() : "";
      if (!company) continue;

      try {
        const rows = await processOne({company, websiteHint, googleKey, googleCx, useHunter, hunterKey});
        results.push(...rows);
      } catch (e) {
        log(`<span class="err">Failed for ${company}:</span> ${e.message}`);
        results.push(blankRow(company, "", "Error: " + e.message));
      }
      renderTable(results);
      await new Promise(r => setTimeout(r, 150)); // tiny pacing for UI
    }

    setStatus(`Done. Companies: ${total}. Rows: ${results.length}`);
    setProgress(1.0);
    el("downloadCsv").disabled = results.length === 0;
  });

  // initial state
  renderTable([]);
})();
</script>
</body>
</html>
