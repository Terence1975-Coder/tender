<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cornwall AI ‚Äî 4-Stage Challenge</title>
<meta name="description" content="Futuristic 4-stage prompt challenge with Firebase uploads, numbered voting, live results, overall leaderboard, archive gallery, and collage/certificate export." />

<!--
WORKSHOP SETUP (read once)

Realtime Database RULES (works even WITHOUT indexes now, but this is better):
{
  "rules": {
    "submissions": {
      "stage1": { ".read": true, ".write": true, ".indexOn": ["name"] },
      "stage2": { ".read": true, ".write": true, ".indexOn": ["name"] },
      "stage3": { ".read": true, ".write": true, ".indexOn": ["name"] },
      "stage4": { ".read": true, ".write": true, ".indexOn": ["name"] }
    },
    "votes": { ".read": true, ".write": true },
    "admin": { ".read": true, ".write": true },
    "archive": { ".read": true, ".write": true }
  }
}

Storage CORS (optional if you rely on the base64 copies; required if you want to draw remote Storage images into canvas):
[
  {
    "origin": ["*"],
    "method": ["GET", "HEAD"],
    "responseHeader": ["Content-Type", "Access-Control-Allow-Origin"],
    "maxAgeSeconds": 3600
  }
]

This app saves a resized base64 snapshot of uploaded images to DB (imageData/demoData),
so collages and certificates can render even when CORS is not set.
-->

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#050316; --bg2:#0b0630; --glow:#7f5af0; --cyan:#2cb67d;
    --blue:#5de4ff; --purple:#a78bfa; --green:#22c55e; --danger:#ef4444;
    --muted:#a3a3a3; --card:#0f0a3a80; --card2:#110a4a99;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:#eef;
    background: radial-gradient(1200px 700px at 20% 10%, #140b55 0%, #090530 40%, #050316 80%),
               radial-gradient(900px 500px at 80% 30%, #0b2455 0%, #060321 60%, #050316 90%);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    overflow-x:hidden;
  }
  .stars, .stars2, .stars3{
    position:fixed; inset:0; pointer-events:none; z-index:0;
    background-repeat:repeat; background-size:contain; opacity:.5; animation: drift 120s linear infinite;
  }
  .stars { background-image: radial-gradient(2px 2px at 20% 30%, #fff, transparent 60%),
                              radial-gradient(1px 1px at 70% 60%, #ddf, transparent 60%),
                              radial-gradient(1.5px 1.5px at 40% 80%, #adf, transparent 60%); }
  .stars2{ background-image: radial-gradient(1.5px 1.5px at 10% 50%, #fff, transparent 60%),
                              radial-gradient(2px 2px at 80% 20%, #cdf, transparent 60%); opacity:.35; animation-duration: 160s;}
  .stars3{ background-image: radial-gradient(1px 1px at 50% 50%, #fff, transparent 60%); opacity:.2; animation-duration: 220s;}
  @keyframes drift { from {transform: translateY(0)} to { transform: translateY(-400px)} }

  header{ position:relative; z-index:1; padding:32px 20px 8px; text-align:center; }
  .brand{
    font-family: Orbitron, Inter, sans-serif; letter-spacing:.06em; font-weight:800; font-size: clamp(24px, 3vw, 44px);
    background: linear-gradient(90deg, var(--blue), var(--purple), var(--cyan));
    -webkit-background-clip:text; background-clip:text; color: transparent; text-shadow: 0 0 20px rgba(127,90,240,.25);
  }
  .subtitle{margin-top:6px; color:#bcd; font-weight:500}
  .container{ position:relative; z-index:1; max-width:1200px; margin: 20px auto 160px; padding: 0 16px; }

  .notice{
    background: linear-gradient(180deg, #0e0b3f88, #0b083388);
    border:1px solid #3b2ab8; color:#dfe9ff; padding:12px 14px; border-radius:14px; margin:14px 0;
    display:flex; align-items:center; gap:10px;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
    background:#1b1655; border:1px solid #34307a; color:#bbf; font-size:12px; letter-spacing:.04em;
  }
  .grid{ display:grid; grid-template-columns: 1fr; gap:18px; margin-top:18px; }
  @media (min-width:1024px){ .grid{ grid-template-columns: 1.35fr .65fr; }}

  .card{
    background: linear-gradient(180deg, var(--card), var(--card2));
    border:1px solid #2b216f; border-radius:20px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 0 40px rgba(94,234,255,.06);
  }
  .card h2{ margin: 6px 0 10px; font-family: Orbitron, Inter; letter-spacing:.04em; color:#e8ecff }
  .muted{ color: var(--muted); font-size: 14px }
  label{ display:block; font-weight:600; margin:10px 0 6px; color:#dfe }
  input[type="text"], textarea, select{
    width:100%; background:#0e0a3d; color:#e7f2ff; border:1px solid #352a89; border-radius:12px; padding:10px 12px; outline:none;
    box-shadow: inset 0 0 0 1px rgba(94,234,255,.05);
  }
  textarea{ min-height: 110px; resize:vertical }
  input[type="file"]{ color:#bbd; }
  .row{ display:flex; gap:10px; flex-wrap:wrap }
  .row > *{ flex:1 }

  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:14px;
    font-weight:700; border:1px solid #344; cursor:pointer; background: linear-gradient(180deg, #1f1a66, #1b134d);
    color:#e9f3ff; text-decoration:none; transition: transform .05s ease, box-shadow .2s ease;
    box-shadow: 0 8px 20px rgba(127,90,240,.25), inset 0 0 0 1px rgba(94,234,255,.08);
  }
  .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 24px rgba(127,90,240,.35), inset 0 0 0 1px rgba(94,234,255,.14); }
  .btn.primary{ background: linear-gradient(180deg, #1b7c65, #125e4c); border-color:#247f6a }
  .btn.ghost{ background:transparent; border-color:#344; }
  .btn.danger{ background: linear-gradient(180deg, #7a1b3a, #5a1230); border-color:#7a2a3a }
  .tiny{ font-size:12px; color:#aac; margin-left:6px }

  .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 6px; }
  .tab{
    padding:8px 12px; border-radius:14px; border:1px solid #2d2b6a; background:#0e0a3d; color:#cfe;
    font-weight:700; cursor:pointer; display:flex; align-items:center; gap:8px;
  }
  .tab.active{ background: linear-gradient(180deg, #1b1450, #171042); border-color:#4a3fb6; box-shadow: 0 0 0 2px rgba(94,234,255,.12) inset; }
  .lock{ font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #3a2a8c; background:#140c4c; color:#9bf; }

  .gallery{
    display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:14px; margin-top:12px;
  }
  .tile{
    background:#0d0935; border:1px solid #2a2170; border-radius:14px; padding:10px; position:relative;
  }
  .tile img{ width:100%; border-radius:10px; display:block; object-fit:cover; aspect-ratio: 4 / 3; background:#070426 }
  .tile .caption{ margin-top:8px; font-size:13px; color:#cde }
  .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#13205a; border:1px solid #2b3a8c; font-size:12px; color:#cbe }
  .winner{ outline: 2px solid #2cb67d; box-shadow: 0 0 0 3px rgba(44,182,125,.2) }
  .num-badge{
    position:absolute; top:8px; left:8px;
    background:#1b1655; border:1px solid #4a3fb6; color:#e6ecff;
    border-radius:12px; padding:4px 10px; font-weight:800;
    box-shadow: 0 0 10px rgba(127,90,240,.25);
  }

  .admin-grid{ display:grid; grid-template-columns: 1fr; gap:12px }
  @media (min-width:1024px){ .admin-grid{ grid-template-columns: .9fr 1.1fr } }
  .kv{ display:flex; align-items:center; justify-content:space-between; gap:14px; padding:10px 12px; border:1px dashed #355; border-radius:12px; }
  .switch{ appearance:none; width:48px; height:28px; border-radius:999px; background:#2a235a; position:relative; border:1px solid #3a2b7a; cursor:pointer; }
  .switch:checked{ background:#1f7a65; border-color:#2a9b80 }
  .switch::after{ content:""; position:absolute; top:3px; left:3px; width:22px; height:22px; border-radius:50%; background:#e7f2ff; transition: transform .2s ease; }
  .switch:checked::after{ transform: translateX(20px); }

  footer{ position:fixed; bottom:0; left:0; right:0; z-index:1; padding:8px 12px; display:flex; align-items:center; justify-content:center; gap:10px; background: linear-gradient(180deg, transparent, #050316bb 30%, #050316ee); }
  .credit{ color:#8da; font-size:12px }
</style>
</head>
<body>
<div class="stars"></div><div class="stars2"></div><div class="stars3"></div>

<header>
  <div class="brand">Cornwall AI ‚Äî Prompt Gauntlet</div>
  <div class="subtitle">Quick-fire stages: <strong>Slogan</strong> ‚Üí <strong>Logo</strong> ‚Üí <strong>Flyer</strong> ‚Üí <strong>Sparkle</strong>. Upload. Vote. Win. üöÄ</div>
</header>

<div class="container">
  <div class="notice">
    <span class="pill">Futuristic Mode ‚ú®</span>
    <div>Enter your <strong>Name</strong> once below; it‚Äôs saved locally for submissions. Voting is anonymous and names are hidden in the gallery.</div>
  </div>

  <div class="grid">
    <!-- Left: Stages, Galleries, Results -->
    <div class="card">
      <h2>Stages</h2>
      <div class="tabs" id="stageTabs"></div>
      <div id="stageContent"></div>

      <div class="notice" style="margin-top:14px; display:flex; justify-content:space-between; align-items:center;">
        <div><strong>Gallery & Voting</strong> ‚Äî opens when the facilitator unlocks it. Winners are ranked by 3/2/1 points.</div>
        <button class="btn ghost" id="openGalleryBtn">Open Gallery</button>
      </div>

      <div id="galleryWrap" class="card" style="margin-top:12px; display:none;">
        <h2 id="galleryTitle">Gallery</h2>
        <div class="muted" id="galleryHint">Names are hidden during voting.</div>
        <div class="gallery" id="gallery"></div>
        <div id="votingPanel" style="margin-top:14px; display:none;">
          <div class="pill" style="margin-bottom:10px;">Select your 1st, 2nd, and 3rd</div>
          <div class="row">
            <select id="firstVote"><option value="">‚Äî First ‚Äî</option></select>
            <select id="secondVote"><option value="">‚Äî Second ‚Äî</option></select>
            <select id="thirdVote"><option value="">‚Äî Third ‚Äî</option></select>
          </div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button class="btn primary" id="submitVoteBtn">Submit Votes</button>
            <div class="tiny">Voting is one-time per device per stage.</div>
          </div>
        </div>
      </div>

      <!-- Public Results -->
      <div class="notice" style="margin-top:14px; display:flex; justify-content:space-between; align-items:center;">
        <div><strong>Results</strong> ‚Äî live scoreboard (visible when facilitator enables ‚ÄúResults‚Äù for the stage).</div>
        <button class="btn ghost" id="openResultsBtn">Open Results</button>
      </div>
      <div id="resultsPublicWrap" class="card" style="margin-top:12px; display:none;">
        <h2>Live Results</h2>
        <div class="muted" id="resultsPublicHint">Leaderboard updates in real time.</div>
        <div id="resultsPublicList"></div>
      </div>

      <!-- Archive Gallery Controls -->
      <div class="notice" style="margin-top:14px; display:flex; justify-content:space-between; align-items:center;">
        <div><strong>Archive Gallery</strong> ‚Äî browse sessions saved when admin archived & cleared.</div>
        <button class="btn ghost" id="openArchiveBtn">Open Archive Gallery</button>
      </div>

      <div id="archiveWrap" class="card" style="margin-top:12px; display:none;">
        <h2>Archive Gallery</h2>
        <div class="row" style="align-items:flex-end;">
          <div>
            <label>Session</label>
            <select id="archiveSession"><option value="">‚Äî Select Session ‚Äî</option></select>
          </div>
          <div>
            <label>Stage</label>
            <select id="archiveStage">
              <option value="stage1">Stage 1 ‚Äî Slogan</option>
              <option value="stage2">Stage 2 ‚Äî Logo</option>
              <option value="stage3">Stage 3 ‚Äî Flyer</option>
              <option value="stage4">Stage 4 ‚Äî Sparkle</option>
            </select>
          </div>
          <div><button class="btn" id="loadArchiveBtn">Load</button></div>
        </div>
        <div class="muted" id="archiveHint">Names are visible in archive.</div>
        <div class="gallery" id="archiveGallery" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- Right: Identity, Certificates & Admin -->
    <div class="card">
      <h2>Identity & Admin</h2>
      <div class="row">
        <div>
          <label>Your Name</label>
          <input id="participantName" type="text" placeholder="e.g., Alex Tremayne" />
          <div class="tiny">Stored only on your device and attached to your uploads.</div>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn" id="saveNameBtn">Save Name</button>
        <button class="btn ghost" id="downloadMyCollageBtn">My Collage (PNG)</button>
        <button class="btn ghost" id="downloadMyCollagePdfBtn">My Collage (PDF)</button>
        <span class="tiny" id="nameStatus"></span>
      </div>

      <hr style="border: none; border-top:1px solid #2a2769; margin:16px 0">

      <h3>Certificate</h3>
      <div class="tiny" style="margin-bottom:8px;">Download a PDF certificate showing your places and overall rank.</div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn" id="downloadMyCertPdfBtn">My Certificate (PDF)</button>
      </div>

      <hr style="border: none; border-top:1px solid #2a2769; margin:16px 0">

      <div id="adminPanelLocked">
        <label>Facilitator Code</label>
        <div class="row">
          <input id="adminCode" type="text" placeholder="Enter code" />
          <button class="btn" id="adminLoginBtn">Unlock</button>
        </div>
        <div class="tiny">Facilitator can open stages, unlock voting/results, view leaderboards, build any collage, and archive/clear.</div>
      </div>

      <div id="adminPanel" style="display:none;">
        <div class="pill" style="margin-bottom:10px;">Admin Dashboard</div>
        <div class="admin-grid">
          <div class="card" style="padding:12px;">
            <h3>Controls</h3>
            <div id="controlList"></div>
            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn ghost" id="lockAllBtn">Lock All</button>
              <button class="btn" id="openNextBtn">Open Next Stage</button>
              <button class="btn danger" id="closeVotingBtn">Close Voting</button>
            </div>

            <hr style="border:none; border-top:1px solid #2a2769; margin:14px 0">

            <h3>Collages</h3>
            <div class="row">
              <select id="adminParticipantPicker"><option value="">‚Äî Select participant ‚Äî</option></select>
              <button class="btn" id="adminDownloadCollageBtn">Collage (PNG)</button>
              <button class="btn" id="adminDownloadCollagePdfBtn">Collage (PDF)</button>
            </div>

            <hr style="border:none; border-top:1px solid #2a2769; margin:14px 0">

            <h3>Overall Results</h3>
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end;">
              <button class="btn" id="computeOverallBtn">Compute Now</button>
              <select id="certPicker"><option value="">‚Äî Select participant ‚Äî</option></select>
              <button class="btn" id="adminDownloadCertPdfBtn">Certificate (PDF)</button>
            </div>
            <div id="overallResultsWrap" style="margin-top:10px;"></div>

            <hr style="border:none; border-top:1px solid #2a2769; margin:14px 0">

            <h3>Archive & Clear</h3>
            <div class="row">
              <button class="btn ghost" id="downloadArchiveBtn">Download Archive (JSON)</button>
              <button class="btn danger" id="archiveAndClearBtn" title="Copies to DB archive + uploads JSON to Storage, then clears live data">Archive to Firebase & Clear All</button>
            </div>
            <div class="tiny" style="margin-top:6px;">DB: <code>archive/</code> ‚Ä¢ Storage: <code>backups/session-*.json</code></div>
          </div>

          <div class="card" style="padding:12px;">
            <h3>Live Results (Admin)</h3>
            <div id="resultsWrap"></div>
          </div>
        </div>
      </div>
    </div><!-- /right card -->
  </div>
</div>

<footer>
  <span class="credit">¬© Cornwall AI ‚Äî ‚ÄúBest AI group in Cornwall‚Äù workshop</span>
</footer>

<!-- Firebase (Compat SDKs) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>
<!-- jsPDF (without SRI); fallback loader in ensureJsPDF() -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
/* ===============================
   Firebase Config (provided)
================================== */
const firebaseConfig = {
  apiKey: "AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
  authDomain: "prospecting-f2f42.firebaseapp.com",
  databaseURL: "https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "prospecting-f2f42",
  storageBucket: "prospecting-f2f42.firebasestorage.app",
  messagingSenderId: "292034226428",
  appId: "1:292034226428:web:878b867e3eb4d3e0098f79",
  measurementId: "G-WWB0JTX2L2"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let storage = null;
try { storage = firebase.storage(); } catch(e){ console.warn("Storage not available:", e); }

/* ===============================
   App State
================================== */
const STAGES = [
  { key: "stage1", label: "Stage 1 ‚Ä¢ Slogan" },
  { key: "stage2", label: "Stage 2 ‚Ä¢ Logo" },
  { key: "stage3", label: "Stage 3 ‚Ä¢ Flyer" },
  { key: "stage4", label: "Stage 4 ‚Ä¢ Sparkle" },
];
const DEFAULT_SETTINGS = {
  currentIndex: 0,
  stage1: { open: true,  votingOpen: false, resultsOpen: false },
  stage2: { open: false, votingOpen: false, resultsOpen: false },
  stage3: { open: false, votingOpen: false, resultsOpen: false },
  stage4: { open: false, votingOpen: false, resultsOpen: false },
};

const els = {
  tabs: document.getElementById('stageTabs'),
  content: document.getElementById('stageContent'),
  openGalleryBtn: document.getElementById('openGalleryBtn'),
  galleryWrap: document.getElementById('galleryWrap'),
  galleryTitle: document.getElementById('galleryTitle'),
  galleryHint: document.getElementById('galleryHint'),
  gallery: document.getElementById('gallery'),
  votingPanel: document.getElementById('votingPanel'),
  firstVote: document.getElementById('firstVote'),
  secondVote: document.getElementById('secondVote'),
  thirdVote: document.getElementById('thirdVote'),
  submitVoteBtn: document.getElementById('submitVoteBtn'),

  openResultsBtn: document.getElementById('openResultsBtn'),
  resultsPublicWrap: document.getElementById('resultsPublicWrap'),
  resultsPublicHint: document.getElementById('resultsPublicHint'),
  resultsPublicList: document.getElementById('resultsPublicList'),

  participantName: document.getElementById('participantName'),
  saveNameBtn: document.getElementById('saveNameBtn'),
  nameStatus: document.getElementById('nameStatus'),

  adminPanelLocked: document.getElementById('adminPanelLocked'),
  adminPanel: document.getElementById('adminPanel'),
  adminCode: document.getElementById('adminCode'),
  adminLoginBtn: document.getElementById('adminLoginBtn'),
  controlList: document.getElementById('controlList'),
  resultsWrap: document.getElementById('resultsWrap'),
  lockAllBtn: document.getElementById('lockAllBtn'),
  openNextBtn: document.getElementById('openNextBtn'),
  closeVotingBtn: document.getElementById('closeVotingBtn'),

  downloadMyCollageBtn: document.getElementById('downloadMyCollageBtn'),
  downloadMyCollagePdfBtn: document.getElementById('downloadMyCollagePdfBtn'),
  adminParticipantPicker: document.getElementById('adminParticipantPicker'),
  adminDownloadCollageBtn: document.getElementById('adminDownloadCollageBtn'),
  adminDownloadCollagePdfBtn: document.getElementById('adminDownloadCollagePdfBtn'),

  downloadArchiveBtn: document.getElementById('downloadArchiveBtn'),
  archiveAndClearBtn: document.getElementById('archiveAndClearBtn'),

  openArchiveBtn: document.getElementById('openArchiveBtn'),
  archiveWrap: document.getElementById('archiveWrap'),
  archiveSession: document.getElementById('archiveSession'),
  archiveStage: document.getElementById('archiveStage'),
  loadArchiveBtn: document.getElementById('loadArchiveBtn'),
  archiveGallery: document.getElementById('archiveGallery'),
  archiveHint: document.getElementById('archiveHint'),

  computeOverallBtn: document.getElementById('computeOverallBtn'),
  overallResultsWrap: document.getElementById('overallResultsWrap'),
  certPicker: document.getElementById('certPicker'),
  downloadMyCertPdfBtn: document.getElementById('downloadMyCertPdfBtn'),
  adminDownloadCertPdfBtn: document.getElementById('adminDownloadCertPdfBtn'),
};
let settings = { ...DEFAULT_SETTINGS };
let admin = false;
let currentStageIndex = 0;

/* ===============================
   Utils
================================== */
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
const getDeviceId = () => { const k='gauntlet_device'; let v=localStorage.getItem(k); if(!v){ v=uid(); localStorage.setItem(k,v);} return v; };
const getName = () => localStorage.getItem('gauntlet_name') || "";
const setName = (name) => localStorage.setItem('gauntlet_name', name.trim());
const stageRef = (stageKey) => db.ref(`submissions/${stageKey}`);
const votesRef = (stageKey) => db.ref(`votes/${stageKey}`);
const adminRef = db.ref('admin/settings');
const archiveSessionsRef = db.ref('archive/sessions');
const archiveDataRef = (sessionId) => db.ref(`archive/data/${sessionId}`);

function escapeHtml(str){ return (str||"").replace(/[&<>"']/g, s=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
function fillSelect(sel, opts){ sel.innerHTML=""; opts.forEach(o=>{ const op=document.createElement('option'); op.value=o.value; op.textContent=o.label; sel.appendChild(op); }); }
function safeFileName(s){ return (s||'file').replace(/[^\w\-]+/g,'_'); }
function triggerDownload(href, filename){ const a=document.createElement('a'); a.href=href; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
function stageLabel(it){ return `#${(it.id||'').slice(-6)}`; }
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
async function ensureJsPDF(){
  if(window.jspdf?.jsPDF) return window.jspdf.jsPDF;
  try { await loadScript('https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'); } catch(e){}
  if(window.jspdf?.jsPDF) return window.jspdf.jsPDF;
  alert('PDF library failed to load. Check your network/Content Security Policy.');
  throw new Error('jsPDF load failed');
}

/* ===============================
   RESULTS (admin + public, LIVE)
================================== */
let votesListener = null, subsListener = null;
function attachLiveResultsListeners(){
  detachLiveResultsListeners();
  const sKey = STAGES[currentStageIndex].key;
  votesListener = votesRef(sKey).on('value', ()=>{ renderAdminResults(); renderPublicResults(); });
  subsListener  = stageRef(sKey).on('value', ()=>{ renderAdminResults(); renderPublicResults(); });
}
function detachLiveResultsListeners(){
  const sKey = STAGES[currentStageIndex]?.key;
  if(sKey && votesListener!==null){ votesRef(sKey).off('value'); votesListener=null; }
  if(sKey && subsListener!==null){ stageRef(sKey).off('value'); subsListener=null; }
}

async function computeStageScores(stageKey){
  const vs = (await votesRef(stageKey).get()).val() || {};
  const subs = (await stageRef(stageKey).get()).val() || {};
  const idToName = {};
  Object.values(subs).forEach(it=>{ idToName[it.id]=it.name||''; });
  const tally = {};
  Object.values(vs).forEach(v=>{
    if(!v) return;
    tally[v.first] = (tally[v.first]||0)+3;
    tally[v.second] = (tally[v.second]||0)+2;
    tally[v.third] = (tally[v.third]||0)+1;
  });
  const arr = Object.values(subs).map(it=>({
    id: it.id, name: idToName[it.id]||'', short: stageLabel(it), score: tally[it.id]||0
  })).sort((a,b)=> b.score-a.score);
  return { scores: arr, idToName };
}

async function renderResultsTo(targetEl, showNames){
  if(!targetEl) return;
  const sKey = STAGES[currentStageIndex].key;
  const { scores } = await computeStageScores(sKey);
  const vs = (await votesRef(sKey).get()).val() || {};
  const totalVotes = Object.keys(vs).length;
  targetEl.innerHTML = `
    <div class="pill" style="margin-bottom:8px;">Current: ${STAGES[currentStageIndex].label}</div>
    <div class="tiny">Total ballots: ${totalVotes}</div>
    <div class="gallery" style="grid-template-columns: 1fr;">
      ${scores.map((r,i)=>`
        <div class="tile ${i<3?'winner':''}" style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <div class="caption" style="font-size:14px;"><strong>${i+1}.</strong> ${r.short} <span class="tiny" style="color:#8fb">(${r.score} pts)</span></div>
            ${showNames ? `<div class="tiny" style="color:#9ab">Name: ${escapeHtml(r.name)}</div>` : ``}
          </div>
          <span class="badge">${i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':'‚≠ê'}</span>
        </div>
      `).join('')}
    </div>
  `;
}
function renderAdminResults(){ return renderResultsTo(els.resultsWrap, true); }
function renderPublicResults(){
  const sKey = STAGES[currentStageIndex].key;
  const canShow = settings[sKey]?.resultsOpen || admin;
  els.resultsPublicHint && (els.resultsPublicHint.textContent = canShow ? "Leaderboard updates in real time." : "Results hidden by facilitator.");
  if(els.resultsPublicWrap && els.resultsPublicWrap.style.display==='block'){
    if(canShow) renderResultsTo(els.resultsPublicList, false);
    else els.resultsPublicList && (els.resultsPublicList.innerHTML = "");
  }
}

/* ===============================
   UI: Tabs & Stage forms
================================== */
function renderTabs(){
  if(!els.tabs) return;
  els.tabs.innerHTML = "";
  STAGES.forEach((s, i) => {
    const b = document.createElement('button');
    b.className = 'tab' + (i === currentStageIndex ? ' active' : '');
    b.innerHTML = `${s.label} <span class="lock">${settings[s.key]?.open ? 'Open' : 'Locked'}</span>`;
    b.disabled = !settings[s.key]?.open;
    b.onclick = () => { currentStageIndex = i; renderTabs(); renderStage(); attachLiveResultsListeners(); };
    els.tabs.appendChild(b);
  });
}
function getStageHTML(key){
  const name = getName();
  const nameWarn = name ? '' : `<div class="tiny" style="color:#ffd9a8">Please set your name in the right panel before submitting.</div>`;
  if(key === 'stage1'){
    return `
      <h2>Stage 1 ‚Äî Slogan</h2>
      <div class="muted">Create a punchy slogan for our AI group in Cornwall. Be nice üòÑ</div>
      ${nameWarn}
      <label>Your Slogan</label>
      <input id="s1Slogan" type="text" maxlength="120" placeholder='e.g., "Cornwall AI: Clever minds, kinder futures"' />
      <button class="btn primary" id="s1Submit" style="margin-top:10px;">Submit Slogan</button>
    `;
  }
  if(key === 'stage2'){
    return `
      <h2>Stage 2 ‚Äî Logo</h2>
      <div class="muted">Upload a logo image (PNG/JPG). Tip: square looks best.</div>
      ${nameWarn}
      <label>Logo File</label>
      <input id="s2File" type="file" accept="image/*" />
      <button class="btn primary" id="s2Submit" style="margin-top:10px;">Upload Logo</button>
    `;
  }
  if(key === 'stage3'){
    return `
      <h2>Stage 3 ‚Äî Flyer</h2>
      <div class="muted">Make a flyer that includes your <strong>Slogan</strong>, your <strong>Logo</strong>, and a short description: ‚ÄúWhy we are the best AI group in Cornwall‚Äù.</div>
      ${nameWarn}
      <label>Short Description</label>
      <textarea id="s3Desc" placeholder="Why we are the best AI group in Cornwall..."></textarea>
      <label>Flyer Image</label>
      <input id="s3File" type="file" accept="image/*" />
      <button class="btn primary" id="s3Submit" style="margin-top:10px;">Upload Flyer</button>
    `;
  }
  return `
    <h2>Stage 4 ‚Äî Sparkle</h2>
    <div class="muted">Add interactive "sparkle" to your idea: choose an effect (we'll showcase it in the gallery ‚ú®).</div>
    ${nameWarn}
    <label>Pick a Sparkle Effect</label>
    <select id="s4Effect">
      <option value="starlight">Starlight</option>
      <option value="pulse">Neon Pulse</option>
      <option value="comet">Comet Trail</option>
      <option value="aurora">Aurora Sweep</option>
    </select>
    <label>Optional: Upload a demo image/gif</label>
    <input id="s4File" type="file" accept="image/*,video/*" />
    <button class="btn primary" id="s4Submit" style="margin-top:10px;">Submit Sparkle</button>
  `;
}
function renderStage(){
  if(!els.content) return;
  const s = STAGES[currentStageIndex];
  const wrap = document.createElement('div');
  wrap.innerHTML = getStageHTML(s.key);
  els.content.innerHTML = "";
  els.content.appendChild(wrap);

  document.getElementById('s1Submit')?.addEventListener('click', submitSlogan);
  document.getElementById('s2Submit')?.addEventListener('click', submitLogo);
  document.getElementById('s3Submit')?.addEventListener('click', submitFlyer);
  document.getElementById('s4Submit')?.addEventListener('click', submitSparkle);
}

/* ===============================
   Debounce & Image helpers
================================== */
let busy = { s1:false, s2:false, s3:false, s4:false };
function disableBtn(btn, on){
  if(!btn) return;
  btn.disabled = !!on;
  btn.style.opacity = on ? .6 : 1;
}
function fileToResizedDataURL(file, maxSize=1024, mime='image/jpeg', quality=.9){
  return new Promise((resolve)=>{
    if(!file || !file.type.startsWith('image/')) return resolve(null);
    const img = new Image(); img.crossOrigin='anonymous';
    const fr = new FileReader();
    fr.onload = ()=>{ img.onload = ()=>{
        const canvas=document.createElement('canvas');
        let w=img.width, h=img.height;
        const scale = Math.min(1, maxSize/Math.max(w,h));
        w=Math.round(w*scale); h=Math.round(h*scale);
        canvas.width=w; canvas.height=h;
        const ctx=canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        try{ resolve(canvas.toDataURL(mime, quality)); }
        catch(e){ resolve(null); }
      }; img.onerror=()=>resolve(null); img.src = fr.result;
    };
    fr.onerror = ()=> resolve(null);
    fr.readAsDataURL(file);
  });
}

/* ===============================
   Submissions (with single-run guards & base64 copy)
================================== */
async function submitSlogan(e){
  if(busy.s1) return; busy.s1 = true; disableBtn(e?.target, true);
  try{
    const name = getName(); if(!name){ alert("Please set your name on the right first."); return; }
    const slogan = (document.getElementById('s1Slogan')?.value || "").trim();
    if(!slogan){ alert("Please write your slogan."); return; }
    const id = uid();
    await stageRef('stage1').child(id).set({ id, name, slogan, createdAt: Date.now() });
    alert("Slogan submitted! üéâ");
    const input = document.getElementById('s1Slogan'); if(input) input.value = "";
  } finally { busy.s1 = false; disableBtn(e?.target, false); }
}

async function submitLogo(e){
  if(busy.s2) return; busy.s2 = true; disableBtn(e?.target, true);
  try{
    const name = getName(); if(!name){ alert("Please set your name on the right first."); return; }
    const file = document.getElementById('s2File')?.files?.[0];
    if(!file){ alert("Please choose a logo file."); return; }
    const id = uid();
    let url = ""; let dataURL = await fileToResizedDataURL(file, 1024, 'image/jpeg', .9);
    if(storage){
      const ref = storage.ref().child(`uploads/stage2/${id}-${file.name}`);
      await ref.put(file);
      url = await ref.getDownloadURL();
    }
    await stageRef('stage2').child(id).set({
      id, name, imageUrl: url, imageData: dataURL || "", fileName: file.name, createdAt: Date.now()
    });
    alert("Logo uploaded! üöÄ");
    const input = document.getElementById('s2File'); if(input) input.value = "";
  } finally { busy.s2 = false; disableBtn(e?.target, false); }
}

async function submitFlyer(e){
  if(busy.s3) return; busy.s3 = true; disableBtn(e?.target, true);
  try{
    const name = getName(); if(!name){ alert("Please set your name on the right first."); return; }
    const desc = (document.getElementById('s3Desc')?.value || "").trim();
    const file = document.getElementById('s3File')?.files?.[0];
    if(!desc){ alert("Please add a short description."); return; }
    if(!file){ alert("Please choose a flyer image file."); return; }
    const id = uid();
    let url = ""; let dataURL = await fileToResizedDataURL(file, 1280, 'image/jpeg', .9);
    if(storage){
      const ref = storage.ref().child(`uploads/stage3/${id}-${file.name}`);
      await ref.put(file);
      url = await ref.getDownloadURL();
    }
    await stageRef('stage3').child(id).set({
      id, name, description: desc, imageUrl: url, imageData: dataURL || "", fileName: file.name, createdAt: Date.now()
    });
    alert("Flyer uploaded! üåü");
    const t = document.getElementById('s3Desc'); if(t) t.value = "";
    const f = document.getElementById('s3File'); if(f) f.value = "";
  } finally { busy.s3 = false; disableBtn(e?.target, false); }
}

async function submitSparkle(e){
  if(busy.s4) return; busy.s4 = true; disableBtn(e?.target, true);
  try{
    const name = getName(); if(!name){ alert("Please set your name on the right first."); return; }
    const effect = document.getElementById('s4Effect')?.value || 'starlight';
    const file = document.getElementById('s4File')?.files?.[0];
    const id = uid();
    let url = ""; let dataURL = file ? await fileToResizedDataURL(file, 1024, 'image/jpeg', .9) : "";
    if(file && storage){
      const ref = storage.ref().child(`uploads/stage4/${id}-${file.name}`);
      await ref.put(file);
      url = await ref.getDownloadURL();
    }
    await stageRef('stage4').child(id).set({
      id, name, effect, demoUrl: url || "", demoData: dataURL || "", fileName: file?.name || "", createdAt: Date.now()
    });
    alert("Sparkle submitted! ‚ú®");
    const f = document.getElementById('s4File'); if(f) f.value = "";
  } finally { busy.s4 = false; disableBtn(e?.target, false); }
}

/* ===============================
   Gallery & Voting (numbered)
================================== */
let galleryStageKey = STAGES[0].key;
els.openGalleryBtn?.addEventListener('click', openGallery);
function openGallery(){
  galleryStageKey = STAGES[currentStageIndex].key;
  els.galleryWrap && (els.galleryWrap.style.display = 'block');
  els.galleryTitle && (els.galleryTitle.textContent = `Gallery ‚Äî ${STAGES[currentStageIndex].label}`);
  loadGallery(galleryStageKey);
}
async function loadGallery(stageKey){
  const votingOpen = !!(settings?.[stageKey]?.votingOpen);
  const showNames = false;

  els.votingPanel && (els.votingPanel.style.display = votingOpen ? 'block' : 'none');
  els.galleryHint && (els.galleryHint.textContent = votingOpen ? "Voting is open ‚Äî names are hidden." : "Gallery preview ‚Äî voting is closed.");

  const snap = await stageRef(stageKey).get();
  const data = snap.val() || {};
  const items = Object.values(data).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

  els.gallery && (els.gallery.innerHTML = "");
  const voteOptions = [{value:"",label:"‚Äî choose ‚Äî"}];

  items.forEach((it, idx) => {
    const number = idx + 1;
    const div = document.createElement('div');
    div.className = 'tile';
    div.style.position = 'relative';

    let media = '';
    if(stageKey==='stage1'){
      media = `<div class="caption" style="font-weight:800; font-size:16px; min-height:130px; display:flex; align-items:center;">‚Äú${escapeHtml(it.slogan || '')}‚Äù</div>`;
    } else {
      const src = it.imageData || it.imageUrl || it.demoData || it.demoUrl || '';
      media = src ? `<img src="${src}" alt="submission media" />` : `<div class="caption" style="min-height:130px; display:flex; align-items:center;">No media uploaded</div>`;
    }

    const caption = showNames ? `<div class="caption">${escapeHtml(it.name||'')}</div>` : '';
    div.innerHTML = `<div class="num-badge">${number}</div>${media}${caption}`;
    els.gallery && els.gallery.appendChild(div);

    voteOptions.push({ value: it.id, label: `${number}` });
  });

  els.firstVote && fillSelect(els.firstVote, voteOptions);
  els.secondVote && fillSelect(els.secondVote, voteOptions);
  els.thirdVote && fillSelect(els.thirdVote, voteOptions);
  if(els.submitVoteBtn) els.submitVoteBtn.onclick = () => submitVotes(stageKey, voteOptions.map(o=>o.value));
}
async function submitVotes(stageKey, validIds){
  const v1 = els.firstVote?.value; const v2 = els.secondVote?.value; const v3 = els.thirdVote?.value;
  if(!(v1 && v2 && v3)){ alert("Please choose all three places."); return; }
  if(new Set([v1,v2,v3]).size !== 3){ alert("Each place must be a different entry."); return; }
  if(!validIds.includes(v1) || !validIds.includes(v2) || !validIds.includes(v3)){ alert("Invalid vote selection."); return; }

  const voter = getDeviceId();
  const votedKey = `voted_${stageKey}`;
  if(localStorage.getItem(votedKey)){ alert("You have already voted on this stage from this device."); return; }

  await votesRef(stageKey).child(voter).set({ first: v1, second: v2, third: v3, createdAt: Date.now() });
  localStorage.setItem(votedKey, '1');
  alert("Thanks ‚Äî your vote is in! üó≥Ô∏è");
}

/* ===============================
   Public Results toggle
================================== */
els.openResultsBtn?.addEventListener('click', ()=>{
  els.resultsPublicWrap && (els.resultsPublicWrap.style.display = 'block');
  renderPublicResults();
});

/* ===============================
   Admin
================================== */
const ADMIN_CODE = "1975";
function setAdminMode(on){
  admin = on;
  els.adminPanel && (els.adminPanel.style.display = on ? 'block' : 'none');
  els.adminPanelLocked && (els.adminPanelLocked.style.display = on ? 'none' : 'block');
  if(on) refreshParticipantPicker();
  renderPublicResults();
}
els.adminLoginBtn?.addEventListener('click', ()=>{
  const code = (els.adminCode?.value||"").trim();
  if(code === ADMIN_CODE){ setAdminMode(true); alert("Admin unlocked."); }
  else { alert("Incorrect code."); }
});
els.lockAllBtn?.addEventListener('click', async ()=>{
  const newSet = {...settings};
  STAGES.forEach(s=>{ newSet[s.key].open=false; newSet[s.key].votingOpen=false; newSet[s.key].resultsOpen=false; });
  await adminRef.update(newSet);
});
els.openNextBtn?.addEventListener('click', async ()=>{
  const idx = settings.currentIndex || 0;
  const next = Math.min(idx+1, STAGES.length-1);
  const newSet = {...settings, currentIndex: next};
  newSet[STAGES[next].key].open = true;
  await adminRef.update(newSet);
});
els.closeVotingBtn?.addEventListener('click', async ()=>{
  const k = STAGES[settings.currentIndex||0].key;
  const newSet = {...settings};
  newSet[k].votingOpen = false;
  await adminRef.update(newSet);
});

function renderAdminControls(){
  if(!admin || !els.controlList) return;
  els.controlList.innerHTML = "";

  STAGES.forEach((s, i)=>{
    const row = document.createElement('div');
    row.className = 'kv';
    row.innerHTML = `
      <div style="display:flex; flex-direction:column; gap:4px;">
        <strong>${s.label}</strong>
        <span class="tiny">Open / Voting / Results visibility</span>
      </div>
      <div style="display:flex; align-items:center; gap:12px;">
        <label class="tiny">Open</label>
        <input type="checkbox" data-k="${s.key}" data-t="open" class="switch" ${settings[s.key]?.open?'checked':''} />
        <label class="tiny">Voting</label>
        <input type="checkbox" data-k="${s.key}" data-t="votingOpen" class="switch" ${settings[s.key]?.votingOpen?'checked':''} />
        <label class="tiny">Results</label>
        <input type="checkbox" data-k="${s.key}" data-t="resultsOpen" class="switch" ${settings[s.key]?.resultsOpen?'checked':''} />
        <button class="btn ghost" data-goto="${i}">Go To</button>
      </div>
    `;
    els.controlList.appendChild(row);
  });

  els.controlList.querySelectorAll('.switch').forEach(sw=>{
    sw.onchange = async (e)=>{
      const k=e.target.dataset.k, t=e.target.dataset.t, val=e.target.checked;
      const newSet = { ...settings };
      newSet[k][t] = val;
      if(t==='open' && val && STAGES.findIndex(x=>x.key===k) > settings.currentIndex){
        newSet.currentIndex = STAGES.findIndex(x=>x.key===k);
      }
      await adminRef.update(newSet);
    };
  });
  els.controlList.querySelectorAll('button[data-goto]').forEach(btn=>{
    btn.onclick = ()=>{
      currentStageIndex = parseInt(btn.dataset.goto,10)||0;
      renderTabs(); renderStage(); attachLiveResultsListeners();
    };
  });

  renderAdminResults();
}

/* ===============================
   Settings Sync (Realtime)
================================== */
function applySettings(newSet){
  settings = { ...DEFAULT_SETTINGS, ...newSet };
  STAGES.forEach(s=>{
    settings[s.key] = { ...DEFAULT_SETTINGS[s.key], ...(newSet?.[s.key]||{}) };
  });
  if(typeof settings.currentIndex !== 'number') settings.currentIndex = 0;
  currentStageIndex = Math.min(settings.currentIndex, STAGES.length-1);
  renderTabs(); renderStage();
  renderAdminControls();
  renderPublicResults();
  attachLiveResultsListeners();
}
adminRef.on('value', (snap)=>{
  const val = snap.val();
  if(!val){ adminRef.update(DEFAULT_SETTINGS); applySettings(DEFAULT_SETTINGS); }
  else { applySettings(val); }
});

/* ===============================
   Participants (picker for admin)
================================== */
async function refreshParticipantPicker(){
  if(!els.adminParticipantPicker) return;
  const names = new Set();
  for(const s of STAGES){
    const snap = await stageRef(s.key).get();
    const data = snap.val() || {};
    Object.values(data).forEach(it=> { if(it?.name) names.add(it.name); });
  }
  const curr = els.adminParticipantPicker.value;
  els.adminParticipantPicker.innerHTML = `<option value="">‚Äî Select participant ‚Äî</option>`;
  Array.from(names).sort().forEach(n=>{
    const op = document.createElement('option');
    op.value = n; op.textContent = n;
    els.adminParticipantPicker.appendChild(op);
  });
  // also populate certificate picker
  fillSelect(els.certPicker, [{value:'',label:'‚Äî Select participant ‚Äî'}].concat(
    Array.from(names).sort().map(n=>({value:n,label:n}))
  ));
  if(curr && names.has(curr)) els.adminParticipantPicker.value = curr;
}

/* ===============================
   Collage Builder (PNG + PDF) ‚Äî prefers base64 from DB
================================== */
els.downloadMyCollageBtn?.addEventListener('click', async ()=>{
  const name = getName();
  if(!name){ alert("Save your name first."); return; }
  const data = await gatherUserStageData(name);
  if(!data){ alert("No submissions yet."); return; }
  await exportCollagePNG(data, `${safeFileName(name)}-CornwallAI-Collage.png`);
});
els.downloadMyCollagePdfBtn?.addEventListener('click', async ()=>{
  const name = getName();
  if(!name){ alert("Save your name first."); return; }
  const data = await gatherUserStageData(name);
  if(!data){ alert("No submissions yet."); return; }
  await exportCollagePDF(data, `${safeFileName(name)}-CornwallAI-Collage.pdf`);
});
els.adminDownloadCollageBtn?.addEventListener('click', async ()=>{
  const n = els.adminParticipantPicker?.value || "";
  if(!n){ alert("Select a participant first."); return; }
  const data = await gatherUserStageData(n);
  if(!data){ alert("No submissions yet for this participant."); return; }
  await exportCollagePNG(data, `${safeFileName(n)}-CornwallAI-Collage.png`);
});
els.adminDownloadCollagePdfBtn?.addEventListener('click', async ()=>{
  const n = els.adminParticipantPicker?.value || "";
  if(!n){ alert("Select a participant first."); return; }
  const data = await gatherUserStageData(n);
  if(!data){ alert("No submissions yet for this participant."); return; }
  await exportCollagePDF(data, `${safeFileName(n)}-CornwallAI-Collage.pdf`);
});

async function gatherUserStageData(name){
  const out = { name, slogan:"", logoUrl:"", logoData:"", flyerUrl:"", flyerData:"", description:"", sparkle: "", sparkleData:"" };

  let snap = await stageRef('stage1').get();
  let items = Object.values(snap.val()||{}).filter(it=>it?.name===name);
  if(items.length){ items.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)); out.slogan = items[0].slogan||""; }

  snap = await stageRef('stage2').get();
  items = Object.values(snap.val()||{}).filter(it=>it?.name===name);
  if(items.length){ items.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)); out.logoUrl = items[0].imageUrl||""; out.logoData = items[0].imageData||""; }

  snap = await stageRef('stage3').get();
  items = Object.values(snap.val()||{}).filter(it=>it?.name===name);
  if(items.length){ items.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)); out.flyerUrl = items[0].imageUrl||""; out.flyerData = items[0].imageData||""; out.description = items[0].description||""; }

  snap = await stageRef('stage4').get();
  items = Object.values(snap.val()||{}).filter(it=>it?.name===name);
  if(items.length){ items.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)); out.sparkle = items[0].effect||""; out.sparkleData = items[0].demoData||""; }

  return out;
}
function loadImage(src){
  return new Promise((resolve)=>{
    if(!src) return resolve(null);
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = ()=> resolve(img);
    img.onerror = ()=> resolve(null);
    img.src = src;
  });
}
function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words = (text||"").split(/\s+/); let line = ""; let yy = y;
  for(let n=0; n<words.length; n++){
    const test = line + words[n] + " ";
    if(ctx.measureText(test).width > maxWidth && n>0){
      ctx.fillText(line, x, yy); line = words[n] + " "; yy += lineHeight;
    } else { line = test; }
  }
  ctx.fillText(line, x, yy);
  return yy;
}
async function renderCollageCanvas({name, slogan, logoUrl, logoData, flyerUrl, flyerData, description, sparkle, sparkleData}){
  const W = 1200, H = 1600;
  const canvas = document.createElement('canvas'); canvas.width=W; canvas.height=H;
  const ctx = canvas.getContext('2d');

  // Background gradient + stars
  const g = ctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0, '#0a0838'); g.addColorStop(.5, '#0a1b44'); g.addColorStop(1, '#050316');
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  ctx.globalAlpha = 0.35;
  for(let i=0;i<180;i++){ const x=Math.random()*W,y=Math.random()*H,r=Math.random()*1.6+.4; ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
  ctx.globalAlpha = 1;

  // Headings
  ctx.fillStyle = '#5de4ff'; ctx.font = 'bold 44px Orbitron, sans-serif'; ctx.fillText('Cornwall AI ‚Äî Prompt Gauntlet', 48, 80);
  ctx.fillStyle = '#a78bfa'; ctx.font = 'bold 36px Inter, sans-serif'; ctx.fillText(name || 'Participant', 48, 130);

  // Slogan box
  ctx.strokeStyle = '#2cb67d'; ctx.lineWidth = 3; ctx.strokeRect(44, 160, W-88, 160);
  ctx.fillStyle = '#e6f3ff'; ctx.font = 'bold 38px Inter, sans-serif';
  wrapText(ctx, `"${slogan || 'Your brilliant slogan'}"`, 60, 205, W-120, 44);

  // Logo
  let logo = await loadImage(logoData || logoUrl);
  if(logo){ ctx.drawImage(logo, 60, 340, 360, 360); }
  else { ctx.strokeStyle = '#4b3fb6'; ctx.strokeRect(60, 340, 360, 360);
         ctx.fillStyle = '#8aa5ff'; ctx.font='bold 20px Inter, sans-serif'; ctx.fillText('Logo not uploaded', 80, 540); }

  // Flyer
  let flyer = await loadImage(flyerData || flyerUrl);
  if(flyer){ ctx.drawImage(flyer, 480, 340, 640, 480); }
  else { ctx.strokeStyle = '#4b3fb6'; ctx.strokeRect(480, 340, 640, 480);
         ctx.fillStyle = '#8aa5ff'; ctx.font='bold 20px Inter, sans-serif'; ctx.fillText('Flyer not uploaded', 500, 580); }

  // Description
  ctx.fillStyle = '#9fe7ff'; ctx.font = 'bold 28px Inter, sans-serif';
  ctx.fillText('Why we are the best AI group in Cornwall', 48, 860);
  ctx.fillStyle = '#dfe9ff'; ctx.font = '24px Inter, sans-serif';
  const lastY = wrapText(ctx, description || '‚Äî', 48, 900, W-96, 34);

  // Sparkle
  ctx.fillStyle = '#2cb67d'; ctx.font = 'bold 28px Inter, sans-serif';
  ctx.fillText(`Sparkle: ${sparkle || '‚Äî'}`, 48, Math.min(lastY+50, 1120));
  const spr = await loadImage(sparkleData);
  if(spr){ ctx.globalAlpha = 0.85; ctx.drawImage(spr, W-360, 880, 300, 220); ctx.globalAlpha = 1; }

  // Footer ribbon
  const grad = ctx.createLinearGradient(0, H-120, W, H-60);
  grad.addColorStop(0,'#5de4ff'); grad.addColorStop(0.5,'#a78bfa'); grad.addColorStop(1,'#2cb67d');
  ctx.fillStyle = grad; ctx.fillRect(0, H-80, W, 80);
  ctx.fillStyle = '#040319'; ctx.font = 'bold 28px Orbitron, sans-serif';
  ctx.fillText('Made at the Cornwall AI Creation Challenge', 48, H-30);

  return canvas;
}
function canvasToDataURL(canvas){
  try { return canvas.toDataURL('image/png'); }
  catch(e){ console.warn('Canvas toDataURL blocked (CORS).'); return null; }
}
async function exportCollagePNG(data, filename){
  const canvas = await renderCollageCanvas(data);
  const dataUrl = canvasToDataURL(canvas);
  if(!dataUrl){ alert('PNG export blocked by browser due to image CORS. (Base64 fallback should avoid this.)'); return; }
  triggerDownload(dataUrl, filename);
}
async function exportCollagePDF(data, filename){
  const canvas = await renderCollageCanvas(data);
  const dataUrl = canvasToDataURL(canvas);
  if(!dataUrl){ alert('PDF export blocked by browser due to image CORS. (Base64 fallback should avoid this.)'); return; }
  const jsPDF = await ensureJsPDF();
  const pdf = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  pdf.setFillColor(5,3,22); pdf.rect(0,0,pageW,pageH,'F');
  const margin = 24, imgW=1200, imgH=1600;
  const ratio = Math.min((pageW-2*margin)/imgW, (pageH-2*margin)/imgH);
  const w = imgW*ratio, h = imgH*ratio, x=(pageW-w)/2, y=(pageH-h)/2;
  pdf.setDrawColor(93,228,255); pdf.setLineWidth(3); pdf.line(margin, margin, pageW - margin, margin);
  pdf.addImage(dataUrl, 'PNG', x, y, w, h, undefined, 'FAST');
  pdf.setDrawColor(167,139,250); pdf.setLineWidth(2); pdf.line(margin, pageH - margin, pageW - margin, pageH - margin);
  pdf.save(filename);
}

/* ===============================
   Overall Results + Certificates
================================== */
els.computeOverallBtn?.addEventListener('click', computeOverallAndRender);
els.adminDownloadCertPdfBtn?.addEventListener('click', async ()=>{
  const n = els.certPicker?.value || "";
  if(!n){ alert("Pick a participant first."); return; }
  await generateCertificateFor(n);
});
els.downloadMyCertPdfBtn?.addEventListener('click', async ()=>{
  const n = getName();
  if(!n){ alert("Save your name first."); return; }
  await generateCertificateFor(n);
});

async function computeOverall(){
  const nameTotals = {};
  for(const s of STAGES){
    const { scores } = await computeStageScores(s.key);
    scores.forEach(r=>{
      const nm = r.name || '(unknown)';
      nameTotals[nm] = (nameTotals[nm]||0) + (r.score||0);
    });
  }
  const leaderboard = Object.entries(nameTotals)
    .map(([name,total])=>({name,total}))
    .sort((a,b)=> b.total-a.total)
    .map((row,i)=> ({...row, rank:i+1}));
  return { leaderboard };
}
async function computeOverallAndRender(){
  const { leaderboard } = await computeOverall();
  els.overallResultsWrap && (els.overallResultsWrap.innerHTML = `
    <div class="gallery" style="grid-template-columns: 1fr;">
      ${leaderboard.map(r=>`
        <div class="tile" style="display:flex; align-items:center; justify-content:space-between;">
          <div>
            <div class="caption" style="font-size:14px;"><strong>${r.rank}.</strong> ${escapeHtml(r.name)}</div>
            <div class="tiny" style="color:#8fb">${r.total} pts (all stages)</div>
          </div>
          <span class="badge">${r.rank===1?'üèÜ': r.rank<=3?'ü•á':'‚≠ê'}</span>
        </div>
      `).join('')}
    </div>
  `);
  // populate pickers
  fillSelect(els.certPicker, [{value:'',label:'‚Äî Select participant ‚Äî'}].concat(
    leaderboard.map(r=>({value:r.name, label:`${r.name} (${r.total} pts)`}))
  ));
}
async function placementsForName(name){
  const out = {};
  for(const s of STAGES){
    const { scores } = await computeStageScores(s.key);
    const top3 = scores.slice(0,3);
    const idx = top3.findIndex(x=> (x.name||'') === name);
    if(idx>=0) out[s.key] = idx+1; // 1..3
  }
  return out;
}
async function generateCertificateFor(name){
  const { leaderboard } = await computeOverall();
  const row = leaderboard.find(r=> r.name===name) || { total:0, rank:leaderboard.length||'-' };
  const places = await placementsForName(name);
  const canvas = await renderCertificateCanvas({ name, overallPoints: row.total, overallRank: row.rank, places });
  const dataUrl = canvasToDataURL(canvas);
  if(!dataUrl){ alert('PDF export blocked by browser due to image CORS.'); return; }
  const jsPDF = await ensureJsPDF();
  const pdf = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  pdf.addImage(dataUrl, 'PNG', 0, 0, pageW, pageH, undefined, 'FAST');
  pdf.save(`${safeFileName(name)}-Certificate.pdf`);
}
async function renderCertificateCanvas({name, overallPoints, overallRank, places}){
  const W = 1600, H = 1132;
  const c = document.createElement('canvas'); c.width=W; c.height=H;
  const ctx = c.getContext('2d');

  const g = ctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0,'#0a0a33'); g.addColorStop(0.5,'#0b1f54'); g.addColorStop(1,'#06041f');
  ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
  ctx.globalAlpha = 0.35;
  for(let i=0;i<240;i++){ const x=Math.random()*W,y=Math.random()*H,r=Math.random()*1.6+.4; ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
  ctx.globalAlpha = 1;

  ctx.strokeStyle = '#7f5af0'; ctx.lineWidth = 8; ctx.strokeRect(24,24,W-48,H-48);

  ctx.fillStyle = '#5de4ff'; ctx.font = 'bold 70px Orbitron, sans-serif'; ctx.textAlign='center';
  ctx.fillText('Certificate of Achievement', W/2, 180);

  ctx.fillStyle = '#a78bfa'; ctx.font = '800 64px Inter, sans-serif';
  ctx.fillText(name || 'Participant', W/2, 280);

  ctx.fillStyle = '#cde8ff'; ctx.font = '28px Inter, sans-serif';
  ctx.fillText('in the Cornwall AI Creation Challenge', W/2, 330);

  ctx.strokeStyle = '#2cb67d'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(200,360); ctx.lineTo(W-200,360); ctx.stroke();

  ctx.textAlign = 'left';
  ctx.fillStyle = '#9fe7ff'; ctx.font = 'bold 30px Inter, sans-serif';
  ctx.fillText('Stage Placements:', 220, 420);

  ctx.fillStyle = '#eaf6ff'; ctx.font = '26px Inter, sans-serif';
  const labels = { stage1:'Stage 1 ‚Ä¢ Slogan', stage2:'Stage 2 ‚Ä¢ Logo', stage3:'Stage 3 ‚Ä¢ Flyer', stage4:'Stage 4 ‚Ä¢ Sparkle' };
  let y = 460; let anyPlace=false;
  for(const k of Object.keys(labels)){
    const p = places[k];
    const line = `${labels[k]} ‚Äî ${p===1?'ü•á First Place': p===2?'ü•à Second Place': p===3?'ü•â Third Place': '‚Äî'}`;
    if(p) anyPlace=true;
    ctx.fillText(line, 240, y); y += 38;
  }
  if(!anyPlace){
    ctx.fillStyle = '#ffdca8'; ctx.fillText('No podium places recorded ‚Äî thanks for participating and shining!', 240, y);
  }

  const boxX = W-640, boxY = 420, boxW = 420, boxH = 220;
  ctx.fillStyle = 'rgba(15,14,60,0.65)'; ctx.strokeStyle='#4a3fb6'; ctx.lineWidth=2;
  ctx.fillRect(boxX, boxY, boxW, boxH); ctx.strokeRect(boxX, boxY, boxW, boxH);
  ctx.fillStyle = '#9fe7ff'; ctx.font = 'bold 28px Inter, sans-serif';
  ctx.fillText('Overall Performance', boxX+24, boxY+42);
  ctx.fillStyle = '#e6f3ff'; ctx.font = '26px Inter, sans-serif';
  ctx.fillText(`Points: ${overallPoints||0}`, boxX+24, boxY+88);
  ctx.fillText(`Rank: ${overallRank||'-'}`, boxX+24, boxY+128);

  ctx.textAlign = 'center';
  ctx.fillStyle = '#7adcc8'; ctx.font = '22px Inter, sans-serif';
  ctx.fillText('Awarded by Cornwall AI ‚Äî Best AI group in Cornwall', W/2, H-80);
  ctx.fillStyle = '#d9e7ff'; ctx.font = '18px Inter, sans-serif';
  ctx.fillText(new Date().toLocaleString(), W/2, H-50);

  return c;
}

/* ===============================
   Archive (JSON + DB + Gallery)
================================== */
els.downloadArchiveBtn?.addEventListener('click', async ()=>{
  const archive = await buildArchive();
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(archive,null,2));
  triggerDownload(dataStr, `CornwallAI-archive-${new Date().toISOString().replace(/[:.]/g,'-')}.json`);
});
els.archiveAndClearBtn?.addEventListener('click', async ()=>{
  if(!confirm("Archive to DB + Storage, then CLEAR ALL submissions/votes? This cannot be undone.")) return;

  const submissions = {};
  for(const s of STAGES){ submissions[s.key] = (await stageRef(s.key).get()).val() || {}; }
  const votes = {};
  for(const s of STAGES){ votes[s.key] = (await votesRef(s.key).get()).val() || {}; }
  const sessionId = new Date().toISOString().replace(/[:.]/g,'-');

  const counts = {}; STAGES.forEach(s=> counts[s.key]=Object.keys(submissions[s.key]||{}).length );
  await archiveDataRef(sessionId).set({ submissions, votes, settings });
  await archiveSessionsRef.child(sessionId).set({ createdAt: Date.now(), counts });

  try{
    if(storage){
      const blob = new Blob([JSON.stringify({ submissions, votes, settings, createdAt: new Date().toISOString() },null,2)], {type:'application/json'});
      await storage.ref().child(`backups/session-${sessionId}.json`).put(blob);
    }
  }catch(e){ console.warn('Storage archive failed:', e); }

  await db.ref('submissions').remove();
  await db.ref('votes').remove();
  await adminRef.set(DEFAULT_SETTINGS);

  alert("Archived to DB (archive/) + Storage, and cleared live data.");
});
async function buildArchive(){
  const submissions = {};
  for(const s of STAGES){ submissions[s.key] = (await stageRef(s.key).get()).val() || {}; }
  const votes = {};
  for(const s of STAGES){ votes[s.key] = (await votesRef(s.key).get()).val() || {}; }
  return { exportedAt: new Date().toISOString(), settings, submissions, votes };
}

/* ---------- Archive Gallery UI ---------- */
els.openArchiveBtn?.addEventListener('click', ()=>{
  els.archiveWrap && (els.archiveWrap.style.display = 'block');
  loadArchiveSessions();
});
els.loadArchiveBtn?.addEventListener('click', ()=>{
  const sessionId = els.archiveSession.value;
  const stageKey = els.archiveStage.value;
  if(!sessionId){ alert('Pick a session first.'); return; }
  loadArchiveGallery(sessionId, stageKey);
});
async function loadArchiveSessions(){
  const snap = await archiveSessionsRef.get();
  const data = snap.val() || {};
  const entries = Object.entries(data).sort((a,b)=> (b[1]?.createdAt||0)-(a[1]?.createdAt||0));
  const opts = [{value:'', label:'‚Äî Select Session ‚Äî'}].concat(entries.map(([id,meta])=>{
    const date = new Date(meta.createdAt||Date.now()).toLocaleString();
    const count = Object.values(meta.counts||{}).reduce((a,b)=>a+(b||0),0);
    return { value:id, label:`${id} (${count} items) ‚Äî ${date}` };
  }));
  fillSelect(els.archiveSession, opts);
}
async function loadArchiveGallery(sessionId, stageKey){
  const node = await archiveDataRef(sessionId).child(`submissions/${stageKey}`).get();
  const items = Object.values(node.val()||{}).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  els.archiveGallery && (els.archiveGallery.innerHTML = "");
  items.forEach((it, idx)=>{
    const number = idx+1;
    const div = document.createElement('div');
    div.className = 'tile';
    div.style.position = 'relative';
    let media = '';
    if(stageKey==='stage1'){
      media = `<div class="caption" style="font-weight:800; font-size:16px; min-height:130px; display:flex; align-items:center;">‚Äú${escapeHtml(it.slogan || '')}‚Äù</div>`;
    } else {
      const src = it.imageData || it.imageUrl || it.demoData || it.demoUrl || '';
      media = src ? `<img src="${src}" alt="submission media" />` : `<div class="caption" style="min-height:130px; display:flex; align-items:center;">No media</div>`;
    }
    const name = `<div class="caption">By: ${escapeHtml(it.name||'-')}</div>`;
    div.innerHTML = `<div class="num-badge">${number}</div>${media}${name}`;
    els.archiveGallery && els.archiveGallery.appendChild(div);
  });
  els.archiveHint && (els.archiveHint.textContent = items.length ? `Loaded ${items.length} item(s) ‚Äî ${STAGES.find(s=>s.key===stageKey).label}` : 'No items in that session/stage.');
}

/* ===============================
   Identity
================================== */
function loadName(){
  const n = getName();
  if(els.participantName) els.participantName.value = n || "";
  if(els.nameStatus) els.nameStatus.textContent = n ? `Saved: ${n}` : '';
}
els.saveNameBtn?.addEventListener('click', ()=>{
  const n = (els.participantName?.value||"").trim();
  if(!n){ alert("Enter your name."); return; }
  setName(n); loadName(); alert("Name saved.");
});

/* ===============================
   Boot
================================== */
window.addEventListener('load', ()=>{
  loadName();
  renderTabs();
  renderStage();
  attachLiveResultsListeners();
});
</script>
</body>
</html>
