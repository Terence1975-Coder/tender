<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Bootcamp Screening Chatbot - n8n + Irish Emily Voice</title>
    <!-- Firebase (kept as original) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* (styles unchanged from original file for brevity) */
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#1e3a4a 0%,#2c5866 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:10px;margin:0}
        .container{max-width:1200px;width:100%;height:90vh;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.2);overflow:hidden;display:flex;flex-direction:column}
        .header{background:linear-gradient(135deg,#1e3a4a 0%,#2c5866 100%);color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;border-bottom:3px solid #7dd321}
        .chat-container{flex:1;overflow-y:auto;padding:15px;background:#f8fafb;min-height:0}
        .message{margin-bottom:15px;padding:12px 18px;border-radius:18px;max-width:80%;word-wrap:break-word}
        .bot-message{background:linear-gradient(135deg,#e8f4f8 0%,#f0f8ff 100%);border:1px solid #2c5866;border-left:4px solid #2c5866;margin-right:auto;color:#1e3a4a}
        .user-message{background:linear-gradient(135deg,#f0fff0 0%,#e8f8e8 100%);border:1px solid #7dd321;border-left:4px solid #7dd321;margin-left:auto;text-align:right;color:#2c5866}
        .input-section{padding:20px;border-top:2px solid #2c5866;background:white}
        .audio-controls{display:flex;gap:10px;margin-bottom:15px;align-items:center;flex-wrap:wrap}
        .audio-btn{background:linear-gradient(135deg,#2c5866 0%,#1e3a4a 100%);color:white;border:none;padding:8px 12px;border-radius:15px;cursor:pointer;font-size:12px;font-weight:600}
        .audio-btn.active{background:linear-gradient(135deg,#7dd321 0%,#6bb81c 100%)}
        .text-input{width:100%;padding:12px;border:2px solid #2c5866;border-radius:25px;font-size:16px}
        .send-btn{padding:12px 20px;background:linear-gradient(135deg,#7dd321 0%,#6bb81c 100%);color:white;border:none;border-radius:25px;cursor:pointer;font-weight:600;margin-left:10px}
        .voice-indicator{display:none}
    </style>
</head>
<body>
    <div id="firebase-status" class="firebase-status firebase-disconnected">🔴 Firebase Disconnected</div>

    <div class="container">
        <div class="header">
            <div style="display:flex;align-items:center;gap:15px">
                <div style="font-size:24px;font-weight:bold;color:white;text-transform:uppercase;letter-spacing:2px">BIT<div style="color:#7dd321;font-size:14px;font-weight:600">TRAINING</div></div>
                <h1 style="font-size:18px;margin:0;color:white">🤖 AI Bootcamp Screening Assistant</h1>
            </div>
            <div style="color:#7dd321;font-size:14px;font-weight:600">+44 (0)1752 724 000</div>
        </div>

        <div style="display:flex;flex:1;overflow:hidden">
            <div style="flex:1;display:flex;flex-direction:column;min-width:0">
                <div id="chatContainer" class="chat-container"></div>

                <div class="input-section">
                    <div class="audio-controls">
                        <button class="audio-btn" id="audioToggle" onclick="window.chatBot.toggleAudio()">🔊 Audio: ON</button>
                        <button class="audio-btn" id="voiceInput" onclick="window.chatBot.startVoiceInput()">🎤 Voice Input</button>
                        <button class="audio-btn" id="voiceTraining" onclick="window.chatBot.startVoiceTraining()">🎯 Voice Info</button>
                        <div class="voice-indicator" id="voiceIndicator">🎤 Listening...</div>
                        <button class="audio-btn" id="stopAudio" onclick="window.chatBot.stopAudio()">⏹️ Stop Audio</button>
                    </div>

                    <div id="responseButtons" class="response-buttons"></div>

                    <div style="display:flex;align-items:center;margin-top:10px">
                        <input id="textInput" class="text-input" placeholder="Ask me anything about the AI Business Productivity Bootcamp or respond to screening questions..." onkeypress="if(event.key==='Enter') window.chatBot.handleTextInput()">
                        <button class="send-btn" onclick="window.chatBot.handleTextInput()">Send</button>
                    </div>
                </div>
            </div>

            <div id="assessmentPanel" class="assessment-panel" style="position:fixed;right:20px;top:20px;width:300px;background:white;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);font-size:14px;max-height:80vh;overflow:hidden;border:2px solid #2c5866">
                <div style="padding:15px 20px;background:linear-gradient(135deg,#2c5866 0%,#1e3a4a 100%);color:white;border-radius:8px 8px 0 0;cursor:pointer">📊 Live Assessment <span style="float:right">▼</span></div>
                <div style="padding:20px;max-height:calc(80vh - 60px);overflow-y:auto">
                    <div style="background:#e8f6f3;padding:8px;border-radius:5px;margin-bottom:12px;font-size:11px">
                        <strong>🎉 Production Features:</strong><br>• 📊 Direct dashboard integration<br>• ☁️ Firebase cloud storage active<br>• 🔊 Irish Emily voice (forced if available)
                    </div>
                    <div id="finalReport" class="final-report hidden" style="background:#f8fafb;border:2px solid #2c5866;border-radius:10px;padding:20px;margin-top:20px"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================
        // ChatBot - Updated
        // - Forces Irish "Emily" voice when available
        // - Tweaks prosody for more natural flow
        // - Adds n8n webhook integration using the provided URL
        // =====================

        class ChatBot {
            constructor() {
                // CONFIG
                this.config = {
                    useN8nIntegration: true,
                    n8nWebhookURL: 'http://localhost:5678/webhook-test/candidate-screening', // user-provided
                    useMakeIntegration: false,
                    dashboardURL: 'https://terence1975-coder.github.io/tender/testbot.html'
                };

                // Firebase config (kept)
                this.firebaseConfig = {
                    apiKey: "AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
                    authDomain: "prospecting-f2f42.firebaseapp.com",
                    databaseURL: "https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app/",
                    projectId: "prospecting-f2f42",
                    storageBucket: "prospecting-f2f42.firebasestorage.app",
                    messagingSenderId: "292034226428",
                    appId: "1:292034226428:web:878b867e3eb4d3e0098f79",
                    measurementId: "G-WWB0JTX2L2"
                };

                // State
                this.candidateData = { name: 'Applicant', responses: [], interestLevel: 5 };
                this.score = 0;
                this.chatContainer = document.getElementById('chatContainer');
                this.responseButtons = document.getElementById('responseButtons');
                this.textInput = document.getElementById('textInput');

                // Voice settings - tuned for natural flow
                this.voiceSettings = {
                    rate: 0.95,   // slightly slower for clarity
                    pitch: 1.05,  // slight rise for naturalness
                    volume: 1.0,  // full volume for clarity
                    selectedVoice: null
                };

                // Speech & recognition placeholders
                this.speechSynthesis = null;
                this.recognition = null;
                this.currentSpeech = null;

                // init
                this.initAudio();
                this.initializeFirebase();
                this.init();
            }

            // ------------------- AUDIO: force Irish Emily when available
            initAudio() {
                if (!('speechSynthesis' in window)) {
                    console.warn('SpeechSynthesis not available');
                    return;
                }

                this.speechSynthesis = window.speechSynthesis;

                const findAndForceEmily = () => {
                    const voices = this.speechSynthesis.getVoices();

                    // Candidate matching steps: prefer Emily en-IE, fallback to any en-IE, then Emily any locale, then en-GB, then first English.
                    let emily = voices.find(v => /Emily/i.test(v.name) && /en-?IE/i.test(v.lang));
                    if (!emily) emily = voices.find(v => /en-?IE/i.test(v.lang));
                    if (!emily) emily = voices.find(v => /Emily/i.test(v.name));
                    if (!emily) emily = voices.find(v => /^en/i.test(v.lang));

                    if (emily) {
                        this.voiceSettings.selectedVoice = emily;
                        console.log('🎤 Selected voice:', emily.name, emily.lang);
                    } else {
                        console.log('🎤 No matching Emily/en-IE voice found - using default');
                    }
                };

                // populate voices - browsers may load them asynchronously
                if (this.speechSynthesis.getVoices().length === 0) {
                    this.speechSynthesis.addEventListener('voiceschanged', findAndForceEmily);
                } else {
                    findAndForceEmily();
                }

                // Minimal speech recognition support (kept simple)
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-GB';
                    this.recognition.onresult = (e) => this.handleVoiceInput(e.results[0][0].transcript);
                    this.recognition.onerror = (e) => { document.getElementById('voiceIndicator').style.display = 'none'; console.error(e); };
                    this.recognition.onend = () => { document.getElementById('voiceIndicator').style.display = 'none'; };
                }
            }

            // Speak with a short, natural pause to reduce robotic overlap
            speakMessage(message) {
                if (!this.speechSynthesis) return;

                // cancel any queued speech to avoid overlaps
                try { this.speechSynthesis.cancel(); } catch(e){}

                const clean = message.replace(/<[^>]*>/g, '').replace(/[\u{1F300}-\u{1F6FF}]/gu, '').replace(/\s+/g,' ').trim();
                if (!clean) return;

                const utter = new SpeechSynthesisUtterance(clean);
                utter.rate = this.voiceSettings.rate;
                utter.pitch = this.voiceSettings.pitch;
                utter.volume = this.voiceSettings.volume;
                if (this.voiceSettings.selectedVoice) utter.voice = this.voiceSettings.selectedVoice;

                // attach simple events for debugging
                utter.onstart = () => { /*console.log('Speech started')*/ };
                utter.onend = () => { /*console.log('Speech ended')*/ };

                // delay slightly to create a more human cadence
                setTimeout(() => this.speechSynthesis.speak(utter), 180);
            }

            stopAudio() { if (this.speechSynthesis) try { this.speechSynthesis.cancel(); } catch(e){} }
            toggleAudio() { const btn = document.getElementById('audioToggle'); btn.textContent = btn.textContent.includes('ON') ? '🔇 Audio: OFF' : '🔊 Audio: ON'; }

            startVoiceInput() {
                if (!this.recognition) { this.addMessage('bot','Sorry, voice input is not supported in your browser.'); return; }
                document.getElementById('voiceIndicator').style.display = 'inline-block';
                this.recognition.start();
            }

            startVoiceTraining() {
                const v = this.voiceSettings.selectedVoice ? `${this.voiceSettings.selectedVoice.name} (${this.voiceSettings.selectedVoice.lang})` : 'Default voice';
                this.addMessage('bot', `🎯 Voice: ${v}<br>Rate: ${this.voiceSettings.rate}, Pitch: ${this.voiceSettings.pitch}, Volume: ${this.voiceSettings.volume}`);
            }

            // ------------------- n8n integration
            // Prepare payload (re-using previous prepareMakeData logic, renamed)
            prepareN8nData() {
                const timestamp = new Date();
                const dateOnly = timestamp.toISOString().split('T')[0];
                const timeOnly = timestamp.toTimeString().split(' ')[0];

                return {
                    submission_id: `BIT-${Date.now()}`,
                    date: dateOnly,
                    time: timeOnly,
                    timestamp: timestamp.toISOString(),
                    full_name: this.candidateData.name || 'Not provided',
                    email: this.candidateData.personalDetails?.email || 'Not provided',
                    phone: this.candidateData.personalDetails?.mobile || 'Not provided',
                    overall_score: this.score,
                    max_score: 10,
                    score_percentage: Math.round((this.score / 10) * 100),
                    location: this.candidateData.location || 'Not assessed',
                    uk_residency: this.candidateData.ukResidency ? 'Eligible (3+ years)' : 'Not eligible',
                    funding_status: this.candidateData.fundingStatus || 'Not assessed',
                    availability: this.candidateData.availability || 'Not assessed',
                    recommendation: this.score >= 8 ? 'HIGHLY SUITABLE' : this.score >= 6 ? 'SUITABLE' : 'NOT SUITABLE',
                    bootcamp: 'AI Business Productivity Bootcamp',
                    program: 'Cornwall Skills Bootcamp',
                    detailed_responses: JSON.stringify(this.candidateData.responses || []),
                    personal_details_json: JSON.stringify(this.candidateData.personalDetails || {}),
                    source: 'AI Bootcamp Screening Chatbot',
                    session_id: Date.now()
                };
            }

            sendToN8n(payload) {
                if (!this.config.useN8nIntegration || !this.config.n8nWebhookURL) {
                    console.warn('n8n integration disabled or webhook URL missing');
                    return Promise.reject(new Error('n8n not configured'));
                }

                // Ensure URL is absolute & likely valid (basic safety check)
                try {
                    new URL(this.config.n8nWebhookURL);
                } catch (e) {
                    console.error('Invalid n8n webhook URL:', this.config.n8nWebhookURL);
                    return Promise.reject(new Error('Invalid n8n webhook URL'));
                }

                return fetch(this.config.n8nWebhookURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(async res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status} - ${res.statusText}`);
                    // try to parse json, but allow empty
                    try { return await res.json(); } catch(e){ return {}; }
                })
                .then(result => {
                    console.log('n8n webhook success', result);
                    this.addMessage('bot', `📤 <strong>Report sent to n8n</strong> — Submission ID: ${payload.submission_id}`);
                    return result;
                })
                .catch(err => {
                    console.error('n8n webhook failed', err);
                    this.addMessage('bot', `⚠️ Failed to send report to n8n: ${err.message}`);
                    throw err;
                });
            }

            // ------------------- overriding/ensuring completeAssessment exists
            // This implementation will run the final report generation, call n8n and also save to Firebase
            completeAssessment() {
                // Create final report HTML
                const recommendation = this.score >= 8 ? 'HIGHLY SUITABLE' : this.score >= 6 ? 'SUITABLE' : 'NOT SUITABLE';
                const reportEl = document.getElementById('finalReport');
                const details = `
                    <h4>📋 Final Assessment</h4>
                    <div><strong>Candidate:</strong> ${this.candidateData.name || 'Applicant'}</div>
                    <div><strong>Score:</strong> ${this.score}/10 (${Math.round((this.score/10)*100)}%)</div>
                    <div><strong>Recommendation:</strong> ${recommendation}</div>
                    <div style="margin-top:10px"><strong>Responses:</strong><pre style="white-space:pre-wrap">${JSON.stringify(this.candidateData.responses||[],null,2)}</pre></div>
                `;
                reportEl.innerHTML = details;
                reportEl.classList.remove('hidden');

                // Prepare payload
                const payload = this.prepareN8nData();

                // Send to n8n and then save to firebase as backup
                this.sendToN8n(payload)
                    .then(() => {
                        // also save to firebase if available
                        try { this.saveToFirebase(); } catch (e) { console.warn('Firebase save failed', e); }
                    })
                    .catch(err => {
                        // on failure still attempt firebase save
                        try { this.saveToFirebase(); } catch (e) { console.warn('Firebase save failed', e); }
                    });
            }

            // ------------------- Firebase helpers (kept minimal)
            initializeFirebase() {
                try {
                    if (typeof firebase === 'undefined') { this.updateFirebaseStatus('disconnected'); return; }
                    if (firebase.apps.length === 0) firebase.initializeApp(this.firebaseConfig);
                    this.database = firebase.database();
                    this.updateFirebaseStatus('connected');
                } catch (e) {
                    console.error('Firebase init error', e);
                    this.updateFirebaseStatus('disconnected');
                }
            }

            updateFirebaseStatus(status) {
                const s = document.getElementById('firebase-status');
                if (!s) return;
                if (status === 'connected') { s.className = 'firebase-status firebase-connected'; s.textContent = '🟢 Firebase Connected'; }
                else if (status === 'saving') { s.className = 'firebase-status firebase-saving'; s.textContent = '🟡 Saving to Cloud...'; }
                else { s.className = 'firebase-status firebase-disconnected'; s.textContent = '🔴 Firebase Offline'; }
            }

            saveToFirebase() {
                if (!this.database) { console.warn('No firebase database'); return; }
                const id = `candidate-${Date.now()}`;
                const payload = { id, candidate: this.candidateData, score: this.score, timestamp: new Date().toISOString() };
                this.updateFirebaseStatus('saving');
                this.database.ref(`bootcampCandidates/${id}`).set(payload).then(()=>{ this.updateFirebaseStatus('connected'); this.addMessage('bot','✅ Saved backup to Firebase'); }).catch(e=>{this.updateFirebaseStatus('disconnected');console.error(e)});
            }

            // ------------------- UI helpers & flow
            init() {
                this.addMessage('bot', `Hi ${this.candidateData.name}, this is the BIT Group AI assistant. I'll be conducting your screening.`);
                setTimeout(()=>this.showOptions(['Yes, that works for me','Can we reschedule?','I have a few minutes']),1400);
            }

            addMessage(sender, message) {
                const d = document.createElement('div'); d.className = `message ${sender}-message`; d.innerHTML = message; this.chatContainer.appendChild(d);
                // limit messages
                const msgs = this.chatContainer.querySelectorAll('.message'); if (msgs.length>40) msgs[0].remove();
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                if (sender==='bot') this.speakMessage(message);
            }

            showOptions(options) {
                this.responseButtons.innerHTML = '';
                options.forEach(opt=>{
                    const b = document.createElement('button'); b.className='btn btn-primary'; b.textContent=opt; b.onclick=()=>this.handleResponse(opt); this.responseButtons.appendChild(b);
                });
            }

            handleResponse(text) {
                this.addMessage('user', text);
                // simplistic scoring example - implement your real rules here
                this.candidateData.responses.push({ question: 'screening', answer: text, timestamp: new Date().toISOString() });
                if (/yes|works|good|ok/i.test(text)) this.score += 3;
                else if (/resched|schedule|later/i.test(text)) this.score += 1;
                else this.score += 2;

                // move through steps - for demo we complete after 3 responses
                if (this.candidateData.responses.length >= 3) {
                    this.completeAssessment();
                } else {
                    this.showOptions(['Continue','Not right now']);
                }
            }

            handleTextInput() { const q = (this.textInput.value||'').trim(); if (!q) return; this.textInput.value=''; this.addMessage('user', q); this.handleResponse(q); }
            handleVoiceInput(transcript) { this.addMessage('user', `🎤 "${transcript}"`); this.handleResponse(transcript); }
        }

        // Instantiate
        window.chatBot = new ChatBot();

    </script>
</body>
</html>
