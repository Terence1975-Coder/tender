<!-- FILE: index.html
     ThinkBIT Training - AI Bootcamp Screening Chatbot
     - n8n webhook integration (POST to http://localhost:5678/webhook-test/candidate-screening)
     - Irish "Emily" speechSynthesis voice forced when available
     - No Firebase (removed per request)
     - Styled to match ThinkBIT website colors/feel
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ThinkBIT Training ‚Äî AI Bootcamp Screening</title>
<style>
  /* ---------- Branding & Layout (ThinkBIT-like) ---------- */
  :root {
    --brand-deep: #0f2d40;    /* deep navy */
    --brand-accent: #8dc63f;  /* lime/green */
    --muted: #f5f8fa;
    --card: #ffffff;
    --text: #0f2d40;
    --soft-border: rgba(15,45,64,0.06);
    --radius: 12px;
  }

  html,body { height:100%; }
  body {
    margin:0;
    font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(180deg,var(--muted),#ffffff);
    color: var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
    padding:20px;
  }

  .app {
    width:100%;
    max-width:1100px;
    border-radius: var(--radius);
    overflow:hidden;
    box-shadow: 0 12px 40px rgba(10,20,30,0.08);
    background: linear-gradient(180deg, white, #fcfdff);
    display:grid;
    grid-template-columns: 1fr 360px;
    gap: 0;
  }

  /* header across full width */
  .header {
    grid-column: 1 / -1;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:16px;
    padding:18px 22px;
    background: linear-gradient(90deg,var(--brand-deep), #123247);
    color: #fff;
  }
  .brand {
    display:flex;
    gap:14px;
    align-items:center;
  }
  .brand-logo {
    width:52px;
    height:52px;
    border-radius:10px;
    background: linear-gradient(180deg,var(--brand-accent), #7bb12f);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#062230;
    font-weight:800;
    font-size:18px;
    letter-spacing:1px;
  }
  .brand h1 {
    font-size:18px;
    margin:0;
    line-height:1;
  }
  .brand h2 {
    margin:0;
    font-weight:600;
    font-size:12px;
    opacity:0.95;
    color: #eaf8d6;
  }
  .header .contact {
    font-size:13px;
    opacity:0.95;
  }

  /* Left (chat) */
  .chat-pane {
    padding:18px;
    display:flex;
    flex-direction:column;
    min-height:520px;
    gap:12px;
    border-right:1px solid var(--soft-border);
  }
  .chat-scroll {
    flex:1;
    overflow:auto;
    padding-right:8px;
  }
  .message {
    max-width:78%;
    padding:12px 14px;
    border-radius:12px;
    margin-bottom:10px;
    line-height:1.38;
  }
  .bot {
    background: linear-gradient(180deg,#eef8ed,#e6f4e8);
    border-left:4px solid var(--brand-accent);
    color:var(--text);
    align-self:flex-start;
    box-shadow: 0 2px 8px rgba(12,20,30,0.03);
  }
  .user {
    background: linear-gradient(180deg,#e9f2fb,#e0eefe);
    border-left:4px solid var(--brand-deep);
    align-self:flex-end;
    color:var(--text);
    text-align:right;
  }

  .typing {
    display:inline-block;
    padding:10px 14px;
    border-radius:20px;
    background:#f0f3f4;
    font-size:13px;
    color:#36454f;
  }

  /* Input area */
  .controls {
    padding-top:8px;
    display:flex;
    gap:12px;
    align-items:center;
  }
  .controls .input {
    flex:1;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .controls input[type="text"]{
    width:100%;
    padding:12px 14px;
    border-radius:10px;
    border:1px solid var(--soft-border);
    font-size:14px;
  }
  .controls .btn {
    background: var(--brand-accent);
    color:#062230;
    border:none;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
  }
  .controls .btn.gray {
    background:#f0f5f6;
    color:var(--text);
    border:1px solid var(--soft-border);
  }

  /* Right (panel) */
  .panel {
    padding:18px;
    background:#fbfcfd;
    min-height:520px;
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .panel h3 {
    margin:0 0 6px 0;
  }

  .card {
    background:white;
    border-radius:10px;
    padding:12px;
    border:1px solid var(--soft-border);
    box-shadow: 0 2px 12px rgba(12,20,30,0.02);
  }

  .criteria { display:flex; flex-direction:column; gap:8px; font-size:13px; }
  .criteria .row { display:flex; justify-content:space-between; align-items:center; padding:8px; border-radius:8px; }
  .pass { background:#eaf8e8; color:#16522a; border:1px solid #c2e8c9; }
  .fail { background:#fff2f2; color:#7a1b1b; border:1px solid #f3c6c6; }
  .wait { background:#fff9e6; color:#7a5a1a; border:1px solid #fae7b9; }

  .score {
    height:14px; background:#f1f4f5; border-radius:999px; overflow:hidden; margin-top:8px; border:1px solid var(--soft-border);
  }
  .score > i { display:block; height:100%; background: linear-gradient(90deg,#ff7a5a,#ffcc00,#8dc63f); width:0%; transition:width .6s ease; }

  .actions { display:flex; gap:8px; flex-wrap:wrap; }
  .small { font-size:13px; padding:8px 10px; border-radius:8px; }

  /* responsive */
  @media (max-width:980px){
    .app { grid-template-columns: 1fr; padding-bottom:10px; }
    .panel { order:2; }
  }
</style>
</head>
<body>
  <div class="app" id="appRoot">
    <div class="header">
      <div class="brand">
        <div class="brand-logo">BIT</div>
        <div>
          <h1>Think<span style="color:var(--brand-accent)">BIT</span> Training</h1>
          <h2>AI Business Productivity Bootcamp ‚Äî Screening Assistant</h2>
        </div>
      </div>
      <div class="contact">Need help? <strong style="color:var(--brand-accent)">+44 (0)1752 724 000</strong></div>
    </div>

    <!-- Chat pane -->
    <main class="chat-pane" aria-live="polite">
      <div id="chatScroll" class="chat-scroll" role="log" aria-atomic="false"></div>

      <section class="controls card" aria-label="Input controls">
        <div style="display:flex; gap:10px; align-items:center; width:100%;">
          <div class="input" style="flex:1">
            <input id="userText" type="text" placeholder="Type your response or question..." />
          </div>
          <div style="display:flex; gap:8px;">
            <button id="sendBtn" class="btn">Send</button>
            <button id="voiceBtn" class="btn gray">üé§ Voice</button>
            <button id="audioToggleBtn" class="btn gray">üîä Voice: ON</button>
          </div>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
          <div id="voiceInfo" style="font-size:13px; color:#355056; opacity:0.9;">Voice: <strong id="voiceName">Detecting...</strong></div>
          <div style="flex:1"></div>
          <div id="statusMsg" style="font-size:13px;color:#778899">Ready</div>
        </div>
      </section>
    </main>

    <!-- Right panel -->
    <aside class="panel">
      <div>
        <h3>Live assessment</h3>
        <div class="card">
          <div class="criteria">
            <div class="row pass"><div>üìç Location</div><div id="c-location">Pending</div></div>
            <div class="row pass"><div>üá¨üáß Residency</div><div id="c-residency">Pending</div></div>
            <div class="row pass"><div>üí∞ Funding</div><div id="c-funding">Pending</div></div>
            <div class="row pass"><div>üó£Ô∏è English level</div><div id="c-english">Pending</div></div>
          </div>

          <div style="margin-top:10px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <strong>Overall score</strong>
              <div id="scoreText">0 / 10</div>
            </div>
            <div class="score"><i id="scoreFill" style="width:0%"></i></div>
          </div>
        </div>
      </div>

      <div>
        <h3>Actions</h3>
        <div class="card actions">
          <button id="sendToN8nBtn" class="small" style="background:var(--brand-deep); color:#fff;">Send report to n8n</button>
          <button id="copyJsonBtn" class="small">Copy payload JSON</button>
          <button id="resetBtn" class="small">Reset session</button>
        </div>
      </div>

      <div>
        <h3>Final report</h3>
        <div id="finalCard" class="card" style="min-height:120px; font-size:14px;">
          <div id="finalText">No report yet.</div>
        </div>
      </div>

    </aside>
  </div>

<script>
/* ===========================
   Screening Chatbot (single-file)
   - No external dependencies
   - n8n integration built-in
   - Irish Emily voice prioritized
   =========================== */

// ---------- CONFIG ----------
const CONFIG = {
  n8nWebhookURL: 'http://localhost:5678/webhook-test/candidate-screening',
  // Optional header token for simple verification in n8n. Set to null to omit.
  webhookToken: null, // e.g. 'secret-abc-123'
  // Voice tuning
  voiceRate: 0.95,
  voicePitch: 1.02,
  voiceVolume: 1.0,
  // When true, send automatically at completion, otherwise user may click 'Send report to n8n'
  autoSendOnComplete: true,
  // Minimum responses before completing (for demo)
  minResponsesToComplete: 4
};

// ---------- STATE ----------
const STATE = {
  candidate: {
    name: null,
    personalDetails: null,
    location: null,
    ukResidency: null,
    fundingStatus: null,
    englishLevel: null,
    responses: []
  },
  score: 0,
  useAudio: true,
  speechVoice: null,
  voiceReady: false
};

// ---------- UI ELEMENTS ----------
const chatScroll = document.getElementById('chatScroll');
const userText = document.getElementById('userText');
const sendBtn = document.getElementById('sendBtn');
const voiceBtn = document.getElementById('voiceBtn');
const audioToggleBtn = document.getElementById('audioToggleBtn');
const voiceNameEl = document.getElementById('voiceName');
const statusMsg = document.getElementById('statusMsg');

const cLocation = document.getElementById('c-location');
const cResidency = document.getElementById('c-residency');
const cFunding = document.getElementById('c-funding');
const cEnglish = document.getElementById('c-english');
const scoreText = document.getElementById('scoreText');
const scoreFill = document.getElementById('scoreFill');

const sendToN8nBtn = document.getElementById('sendToN8nBtn');
const copyJsonBtn = document.getElementById('copyJsonBtn');
const resetBtn = document.getElementById('resetBtn');
const finalText = document.getElementById('finalText');

// ---------- Helpers: UI ----------
function appendBot(html) {
  const d = document.createElement('div');
  d.className = 'message bot';
  // allow basic markup
  d.innerHTML = html;
  chatScroll.appendChild(d);
  chatScroll.scrollTop = chatScroll.scrollHeight;
  speakIfAllowed(stripHtml(html));
}
function appendUser(text) {
  const d = document.createElement('div');
  d.className = 'message user';
  d.textContent = text;
  chatScroll.appendChild(d);
  chatScroll.scrollTop = chatScroll.scrollHeight;
}
function stripHtml(s){ return s.replace(/<[^>]*>/g,'').replace(/\s+/g,' ').trim(); }

// ---------- Voice: detection & forcing Emily (en-IE) ----------
function findPreferredVoice() {
  if (!('speechSynthesis' in window)) return null;
  const voices = window.speechSynthesis.getVoices() || [];

  // prefer voices that are en-IE and contain Emily
  let v = voices.find(x => /Emily/i.test(x.name) && /en-?IE/i.test(x.lang));
  if (!v) v = voices.find(x => /en-?IE/i.test(x.lang) && /female/i.test(x.name || ''));
  if (!v) v = voices.find(x => /Emily/i.test(x.name));
  // fallback to any english female or english voice
  if (!v) v = voices.find(x => /^en/i.test(x.lang) && /female/i.test(x.name || ''));
  if (!v) v = voices.find(x => /^en/i.test(x.lang));
  return v || null;
}

function initVoice() {
  if (!('speechSynthesis' in window)) {
    voiceNameEl.textContent = 'Not supported';
    STATE.voiceReady = false;
    return;
  }

  const setup = () => {
    const v = findPreferredVoice();
    if (v) {
      STATE.speechVoice = v;
      STATE.voiceReady = true;
      voiceNameEl.textContent = `${v.name} (${v.lang})`;
    } else {
      voiceNameEl.textContent = 'Default browser voice';
      STATE.voiceReady = true;
    }
  };

  // populate voices may be async
  const voices = window.speechSynthesis.getVoices();
  if (voices.length === 0) {
    window.speechSynthesis.addEventListener('voiceschanged', setup);
  } else {
    setup();
  }
}

function speakIfAllowed(text) {
  if (!STATE.useAudio) return;
  if (!('speechSynthesis' in window)) return;

  // Short guard to avoid speaking too-short or system messages
  if (!text || typeof text !== 'string' || text.length < 2) return;

  try {
    window.speechSynthesis.cancel();
  } catch(e){}

  const ut = new SpeechSynthesisUtterance(text);
  ut.rate = CONFIG.voiceRate;
  ut.pitch = CONFIG.voicePitch;
  ut.volume = CONFIG.voiceVolume;
  if (STATE.speechVoice) ut.voice = STATE.speechVoice;

  // tiny random pauses and slight variation to sound less robotic
  const jitter = (Math.random()*20 - 10)/1000; // -0.01 to +0.01
  setTimeout(() => {
    try { window.speechSynthesis.speak(ut); } catch(e){}
  }, 140 + (jitter*1000));
}

// ---------- Voice input (SpeechRecognition) ----------
let recognition = null;
function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    voiceBtn.style.display = 'none';
    return;
  }
  recognition = new SR();
  recognition.lang = 'en-GB';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.onresult = (ev) => {
    const text = (ev.results[0][0].transcript || '').trim();
    if (text) {
      userText.value = text;
      sendUserMessage();
    }
  };
  recognition.onerror = (ev) => {
    console.warn('Speech recognition error', ev);
    statusMsg.textContent = 'Voice input error';
    setTimeout(()=>statusMsg.textContent='Ready',2000);
  };
  recognition.onend = () => {
    voiceBtn.classList.remove('active');
    voiceBtn.textContent = 'üé§ Voice';
  };
}

// ---------- Core flow: simple screening -----
function sendUserMessage() {
  const text = userText.value.trim();
  if (!text) return;
  appendUser(text);
  recordResponse(text);
  userText.value = '';
}
sendBtn.addEventListener('click', sendUserMessage);
userText.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendUserMessage(); });

voiceBtn.addEventListener('click', () => {
  if (!recognition) { statusMsg.textContent = 'Voice not supported'; setTimeout(()=>statusMsg.textContent='Ready',1500); return; }
  try {
    recognition.start();
    voiceBtn.classList.add('active');
    voiceBtn.textContent = 'üé§ Listening...';
  } catch(e) {
    console.warn('recognition start error', e);
  }
});

audioToggleBtn.addEventListener('click', () => {
  STATE.useAudio = !STATE.useAudio;
  audioToggleBtn.textContent = STATE.useAudio ? 'üîä Voice: ON' : 'üîá Voice: OFF';
});

// ---------- Scoring & state ----------
function recordResponse(text) {
  const now = new Date().toISOString();
  STATE.candidate.responses.push({ text, timestamp: now });

  // very simple scoring heuristic (replace with your rules)
  if (/yes|definitely|sure|ok|great|works|ready/i.test(text)) {
    STATE.score += 3;
  } else if (/maybe|not sure|later/i.test(text)) {
    STATE.score += 1;
  } else {
    STATE.score += 2;
  }

  updateScoreUI();

  // sample quick checks to update criteria fields based on keywords
  if (/cornwall|penzance|truro|st austell|newquay/i.test(text)) {
    STATE.candidate.location = 'Cornwall';
    cLocation.textContent = 'Pass (Cornwall)';
    cLocation.className = '';
  } else if (/devon|exeter|plymouth/i.test(text)) {
    STATE.candidate.location = 'Devon';
    cLocation.textContent = 'Waiting list (Devon)';
    cLocation.className = '';
  }

  if (/3 years|3yrs|3\+ years|three years|3\+ yrs/i.test(text)) {
    STATE.candidate.ukResidency = true;
    cResidency.textContent = 'Pass (3+ years)';
  }

  if (/unemployed|self-?employed|fully funded|funded|¬£0/i.test(text)) {
    STATE.candidate.fundingStatus = 'Funded';
    cFunding.textContent = 'Pass (funded)';
  }

  if (/english (level|proficient)|fluent|native|good english/i.test(text)) {
    STATE.candidate.englishLevel = 'Good';
    cEnglish.textContent = 'Pass';
  }

  // complete when we've collected enough responses
  if (STATE.candidate.responses.length >= CONFIG.minResponsesToComplete) {
    // small delay for UX
    setTimeout(() => {
      completeAssessment();
    }, 650);
  } else {
    // continue prompt
    setTimeout(()=> appendBot(randomFollowUp()), 450);
  }
}

function updateScoreUI(){
  const capped = Math.min(10, STATE.score);
  scoreText.textContent = `${capped} / 10`;
  const pct = Math.min(100, Math.round((capped/10)*100));
  scoreFill.style.width = pct + '%';
}

// friendly follow-ups
function randomFollowUp(){
  const prompts = [
    "Can you confirm your full name and best email address for contact?",
    "Do you have any employer support or will you need funding?",
    "What days/times suit you for sessions ‚Äî evenings or daytime?",
    "Are you available for a 30-minute Teams interview if invited?"
  ];
  return prompts[Math.floor(Math.random()*prompts.length)];
}

// ---------- Finalize & prepare payload ----------
function assemblePayload() {
  const timestamp = new Date().toISOString();
  const payload = {
    submission_id: `TBT-${Date.now()}`,
    timestamp,
    candidate: STATE.candidate,
    score: Math.min(10, STATE.score),
    score_percentage: Math.round((Math.min(10, STATE.score)/10)*100),
    recommendation: STATE.score >= 8 ? 'HIGHLY SUITABLE' : (STATE.score >=6 ? 'SUITABLE' : 'NOT SUITABLE'),
    source: 'ThinkBIT Screening Chatbot',
    version: '1.0-n8n-voice'
  };
  return payload;
}

// ---------- send to n8n ----------
async function sendToN8n(payload, opts = {}) {
  const url = CONFIG.n8nWebhookURL;
  if (!url) throw new Error('n8n webhook URL not set');

  const headers = { 'Content-Type': 'application/json' };
  if (CONFIG.webhookToken) headers['X-Hook-Token'] = CONFIG.webhookToken;

  try {
    const res = await fetch(url, {
      method:'POST',
      headers,
      body: JSON.stringify(payload),
      // keep CORS default behaviour: n8n/local must accept CORS if you post from browser
      credentials: opts.credentials || 'omit'
    });

    // allow 2xx & 204
    if (!res.ok) {
      const txt = await res.text().catch(()=>res.statusText);
      throw new Error(`HTTP ${res.status} - ${txt}`);
    }

    // attempt parse, but accept empty responses
    let json = null;
    try { json = await res.json(); } catch(e){ json = null; }
    return json;
  } catch (err) {
    throw err;
  }
}

// ---------- completeAssessment ----------
let _completed = false;
function completeAssessment() {
  if (_completed) return;
  _completed = true;

  const payload = assemblePayload();
  const rec = payload.recommendation;

  appendBot(`<strong>Assessment complete</strong><br/>Recommendation: <strong style="color:${rec==='HIGHLY SUITABLE'?'green':rec==='SUITABLE'?'#e69900':'#c0392b'}">${rec}</strong>`);
  finalText.innerHTML = `
    <div><strong>Candidate:</strong> ${payload.candidate.personalDetails?.name || 'Not provided'}</div>
    <div><strong>Score:</strong> ${payload.score} (${payload.score_percentage}%)</div>
    <div style="margin-top:8px;"><strong>Submission ID:</strong> ${payload.submission_id}</div>
  `;

  // Auto-send if configured
  if (CONFIG.autoSendOnComplete) {
    appendBot('üì§ Sending report to automation...');
    sendToN8n(payload)
      .then(r => {
        appendBot('‚úÖ Report delivered to automation.');
        statusMsg.textContent = 'Report sent';
      })
      .catch(err => {
        appendBot(`<span style="color:#d9534f">‚ö†Ô∏è Failed to send to automation:</span> ${err.message}`);
        statusMsg.textContent = 'Send failed';
      });
  } else {
    statusMsg.textContent = 'Assessment complete ‚Äî ready to send';
  }
}

// ---------- UI buttons ----------
sendToN8nBtn.addEventListener('click', async () => {
  try {
    const payload = assemblePayload();
    appendBot('üì§ Sending report to automation (manually)...');
    await sendToN8n(payload);
    appendBot('‚úÖ Report delivered to automation.');
    statusMsg.textContent = 'Report sent';
  } catch (err) {
    appendBot(`<span style="color:#d9534f">‚ö†Ô∏è Failed to send to automation:</span> ${err.message}`);
    statusMsg.textContent = 'Send failed';
  }
});

copyJsonBtn.addEventListener('click', () => {
  const payload = assemblePayload();
  try {
    navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
    appendBot('üìã Payload JSON copied to clipboard.');
  } catch (e) {
    appendBot('‚ö†Ô∏è Cannot copy to clipboard in this environment. Open console to view payload.');
    console.log(payload);
  }
});

resetBtn.addEventListener('click', () => {
  if (!confirm('Reset session and clear responses?')) return;
  STATE.candidate = { name:null, personalDetails:null, location:null, ukResidency:null, fundingStatus:null, englishLevel:null, responses:[] };
  STATE.score = 0;
  _completed = false;
  chatScroll.innerHTML = '';
  finalText.innerHTML = 'No report yet.';
  cLocation.textContent = 'Pending';
  cResidency.textContent = 'Pending';
  cFunding.textContent = 'Pending';
  cEnglish.textContent = 'Pending';
  scoreText.textContent = '0 / 10';
  scoreFill.style.width = '0%';
  appendBot('üëã Session reset. Say hi to start a new screening.');
});

// ---------- startup messages & initialization ----------
function greet() {
  appendBot(`<strong>Welcome to ThinkBIT Training</strong><br>Hi ‚Äî I'm the AI screening assistant. I will run a quick eligibility check and record your responses. This will take around 5‚Äì10 minutes. Are you ready to begin?`);
}

(function boot() {
  initVoice();
  initRecognition();
  greet();
  // show detected voice after a short delay if async
  setTimeout(()=>{
    if (STATE.voiceReady) {
      voiceNameEl.textContent = STATE.speechVoice ? `${STATE.speechVoice.name} (${STATE.speechVoice.lang})` : voiceNameEl.textContent;
    }
  },600);
})();

</script>
</body>
</html>

