<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>SupaChargeAI – A2IA Interactive Trainer</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Framer Motion (optional) -->
    <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>

    <!-- Cytoscape for network graph -->
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.umd.js"></script>

    <!-- Firebase compat (single-file setup) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <style>
      :root { --accent: #ff8a3d; }
      .bg-accent { background: var(--accent); }
      .text-accent { color: var(--accent); }
      .border-soft { border-color: rgba(0,0,0,0.08); }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;
      const motion = (window.framerMotion && window.framerMotion.motion) || { div:(p)=><div {...p}/>, span:(p)=><span {...p}/> };

      // ===== Firebase config (given)
      const firebaseConfig = {
        apiKey: "AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
        authDomain: "prospecting-f2f42.firebaseapp.com",
        databaseURL: "https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "prospecting-f2f42",
        storageBucket: "prospecting-f2f42.firebasestorage.app",
        messagingSenderId: "292034226428",
        appId: "1:292034226428:web:878b867e3eb4d3e0098f79",
        measurementId: "G-WWB0JTX2L2"
      };
      let fbApp, fbAuth, fbDB;
      try { fbApp = firebase.initializeApp(firebaseConfig); fbAuth = firebase.auth(); fbDB = firebase.database(); } catch(e) { console.warn("Firebase init error:", e); }

      // ===== Data
      const LEVELS = ["Novice","Intermediate","Expert"];
      const WEEKS = [
        { id:"w1", title:"Week 1-2: AI Fundamentals for Business", sessions:[
          { id:"s1",  title:"Introduction to AI in the Workplace" },
          { id:"s2",  title:"Prompt Engineering Basics" },
          { id:"s3",  title:"AI Tools Overview" },
        ]},
        { id:"w2", title:"Week 3-4: AI for Productivity & Efficiency", sessions:[
          { id:"s4",  title:"Automating Repetitive Tasks" },
          { id:"s5",  title:"AI for Smarter Communication" },
          { id:"s6",  title:"AI for Data Handling" },
        ]},
        { id:"w3", title:"Week 5-6: AI for Decision Making", sessions:[
          { id:"s7",  title:"AI-Powered Research & Analysis" },
          { id:"s8",  title:"Predictive AI for Planning" },
          { id:"s9",  title:"AI in Strategic Meetings" },
        ]},
        { id:"w4", title:"Week 7-8: AI for Customer & Market Engagement", sessions:[
          { id:"s10", title:"AI in Customer Service" },
          { id:"s11", title:"AI for Personalised Marketing" },
          { id:"s12", title:"Market Intelligence with AI" },
        ]},
        { id:"w5", title:"Week 9-10: AI for Creativity & Problem-Solving", sessions:[
          { id:"s13", title:"AI for Brainstorming & Ideation" },
          { id:"s14", title:"Visual & Content Creation" },
          { id:"s15", title:"Solving Business Problems with AI" },
        ]},
        { id:"w6", title:"Week 11-12: Implementation & Future Trends", sessions:[
          { id:"s16", title:"Building an AI-Adoption Plan" },
          { id:"s17", title:"Ethics & Responsible AI Use" },
          { id:"s18", title:"Capstone Showcase" },
        ]},
      ];
      const OUTCOMES = [
        "Understand AI’s role in business",
        "Master prompt engineering",
        "Boost productivity with AI",
        "Enhance customer & market engagement",
        "Solve problems creatively",
        "Implement AI responsibly",
        "Build an AI-ready strategy",
      ];
      const ALL_SESSIONS = WEEKS.flatMap(w=>w.sessions);
      const byId = (id)=>ALL_SESSIONS.find(x=>x.id===id);

      // ===== Utils
      const DAY = 24*60*60*1000;
      const throttle = (fn, wait=800) => { let t=0, last=null; return (...a)=>{ const n=Date.now(); last=a; if(n-t>wait){ t=n; fn(...last);} }; };
      const fmtDate = (ms)=> new Date(ms).toLocaleDateString();

      // AES-GCM + PBKDF2 (for admin key backup)
      const enc = new TextEncoder(), dec = new TextDecoder();
      async function deriveKey(passphrase, salt) {
        const km = await crypto.subtle.importKey("raw", enc.encode(passphrase), {name:"PBKDF2"}, false, ["deriveKey"]);
        return crypto.subtle.deriveKey({name:"PBKDF2", salt, iterations:120000, hash:"SHA-256"}, km, {name:"AES-GCM", length:256}, false, ["encrypt","decrypt"]);
      }
      async function encryptToBase64(plain, pass) {
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const key = await deriveKey(pass, salt);
        const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, enc.encode(plain));
        const payload = new Uint8Array(salt.length + iv.length + cipher.byteLength);
        payload.set(salt,0); payload.set(iv,16); payload.set(new Uint8Array(cipher),28);
        return btoa(String.fromCharCode(...payload));
      }
      async function decryptFromBase64(b64, pass) {
        const buf = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
        const salt = buf.slice(0,16), iv = buf.slice(16,28), data = buf.slice(28);
        const key = await deriveKey(pass, salt);
        const plain = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, data);
        return dec.decode(plain);
      }

      // Tasks (level-aware)
      function tasksFor(session, level) {
        const hint = level==="Novice" ? "Guided steps + examples." : level==="Intermediate" ? "Less hand-holding; include choices." : "Open-ended; focus on outcomes & metrics.";
        const mk = (d,l,dt)=>({duration:d,label:l,detail:dt});
        const base = session.title;
        return {
          short: [ mk("2–5 min", `Micro-task: ${base}`, `${hint} Do a 1-step action tied to ${base}.`) ],
          medium:[ mk("15–30 min", `Applied: ${base}`, `${hint} Complete a mini workflow for ${base}.`) ],
          long:  [ mk("1–3 hrs", `Project: ${base}`, `${hint} Build an artefact/SOP for ${base} in context.`) ],
        };
      }

      // MCQs (2 per session)
      function mcqFor(session) {
        const s = session.title;
        return [
          { q:`What is the primary goal of "${s}"?`, choices:["Increase operational risk","Align AI use with a measurable business outcome","Replace every human task","Ignore data quality"], answer:1, why:"Business-first framing ensures measurable value." },
          { q:`Which action best reflects learning from "${s}"?`, choices:["Implement random tools without a plan","Design prompts/workflows mapped to a KPI","Block all automation","Wait for perfect data before any pilot"], answer:1, why:"Tie prompts/workflows to a KPI to validate value early." }
        ];
      }
      const MCQ = Object.fromEntries(ALL_SESSIONS.map(s=>[s.id, mcqFor(s)]));

      // Spaced repetition
      function nextSchedule(prev, correct, level) {
        const prevBox = prev?.box ?? 1;
        let box = correct ? Math.min(5, prevBox+1) : Math.max(1, prevBox-1);
        const gap = correct ? (level==="Novice"?3:level==="Intermediate"?5:7)*DAY : 1*DAY;
        return { box, next: Date.now()+gap, last: Date.now() };
      }

      // ===== UI Components
      function Header({theme,setTheme,level,setLevel}) {
        return (
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="w-9 h-9 rounded-2xl bg-accent" />
              <div>
                <div className="font-semibold">SupaChargeAI – Applied AI Associate (A2IA)</div>
                <div className="text-xs opacity-60">Interactive Training Tool</div>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <select value={level} onChange={(e)=>setLevel(e.target.value)} className="rounded-xl border border-soft px-3 py-2 bg-white">
                {LEVELS.map(l=><option key={l} value={l}>{l}</option>)}
              </select>
              <input type="color" value={theme.primary} onChange={(e)=>setTheme({primary:e.target.value})} className="w-10 h-10 p-0 rounded-xl border border-soft" title="Accent colour" />
              <a href="#/admin" className="text-xs underline">Admin</a>
            </div>
          </div>
        );
      }

      function Outcomes() {
        return (
          <div className="rounded-2xl border border-soft bg-white p-4">
            <div className="font-semibold mb-2">Learning Outcomes</div>
            <ul className="grid sm:grid-cols-2 gap-2 text-sm">
              {OUTCOMES.map((o,i)=><li key={i} className="rounded-xl border border-soft px-3 py-2">{o}</li>)}
            </ul>
          </div>
        );
      }

      function Graph({ onSelect, selected }) {
        const ref = useRef(null), cyRef = useRef(null);
        useEffect(()=>{
          if(!ref.current) return;
          const cy = cytoscape({
            container: ref.current,
            elements: [
              ...WEEKS.map(w=>({ data:{ id:w.id, label:w.title, type:"week" }})),
              ...ALL_SESSIONS.map(s=>({ data:{ id:s.id, label:s.title, type:"session" }})),
              ...WEEKS.flatMap(w=>w.sessions.map(s=>({ data:{ id:`e-${w.id}-${s.id}`, source:w.id, target:s.id }}))),
            ],
            style: [
              { selector:'node[type="week"]', style:{ 'background-color':'#fff','border-width':1,'border-color':'#ddd','label':'data(label)','text-wrap':'wrap','text-max-width':220,'padding':12,'shape':'round-rectangle','font-size':12 } },
              { selector:'node[type="session"]', style:{ 'background-color':'#fff','border-width':2,'border-color':'#bbb','label':'data(label)','text-wrap':'wrap','text-max-width':200,'padding':10,'shape':'round-rectangle','font-size':11 } },
              { selector:'edge', style:{ 'width':1,'line-color':'#ddd','target-arrow-shape':'triangle','target-arrow-color':'#ddd','curve-style':'bezier' } },
              { selector:'.selected', style:{ 'border-color':'var(--accent)','border-width':4 } },
            ],
            layout: { name:'breadthfirst', directed:true, spacingFactor:1.2, animate:false },
            wheelSensitivity: 0.2
          });
          cy.on('tap','node',(evt)=>{
            const n = evt.target;
            if(n.data('type')==='session'){
              const s = byId(n.id());
              if(s) onSelect(s);
            }
          });
          cyRef.current = cy;
          const rs = ()=>cy.resize();
          window.addEventListener('resize', rs);
          return ()=>{ window.removeEventListener('resize', rs); cy.destroy(); };
        }, [onSelect]);
        useEffect(()=>{
          const cy = cyRef.current; if(!cy) return;
          cy.nodes().forEach(n=>n.removeClass('selected'));
          if(selected){ const n = cy.getElementById(selected.id); if(n) n.addClass('selected'); }
        }, [selected]);
        return <div ref={ref} className="w-full h-96 rounded-2xl border border-soft bg-white" />;
      }

      function Whiteboard({notes,setNotes}) {
        const boardRef = useRef(null);
        const add = ()=> setNotes(n=>[...n, {id:crypto.randomUUID(), text:"New note", x:40, y:40}]);
        const remove = (id)=> setNotes(n=>n.filter(x=>x.id!==id));
        const onText = (id, text)=> setNotes(n=>n.map(x=>x.id===id?{...x,text}:x));
        return (
          <div className="rounded-2xl border border-soft bg-white p-3">
            <div className="flex items-center justify-between mb-2">
              <div className="font-semibold">Floating Whiteboard</div>
              <button onClick={add} className="text-xs underline">add note</button>
            </div>
            <div ref={boardRef} className="relative h-64 rounded-xl border border-dashed border-soft bg-[linear-gradient(90deg,rgba(0,0,0,0.03)_1px,transparent_1px),linear-gradient(rgba(0,0,0,0.03)_1px,transparent_1px)] bg-[size:20px_20px]">
              {notes.map(n=>(
                <div key={n.id} className="absolute w-40" style={{ left:n.x, top:n.y }}>
                  <div
                    className="cursor-move rounded-t-xl px-3 py-1 text-white"
                    style={{ background:'var(--accent)' }}
                    onMouseDown={(downEvt)=>{
                      const rect = boardRef.current.getBoundingClientRect();
                      const startX = downEvt.clientX - n.x - rect.left;
                      const startY = downEvt.clientY - n.y - rect.top;
                      const move = (e)=>{
                        const x = e.clientX - rect.left - startX;
                        const y = e.clientY - rect.top - startY;
                        setNotes(ns=>ns.map(xn=>xn.id===n.id?{...xn, x:Math.max(0,x), y:Math.max(0,y)}:xn));
                      };
                      const up = ()=>{ window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
                      window.addEventListener('mousemove', move);
                      window.addEventListener('mouseup', up);
                    }}
                    title="Drag"
                  >drag</div>
                  <textarea value={n.text} onChange={(e)=>onText(n.id,e.target.value)} className="w-40 h-24 rounded-b-xl border border-soft p-2 text-sm bg-white" />
                  <button onClick={()=>remove(n.id)} className="text-xs underline opacity-70 mt-1">remove</button>
                </div>
              ))}
            </div>
          </div>
        );
      }

      function ChatGPTPanel({adminApiKey, thread, setThread}) {
        const [userKey, setUserKey] = useState("");
        const [input, setInput] = useState("");
        const key = userKey || adminApiKey || "";

        const send = async ()=>{
          const msg = input.trim(); if(!msg) return;
          setThread(t=>[...t,{role:"user",content:msg}]);
          if(!key){
            setThread(t=>[...t,{role:"assistant",content:"(No API key) Example: outline steps, sample prompt, quick win."}]);
            setInput(""); return;
          }
          try{
            const res = await fetch("https://api.openai.com/v1/chat/completions",{
              method:"POST",
              headers:{ "Content-Type":"application/json", "Authorization":`Bearer ${key}` },
              body: JSON.stringify({
                model:"gpt-4o-mini",
                messages:[ {role:"system",content:"You are a concise, practical AI training assistant."}, ...thread, {role:"user",content:msg} ],
                temperature:0.4
              })
            });
            const data = await res.json();
            const text = data?.choices?.[0]?.message?.content || "(No content)";
            setThread(t=>[...t,{role:"assistant",content:text}]);
          } catch(e){ setThread(t=>[...t,{role:"assistant",content:`Error: ${e?.message||e}`}]); }
          finally{ setInput(""); }
        };

        return (
          <div className="rounded-2xl border border-soft bg-white p-4 h-full">
            <div className="font-semibold mb-2">ChatGPT Integration</div>
            <div className="text-xs opacity-70 mb-2">Using {userKey ? "your" : adminApiKey ? "admin" : "no"} key.</div>
            <input type="password" placeholder="OpenAI API Key (sk-...)" value={userKey} onChange={(e)=>setUserKey(e.target.value)} className="w-full rounded-xl border border-soft px-3 py-2 mb-2" />
            <div className="h-40 overflow-auto rounded-xl border border-soft p-2 mb-2 bg-gray-50">
              {thread.length===0 ? <div className="text-xs opacity-60">Start a conversation below.</div> : thread.map((m,i)=>(
                <div key={i} className="mb-2">
                  <span className="text-[10px] uppercase opacity-50 mr-2">{m.role}</span>
                  <span className="text-sm whitespace-pre-wrap">{m.content}</span>
                </div>
              ))}
            </div>
            <div className="flex gap-2">
              <textarea className="flex-1 rounded-xl border border-soft px-3 py-2" rows="2" placeholder="Ask or paste a prompt…" value={input} onChange={(e)=>setInput(e.target.value)} />
              <button className="rounded-xl px-3 py-2 bg-accent text-white" onClick={send}>Send</button>
            </div>
          </div>
        );
      }

      function QuizModal({session, level, onClose, onResult}) {
        const qs = MCQ[session.id] || [];
        const [idx,setIdx]=useState(0);
        const [choice,setChoice]=useState(null);
        const [showAns,setShowAns]=useState(false);
        const q = qs[idx];

        const submit = ()=>{ if(choice==null) return; setShowAns(true); };
        const next = ()=>{
          if(idx<qs.length-1){ setIdx(idx+1); setChoice(null); setShowAns(false); }
          else { const passed = choice===q.answer; onResult(passed); onClose(); }
        };
        const correct = (choice!=null && showAns) ? (choice===q.answer) : null;

        return (
          <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
            <div className="w-full max-w-lg rounded-2xl bg-white p-5 shadow-xl">
              <div className="flex items-center justify-between mb-2">
                <div className="font-semibold">Quiz – {session.title}</div>
                <div className="text-xs opacity-70">Level: {level}</div>
              </div>
              <div className="mb-3 text-sm">{q.q}</div>
              <div className="space-y-2">
                {q.choices.map((c,i)=>(
                  <label key={i} className={`block rounded-xl border p-2 cursor-pointer ${choice===i ? 'border-[var(--accent)]':'border-soft'}`}>
                    <input type="radio" name="mcq" className="mr-2" checked={choice===i} onChange={()=>setChoice(i)} />
                    {c}
                  </label>
                ))}
              </div>
              {showAns && <div className={`mt-3 text-sm ${correct?'text-green-600':'text-red-600'}`}>{correct?"Correct. ":"Not quite. "}{q.why}</div>}
              <div className="mt-4 flex justify-end gap-2">
                {!showAns ? (<>
                  <button className="px-3 py-2 rounded-xl border border-soft" onClick={onClose}>Cancel</button>
                  <button className="px-3 py-2 rounded-xl bg-accent text-white" onClick={submit}>Check</button>
                </>) : (
                  <button className="px-3 py-2 rounded-xl bg-accent text-white" onClick={next}>Next</button>
                )}
              </div>
            </div>
          </div>
        );
      }

      function LearningWorkspace({session, level, onClose, onQuizResult}) {
        const [tab,setTab]=useState("Instructions");
        const [quizOpen,setQuizOpen]=useState(false);
        const tasks = tasksFor(session, level);
        return (
          <div className="rounded-2xl border border-soft bg-white p-4">
            <div className="flex items-center justify-between mb-2">
              <div className="font-semibold">{session.title}</div>
              <button onClick={onClose} className="text-xs underline opacity-70">back to selection</button>
            </div>
            <div className="flex items-center gap-2 mb-3">
              {["Instructions","Tasks","Quiz"].map(t=>(
                <button key={t} onClick={()=>setTab(t)} className={`px-3 py-2 rounded-xl ${tab===t?'bg-accent text-white':'border border-soft'}`}>{t}</button>
              ))}
            </div>
            {tab==="Instructions" && (
              <div className="text-sm space-y-2">
                <p>What you’ll learn: align {session.title} with a measurable business outcome. Focus on outcomes, data quality, and ethics.</p>
                <ul className="list-disc ml-5">
                  <li>Key concept: value-first framing</li>
                  <li>Deliverable: 1 KPI-aligned workflow or prompt</li>
                  <li>Evidence: before/after metric or artefact</li>
                </ul>
              </div>
            )}
            {tab==="Tasks" && (
              <div className="grid md:grid-cols-3 gap-3">
                <TaskCol title="Short" items={tasks.short}/>
                <TaskCol title="Medium" items={tasks.medium}/>
                <TaskCol title="Long" items={tasks.long}/>
              </div>
            )}
            {tab==="Quiz" && (
              <div className="text-sm">
                <p className="mb-3">Test your understanding of this module.</p>
                <button className="px-3 py-2 rounded-xl bg-accent text-white" onClick={()=>setQuizOpen(true)}>Start Quiz</button>
              </div>
            )}
            {quizOpen && <QuizModal session={session} level={level} onClose={()=>setQuizOpen(false)} onResult={onQuizResult} />}
          </div>
        );
      }
      function TaskCol({title, items}) {
        return (
          <div className="rounded-xl border border-soft p-3">
            <div className="font-medium mb-2">{title}</div>
            <ul className="space-y-2 text-sm">
              {items.map((it,i)=>(
                <li key={i} className="rounded-lg border border-soft p-2">
                  <div className="flex items-center justify-between">
                    <span className="opacity-70">{it.duration}</span>
                    <span className="text-xs">{it.label}</span>
                  </div>
                  <div className="text-xs mt-1">{it.detail}</div>
                </li>
              ))}
            </ul>
          </div>
        );
      }

      function Admin() {
        const [uid,setUid]=useState(null);
        const [email,setEmail]=useState(""); const [password,setPassword]=useState("");
        const [apiKey,setApiKey]=useState(localStorage.getItem("a2ia_admin_api_key")||"");
        const [passphrase,setPassphrase]=useState("");
        const [cloudEnc,setCloudEnc]=useState(null);
        const [status,setStatus]=useState("");

        useEffect(()=>{ 
          if(!fbAuth) return;
          const unsub = fbAuth.onAuthStateChanged(u=>setUid(u?.uid||null));
          return ()=>unsub&&unsub();
        },[]);
        useEffect(()=>{
          if(!fbDB) return;
          const ref = fbDB.ref("/admin/apiKeyEnc");
          const cb = snap=> setCloudEnc(snap.val()||null);
          ref.on("value", cb);
          return ()=> ref.off("value", cb);
        },[]);

        const saveLocal = ()=>{ localStorage.setItem("a2ia_admin_api_key", apiKey); setStatus("Saved locally."); };
        const loadLocal = ()=>{ const v=localStorage.getItem("a2ia_admin_api_key")||""; setApiKey(v); setStatus(v?"Loaded local key.":"No local key."); };

        const backupToCloud = async ()=>{
          if(!uid){ setStatus("Sign in first."); return; }
          if(!apiKey){ setStatus("No API key."); return; }
          if(!passphrase){ setStatus("Enter passphrase."); return; }
          const encb64 = await encryptToBase64(apiKey, passphrase);
          await fbDB.ref("/admin/apiKeyEnc").set(encb64);
          setStatus("Encrypted backup saved to Firebase.");
        };
        const restoreFromCloud = async ()=>{
          if(!cloudEnc){ setStatus("No cloud backup."); return; }
          if(!passphrase){ setStatus("Enter passphrase to decrypt."); return; }
          try { const plain = await decryptFromBase64(cloudEnc, passphrase); setApiKey(plain); setStatus("Decrypted key restored (not auto-saved)."); }
          catch { setStatus("Decryption failed. Check passphrase."); }
        };

        const signIn = async ()=>{ try{ await fbAuth.signInWithEmailAndPassword(email,password); setStatus("Signed in."); } catch(e){ setStatus(e?.message||"Sign-in error"); } };
        const signUp = async ()=>{ try{ await fbAuth.createUserWithEmailAndPassword(email,password); setStatus("Account created. Sign in."); } catch(e){ setStatus(e?.message||"Sign-up error"); } };
        const signOut = async ()=>{ try{ await fbAuth.signOut(); setStatus("Signed out."); } catch(e){} };

        return (
          <div className="max-w-xl mx-auto p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <div className="font-semibold">Admin</div>
                <div className="text-xs opacity-70">UID: {uid||"-"}</div>
              </div>
              <a href="#/" className="text-xs underline">Back</a>
            </div>

            {!uid ? (
              <div className="rounded-2xl border border-soft bg-white p-4 mb-4">
                <div className="font-semibold mb-2">Sign In</div>
                <input className="w-full rounded-xl border border-soft px-3 py-2 mb-2" placeholder="Email" value={email} onChange={(e)=>setEmail(e.target.value)} />
                <input type="password" className="w-full rounded-xl border border-soft px-3 py-2 mb-2" placeholder="Password" value={password} onChange={(e)=>setPassword(e.target.value)} />
                <div className="flex gap-2">
                  <button className="px-3 py-2 rounded-xl bg-accent text-white" onClick={signIn}>Sign In</button>
                  <button className="px-3 py-2 rounded-xl border border-soft" onClick={signUp}>Create Account</button>
                </div>
              </div>
            ) : (
              <div className="mb-4">
                <button className="text-xs underline" onClick={signOut}>Sign out</button>
              </div>
            )}

            <div className="rounded-2xl border border-soft bg-white p-4 space-y-3">
              <div className="font-semibold">OpenAI API Key Vault</div>
              <input type="password" className="w-full rounded-xl border border-soft px-3 py-2" placeholder="API Key (sk-...)" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} />
              <div className="flex items-center gap-2">
                <button className="px-3 py-2 rounded-xl bg-accent text-white" onClick={saveLocal}>Save Locally</button>
                <button className="px-3 py-2 rounded-xl border border-soft" onClick={loadLocal}>Load Local</button>
              </div>
              <div className="text-xs opacity-70">Cloud backup (encrypted)</div>
              <input type="password" className="w-full rounded-xl border border-soft px-3 py-2" placeholder="Passphrase for encryption" value={passphrase} onChange={(e)=>setPassphrase(e.target.value)} />
              <div className="flex items-center gap-2">
                <button className="px-3 py-2 rounded-xl border border-soft" onClick={backupToCloud}>Backup to Firebase</button>
                <button className="px-3 py-2 rounded-xl border border-soft" onClick={restoreFromCloud}>Restore from Firebase</button>
              </div>
              <div className="text-xs opacity-70">{status}</div>
              <div className="text-xs opacity-60">
                Security: local save is plaintext in your browser; Firebase backup is encrypted with your passphrase; keep it safe.
              </div>
            </div>
          </div>
        );
      }

      function App() {
        const [theme,setTheme]=useState({ primary:"#ff8a3d" });
        const [level,setLevel]=useState("Novice");
        const [selected,setSelected]=useState(null);
        const [workspaceOpen,setWorkspaceOpen]=useState(false);

        const [notes,setNotes]=useState([]);
        const [progress,setProgress]=useState({});
        const [thread,setThread]=useState([]);
        const [adminApiKey,setAdminApiKey]=useState(localStorage.getItem("a2ia_admin_api_key"));

        useEffect(()=>{ document.documentElement.style.setProperty("--accent", theme.primary); },[theme]);

        // anon auth & cloud sync
        useEffect(()=>{
          if(!fbAuth || !fbDB) return;
          if(!fbAuth.currentUser){ fbAuth.signInAnonymously().catch(()=>{}); }
        },[]);
        useEffect(()=>{
          if(!fbAuth || !fbDB) return;
          const uid = fbAuth.currentUser?.uid;
          if(!uid) return;
          const ref = fbDB.ref(`/users/${uid}/a2iaState`);
          const cb = snap=>{
            const cloud = snap.val(); if(!cloud) return;
            setTheme(cloud.theme || {primary:"#ff8a3d"});
            setLevel(cloud.level || "Novice");
            setNotes(cloud.notes || []);
            setProgress(cloud.progress || {});
            setThread(cloud.thread || []);
          };
          ref.on('value', cb);
          return ()=> ref.off('value', cb);
        }, [fbAuth?.currentUser?.uid]);

        // local load
        useEffect(()=>{
          try{
            const st = JSON.parse(localStorage.getItem("a2ia_state")||"{}");
            if(st.theme) setTheme(st.theme);
            if(st.level) setLevel(st.level);
            if(st.notes) setNotes(st.notes);
            if(st.progress) setProgress(st.progress);
            if(st.thread) setThread(st.thread);
          } catch {}
        },[]);
        const persist = useMemo(()=>throttle((state)=>{
          localStorage.setItem("a2ia_state", JSON.stringify(state));
          if(fbAuth?.currentUser && fbDB){ fbDB.ref(`/users/${fbAuth.currentUser.uid}/a2iaState`).set({...state, _ts: Date.now()}).catch(()=>{}); }
        },1000),[]);
        useEffect(()=>{ persist({ theme, level, notes, progress, thread }); }, [theme, level, notes, progress, thread, persist]);

        const startLearning = ()=>{ if(!selected) return; setWorkspaceOpen(true); };
        const onQuizResult = (passed)=>{
          if(!selected) return;
          const sch = nextSchedule(progress[selected.id], passed, level);
          setProgress(p=>({ ...p, [selected.id]: sch }));
        };

        return (
          <div className="max-w-6xl mx-auto p-6">
            <Header theme={theme} setTheme={setTheme} level={level} setLevel={setLevel} />

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div className="lg:col-span-2 space-y-4">
                <div className="rounded-2xl border border-soft bg-white p-4">
                  <div className="font-semibold mb-2">Select a Module</div>
                  <Graph onSelect={setSelected} selected={selected} />
                  <div className="flex items-center justify-between mt-3">
                    <div className="text-sm opacity-70">
                      {selected ? <>Selected: <span className="font-medium">{selected.title}</span></> : "Pick a session node from the graph."}
                    </div>
                    <button className="px-3 py-2 rounded-xl bg-accent text-white disabled:opacity-50" disabled={!selected} onClick={startLearning}>
                      Start Learning
                    </button>
                  </div>
                </div>

                <Outcomes />
              </div>

              <div className="space-y-4">
                <Whiteboard notes={notes} setNotes={setNotes} />
                <ChatGPTPanel adminApiKey={adminApiKey} thread={thread} setThread={setThread} />
              </div>
            </div>

            {workspaceOpen && selected && (
              <div className="mt-4">
                <LearningWorkspace session={selected} level={level} onClose={()=>setWorkspaceOpen(false)} onQuizResult={onQuizResult} />
              </div>
            )}

            <footer className="mt-8 text-xs opacity-70 text-center">
              © 2025 Blue Screen IT Ltd. Course mapping used for interactive learning prototype.
            </footer>
          </div>
        );
      }

      // ===== Tiny router (hash)
      function Router() {
        const [route,setRoute]=useState(window.location.hash || "#/");
        useEffect(()=>{
          const onHash=()=>setRoute(window.location.hash || "#/");
          window.addEventListener("hashchange", onHash);
          return ()=>window.removeEventListener("hashchange", onHash);
        },[]);
        useEffect(()=>{
          // ensure anon auth for learner view
          if(route==="#/" && fbAuth && !fbAuth.currentUser){ fbAuth.signInAnonymously().catch(()=>{}); }
        },[route]);
        return route==="#/admin" ? <Admin/> : <App/>;
      }

      // ===== Mount
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<Router />);
    </script>
  </body>
</html>

