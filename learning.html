<!-- /index.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>SupaChargeAI – A2IA Interactive Trainer</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Framer Motion (optional) -->
    <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>

    <!-- Cytoscape for network graph -->
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.umd.js"></script>

    <!-- Firebase compat (easier single-file setup) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <style>
      :root { --accent: #ff8a3d; }
      .bg-accent { background: var(--accent); }
      .text-accent { color: var(--accent); }
      .border-soft { border-color: rgba(0,0,0,0.08); }
      .glass { backdrop-filter: blur(8px); background: rgba(255,255,255,0.6); }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
      // ===== Minimal globals
      const {useEffect,useMemo,useRef,useState} = React;
      const motion = (window.framerMotion && window.framerMotion.motion) || {div:(p)=><div {...p}/>,span:(p)=><span {...p}/>};

      // ===== Firebase init (provided config)
      const firebaseConfig = {
        apiKey: "AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
        authDomain: "prospecting-f2f42.firebaseapp.com",
        databaseURL: "https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "prospecting-f2f42",
        storageBucket: "prospecting-f2f42.firebasestorage.app",
        messagingSenderId: "292034226428",
        appId: "1:292034226428:web:878b867e3eb4d3e0098f79",
        measurementId: "G-WWB0JTX2L2"
      };
      let fbApp, fbAuth, fbDB;
      try {
        fbApp = firebase.initializeApp(firebaseConfig);
        fbAuth = firebase.auth();
        fbDB = firebase.database();
      } catch(e) {
        console.warn("Firebase init error:", e);
      }

      // ===== Data model
      const LEVELS = ["Novice","Intermediate","Expert"];

      const WEEKS = [
        { id:"w1", title:"Week 1-2: AI Fundamentals for Business", sessions:[
          { id:"s1",  title:"Introduction to AI in the Workplace" },
          { id:"s2",  title:"Prompt Engineering Basics" },
          { id:"s3",  title:"AI Tools Overview" },
        ]},
        { id:"w2", title:"Week 3-4: AI for Productivity & Efficiency", sessions:[
          { id:"s4",  title:"Automating Repetitive Tasks" },
          { id:"s5",  title:"AI for Smarter Communication" },
          { id:"s6",  title:"AI for Data Handling" },
        ]},
        { id:"w3", title:"Week 5-6: AI for Decision Making", sessions:[
          { id:"s7",  title:"AI-Powered Research & Analysis" },
          { id:"s8",  title:"Predictive AI for Planning" },
          { id:"s9",  title:"AI in Strategic Meetings" },
        ]},
        { id:"w4", title:"Week 7-8: AI for Customer & Market Engagement", sessions:[
          { id:"s10", title:"AI in Customer Service" },
          { id:"s11", title:"AI for Personalised Marketing" },
          { id:"s12", title:"Market Intelligence with AI" },
        ]},
        { id:"w5", title:"Week 9-10: AI for Creativity & Problem-Solving", sessions:[
          { id:"s13", title:"AI for Brainstorming & Ideation" },
          { id:"s14", title:"Visual & Content Creation" },
          { id:"s15", title:"Solving Business Problems with AI" },
        ]},
        { id:"w6", title:"Week 11-12: Implementation & Future Trends", sessions:[
          { id:"s16", title:"Building an AI-Adoption Plan" },
          { id:"s17", title:"Ethics & Responsible AI Use" },
          { id:"s18", title:"Capstone Showcase" },
        ]},
      ];

      const LEARNING_OUTCOMES = [
        "Understand AI’s role in business",
        "Master prompt engineering",
        "Boost productivity with AI",
        "Enhance customer & market engagement",
        "Solve problems creatively",
        "Implement AI responsibly",
        "Build an AI-ready strategy",
      ];

      const CHALLENGES = [
        {
          id:"c1",
          title:"Too many emails, not enough time",
          mapsTo:["s2","s4","s5"]
        },
        {
          id:"c2",
          title:"I want to create an app which…",
          mapsTo:["s2","s13","s14","s15"]
        },
        {
          id:"c3",
          title:"I need clarity on my data…",
          mapsTo:["s6","s7","s8"]
        },
        {
          id:"c4",
          title:"Improve customer experience fast",
          mapsTo:["s10","s11","s12"]
        },
        {
          id:"c5",
          title:"Plan an AI adoption roadmap",
          mapsTo:["s16","s17","s18"]
        },
      ];

      // ===== Helpers
      const byId = (id) => WEEKS.flatMap(w=>w.sessions).find(s=>s.id===id);
      const now = () => Date.now();
      const days = (n) => n*24*60*60*1000;
      const fmtDate = (ms) => new Date(ms).toLocaleDateString();

      // Task generator (level-aware)
      function tasksFor(session, level) {
        const L = level || "Novice";
        const t = (dur,label,detail) => ({ duration:dur, label, detail });
        const base = session.title;

        // why: templates ensure complete coverage without manual authoring per session
        const noviceHint = "Guided steps + examples.";
        const interHint = "Less hand-holding; include choices.";
        const expertHint = "Open-ended; focus on outcomes and metrics.";

        const hint = L==="Novice" ? noviceHint : L==="Intermediate" ? interHint : expertHint;

        return {
          short: [
            t("2–5 min", `Micro-task: ${base}`, `${hint} Do a 1-step action tied to ${base}.`),
          ],
          medium: [
            t("15–30 min", `Applied practice: ${base}`, `${hint} Complete an end-to-end mini workflow for ${base}.`),
          ],
          long: [
            t("1–3 hrs", `Project: ${base}`, `${hint} Build a small artefact or SOP demonstrating ${base} in context.`),
          ]
        };
      }

      // MCQ generator (2 Qs per session)
      function mcqFor(session) {
        const s = session.title;
        return [
          {
            q: `What is the primary goal of "${s}" in a business context?`,
            choices: [
              "Increase operational risk",
              "Align AI use with a real business outcome",
              "Replace every human task",
              "Ignore data quality"
            ],
            answer: 1,
            why: "Business-first framing ensures AI adds measurable value."
          },
          {
            q: `Which action best reflects learning from "${s}"?`,
            choices: [
              "Implementing random tools without a plan",
              "Designing prompts/workflows mapped to a KPI",
              "Blocking all automation",
              "Waiting for perfect data before any pilot"
            ],
            answer: 1,
            why: "Tie prompts/workflows to a KPI to validate value early."
          }
        ];
      }

      // Build MCQ bank
      const MCQ = Object.fromEntries(
        WEEKS.flatMap(w=>w.sessions).map(s => [s.id, mcqFor(s)])
      );

      // Spaced repetition schedule (Leitner-like)
      function nextSchedule(prevBox, correct, level) {
        const L = level || "Novice";
        let box = Math.max(1, Math.min(5, prevBox || 1));
        box = correct ? Math.min(5, box+1) : Math.max(1, box-1);

        const gap = correct
          ? (L==="Novice" ? days(3) : L==="Intermediate" ? days(5) : days(7))
          : days(1);

        return { box, next: now() + gap };
      }

      // Throttle
      function throttle(fn, wait=800) {
        let t = 0, lastArgs=null;
        return (...args) => {
          const n = Date.now();
          lastArgs = args;
          if (n - t > wait) {
            t = n; fn(...lastArgs);
          }
        };
      }

      // ===== Components
      function Header({theme,setTheme,level,setLevel}) {
        return (
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="w-9 h-9 rounded-2xl bg-accent" />
              <div>
                <div className="font-semibold">SupaChargeAI – Applied AI Associate (A2IA)</div>
                <div className="text-xs opacity-60">Interactive Training Tool</div>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <select
                value={level}
                onChange={(e)=>setLevel(e.target.value)}
                className="rounded-xl border border-soft px-3 py-2 bg-white"
                title="Skill level"
              >
                {LEVELS.map(l=><option key={l} value={l}>{l}</option>)}
              </select>
              <input
                type="color"
                value={theme.primary}
                onChange={(e)=>setTheme({primary:e.target.value})}
                className="w-10 h-10 p-0 rounded-xl border border-soft"
                title="Accent colour"
              />
            </div>
          </div>
        );
      }

      function Outcomes() {
        return (
          <div className="rounded-2xl border border-soft bg-white p-4">
            <div className="font-semibold mb-2">Learning Outcomes</div>
            <ul className="grid sm:grid-cols-2 gap-2 text-sm">
              {LEARNING_OUTCOMES.map((o,i)=>(
                <li key={i} className="rounded-xl border border-soft px-3 py-2">{o}</li>
              ))}
            </ul>
          </div>
        );
      }

      function Graph({path, onSelect}) {
        const ref = useRef(null);
        useEffect(()=>{
          if (!ref.current) return;
          const cy = cytoscape({
            container: ref.current,
            elements: [
              ...WEEKS.map(w=>({ data:{ id:w.id, label:w.title, type:"week" }})),
              ...WEEKS.flatMap(w=>w.sessions.map(s=>({ data:{ id:s.id, label:s.title, type:"session" }}))),
              ...WEEKS.flatMap(w=>w.sessions.map(s=>({ data:{ id:`e-${w.id}-${s.id}`, source:w.id, target:s.id }}))),
            ],
            style: [
              { selector: 'node[type="week"]', style: { 'background-color':'#fff','border-width':1,'border-color':'#ddd','label':'data(label)','text-wrap':'wrap','text-max-width':220,'padding':12,'shape':'round-rectangle','font-size':12 } },
              { selector: 'node[type="session"]', style: { 'background-color':'#fff','border-width':2,'border-color':'#bbb','label':'data(label)','text-wrap':'wrap','text-max-width':200,'padding':10,'shape':'round-rectangle','font-size':11 } },
              { selector: 'edge', style: { 'width':1,'line-color':'#ddd','target-arrow-shape':'triangle','target-arrow-color':'#ddd','curve-style':'bezier' } },
              { selector: '.in-path', style: { 'border-color':'var(--accent)','border-width':3,'color':'#111' } },
            ],
            layout: { name:'breadthfirst', directed:true, spacingFactor: 1.2, animate:false },
            wheelSensitivity: 0.2
          });

          cy.on('tap', 'node', (evt)=>{
            const n = evt.target;
            const id = n.data('id');
            const s = byId(id);
            if (s) onSelect(s);
          });

          // Highlight path nodes
          const ids = new Set(path.map(p=>p.id));
          cy.nodes().forEach(n=>{
            if (ids.has(n.id())) n.addClass('in-path'); else n.removeClass('in-path');
          });

          const handle = () => cy.resize();
          window.addEventListener('resize', handle);
          return ()=>{ window.removeEventListener('resize', handle); cy.destroy(); };
        }, [ref, path]);
        return <div ref={ref} className="w-full h-96 rounded-2xl border border-soft bg-white" />;
      }

      function SessionPanel({session, level, onAddToPath, onStartQuiz, progress}) {
        if (!session) return (
          <div className="rounded-2xl border border-soft bg-white p-4">
            <div className="font-semibold mb-2">Session Details</div>
            <div className="text-sm opacity-60">Select a session from the network to view tasks, then add it to your path.</div>
          </div>
        );

        const t = tasksFor(session, level);
        const pr = progress[session.id];
        return (
          <div className="rounded-2xl border border-soft bg-white p-4 space-y-3">
            <div className="flex items-center justify-between">
              <div className="font-semibold">{session.title}</div>
              <div className="text-xs opacity-70">Level: {level}</div>
            </div>

            {pr && pr.next ? (
              <div className="text-xs">
                Next review: <span className="font-medium">{fmtDate(pr.next)}</span> · Box {pr.box || 1}
              </div>
            ) : (
              <div className="text-xs opacity-70">No review scheduled yet.</div>
            )}

            <div className="grid md:grid-cols-3 gap-3">
              <TaskCard title="Short" items={t.short}/>
              <TaskCard title="Medium" items={t.medium}/>
              <TaskCard title="Long" items={t.long}/>
            </div>

            <div className="flex gap-2">
              <button className="px-3 py-2 rounded-xl bg-accent text-white" onClick={()=>onAddToPath(session)}>Add to Path</button>
              <button className="px-3 py-2 rounded-xl border border-soft" onClick={()=>onStartQuiz(session)}>Start Quiz</button>
            </div>
          </div>
        );
      }

      function TaskCard({title, items}) {
        return (
          <div className="rounded-xl border border-soft p-3">
            <div className="font-medium mb-2">{title}</div>
            <ul className="space-y-2 text-sm">
              {items.map((it,i)=>(
                <li key={i} className="rounded-lg border border-soft p-2">
                  <div className="flex items-center justify-between">
                    <span className="opacity-70">{it.duration}</span>
                    <span className="text-xs">{it.label}</span>
                  </div>
                  <div className="text-xs mt-1">{it.detail}</div>
                </li>
              ))}
            </ul>
          </div>
        );
      }

      function ChallengesPanel({onPick, onAddToPath}) {
        return (
          <div className="rounded-2xl border border-soft bg-white p-4">
            <div className="font-semibold mb-2">Learn by Challenge/Opportunity</div>
            <ul className="space-y-3">
              {CHALLENGES.map(c=>(
                <li key={c.id} className="rounded-xl border border-soft p-3">
                  <div className="font-medium mb-1">{c.title}</div>
                  <div className="text-xs opacity-70 mb-2">Mapped sessions:</div>
                  <div className="flex flex-wrap gap-2">
                    {c.mapsTo.map(id=>{
                      const s = byId(id);
                      return (
                        <button key={id} className="text-xs px-2 py-1 rounded-lg border border-soft" onClick={()=>onPick(s)}>{s?.title}</button>
                      );
                    })}
                  </div>
                  <div className="mt-2">
                    <button className="text-xs underline" onClick={()=>c.mapsTo.forEach(id=>{ const s=byId(id); if(s) onAddToPath(s); })}>
                      Add all to path
                    </button>
                  </div>
                </li>
              ))}
            </ul>
          </div>
        );
      }

      function PathPanel({path, onRemove, onClear}) {
        return (
          <div className="rounded-2xl border border-soft bg-white p-4">
            <div className="flex items-center justify-between mb-2">
              <div className="font-semibold">Your Path</div>
              <button className="text-xs underline opacity-70" onClick={onClear} disabled={!path.length}>clear</button>
            </div>
            {path.length===0 ? (
              <div className="text-xs opacity-60">No sessions yet.</div>
            ) : (
              <ul className="space-y-2">
                {path.map(s=>(
                  <li key={s.id} className="flex items-center justify-between rounded-lg border border-soft p-2">
                    <span className="text-sm">{s.title}</span>
                    <button onClick={()=>onRemove(s.id)} className="text-xs underline opacity-70">remove</button>
                  </li>
                ))}
              </ul>
            )}
          </div>
        );
      }

      function Whiteboard({notes,setNotes,theme}) {
        const boardRef = useRef(null);
        const add = () => {
          setNotes(n => [...n, { id: crypto.randomUUID(), text:"New note", x: 40, y: 40 }]);
        };
        const onDrag = (id, e) => {
          // why: direct DOM coords keep it simple in a single file
          const rect = boardRef.current.getBoundingClientRect();
          const x = e.clientX - rect.left - 60;
          const y = e.clientY - rect.top - 20;
          setNotes(ns => ns.map(n => n.id===id ? {...n, x:Math.max(0,x), y:Math.max(0,y)} : n));
        };
        const onText = (id, value) => setNotes(ns => ns.map(n => n.id===id ? {...n, text:value} : n));
        const remove = (id) => setNotes(ns => ns.filter(n=>n.id!==id));

        return (
          <div className="rounded-2xl border border-soft bg-white p-3">
            <div className="flex items-center justify-between mb-2">
              <div className="font-semibold">Floating Whiteboard</div>
              <button onClick={add} className="text-xs underline">add note</button>
            </div>
            <div ref={boardRef} className="relative h-64 rounded-xl border border-dashed border-soft bg-[linear-gradient(90deg,rgba(0,0,0,0.03)_1px,transparent_1px),linear-gradient(rgba(0,0,0,0.03)_1px,transparent_1px)] bg-[size:20px_20px]">
              {notes.map(n=>(
                <div key={n.id}
                  className="absolute w-40"
                  style={{ left:n.x, top:n.y }}
                >
                  <div
                    className="cursor-move rounded-t-xl px-3 py-1 text-white"
                    style={{ background: 'var(--accent)' }}
                    onMouseDown={(downEvt)=>{
                      const move = (e)=>onDrag(n.id,e);
                      const up = ()=>{ window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
                      window.addEventListener('mousemove', move);
                      window.addEventListener('mouseup', up);
                    }}
                    title="Drag"
                  >drag</div>
                  <textarea
                    value={n.text}
                    onChange={(e)=>onText(n.id,e.target.value)}
                    className="w-40 h-24 rounded-b-xl border border-soft p-2 text-sm"
                  />
                  <button onClick={()=>remove(n.id)} className="text-xs underline opacity-70 mt-1">remove</button>
                </div>
              ))}
            </div>
          </div>
        );
      }

      function ChatGPTPanel({apiKey,setApiKey,thread,setThread,level}) {
        const [goal,setGoal]=useState("");
        const [constraints,setConstraints]=useState("");
        const [input,setInput]=useState("");

        const buildPrompt = ()=>{
          const pre = `Role: You are a helpful AI coach for ${level} learners.\nGoal: ${goal || "Help me apply AI effectively."}\nConstraints: ${constraints || "Keep it actionable and safe."}\nTask: Provide step-by-step guidance, a sample prompt, and a quick win in 5 minutes.`;
          setInput(pre);
        };

        const send = async ()=>{
          const msg = input.trim();
          if (!msg) return;
          setThread(t=>[...t, {role:"user", content:msg}]);
          if (!apiKey) {
            setThread(t=>[...t, {role:"assistant", content:"(No API key set) Example response: Outline steps, create a prompt, suggest a quick win."}]);
            setInput(""); return;
          }
          try {
            const res = await fetch("https://api.openai.com/v1/chat/completions",{
              method:"POST",
              headers:{
                "Content-Type":"application/json",
                "Authorization":`Bearer ${apiKey}`
              },
              body: JSON.stringify({
                model: "gpt-4o-mini",
                messages: [
                  { role:"system", content:"You are a concise, practical AI training assistant."},
                  ...thread.map(m=>({role:m.role, content:m.content})),
                  { role:"user", content: msg }
                ],
                temperature: 0.4
              })
            });
            const data = await res.json();
            const text = data?.choices?.[0]?.message?.content || "(No content)";
            setThread(t=>[...t, {role:"assistant", content:text}]);
          } catch (e) {
            setThread(t=>[...t, {role:"assistant", content:`Error: ${e?.message || e}` }]);
          } finally {
            setInput("");
          }
        };

        return (
          <div className="rounded-2xl border border-soft bg-white p-4 h-full">
            <div className="font-semibold mb-2">ChatGPT Integration</div>
            <div className="grid sm:grid-cols-2 gap-2 mb-3">
              <input
                type="password"
                placeholder="OpenAI API Key (sk-...)"
                value={apiKey}
                onChange={(e)=>setApiKey(e.target.value)}
                className="rounded-xl border border-soft px-3 py-2"
              />
              <button className="rounded-xl px-3 py-2 bg-accent text-white" onClick={buildPrompt}>Build Prompt from Goal</button>
            </div>
            <div className="grid sm:grid-cols-2 gap-2 mb-3">
              <input className="rounded-xl border border-soft px-3 py-2" placeholder="Your goal..." value={goal} onChange={(e)=>setGoal(e.target.value)} />
              <input className="rounded-xl border border-soft px-3 py-2" placeholder="Constraints..." value={constraints} onChange={(e)=>setConstraints(e.target.value)} />
            </div>
            <div className="h-40 overflow-auto rounded-xl border border-soft p-2 mb-2 bg-gray-50">
              {thread.length===0 ? <div className="text-xs opacity-60">Start a conversation below.</div> : thread.map((m,i)=>(
                <div key={i} className="mb-2">
                  <span className="text-[10px] uppercase opacity-50 mr-2">{m.role}</span>
                  <span className="text-sm whitespace-pre-wrap">{m.content}</span>
                </div>
              ))}
            </div>
            <div className="flex gap-2">
              <textarea className="flex-1 rounded-xl border border-soft px-3 py-2" rows="2" placeholder="Type or build a prompt…" value={input} onChange={(e)=>setInput(e.target.value)} />
              <button className="rounded-xl px-3 py-2 bg-accent text-white" onClick={send}>Send</button>
            </div>
          </div>
        );
      }

      function QuizModal({session, onClose, level, onResult}) {
        const [idx,setIdx]=useState(0);
        const [choice,setChoice]=useState(null);
        const [showAns,setShowAns]=useState(false);
        const qs = MCQ[session.id] || [];
        const q = qs[idx];

        if (!q) return null;

        const submit = ()=>{
          if (choice==null) return;
          setShowAns(true);
        };

        const next = ()=>{
          if (idx < qs.length-1) {
            setIdx(idx+1); setChoice(null); setShowAns(false);
          } else {
            const correctCount = qs.reduce((acc,_,i)=> acc + (i===idx ? (choice===q.answer?1:0) : 1), 0); // last screen includes current choice
            const passed = correctCount >= Math.ceil(qs.length*0.5);
            onResult(passed);
            onClose();
          }
        };

        const correct = (choice!=null && showAns) ? (choice===q.answer) : null;

        return (
          <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
            <div className="w-full max-w-lg rounded-2xl bg-white p-5 shadow-xl">
              <div className="flex items-center justify-between mb-2">
                <div className="font-semibold">Quiz – {session.title}</div>
                <div className="text-xs opacity-70">Level: {level}</div>
              </div>
              <div className="mb-3 text-sm">{q.q}</div>
              <div className="space-y-2">
                {q.choices.map((c,i)=>(
                  <label key={i} className={`block rounded-xl border p-2 cursor-pointer ${choice===i ? 'border-[var(--accent)]' : 'border-soft'}`}>
                    <input type="radio" name="mcq" className="mr-2" checked={choice===i} onChange={()=>setChoice(i)} />
                    {c}
                  </label>
                ))}
              </div>

              {showAns && (
                <div className={`mt-3 text-sm ${correct ? 'text-green-600' : 'text-red-600'}`}>
                  {correct ? "Correct. " : "Not quite. "} {q.why}
                </div>
              )}

              <div className="mt-4 flex justify-end gap-2">
                {!showAns ? (
                  <>
                    <button className="px-3 py-2 rounded-xl border border-soft" onClick={onClose}>Cancel</button>
                    <button className="px-3 py-2 rounded-xl bg-accent text-white" onClick={submit}>Check</button>
                  </>
                ) : (
                  <button className="px-3 py-2 rounded-xl bg-accent text-white" onClick={next}>Next</button>
                )}
              </div>
            </div>
          </div>
        );
      }

      // ===== Main App
      function App() {
        const [theme,setTheme] = useState({ primary:"#ff8a3d" });
        const [level,setLevel] = useState("Novice");
        const [mode,setMode] = useState("Topics");
        const [path,setPath] = useState([]);
        const [selected,setSelected] = useState(null);
        const [notes,setNotes] = useState([]);
        const [quizFor,setQuizFor] = useState(null);
        const [progress,setProgress] = useState({}); // sessionId -> {box,next,last}
        const [apiKey,setApiKey] = useState("");
        const [thread,setThread] = useState([]);
        const [fbUser,setFbUser] = useState(null);

        // theme sync
        useEffect(()=>{ document.documentElement.style.setProperty("--accent", theme.primary); }, [theme]);

        // load from local
        useEffect(()=>{
          const raw = localStorage.getItem("a2ia_state");
          if (raw) {
            try {
              const s = JSON.parse(raw);
              if (s.theme) setTheme(s.theme);
              if (s.level) setLevel(s.level);
              if (s.path) setPath(s.path);
              if (s.notes) setNotes(s.notes);
              if (s.progress) setProgress(s.progress);
              if (s.thread) setThread(s.thread);
              if (s.apiKey) setApiKey(s.apiKey);
            } catch {}
          }
        },[]);

        // firebase auth + sync
        useEffect(()=>{
          if (!fbAuth || !fbDB) return;
          let unsub = fbAuth.onAuthStateChanged(async (user)=>{
            if (!user) {
              try { await fbAuth.signInAnonymously(); } catch(e){ console.warn("Anon auth failed", e); }
              return;
            }
            setFbUser(user);
            const ref = fbDB.ref(`/users/${user.uid}/a2iaState`);
            ref.on('value', snap=>{
              const cloud = snap.val();
              if (cloud && cloud._ts && (!localStorage.getItem("a2ia_cloud_ts") || cloud._ts > Number(localStorage.getItem("a2ia_cloud_ts")))) {
                // merge – local takes precedence for apiKey for privacy
                setTheme(cloud.theme || {primary:"#ff8a3d"});
                setLevel(cloud.level || "Novice");
                setPath(cloud.path || []);
                setNotes(cloud.notes || []);
                setProgress(cloud.progress || {});
                setThread(cloud.thread || []);
                localStorage.setItem("a2ia_cloud_ts", String(cloud._ts));
              }
            });
          });
          return ()=>unsub && unsub();
        },[]);

        const saveLocalAndCloud = useMemo(()=>throttle((state)=>{
          localStorage.setItem("a2ia_state", JSON.stringify(state));
          if (fbUser && fbDB) {
            const ref = fbDB.ref(`/users/${fbUser.uid}/a2iaState`);
            const { apiKey, ...safe } = state; // why: never store API key in cloud
            ref.set({ ...safe, _ts: Date.now() }).catch(()=>{});
            localStorage.setItem("a2ia_cloud_ts", String(Date.now()));
          }
        }, 1000), [fbUser]);

        // persist on changes
        useEffect(()=>{
          saveLocalAndCloud({ theme, level, path, notes, progress, thread, apiKey });
        }, [theme, level, path, notes, progress, thread, apiKey, saveLocalAndCloud]);

        const addToPath = (s)=> setPath(p => p.some(x=>x.id===s.id) ? p : [...p, s]);
        const removeFromPath = (id)=> setPath(p => p.filter(x=>x.id!==id));
        const clearPath = ()=> setPath([]);

        const handleQuizResult = (passed)=>{
          const prev = progress[quizFor.id] || { box:1, next:0, last:0 };
          const sch = nextSchedule(prev.box, passed, level);
          setProgress(pr => ({ ...pr, [quizFor.id]: { box: sch.box, next: sch.next, last: now() } }));
          if (passed) {
            // auto-advance to next session in global sequence
            const all = WEEKS.flatMap(w=>w.sessions);
            const idx = all.findIndex(x=>x.id===quizFor.id);
            const next = all[idx+1];
            if (next) addToPath(next);
          }
        };

        return (
          <div className="max-w-6xl mx-auto p-6">
            <Header theme={theme} setTheme={setTheme} level={level} setLevel={setLevel} />

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
              <div className="lg:col-span-2 space-y-4">
                <div className="rounded-2xl border border-soft bg-white p-2">
                  <div className="flex items-center gap-2 p-2">
                    <button className={`px-3 py-2 rounded-xl ${mode==="Topics"?"bg-accent text-white":"border border-soft"}`} onClick={()=>setMode("Topics")}>Topics</button>
                    <button className={`px-3 py-2 rounded-xl ${mode==="Challenges"?"bg-accent text-white":"border border-soft"}`} onClick={()=>setMode("Challenges")}>Challenges</button>
                  </div>
                  <div className="p-2">
                    <Graph path={path} onSelect={setSelected}/>
                  </div>
                </div>

                {mode==="Challenges" ? (
                  <ChallengesPanel onPick={setSelected} onAddToPath={addToPath}/>
                ) : (
                  <Outcomes />
                )}

                <div className="rounded-2xl border border-soft p-4 bg-white">
                  <div className="font-semibold mb-2">Session</div>
                  <SessionPanel
                    session={selected}
                    level={level}
                    onAddToPath={addToPath}
                    onStartQuiz={(s)=>setQuizFor(s)}
                    progress={progress}
                  />
                </div>
              </div>

              <div className="space-y-4">
                <PathPanel path={path} onRemove={removeFromPath} onClear={clearPath} />
                <Whiteboard notes={notes} setNotes={setNotes} theme={theme} />
              </div>
            </div>

            <div className="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-3">
              <ChatGPTPanel apiKey={apiKey} setApiKey={setApiKey} thread={thread} setThread={setThread} level={level} />
              <div className="rounded-2xl border border-soft bg-white p-4">
                <div className="font-semibold mb-2">Course Weeks & Sessions</div>
                <div className="grid md:grid-cols-2 gap-3">
                  {WEEKS.map(w=>(
                    <div key={w.id} className="rounded-xl border border-soft">
                      <div className="px-3 py-2 bg-gray-50 rounded-t-xl font-medium">{w.title}</div>
                      <ul className="p-2 space-y-2">
                        {w.sessions.map(s=>(
                          <li key={s.id} className="flex items-center justify-between rounded-lg border border-soft p-2">
                            <span className="text-sm">{s.title}</span>
                            <div className="flex gap-2">
                              <button className="text-xs underline" onClick={()=>addToPath(s)}>add</button>
                              <button className="text-xs underline" onClick={()=>setSelected(s)}>view</button>
                              <button className="text-xs underline" onClick={()=>setQuizFor(s)}>quiz</button>
                            </div>
                          </li>
                        ))}
                      </ul>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            <div className="mt-8 text-xs opacity-70 text-center">
              © 2025 Blue Screen IT Ltd. Course mapping used for interactive learning prototype.
            </div>

            {quizFor && (
              <QuizModal
                session={quizFor}
                level={level}
                onClose={()=>setQuizFor(null)}
                onResult={handleQuizResult}
              />
            )}
          </div>
        );
      }

      // ===== Mount
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>

