<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bootcamp Concierge ‚Äì Chatbot & Admin</title>
<!--
  Single-file web app
  - Bootcamp Q&A chatbot with RAG over uploaded PDFs (per-course)
  - Secret phrase to open admin portal: "NICEONEBRUVA" ‚Üí passcode "1975"
  - Admin edits content, uploads PDFs, sets screening link, OpenAI key, Firebase config
  - Firestore used if configured; otherwise localStorage fallback
  - Styled to echo the look/feel of the provided screenshot (lavender/purple UI)
-->
<style>
  :root{
    --bg:#f5f2ff;               /* soft lilac */
    --panel:#ffffff;
    --brand:#7c3aed;            /* purple */
    --brand-2:#6366f1;          /* indigo */
    --text:#1c1c28;
    --muted:#6b6b88;
    --chip:#efeafe;
    --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --border: #eadffd;
    --shadow:0 8px 24px rgba(74,58,255,.12);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; color:var(--text); background:var(--bg)}
  a{color:var(--brand)}

  /* Shell */
  .app{display:grid; grid-template-columns:220px 1fr; min-height:100vh}
  aside{background:#faf7ff; border-right:1px solid var(--border); padding:16px}
  main{display:flex; flex-direction:column}

  /* Sidebar */
  .s-logo{display:flex; align-items:center; gap:12px; padding:10px 10px 20px}
  .s-logo .dot{width:36px; height:36px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #ffd97a, #ffb300 60%, #f59e0b); box-shadow: inset 0 0 0 4px #fff7}
  .s-logo h2{margin:0; font-size:20px; letter-spacing:.4px}

  .nav{display:flex; flex-direction:column; gap:10px}
  .nav a{display:flex; align-items:center; gap:12px; padding:14px 12px; border-radius:14px; text-decoration:none; color:#3f3d56; background:#fff; border:1px solid var(--border); box-shadow: var(--shadow)}
  .nav a span.icon{width:28px; height:28px; border-radius:50%; background:#ece9ff; display:inline-flex; align-items:center; justify-content:center; font-weight:700; color:#6d5dfc}
  .nav a.active{background:#ede9fe}

  /* Header */
  header{display:flex; align-items:center; justify-content:space-between; padding:16px 22px; background:#fff; border-bottom:1px solid var(--border)}
  .title{display:flex; align-items:center; gap:12px}
  .title h1{font-size:22px; margin:0}
  .pill{background:#eef2ff; color:#3730a3; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #dbe4ff}

  /* Content layout */
  .content{padding:22px; display:grid; grid-template-columns:1.15fr .85fr; gap:18px}
  @media(max-width:1080px){.content{grid-template-columns:1fr}}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow: var(--shadow); padding:16px}
  .card h3{margin:0 0 8px; font-size:18px}
  .muted{color:var(--muted)}

  /* Chat */
  .chat-wrap{display:flex; flex-direction:column; height:560px}
  .chat{flex:1; overflow:auto; padding:12px; background:#fbfaff; border:1px solid var(--border); border-radius:14px}
  .bubble{max-width:78%; padding:10px 12px; margin:8px 0; border-radius:14px; box-shadow:0 3px 8px rgba(0,0,0,.05)}
  .bot{background:#f5f3ff; border:1px solid #e6e1ff}
  .user{background:#e0f7ff; border:1px solid #bde8ff; margin-left:auto}
  .row{display:flex; gap:8px; align-items:flex-end}
  .row .avatar{width:28px; height:28px; border-radius:50%; background:linear-gradient(135deg,#6d5dfc,#9a8cff)}
  .row.user{flex-direction:row-reverse}
  .row.user .avatar{background:linear-gradient(135deg,#06b6d4,#67e8f9)}
  .chat-input{display:flex; gap:8px; margin-top:10px}
  .chat-input input{flex:1; padding:12px; border-radius:12px; border:1px solid var(--border)}
  .btn{border:1px solid var(--border); background:linear-gradient(#fff,#f9f7ff); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; color:#4b3bab}
  .btn.primary{background:linear-gradient(180deg,#7c3aed,#6366f1); color:#fff; border:none}
  .btn.ghost{background:#fff}

  /* Course info panel */
  .info-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media(max-width:900px){.info-grid{grid-template-columns:1fr}}
  .info-item{background:#fbfaff; border:1px solid var(--border); border-radius:12px; padding:12px}
  .info-item h4{margin:0 0 6px; font-size:14px; color:#4b3bab}

  .ctas{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px}
  .badge{background:#ede9fe; border:1px solid #ded7ff; color:#4b3bab; padding:4px 8px; border-radius:999px; font-size:12px}

  /* Admin modal */
  .modal{position:fixed; inset:0; display:none; backdrop-filter: blur(6px); background:rgba(36,0,70,.2)}
  .modal.open{display:grid; place-items:center}
  .sheet{width:min(980px,95vw); max-height:90vh; overflow:auto; background:#fff; border-radius:22px; box-shadow:0 24px 80px rgba(88,54,255,.35); border:1px solid var(--border)}
  .sheet header{position:sticky; top:0; background:#fff}
  .sheet .body{padding:16px 22px 22px}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media(max-width:900px){.grid-2{grid-template-columns:1fr}}
  label{font-size:13px; display:block; color:#4b3bab; margin:10px 0 6px}
  input[type="text"], input[type="url"], input[type="password"], input[type="file"], textarea{width:100%; border:1px solid var(--border); border-radius:12px; padding:10px; font:inherit}
  textarea{min-height:90px}
  .hr{height:1px; background:var(--border); margin:14px 0}
  .small{font-size:12px; color:var(--muted)}
  .k{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px}

  .toast{position:fixed; right:18px; bottom:18px; background:#111827; color:#fff; padding:10px 12px; border-radius:12px; box-shadow: var(--shadow); opacity:0; transform: translateY(8px); transition:.2s}
  .toast.show{opacity:1; transform:none}

  .warn{padding:10px 12px; border:1px solid #fde68a; background:#fff7ed; color:#92400e; border-radius:12px}

  .kb-list{display:grid; gap:8px}
  .kb-item{background:#fbfaff; border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center}
</style>
</head>
<body>
<div class="app">
  <aside>
    <div class="s-logo">
      <div class="dot" aria-hidden="true"></div>
      <h2>GONGSY</h2>
    </div>
    <nav class="nav">
      <a class="active" href="#" id="nav-chat"><span class="icon">üí¨</span> Chatbot</a>
      <a href="#" id="nav-screening"><span class="icon">üìù</span> Bootcamp Screening</a>
    </nav>
  </aside>

  <main>
    <header>
      <div class="title"><span class="pill">Bootcamp Concierge</span><h1 id="courseTitle">AI Engineering Bootcamp</h1></div>
      <div class="right"><span class="badge" id="envBadge">Local Mode</span></div>
    </header>

    <section class="content">
      <div class="card">
        <h3>Ask about our bootcamps</h3>
        <p class="muted">Upload course PDFs in Admin to enable RAG. Try: ‚ÄúWhat are the prerequisites?‚Äù or ‚ÄúShow me module list‚Äù. Type <strong>I SAID.........</strong> to open admin.</p>
        <div class="chat-wrap">
          <div class="chat" id="chat"></div>
          <div class="chat-input">
            <input id="chatInput" type="text" placeholder="Type your question‚Ä¶" />
            <button class="btn primary" id="sendBtn">Send</button>
          </div>
          <div class="ctas">
            <button id="callbackBtn" class="btn">Request interview callback</button>
            <a id="registerLink" class="btn ghost" href="#" target="_blank" rel="noopener">Register</a>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Bootcamp overview</h3>
        <div class="info-grid">
          <div class="info-item"><h4>Summary</h4><div id="courseSummary" class="muted"></div></div>
          <div class="info-item"><h4>Key facts</h4>
            <ul class="muted" id="facts" style="margin:0 0 0 18px"></ul>
          </div>
          <div class="info-item"><h4>Next cohort</h4><div id="nextCohort" class="muted"></div></div>
          <div class="info-item"><h4>Location</h4><div id="location" class="muted"></div></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Admin Modal (locked behind secret + passcode) -->
<div class="modal" id="adminModal" aria-hidden="true">
  <div class="sheet">
    <header>
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 22px">
        <div style="display:flex; gap:10px; align-items:center"><span class="pill">Admin</span><strong>Bootcamp Settings</strong></div>
        <button class="btn" id="closeAdmin">Close</button>
      </div>
    </header>
    <div class="body">
      <div id="adminGate">
        <label>Enter passcode</label>
        <input id="passcode" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <div class="small">Hint: provided by request (<span class="k">great year</span>)</div>
        <div style="margin-top:10px; display:flex; gap:8px"><button id="unlock" class="btn primary">Unlock</button></div>
        <div id="gateMsg" class="small muted" style="margin-top:8px"></div>
        <div class="hr"></div>
        <div class="warn">‚ö†Ô∏è Keep your keys/config private. This tool stores secrets in <strong>localStorage</strong> on this device only.</div>
      </div>

      <div id="adminBody" style="display:none">
        <div class="grid-2">
          <div>
            <h3>Course content</h3>
            <label>Title</label>
            <input id="fTitle" type="text" />
            <label>Summary</label>
            <textarea id="fSummary"></textarea>
            <label>Key facts (one per line)</label>
            <textarea id="fFacts"></textarea>
            <label>Next cohort</label>
            <input id="fCohort" type="text" />
            <label>Location</label>
            <input id="fLocation" type="text" />
            <label>Pre‚Äëscreening questionnaire URL</label>
            <input id="fScreening" type="url" placeholder="https://your-training-site/prescreening" />
            <label>FAQs (Q|A per line)</label>
            <textarea id="fFaqs" placeholder="What is the duration?|12 weeks\nDo you offer certificates?|Yes, a digital certificate‚Ä¶"></textarea>
            <label>Troubleshooting (Issue|Resolution per line)</label>
            <textarea id="fTroubles" placeholder="I can't access the portal|Reset your password at ‚Ä¶"></textarea>
          </div>
          <div>
            <h3>Actions & integrations</h3>
            <label>Register link (URL)</label>
            <input id="fRegister" type="url" />
            <label>Callback button label</label>
            <input id="fCallbackLabel" type="text" />
            <label>Callback webhook/mailto (URL)</label>
            <input id="fCallbackUrl" type="url" placeholder="mailto:admissions@example.com?subject=Callback%20Request" />

            <div class="hr"></div>
            <h3>Optional: GPT responses + RAG</h3>
            <label>OpenAI API key</label>
            <input id="fOpenAI" type="password" placeholder="sk-‚Ä¶" />
            <label>Model (chat)</label>
            <input id="fModel" type="text" value="gpt-4o-mini" />
            <label>Embeddings model</label>
            <input id="fEmbedModel" type="text" value="text-embedding-3-small" />
            <div class="small">If no API key is set, the bot falls back to local keyword matching. RAG still works but with simpler matching.</div>

            <div class="hr"></div>
            <h3>Knowledge base (PDFs per course)</h3>
            <label>Upload one or more PDFs</label>
            <input id="kbUpload" type="file" accept="application/pdf" multiple />
            <div class="small">We extract text in-browser (no files are sent anywhere). Then we chunk and index it for retrieval.</div>
            <div class="kb-list" id="kbList" style="margin-top:8px"></div>
            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
              <button class="btn" id="btnClearKB">Clear knowledge</button>
              <button class="btn" id="btnRebuild">Rebuild index</button>
            </div>

            <div class="hr"></div>
            <h3>Optional: Firebase</h3>
            <div class="small">Paste your config JSON to use Firestore for persistence. We pre‚Äëfilled some values from your error (projectId & storageBucket). Storage CORS not required.</div>
            <label>Firebase config JSON</label>
            <textarea id="fFirebase" placeholder='{"apiKey":"‚Ä¶","authDomain":"‚Ä¶","projectId":"prospecting-f2f42","storageBucket":"prospecting-f2f42.appspot.com","appId":"‚Ä¶"}'></textarea>
            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
              <button class="btn" id="btnSave">Save</button>
              <button class="btn" id="btnExport">Export JSON</button>
              <button class="btn" id="btnImport">Import JSON</button>
              <button class="btn" id="btnSync">Sync to Firestore</button>
            </div>
            <div id="adminMsg" class="small" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/**********************
 * Default Course Data *
 **********************/
const DEFAULT_DATA = {
  course: {
    title: 'AI Engineering Bootcamp',
    summary: 'A 12‚Äëweek, hands‚Äëon program covering Python, ML, LLMs, RAG, vector databases, MLOps, and deployment on the cloud. Weekly live sessions + capstone.',
    facts: [
      'Duration: 12 weeks',
      'Schedule: 2√ó evenings + 1√ó weekend lab',
      'Prereqs: Python, basic Git',
      'Certificate upon completion'
    ],
    nextCohort: 'Starts 6 Oct 2025 ‚Äì rolling admissions',
    location: 'Hybrid (London + Remote)',
    registerUrl: 'https://example.com/register',
    screeningUrl: 'https://example.com/pre-screening',
    callbackLabel: 'Request interview callback',
    callbackUrl: 'mailto:admissions@example.com?subject=Callback%20Request',
    faqs: [
      {q:'How long is the bootcamp?', a:'12 weeks. Expect ~8‚Äì10 hours/week including labs.'},
      {q:'Do I need prior ML experience?', a:'Helpful but not required. We begin with core ML then move to LLMs and MLOps.'},
      {q:'Is there a certificate?', a:'Yes, a shareable certificate is issued upon meeting assessment criteria.'},
      {q:'What projects will I build?', a:'You will ship 3 mini‚Äëprojects and one capstone (e.g., an RAG app with evaluations).'}
    ],
    troubleshooting: [
      {issue:'I cannot access the portal', fix:'Use the reset link on the login page; check spam for the reset email.'},
      {issue:'My notebook will not run', fix:'Ensure you installed dependencies; try restarting the kernel and pulling the latest template.'}
    ]
  },
  ai: { useOpenAI: false, model: 'gpt-4o-mini', embedModel:'text-embedding-3-small', apiKey: '' },
  firebase: { projectId: 'prospecting-f2f42', storageBucket: 'prospecting-f2f42.appspot.com' },
  rag: { docs: [] } // {id,name,pages,courseTag,textBytes,chunks:[{text,embedding?}]}
};

/***************************
 * Persistence & utilities  *
 ***************************/
const LS_KEY = 'bootcamp.concierge.v2';
const $ = (sel, el=document)=> el.querySelector(sel);
const $$ = (sel, el=document)=> [...el.querySelectorAll(sel)];
const ui = id => document.getElementById(id);

function loadState(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)) || DEFAULT_DATA }catch(e){ return DEFAULT_DATA }
}
function saveState(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function toast(msg, t=2200){ const n=ui('toast'); n.textContent=msg; n.classList.add('show'); setTimeout(()=>n.classList.remove('show'), t); }
function mdEscape(s=''){ return s.replace(/[\n\r]+/g,' '); }
function uuid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

let STATE = loadState();

/**********************
 * Rendering functions *
 **********************/
function renderCourse(){
  ui('courseTitle').textContent = STATE.course.title;
  ui('courseSummary').textContent = STATE.course.summary;
  ui('nextCohort').textContent = STATE.course.nextCohort;
  ui('location').textContent = STATE.course.location;
  const facts = ui('facts'); facts.innerHTML='';
  STATE.course.facts.forEach(f=>{ const li=document.createElement('li'); li.textContent=f; facts.appendChild(li); });
  // CTAs
  const reg = ui('registerLink'); reg.href = STATE.course.registerUrl || '#';
  ui('callbackBtn').textContent = STATE.course.callbackLabel || 'Request interview callback';
}

function addMsg(from, text){
  const wrap = ui('chat');
  const row = document.createElement('div'); row.className = 'row ' + (from==='user'?'user':'');
  const avatar = document.createElement('div'); avatar.className='avatar';
  const bubble = document.createElement('div'); bubble.className = 'bubble ' + (from==='user'?'user':'bot'); bubble.textContent = text;
  row.append(avatar, bubble); wrap.append(row); wrap.scrollTop = wrap.scrollHeight;
}

function systemIntro(){
  ui('chat').innerHTML='';
  addMsg('bot', `Hi! I\'m your bootcamp concierge. Ask me anything about the ${STATE.course.title}.`);
}

/***********************
 * RAG implementation   *
 ***********************/
const EMBED_BATCH = 50; // OpenAI max per request is high; keep modest for browser

async function ensurePdfJs(){
  if(window.pdfjsLib) return window.pdfjsLib;
  const lib = await import('https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.mjs');
  window.pdfjsLib = lib; return lib;
}

function chunkText(txt, size=1200, overlap=120){
  const chunks=[]; let i=0; while(i<txt.length){ const end = Math.min(txt.length, i+size); const slice = txt.slice(i, end); chunks.push(slice.trim()); i = end - overlap; if(i<0) i=0; }
  return chunks.filter(Boolean);
}

async function extractPdfText(file){
  await ensurePdfJs();
  const buf = await file.arrayBuffer();
  const pdf = await window.pdfjsLib.getDocument({data: buf}).promise;
  let text='';
  for(let p=1;p<=pdf.numPages;p++){
    const page = await pdf.getPage(p); const content = await page.getTextContent();
    const strings = content.items.map(i=>i.str); text += strings.join(' ') + '\n';
  }
  return {text, pages: pdf.numPages};
}

async function embedTexts(texts){
  if(!STATE.ai.apiKey) return null; // We'll use keyword fallback
  const model = STATE.ai.embedModel || 'text-embedding-3-small';
  const out=[];
  for(let i=0;i<texts.length;i+=EMBED_BATCH){
    const batch = texts.slice(i, i+EMBED_BATCH);
    const res = await fetch('https://api.openai.com/v1/embeddings',{
      method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${STATE.ai.apiKey}`},
      body: JSON.stringify({model, input: batch})
    });
    if(!res.ok){ console.warn('Embedding error', await res.text()); return null; }
    const data = await res.json();
    data.data.forEach(d=> out.push(d.embedding));
  }
  return out;
}

function cosine(a,b){ let s=0,na=0,nb=0; for(let i=0;i<a.length;i++){ s+=a[i]*b[i]; na+=a[i]*a[i]; nb+=b[i]*b[i]; } return s/(Math.sqrt(na)*Math.sqrt(nb)+1e-9); }
function tokens(s){ return s.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(Boolean); }
function simpleScore(q, txt){
  const A=new Set(tokens(q)); let hit=0; tokens(txt).forEach(t=>{ if(A.has(t)) hit++;});
  return hit/Math.max(10, tokens(txt).length);
}

async function indexPdfFiles(fileList){
  const files=[...fileList];
  for(const f of files){
    const {text, pages} = await extractPdfText(f);
    const chunks = chunkText(text);
    let embeddings = await embedTexts(chunks);
    const doc = { id: uuid(), name: f.name, pages, courseTag: STATE.course.title, textBytes: text.length, chunks: [] };
    for(let i=0;i<chunks.length;i++){
      doc.chunks.push({ text: chunks[i], embedding: embeddings? embeddings[i]: null });
    }
    STATE.rag.docs.push(doc);
  }
  saveState(STATE); renderKBList(); toast('PDFs indexed for RAG');
}

function renderKBList(){
  const list = ui('kbList'); if(!list) return; list.innerHTML='';
  if(!STATE.rag?.docs?.length){ list.innerHTML = '<div class="small muted">No PDFs uploaded yet.</div>'; return; }
  STATE.rag.docs.forEach(d=>{
    const row = document.createElement('div'); row.className='kb-item';
    row.innerHTML = `<div><strong>${d.name}</strong> <span class="small">‚Äî ${d.pages}p, ${(d.textBytes/1024|0)}KB, tag: ${d.courseTag}</span></div>`;
    const del = document.createElement('button'); del.className='btn'; del.textContent='Remove'; del.onclick=()=>{ STATE.rag.docs = STATE.rag.docs.filter(x=>x.id!==d.id); saveState(STATE); renderKBList(); };
    row.append(del); list.append(row);
  });
}

async function retrieveRelevantChunks(query, k=3){
  const docs = (STATE.rag?.docs||[]).filter(d=> d.courseTag === STATE.course.title);
  const allChunks=[]; docs.forEach(d=> d.chunks.forEach(c=> allChunks.push(c)));
  if(!allChunks.length) return [];
  if(STATE.ai.apiKey){
    const res = await fetch('https://api.openai.com/v1/embeddings',{
      method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${STATE.ai.apiKey}`},
      body: JSON.stringify({model: STATE.ai.embedModel||'text-embedding-3-small', input: [query]})
    });
    if(res.ok){ const v=(await res.json()).data[0].embedding; return allChunks.map(c=>({c, s: c.embedding? cosine(v,c.embedding): simpleScore(query,c.text)})).sort((a,b)=>b.s-a.s).slice(0,k).map(x=>x.c); }
  }
  // fallback to keyword overlap
  return allChunks.map(c=>({c, s: simpleScore(query,c.text)})).sort((a,b)=>b.s-a.s).slice(0,k).map(x=>x.c);
}

/*********************************
 * Conversational AI (two modes)  *
 *********************************/
function normalize(s=''){ return s.toLowerCase().replace(/[^a-z0-9\s]/g,' '); }
function overlapScore(a,b){ const A=new Set(normalize(a).split(/\s+/).filter(Boolean)); const B=new Set(normalize(b).split(/\s+/).filter(Boolean)); let o=0; A.forEach(x=>{ if(B.has(x)) o++;}); return o/(1+Math.min(A.size,B.size)); }

async function replyLocal(q){
  // Secret phrase ‚Üí admin
  if(q.trim().toUpperCase()==='NICEONEBRUVA'){ openAdmin(); return; }

  // RAG lookup first
  const hits = await retrieveRelevantChunks(q, 2);
  if(hits.length){
    const snippet = hits.map(h=>h.text.trim()).join('\n---\n').slice(0,800);
    return `According to the course material:\n\n${snippet}\n\nIf you need the exact page, I can point you to the PDF source.`;
  }

  // Direct patterns
  const n = normalize(q);
  if(/(price|cost|tuition|fee)/.test(n)) return `Tuition details: we\'ll send exact pricing during admissions. Typical early‚Äëbird is ¬£1,200‚Äì¬£1,800 depending on cohort.`;
  if(/(start|cohort|date|when)/.test(n)) return STATE.course.nextCohort;
  if(/(location|where)/.test(n)) return `We\'re ${STATE.course.location}.`;
  if(/(register|sign ?up|enrol|enroll)/.test(n)) return `You can register here: ${STATE.course.registerUrl}`;

  // FAQ similarity
  let best=null, score=0; STATE.course.faqs.forEach(f=>{ const s=overlapScore(q, f.q); if(s>score){score=s; best=f;} });
  if(best && score>.15) return best.a;

  // Troubleshooting
  let tbest=null, tscore=0; STATE.course.troubleshooting.forEach(t=>{ const s=overlapScore(q, t.issue); if(s>tscore){tscore=s; tbest=t;} });
  if(tbest && tscore>.18) return tbest.fix;

  // Fallback
  return "I couldn‚Äôt find that in our notes. Upload PDFs in Admin to power precise answers or ask about dates, syllabus, or fees.";
}

async function replyOpenAI(q){
  const key = STATE.ai.apiKey; if(!key){ return replyLocal(q); }
  // Retrieve context from RAG
  const ctxChunks = await retrieveRelevantChunks(q, 4);
  const context = ctxChunks.map((c,i)=>`[${i+1}] ${c.text}`).join('\n\n');
  const sys = `You are a concise admissions concierge. Answer ONLY using the CONTEXT and COURSE DATA below. If the answer is missing, say you don't know and suggest next steps (register link or callback). Keep answers to 3‚Äì6 sentences.\n\nCOURSE DATA:\nTitle: ${STATE.course.title}\nSummary: ${mdEscape(STATE.course.summary)}\nFacts: ${STATE.course.facts.join('; ')}\nNext cohort: ${STATE.course.nextCohort}\nLocation: ${STATE.course.location}\nRegister: ${STATE.course.registerUrl}\n\nCONTEXT (excerpts from PDFs tagged for this course):\n${context || '(no documents uploaded)'}\n`;
  try{
    const res = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
      body: JSON.stringify({
        model: STATE.ai.model||'gpt-4o-mini',
        messages:[{role:'system', content: sys}, {role:'user', content:q}],
        temperature:0.3, max_tokens:300
      })
    });
    if(!res.ok){ const t=await res.text(); console.warn('OpenAI error', t); return replyLocal(q); }
    const data = await res.json();
    return data.choices?.[0]?.message?.content?.trim() || replyLocal(q);
  }catch(e){ console.warn(e); return replyLocal(q); }
}

async function handleSend(){
  const input = ui('chatInput'); const q = input.value.trim(); if(!q) return; input.value='';
  addMsg('user', q);
  const thinking = '‚Ä¶'; addMsg('bot', thinking);
  const last = ui('chat').lastElementChild; // placeholder
  const useGPT = !!STATE.ai.apiKey && STATE.ai.useOpenAI !== false; // if key present, default to true
  const a = useGPT ? await replyOpenAI(q) : await replyLocal(q);
  last.querySelector('.bubble').textContent = a;
}

/**********************
 * Callback + Register *
 **********************/
ui('callbackBtn').addEventListener('click', ()=>{
  const name = prompt('Your name'); if(!name) return;
  const phone = prompt('Phone / WhatsApp');
  const email = prompt('Email');
  const payload = {ts: Date.now(), name, phone, email, note:'Interview callback request'};
  // Try Firestore, else mailto/webhook, else download JSON
  if(window.firestore){
    firestoreAdd('callbacks', payload).then(()=> toast('Callback saved to Firestore')).catch(()=> fallback())
  } else fallback();

  function fallback(){
    if(STATE.course.callbackUrl && STATE.course.callbackUrl.startsWith('mailto:')){
      const m = STATE.course.callbackUrl + `&body=${encodeURIComponent(JSON.stringify(payload,null,2))}`;
      window.location.href = m;
    } else if(STATE.course.callbackUrl){
      fetch(STATE.course.callbackUrl, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}).then(()=>toast('Callback sent')).catch(()=> downloadJSON(payload, 'callback.json'))
    } else {
      downloadJSON(payload, 'callback.json');
    }
  }
});

function downloadJSON(obj, filename){
  const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500);
}

/****************
 * Admin portal  *
 ****************/
function openAdmin(){ ui('adminModal').classList.add('open'); ui('adminModal').setAttribute('aria-hidden','false'); ui('passcode').focus(); }
function closeAdmin(){ ui('adminModal').classList.remove('open'); ui('adminModal').setAttribute('aria-hidden','true'); }
ui('closeAdmin').addEventListener('click', closeAdmin);
ui('unlock').addEventListener('click', ()=>{
  if(ui('passcode').value.trim()==='1975'){ ui('adminGate').style.display='none'; ui('adminBody').style.display='block'; loadAdminForm(); renderKBList(); }
  else{ ui('gateMsg').textContent='Incorrect passcode'; }
});

function loadAdminForm(){
  ui('fTitle').value = STATE.course.title;
  ui('fSummary').value = STATE.course.summary;
  ui('fFacts').value = STATE.course.facts.join('\n');
  ui('fCohort').value = STATE.course.nextCohort;
  ui('fLocation').value = STATE.course.location;
  ui('fRegister').value = STATE.course.registerUrl;
  ui('fScreening').value = STATE.course.screeningUrl||'';
  ui('fCallbackLabel').value = STATE.course.callbackLabel;
  ui('fCallbackUrl').value = STATE.course.callbackUrl;
  ui('fFaqs').value = STATE.course.faqs.map(x=>`${x.q}|${x.a}`).join('\n');
  ui('fTroubles').value = STATE.course.troubleshooting.map(x=>`${x.issue}|${x.fix}`).join('\n');
  ui('fOpenAI').value = STATE.ai.apiKey||'';
  ui('fModel').value = STATE.ai.model||'gpt-4o-mini';
  ui('fEmbedModel').value = STATE.ai.embedModel||'text-embedding-3-small';
  // Prefill Firebase JSON if blank
  const fb = STATE.firebase||{};
  const pre = {projectId: fb.projectId||'prospecting-f2f42', storageBucket: fb.storageBucket||'prospecting-f2f42.appspot.com'};
  ui('fFirebase').value = JSON.stringify({...pre, ...fb}, null, 2);
}

ui('btnSave').addEventListener('click', ()=>{
  STATE.course.title = ui('fTitle').value.trim();
  STATE.course.summary = ui('fSummary').value.trim();
  STATE.course.facts = ui('fFacts').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
  STATE.course.nextCohort = ui('fCohort').value.trim();
  STATE.course.location = ui('fLocation').value.trim();
  STATE.course.registerUrl = ui('fRegister').value.trim();
  STATE.course.screeningUrl = ui('fScreening').value.trim();
  STATE.course.callbackLabel = ui('fCallbackLabel').value.trim();
  STATE.course.callbackUrl = ui('fCallbackUrl').value.trim();
  STATE.course.faqs = ui('fFaqs').value.split(/\n+/).map(line=>{ const [q,a]=line.split('|'); return q&&a?{q:q.trim(), a:a.trim()}:null }).filter(Boolean);
  STATE.course.troubleshooting = ui('fTroubles').value.split(/\n+/).map(line=>{ const [i,f]=line.split('|'); return i&&f?{issue:i.trim(), fix:f.trim()}:null }).filter(Boolean);
  STATE.ai.apiKey = ui('fOpenAI').value.trim(); STATE.ai.useOpenAI = !!STATE.ai.apiKey; STATE.ai.model = ui('fModel').value.trim()||'gpt-4o-mini'; STATE.ai.embedModel = ui('fEmbedModel').value.trim()||'text-embedding-3-small';
  try{ STATE.firebase = JSON.parse(ui('fFirebase').value) }catch(e){ toast('Firebase JSON invalid (keeping previous)'); }
  saveState(STATE); renderCourse(); toast('Saved'); updateEnvBadge();
});

ui('kbUpload')?.addEventListener('change', (e)=>{ const files=e.target.files; if(files?.length){ indexPdfFiles(files); e.target.value=''; }});
ui('btnClearKB')?.addEventListener('click', ()=>{ STATE.rag.docs=[]; saveState(STATE); renderKBList(); toast('Cleared knowledge'); });
ui('btnRebuild')?.addEventListener('click', async ()=>{
  // Re-embed all chunks if OpenAI key present
  if(!STATE.ai.apiKey){ toast('Set an OpenAI key to build embeddings (fallback uses keywords).'); return; }
  const all=[]; STATE.rag.docs.forEach(d=> d.chunks.forEach(c=> all.push(c.text)));
  const embs = await embedTexts(all); if(!embs){ toast('Embedding failed'); return; }
  let i=0; STATE.rag.docs.forEach(d=> d.chunks.forEach(c=>{ c.embedding = embs[i++]; }));
  saveState(STATE); toast('Index rebuilt with embeddings');
});

/*******************
 * Firebase (opt-in) *
 *******************/
let firebaseApp, firestore;
async function ensureFirebase(){
  if(window.firebase?.apps?.length){ firebaseApp = window.firebase.app(); return; }
  await Promise.all([
    import('https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js'),
    import('https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js'),
    import('https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js')
  ]);
  const cfg = STATE.firebase||{}; if(!cfg.projectId){ throw new Error('Missing Firebase config'); }
  firebaseApp = window.firebase.initializeApp(cfg);
  firestore = window.firebase.firestore();
  try{ await window.firebase.auth().signInAnonymously(); }catch(e){ console.warn('Auth', e); }
}

async function firestoreAdd(collection, doc){ await ensureFirebase(); return firestore.collection(collection).add(doc); }

ui('btnSync').addEventListener('click', async ()=>{
  try{ await ensureFirebase(); await firestore.collection('bootcamps').doc('default').set(STATE.course); toast('Synced to Firestore (bootcamps/default)'); }
  catch(e){ console.error(e); ui('adminMsg').innerHTML = `<div class="warn">${e.message}</div>`; }
});

/*************************
 * Navigation & bindings  *
 *************************/
// Only two items remain: Chatbot (active) and Bootcamp Screening (opens link)
ui('nav-screening').addEventListener('click', (e)=>{ e.preventDefault(); const url=STATE.course.screeningUrl||'#'; if(url==='#'){ alert('Admin: add a pre‚Äëscreening URL.'); } else { window.open(url, '_blank'); } });

ui('sendBtn').addEventListener('click', handleSend);
ui('chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter') handleSend(); });
ui('registerLink').addEventListener('click', e=>{ if(!STATE.course.registerUrl){ e.preventDefault(); alert('Admin: add a register URL in the portal.'); }});

function updateEnvBadge(){ const docs = (STATE.rag?.docs||[]).length; ui('envBadge').textContent = (STATE.ai.apiKey? `GPT${docs?'+RAG':''}` : (docs? 'RAG (local)': 'Local Mode')); }

// Initialize
renderCourse(); systemIntro(); renderKBList(); updateEnvBadge();
</script>
</body>
</html>
