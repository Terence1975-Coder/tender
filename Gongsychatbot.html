<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bootcamp Concierge ‚Äì Chatbot & Admin</title>
<style>
  :root{
    --bg:#f5f2ff; --panel:#ffffff; --brand:#7c3aed; --brand-2:#6366f1;
    --text:#1c1c28; --muted:#6b6b88; --border:#eadffd; --shadow:0 8px 24px rgba(74,58,255,.12);
    --radius:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif; color:var(--text); background:var(--bg)}
  a{color:var(--brand)}
  .app{display:grid; grid-template-columns:220px 1fr; min-height:100vh}
  aside{background:#faf7ff; border-right:1px solid var(--border); padding:16px}
  main{display:flex; flex-direction:column}
  .s-logo{display:flex; align-items:center; gap:12px; padding:10px 10px 20px}
  .s-logo .dot{width:36px; height:36px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #ffd97a, #ffb300 60%, #f59e0b); box-shadow: inset 0 0 0 4px #fff7}
  .s-logo h2{margin:0; font-size:20px; letter-spacing:.4px}
  .nav{display:flex; flex-direction:column; gap:10px}
  .nav a{display:flex; align-items:center; gap:12px; padding:14px 12px; border-radius:14px; text-decoration:none; color:#3f3d56; background:#fff; border:1px solid var(--border); box-shadow: var(--shadow)}
  .nav a span.icon{width:28px; height:28px; border-radius:50%; background:#ece9ff; display:inline-flex; align-items:center; justify-content:center; font-weight:700; color:#6d5dfc}
  .nav a.active{background:#ede9fe}
  header{display:flex; align-items:center; justify-content:space-between; padding:16px 22px; background:#fff; border-bottom:1px solid var(--border)}
  .title{display:flex; align-items:center; gap:12px}
  .title h1{font-size:22px; margin:0}
  .pill{background:#eef2ff; color:#3730a3; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #dbe4ff}
  .content{padding:22px; display:grid; grid-template-columns:1.15fr .85fr; gap:18px}
  @media(max-width:1080px){.content{grid-template-columns:1fr}}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow: var(--shadow); padding:16px}
  .card h3{margin:0 0 8px; font-size:18px}
  .muted{color:var(--muted)}
  .chat-wrap{display:flex; flex-direction:column; height:560px}
  .chat{flex:1; overflow:auto; padding:12px; background:#fbfaff; border:1px solid var(--border); border-radius:14px}
  .bubble{max-width:78%; padding:10px 12px; margin:8px 0; border-radius:14px; box-shadow:0 3px 8px rgba(0,0,0,.05)}
  .bot{background:#f5f3ff; border:1px solid #e6e1ff} .user{background:#e0f7ff; border:1px solid #bde8ff; margin-left:auto}
  .row{display:flex; gap:8px; align-items:flex-end} .row .avatar{width:28px; height:28px; border-radius:50%; background:linear-gradient(135deg,#6d5dfc,#9a8cff)}
  .row.user{flex-direction:row-reverse} .row.user .avatar{background:linear-gradient(135deg,#06b6d4,#67e8f9)}
  .chat-input{display:flex; gap:8px; margin-top:10px} .chat-input input{flex:1; padding:12px; border-radius:12px; border:1px solid var(--border)}
  .btn{border:1px solid var(--border); background:linear-gradient(#fff,#f9f7ff); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; color:#4b3bab}
  .btn.primary{background:linear-gradient(180deg,#7c3aed,#6366f1); color:#fff; border:none} .btn.ghost{background:#fff}
  .info-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px} @media(max-width:900px){.info-grid{grid-template-columns:1fr}}
  .info-item{background:#fbfaff; border:1px solid var(--border); border-radius:12px; padding:12px}
  .info-item h4{margin:0 0 6px; font-size:14px; color:#4b3bab}
  .ctas{display:flex; flex-wrap:wrap; gap:10px; margin-top:8px}
  .badge{background:#ede9fe; border:1px solid #ded7ff; color:#4b3bab; padding:4px 8px; border-radius:999px; font-size:12px}
  .modal{position:fixed; inset:0; display:none; backdrop-filter: blur(6px); background:rgba(36,0,70,.2)} .modal.open{display:grid; place-items:center}
  .sheet{width:min(980px,95vw); max-height:90vh; overflow:auto; background:#fff; border-radius:22px; box-shadow:0 24px 80px rgba(88,54,255,.35); border:1px solid var(--border)}
  .sheet header{position:sticky; top:0; background:#fff} .sheet .body{padding:16px 22px 22px}
  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px} @media(max-width:900px){.grid-2{grid-template-columns:1fr}}
  label{font-size:13px; display:block; color:#4b3bab; margin:10px 0 6px}
  input[type="text"], input[type="url"], input[type="password"], input[type="file"], textarea{width:100%; border:1px solid var(--border); border-radius:12px; padding:10px; font:inherit}
  textarea{min-height:90px} .hr{height:1px; background:var(--border); margin:14px 0} .small{font-size:12px; color:#6b6b88}
  .kb-list{display:grid; gap:8px} .kb-item{background:#fbfaff; border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center}
  .toast{position:fixed; right:18px; bottom:18px; background:#111827; color:#fff; padding:10px 12px; border-radius:12px; box-shadow: var(--shadow); opacity:0; transform: translateY(8px); transition:.2s}
  .toast.show{opacity:1; transform:none}
</style>

<!-- pdf.js (classic build ‚Äì no module/CORS fuss) -->
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
  // Point worker to matching CDN file
  if (window.pdfjsLib) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
  } else {
    console.error("Failed to load pdf.js from CDN. PDF upload will not work.");
  }
</script>
</head>
<body>
<div class="app">
  <aside>
    <div class="s-logo"><div class="dot" aria-hidden="true"></div><h2>GONGSY</h2></div>
    <nav class="nav">
      <a class="active" href="#" id="nav-chat"><span class="icon">üí¨</span> Chatbot</a>
      <a href="#" id="nav-screening"><span class="icon">üìù</span> Bootcamp Screening</a>
    </nav>
  </aside>

  <main>
    <header>
      <div class="title"><span class="pill">Bootcamp Concierge</span><h1 id="courseTitle">AI Engineering Bootcamp</h1></div>
      <div class="right"><span class="badge" id="envBadge">Local Mode</span></div>
    </header>

    <section class="content">
      <div class="card">
        <h3>Ask about our bootcamps</h3>
        <p class="muted">Upload course PDFs in Admin to enable RAG. Try: ‚ÄúWhat are the prerequisites?‚Äù or ‚ÄúShow me modules‚Äù. Type <strong>NICEONEBRUVA</strong> to open admin.</p>
        <div class="chat-wrap">
          <div class="chat" id="chat"></div>
          <div class="chat-input">
            <input id="chatInput" type="text" placeholder="Type your question‚Ä¶" />
            <button class="btn primary" id="sendBtn">Send</button>
          </div>
          <div class="ctas">
            <button id="callbackBtn" class="btn">Request interview callback</button>
            <a id="registerLink" class="btn ghost" href="#" target="_blank" rel="noopener">Register</a>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Bootcamp overview</h3>
        <div class="info-grid">
          <div class="info-item"><h4>Summary</h4><div id="courseSummary" class="muted"></div></div>
          <div class="info-item"><h4>Key facts</h4><ul class="muted" id="facts" style="margin:0 0 0 18px"></ul></div>
          <div class="info-item"><h4>Next cohort</h4><div id="nextCohort" class="muted"></div></div>
          <div class="info-item"><h4>Location</h4><div id="location" class="muted"></div></div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Admin Modal -->
<div class="modal" id="adminModal" aria-hidden="true">
  <div class="sheet">
    <header>
      <div style="display:flex; align-items:center; justify-content:space-between; padding:12px 22px">
        <div style="display:flex; gap:10px; align-items:center"><span class="pill">Admin</span><strong>Bootcamp Settings</strong></div>
        <button class="btn" id="closeAdmin">Close</button>
      </div>
    </header>
    <div class="body">
      <div id="adminGate">
        <label>Enter passcode</label>
        <input id="passcode" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <div class="small">Hint: <span style="font-family:ui-monospace">1975</span></div>
        <div style="margin-top:10px; display:flex; gap:8px"><button id="unlock" class="btn primary">Unlock</button></div>
        <div id="gateMsg" class="small muted" style="margin-top:8px"></div>
        <div class="hr"></div>
        <div class="small">Secrets are stored locally in <strong>localStorage</strong> on this device only.</div>
      </div>

      <div id="adminBody" style="display:none">
        <div class="grid-2">
          <div>
            <h3>Course content</h3>
            <label>Title</label><input id="fTitle" type="text" />
            <label>Summary</label><textarea id="fSummary"></textarea>
            <label>Key facts (one per line)</label><textarea id="fFacts"></textarea>
            <label>Next cohort</label><input id="fCohort" type="text" />
            <label>Location</label><input id="fLocation" type="text" />
            <label>Pre‚Äëscreening questionnaire URL</label><input id="fScreening" type="url" placeholder="https://your-training-site/prescreening" />
            <label>FAQs (Q|A per line)</label><textarea id="fFaqs" placeholder="What is the duration?|12 weeks&#10;Do you offer certificates?|Yes, a digital certificate‚Ä¶"></textarea>
            <label>Troubleshooting (Issue|Resolution per line)</label><textarea id="fTroubles" placeholder="I can't access the portal|Reset your password at ‚Ä¶"></textarea>
          </div>
          <div>
            <h3>Actions & integrations</h3>
            <label>Register link (URL)</label><input id="fRegister" type="url" />
            <label>Callback button label</label><input id="fCallbackLabel" type="text" />
            <label>Callback webhook/mailto (URL)</label><input id="fCallbackUrl" type="url" placeholder="mailto:admissions@example.com?subject=Callback%20Request" />
            <div class="hr"></div>
            <h3>GPT + RAG (optional)</h3>
            <label>OpenAI API key</label><input id="fOpenAI" type="password" placeholder="sk-‚Ä¶" />
            <label>Model (chat)</label><input id="fModel" type="text" value="gpt-4o-mini" />
            <label>Embeddings model</label><input id="fEmbedModel" type="text" value="text-embedding-3-small" />
            <div class="hr"></div>
            <h3>Knowledge base (PDFs per course)</h3>
            <label>Upload one or more PDFs</label><input id="kbUpload" type="file" accept="application/pdf" multiple />
            <div class="small">Text is extracted in-browser (no files are sent anywhere). Then we chunk and index it for retrieval.</div>
            <div class="kb-list" id="kbList" style="margin-top:8px"></div>
            <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
              <button class="btn" id="btnClearKB">Clear knowledge</button>
              <button class="btn" id="btnRebuild">Rebuild index</button>
            </div>
          </div>
        </div>
        <div id="adminMsg" class="small" style="margin-top:8px"></div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/**********************
 * Default Course Data *
 **********************/
const DEFAULT_DATA = {
  course: {
    title: 'AI Engineering Bootcamp',
    summary: 'A 12-week, hands-on program covering Python, ML, LLMs, RAG, vector databases, MLOps, and deployment on the cloud. Weekly live sessions + capstone.',
    facts: [
      'Duration: 12 weeks',
      'Schedule: 2√ó evenings + 1√ó weekend lab',
      'Prereqs: Python, basic Git',
      'Certificate upon completion'
    ],
    nextCohort: 'Starts 6 Oct 2025 ‚Äì rolling admissions',
    location: 'Hybrid (London + Remote)',
    registerUrl: 'https://example.com/register',
    screeningUrl: 'https://example.com/pre-screening',
    callbackLabel: 'Request interview callback',
    callbackUrl: 'mailto:admissions@example.com?subject=Callback%20Request',
    faqs: [
      {q:'How long is the bootcamp?', a:'12 weeks. Expect ~8‚Äì10 hours/week including labs.'},
      {q:'Do I need prior ML experience?', a:'Helpful but not required. We begin with core ML then move to LLMs and MLOps.'},
      {q:'Is there a certificate?', a:'Yes, a shareable certificate is issued upon meeting assessment criteria.'},
      {q:'What projects will I build?', a:'You will ship 3 mini-projects and one capstone (e.g., an RAG app with evaluations).'}
    ],
    troubleshooting: [
      {issue:'I cannot access the portal', fix:'Use the reset link on the login page; check spam for the reset email.'},
      {issue:'My notebook will not run', fix:'Ensure you installed dependencies; try restarting the kernel and pulling the latest template.'}
    ]
  },
  ai: { useOpenAI: false, model: 'gpt-4o-mini', embedModel:'text-embedding-3-small', apiKey: '' },
  rag: { docs: [] }
};

/***************************
 * Persistence & utilities  *
 ***************************/
const LS_KEY = 'bootcamp.concierge.v5';
const ui = id => document.getElementById(id);
const $ = (sel, el=document)=> el.querySelector(sel);
function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || DEFAULT_DATA }catch(e){ return DEFAULT_DATA } }
function saveState(state){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); } catch(err){ console.warn('localStorage full ‚Äì index kept in memory', err); toast('Large docs not fully saved; index kept in memory.'); } }
function toast(msg, t=2400){ const n=ui('toast'); n.textContent=msg; n.classList.add('show'); setTimeout(()=>n.classList.remove('show'), t); }
function uuid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }

let STATE = loadState();

/**********************
 * Rendering functions *
 **********************/
function renderCourse(){
  ui('courseTitle').textContent = STATE.course.title;
  ui('courseSummary').textContent = STATE.course.summary;
  ui('nextCohort').textContent = STATE.course.nextCohort;
  ui('location').textContent = STATE.course.location;
  const facts = ui('facts'); facts.innerHTML='';
  STATE.course.facts.forEach(f=>{ const li=document.createElement('li'); li.textContent=f; facts.appendChild(li); });
  ui('registerLink').href = STATE.course.registerUrl || '#';
  ui('callbackBtn').textContent = STATE.course.callbackLabel || 'Request interview callback';
}

function addMsg(from, text){
  const wrap = ui('chat');
  const row = document.createElement('div'); row.className = 'row ' + (from==='user'?'user':'');
  const avatar = document.createElement('div'); avatar.className='avatar';
  const bubble = document.createElement('div'); bubble.className = 'bubble ' + (from==='user'?'user':'bot'); bubble.textContent = text;
  row.append(avatar, bubble); wrap.append(row); wrap.scrollTop = wrap.scrollHeight;
}

function systemIntro(){
  ui('chat').innerHTML='';
  addMsg('bot', `Hi! I\\'m your bootcamp concierge. Ask me anything about the ${STATE.course.title}.`);
}

/***********************
 * RAG (PDF ‚Üí chunks)   *
 ***********************/
function chunkText(txt, size=1200, overlap=120){
  const chunks=[]; let i=0;
  while(i<txt.length){ const end=Math.min(txt.length,i+size); chunks.push(txt.slice(i,end).trim()); i=end-overlap; if(i<0) i=0; }
  return chunks.filter(Boolean);
}
async function extractPdfText(file){
  if(!window.pdfjsLib){ throw new Error('PDF.js library not available'); }
  const buf = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
  let text='';
  for(let p=1;p<=pdf.numPages;p++){
    const page=await pdf.getPage(p);
    const c=await page.getTextContent();
    text += c.items.map(i=>i.str).join(' ') + '\\n';
  }
  return {text, pages: pdf.numPages};
}
function tokens(s){ return s.toLowerCase().replace(/[^a-z0-9\\s]/g,' ').split(/\\s+/).filter(Boolean); }
function keywordScore(q,txt){ const A=new Set(tokens(q)); let hit=0; const w=tokens(txt); w.forEach(t=>{ if(A.has(t)) hit++;}); return hit/Math.max(10,w.length); }

async function indexPdfFiles(fileList){
  const files=[...fileList];
  for(const f of files){
    const {text, pages}=await extractPdfText(f);
    if(!text || text.trim().length<20){
      toast(`Heads up: "${f.name}" has little/no extractable text. If it's a scanned PDF, OCR is needed.`);
    }
    const chunks=chunkText(text || '');
    const doc={id:uuid(), name:f.name, pages, courseTag: STATE.course.title, textBytes:text.length, chunks:chunks.map(t=>({text:t, embedding:null}))};
    STATE.rag.docs.push(doc);
  }
  saveState(STATE); renderKBList(); updateEnvBadge(); toast('PDFs indexed for RAG');
}

function renderKBList(){
  const list=ui('kbList'); if(!list) return; list.innerHTML='';
  if(!STATE.rag?.docs?.length){ list.innerHTML='<div class="small">No PDFs uploaded yet.</div>'; return; }
  STATE.rag.docs.forEach(d=>{
    const row=document.createElement('div'); row.className='kb-item';
    row.innerHTML=`<div><strong>${d.name}</strong> <span class="small">‚Äî ${d.pages}p, ${(d.textBytes/1024|0)}KB</span></div>`;
    const del=document.createElement('button'); del.className='btn'; del.textContent='Remove';
    del.onclick=()=>{ STATE.rag.docs=STATE.rag.docs.filter(x=>x.id!==d.id); saveState(STATE); renderKBList(); updateEnvBadge(); };
    row.append(del); list.append(row);
  });
}

async function retrieveRelevantChunks(query,k=3){
  const docs=(STATE.rag?.docs||[]).filter(d=> d.courseTag===STATE.course.title);
  const all=[]; docs.forEach(d=> d.chunks.forEach(c=> all.push(c)));
  if(!all.length) return [];
  // If we had embeddings, we could do cosine similarity here. For now, keyword score:
  return all.map(c=>({c, s: keywordScore(query,c.text)})).sort((a,b)=>b.s-a.s).slice(0,k).map(x=>x.c);
}

/*********************************
 * Conversational replies         *
 *********************************/
function normalize(s=''){ return s.toLowerCase().replace(/[^a-z0-9\\s]/g,' '); }
function overlapScore(a,b){ const A=new Set(normalize(a).split(/\\s+/).filter(Boolean)); const B=new Set(normalize(b).split(/\\s+/).filter(Boolean)); let o=0; A.forEach(x=>{ if(B.has(x)) o++;}); return o/(1+Math.min(A.size,B.size)); }

async function replyLocal(q){
  if(q.trim().toUpperCase()==='NICEONEBRUVA'){ openAdmin(); return; }
  if(STATE.rag && STATE.rag.docs && STATE.rag.docs.length){
    const hits = await retrieveRelevantChunks(q, 2);
    if(hits.length){
      const snippet = hits.map(h=>h.text.trim()).join('\\n---\\n').slice(0,800);
      return `According to the course material:\\n\\n${snippet}\\n\\n(Upload more PDFs in Admin for better coverage.)`;
    }
  }
  const n = normalize(q);
  if(/(price|cost|tuition|fee)/.test(n)) return `Tuition details are shared during admissions. Typical early-bird ranges ¬£1,200‚Äì¬£1,800.`;
  if(/(start|cohort|date|when)/.test(n)) return STATE.course.nextCohort;
  if(/(location|where)/.test(n)) return `We're ${STATE.course.location}.`;
  if(/(register|sign ?up|enrol|enroll)/.test(n)) return `Register here: ${STATE.course.registerUrl}`;
  let best=null,score=0; STATE.course.faqs.forEach(f=>{ const s=overlapScore(q, f.q); if(s>score){score=s; best=f;} }); if(best && score>.15) return best.a;
  let tbest=null, tscore=0; STATE.course.troubleshooting.forEach(t=>{ const s=overlapScore(q, t.issue); if(s>tscore){tscore=s; tbest=t;} }); if(tbest && tscore>.18) return tbest.fix;
  return "I couldn‚Äôt find that in our notes. Upload PDFs in Admin to power precise answers or ask about dates, syllabus, or fees.";
}

/**********************
 * Callback + Register *
 **********************/
ui('callbackBtn').addEventListener('click', ()=>{
  const name = prompt('Your name'); if(!name) return;
  const phone = prompt('Phone / WhatsApp');
  const email = prompt('Email');
  const payload = {ts: Date.now(), name, phone, email, note:'Interview callback request'};
  const mail = STATE.course.callbackUrl + `&body=${encodeURIComponent(JSON.stringify(payload,null,2))}`;
  try{ window.location.href = mail; }catch{ toast('Could not open mail client.'); }
});

/****************
 * Admin portal  *
 ****************/
function openAdmin(){ ui('adminModal').classList.add('open'); ui('passcode').focus(); }
function closeAdmin(){ ui('adminModal').classList.remove('open'); }
ui('closeAdmin').addEventListener('click', closeAdmin);
ui('unlock').addEventListener('click', ()=>{
  if(ui('passcode').value.trim()==='1975'){
    ui('adminGate').style.display='none'; ui('adminBody').style.display='block';
    loadAdminForm(); renderKBList();
  } else { ui('gateMsg').textContent='Incorrect passcode'; }
});

function loadAdminForm(){
  ui('fTitle').value = STATE.course.title;
  ui('fSummary').value = STATE.course.summary;
  ui('fFacts').value = STATE.course.facts.join('\\n');
  ui('fCohort').value = STATE.course.nextCohort;
  ui('fLocation').value = STATE.course.location;
  ui('fRegister').value = STATE.course.registerUrl;
  ui('fScreening').value = STATE.course.screeningUrl||'';
  ui('fCallbackLabel').value = STATE.course.callbackLabel;
  ui('fCallbackUrl').value = STATE.course.callbackUrl;
  ui('fFaqs').value = STATE.course.faqs.map(x=>`${x.q}|${x.a}`).join('\\n');
  ui('fTroubles').value = STATE.course.troubleshooting.map(x=>`${x.issue}|${x.fix}`).join('\\n');
  ui('fOpenAI').value = STATE.ai.apiKey||'';
  ui('fModel').value = STATE.ai.model||'gpt-4o-mini';
  ui('fEmbedModel').value = STATE.ai.embedModel||'text-embedding-3-small';
}

ui('btnClearKB')?.addEventListener('click', ()=>{ STATE.rag.docs=[]; saveState(STATE); renderKBList(); updateEnvBadge(); toast('Cleared knowledge'); });
ui('btnRebuild')?.addEventListener('click', ()=>{ toast('Vector embeddings require an OpenAI key; current build uses keyword retrieval.'); });

ui('kbUpload')?.addEventListener('change', (e)=>{
  const files=e.target.files;
  if(files?.length){ indexPdfFiles(files); e.target.value=''; }
});

ui('btnSave')?.addEventListener('click', ()=>{
  STATE.course.title = ui('fTitle').value.trim();
  STATE.course.summary = ui('fSummary').value.trim();
  STATE.course.facts = ui('fFacts').value.split(/\\n+/).map(s=>s.trim()).filter(Boolean);
  STATE.course.nextCohort = ui('fCohort').value.trim();
  STATE.course.location = ui('fLocation').value.trim();
  STATE.course.registerUrl = ui('fRegister').value.trim();
  STATE.course.screeningUrl = ui('fScreening').value.trim();
  STATE.course.callbackLabel = ui('fCallbackLabel').value.trim();
  STATE.course.callbackUrl = ui('fCallbackUrl').value.trim();
  STATE.ai.apiKey = ui('fOpenAI').value.trim(); STATE.ai.model = ui('fModel').value.trim()||'gpt-4o-mini'; STATE.ai.embedModel = ui('fEmbedModel').value.trim()||'text-embedding-3-small';
  saveState(STATE); renderCourse(); updateEnvBadge(); toast('Saved');
});

/*************************
 * Navigation & bindings  *
 *************************/
ui('nav-screening').addEventListener('click', (e)=>{
  e.preventDefault();
  const url=STATE.course.screeningUrl||'#';
  if(url==='#'){ alert('Admin: add a pre-screening URL in the portal.'); } else { window.open(url, '_blank'); }
});
ui('sendBtn').addEventListener('click', async ()=>{
  const input = ui('chatInput'); const q = input.value.trim(); if(!q) return; input.value='';
  addMsg('user', q); addMsg('bot', '‚Ä¶'); const last = ui('chat').lastElementChild;
  const a = await replyLocal(q); last.querySelector('.bubble').textContent = a;
});
ui('chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter') ui('sendBtn').click(); });
ui('registerLink').addEventListener('click', e=>{ if(!STATE.course.registerUrl){ e.preventDefault(); alert('Admin: add a register URL in the portal.'); }});

function updateEnvBadge(){
  const docs=(STATE.rag?.docs||[]).length;
  const hasKey = !!STATE.ai.apiKey;
  ui('envBadge').textContent = hasKey ? (docs? 'GPT + RAG':'GPT Enabled') : (docs? 'RAG (local)':'Local Mode');
}

/* Init */
if(!STATE.rag) STATE.rag={docs:[]};
renderCourse(); systemIntro(); renderKBList?.(); updateEnvBadge();
</script>
</body>
</html>

