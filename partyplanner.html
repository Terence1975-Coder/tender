<!doctype html>
<html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PartyFlow â€“ Birthday Planner</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>tailwind.config={theme:{extend:{fontFamily:{sans:["Inter","ui-sans-serif","system-ui"],display:["Poppins","Inter"],serif:["Merriweather","Georgia","serif"]}}}};</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Merriweather:wght@400;700&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
<style>
:root{--accent:#7c3aed;--bg:#0b1220;--card:#0f172a;--radius:1.1rem;--font-heading:'Poppins',system-ui,sans-serif;--font-body:'Inter',system-ui,sans-serif}
body{background:#0b1220;color:#e2e8f0;font-family:var(--font-body)}.glass{background:rgba(15,23,42,.65);backdrop-filter:blur(8px);border:1px solid rgba(148,163,184,.15)}.card{background:var(--card);border-radius:var(--radius);border:1px solid rgba(148,163,184,.15)}.btn{background:var(--accent);color:#fff;border-radius:999px;padding:.6rem 1rem;font-weight:600}.btn:hover{filter:brightness(.95)}.btn-outline{border:2px solid var(--accent);color:var(--accent);border-radius:999px;padding:.5rem .9rem}.btn-outline:hover{background:var(--accent);color:#fff}.heading{font-family:var(--font-heading)}.chip{background:rgba(124,58,237,.15);color:#c4b5fd;border:1px solid rgba(124,58,237,.35);padding:.2rem .5rem;border-radius:999px;font-size:.76rem}.nav-active{color:#fff;border-bottom:2px solid var(--accent)}.drop{border:2px dashed rgba(148,163,184,.35);border-radius:var(--radius);padding:1rem;text-align:center}.hidden{display:none}.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
</style></head>
<body>
<header class="sticky top-0 z-40 glass"><div class="max-w-6xl mx-auto px-4"><div class="flex items-center justify-between h-16">
  <div class="flex items-center gap-3"><img id="logoImg" class="w-8 h-8 rounded-full object-cover hidden"/><a class="heading text-lg font-semibold" id="eventTitleNav">PartyFlow</a><span class="chip" id="eventDateChip"></span></div>
  <nav class="hidden md:flex items-center gap-6 text-sm"><a data-tab="home" class="cursor-pointer nav-link nav-active">Home</a><a data-tab="schedule" class="cursor-pointer nav-link">Schedule</a><a data-tab="guests" class="cursor-pointer nav-link">Guests</a><a data-tab="gallery" class="cursor-pointer nav-link">Gallery</a><a data-tab="info" class="cursor-pointer nav-link">Info</a><a data-tab="chat" class="cursor-pointer nav-link" id="chatTab" style="display:none">Chat</a></nav>
  <div class="flex items-center gap-2"><button id="shareBtn" class="btn-outline hidden md:inline">Share</button><button id="adminBtn" class="btn">Admin</button></div>
</div></div></header>
<div class="md:hidden glass"><div class="max-w-6xl mx-auto px-4"><div class="flex gap-4 overflow-x-auto py-2 text-sm"><button data-tab="home" class="nav-link nav-active">Home</button><button data-tab="schedule" class="nav-link">Schedule</button><button data-tab="guests" class="nav-link">Guests</button><button data-tab="gallery" class="nav-link">Gallery</button><button data-tab="info" class="nav-link">Info</button><button data-tab="chat" class="nav-link" id="chatTabMobile" style="display:none">Chat</button></div></div></div>
<section class="relative"><div class="h-[260px] md:h-[380px] w-full bg-cover bg-center" id="coverDiv"></div>
<div class="max-w-6xl mx-auto px-4 -mt-24 relative"><div class="card p-6 md:p-8 shadow-xl"><div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"><div>
  <h1 class="heading text-2xl md:text-4xl font-bold" id="eventTitle">[Event Title]</h1>
  <p class="text-slate-300 mt-1" id="heroText">Welcome! Get the details, RSVP and add photos.</p>
  <div class="flex flex-wrap gap-2 mt-3 text-sm text-slate-300"><span id="eventDate"></span><span>â€¢</span><a id="whatsappLinkHero" class="underline" target="_blank">Open WhatsApp Group</a></div>
</div>
<div class="flex gap-2"><button id="calendarBtn" class="btn">Add to Calendar</button><a id="directionsBtn" target="_blank" class="btn-outline">Get Directions</a></div>
</div></div></div></section>
<main class="max-w-6xl mx-auto px-4 mt-8 space-y-8">
<section id="tab-home" class="tab-section"><div class="grid md:grid-cols-3 gap-6"><div class="md:col-span-2 card p-6"><h2 class="heading text-xl font-semibold mb-2">Tonight's Plan</h2><ol id="timelineList" class="space-y-4"></ol></div><aside class="card p-6"><h3 class="heading font-semibold mb-2">Quick Actions</h3><div class="flex flex-col gap-2"><a id="whatsappLinkSide" target="_blank" class="btn">Open WhatsApp Group</a><button id="shareBtn2" class="btn-outline">Share Event</button><a id="gmapsMeetBtn" target="_blank" class="btn-outline">Meet-up Map</a><a id="gmapsClubBtn" target="_blank" class="btn-outline">Club Map</a></div></aside></div></section>
<section id="tab-schedule" class="tab-section hidden"><div class="grid md:grid-cols-2 gap-6"><div class="card p-6"><h2 class="heading text-xl font-semibold">Meet for Drinks</h2><p class="mt-2" id="meetVenueText"></p><a id="meetMapsLink" target="_blank" class="underline">Open in Maps</a></div><div class="card p-6"><h2 class="heading text-xl font-semibold">Nightclub</h2><p class="mt-2" id="clubVenueText"></p><a id="clubMapsLink" target="_blank" class="underline">Open in Maps</a></div></div></section>
<section id="tab-guests" class="tab-section hidden"><div class="grid md:grid-cols-2 gap-6"><div class="card p-6"><h2 class="heading text-xl font-semibold">RSVP</h2><form id="rsvpForm" class="mt-4 space-y-3"><input id="rsvpName" class="w-full p-3 rounded bg-slate-800 border border-slate-700" placeholder="Your name" required/><select id="rsvpStatus" class="w-full p-3 rounded bg-slate-800 border border-slate-700" required><option value="going">I'm coming ðŸŽ‰</option><option value="maybe">Maybe ðŸ¤”</option><option value="not_going">Can't make it ðŸ˜”</option></select><button class="btn" type="submit">Send RSVP</button></form></div><div class="card p-6"><h2 class="heading text-xl font-semibold">Guest List</h2><div class="mt-3 text-sm text-slate-300">Total: <span id="guestCount">0</span></div><ul id="guestList" class="mt-3 space-y-2"></ul><button id="exportCsvBtn" class="mt-4 btn-outline">Export CSV</button></div></div></section>
<section id="tab-gallery" class="tab-section hidden"><div class="card p-6"><div class="flex items-center justify-between"><h2 class="heading text-xl font-semibold">Live Gallery</h2><div id="uploadControls" class="flex items-center gap-2"><input id="fileInput" type="file" accept="image/*" multiple class="hidden"/><button id="uploadBtn" class="btn">Upload Photos</button></div></div><div id="uploadDrop" class="drop mt-4">Drag & drop images here (or use Upload)</div><div id="galleryGrid" class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-3"></div></div></section>
<section id="tab-info" class="tab-section hidden"><div class="card p-6"><h2 class="heading text-xl font-semibold">Info</h2><div id="infoDetails" class="mt-3 space-y-3 text-slate-300"></div></div></section>
<section id="tab-chat" class="tab-section hidden"><div class="card p-6"><div class="flex items-center justify-between"><h2 class="heading text-xl font-semibold">Event Chat</h2><span id="chatNotice" class="text-sm text-slate-400"></span></div><div id="chatBox" class="mt-4 h-72 overflow-y-auto bg-slate-900/40 rounded p-3 border border-slate-700"></div><form id="chatForm" class="mt-3 grid grid-cols-12 gap-2"><input id="chatName" placeholder="Your name" class="col-span-3 p-2 rounded bg-slate-800 border border-slate-700" required><input id="chatText" placeholder="Message" class="col-span-7 p-2 rounded bg-slate-800 border border-slate-700" required><button class="col-span-2 btn" type="submit">Send</button></form></div></section>
</main>
<div id="adminModal" class="modal hidden"><div class="card w-[960px] max-w-full m-4 p-6 relative"><button id="adminClose" class="absolute right-3 top-3 text-slate-400 hover:text-white">âœ•</button>
  <div id="adminGate"><h2 class="heading text-2xl font-bold mb-2">Admin Access</h2><p class="text-slate-300 mb-4">Enter password 1975</p><input id="adminPassword" type="password" placeholder="Password" class="w-full p-3 rounded bg-slate-800 border border-slate-700"/><button id="adminUnlock" class="btn mt-3">Unlock</button><p id="adminError" class="text-rose-400 mt-2 hidden">Incorrect password.</p></div>
  <div id="adminPanel" class="hidden"><h2 class="heading text-2xl font-bold mb-4">Admin</h2><div class="grid md:grid-cols-3 gap-4">
    <div class="md:col-span-2 card p-4"><h3 class="heading font-semibold mb-2">Event</h3><div class="grid md:grid-cols-2 gap-3">
      <label class="text-sm">Title<input id="admTitle" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      <label class="text-sm">Date/Time<input id="admDateTime" type="datetime-local" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      <label class="text-sm md:col-span-2">Hero<textarea id="admHero" rows="3" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></textarea></label>
      <label class="text-sm">Theme<input id="admTheme" type="color" value="#7c3aed" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      <label class="text-sm">Font<select id="admFont" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"><option value="display">Display</option><option value="sans" selected>Sans</option><option value="serif">Serif</option></select></label>
      <label class="text-sm md:col-span-2">WhatsApp URL<input id="admWhats" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700" placeholder="https://chat.whatsapp.com/..."/></label>
    </div>
    <div class="card p-4"><h3 class="heading font-semibold mb-2">Venues</h3>
      <label class="text-sm">Meet Name<input id="admMeetName" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      <label class="text-sm">Meet Address<input id="admMeetAddr" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      <label class="text-sm">Meet Maps<input id="admMeetMap" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      <label class="text-sm">Meet Notes<textarea id="admMeetNotes" rows="2" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></textarea></label>
      <label class="text-sm">Meet Time<input id="admMeetTime" type="time" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      <div class="h-2"></div>
      <label class="text-sm">Club Name<input id="admClubName" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      <label class="text-sm">Club Address<input id="admClubAddr" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      <label class="text-sm">Club Maps<input id="admClubMap" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      <label class="text-sm">Club Notes<textarea id="admClubNotes" rows="2" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></textarea></label>
      <label class="text-sm">Club Time<input id="admClubTime" type="time" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
    </div>
    <div class="card p-4 md:col-span-3"><h3 class="heading font-semibold mb-2">Settings</h3>
      <div class="grid md:grid-cols-3 gap-3"><label class="inline-flex items-center gap-2"><input type="checkbox" id="admAllowUploads" class="scale-110"><span>Allow Photo Uploads</span></label><label class="inline-flex items-center gap-2"><input type="checkbox" id="admChatEnabled" class="scale-110"><span>Enable Chat</span></label><label class="inline-flex items-center gap-2"><input type="checkbox" id="admConsent" class="scale-110"><span>Photo Consent Notice</span></label></div>
      <div class="mt-3 flex items-center gap-3"><button id="admSave" class="btn">Save</button><span id="admStatus" class="text-slate-400"></span></div>
    </div>
    <div class="card p-4 md:col-span-3"><h3 class="heading font-semibold mb-2">Branding</h3>
      <div class="grid md:grid-cols-3 gap-3">
        <label class="text-sm">Logo <input id="admLogo" type="file" accept="image/*" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
        <label class="text-sm">Cover <input id="admCover" type="file" accept="image/*" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
        <label class="text-sm">Admin BG <input id="admBg" type="file" accept="image/*" class="w-full p-2 mt-1 rounded bg-slate-800 border border-slate-700"></label>
      </div>
      <div class="mt-2 flex gap-2"><button id="admUploadLogo" class="btn">Upload Logo</button><button id="admUploadCover" class="btn">Upload Cover</button><button id="admUploadBg" class="btn">Upload Admin BG</button><button id="admExportCsv" class="btn-outline">Export RSVPs</button><button id="admExportJson" class="btn-outline">Export JSON</button></div>
    </div>
  </div></div></div></div>
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getFirestore,doc,getDoc,setDoc,updateDoc,onSnapshot,collection,addDoc,serverTimestamp,query,orderBy}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{getStorage,ref as sRef,uploadBytes,getDownloadURL}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
const app=initializeApp({apiKey:"1.292034226428.web.878b867e3eb4d3e0098f79",authDomain:"prospecting-f2f42.firebaseapp.com",projectId:"prospecting-f2f42",storageBucket:"prospecting-f2f42.appspot.com"});
const db=getFirestore(app),st=getStorage(app);const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const eventId='default',eventRef=doc(db,'events',eventId),ADMIN_PASS='1975';
function setTheme(hex,font){if(hex)document.documentElement.style.setProperty('--accent',hex);if(font){const h=font==='display'?'Poppins':font==='serif'?'Merriweather':'Inter',b=font==='serif'?'Merriweather':'Inter';document.documentElement.style.setProperty('--font-heading',`'${h}',system-ui,sans-serif`);document.documentElement.style.setProperty('--font-body',`'${b}',system-ui,sans-serif`);document.body.style.fontFamily='var(--font-body)';$$('.heading').forEach(e=>e.style.fontFamily='var(--font-heading)')}}
const bad=['fuck','shit','cunt','wanker','twat'];const clean=t=>bad.reduce((s,w)=>s.replace(new RegExp(w,'gi'),'*'.repeat(w.length)),String(t));
const fmt=d=>d?new Intl.DateTimeFormat('en-GB',{dateStyle:'full',timeStyle:'short',timeZone:'Europe/London'}).format(new Date(d)):'';
function ics(ev){const to=(x)=>{const dt=new Date(x),p=n=>String(n).padStart(2,'0');return `${dt.getUTCFullYear()}${p(dt.getUTCMonth()+1)}${p(dt.getUTCDate())}T${p(dt.getUTCHours())}${p(dt.getUTCMinutes())}${p(dt.getUTCSeconds())}Z`};const s=(z)=>String(z).replace(/[
,;]/g,' ');const start=to(ev.dateTime),end=to(new Date(new Date(ev.dateTime).getTime()+7.2e6));const txt=`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
UID:${crypto.randomUUID()}
DTSTAMP:${to(new Date)}
DTSTART:${start}
DTEND:${end}
SUMMARY:${s(ev.title||'PartyFlow Event')}
LOCATION:${s([ev.meetVenue?.name,ev.meetVenue?.address].filter(Boolean).join(', '))}
DESCRIPTION:${s(ev.heroText||'')}
END:VEVENT
END:VCALENDAR`;const blob=new Blob([txt],{type:'text/calendar'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='event.ics';a.click();setTimeout(()=>URL.revokeObjectURL(url),1e3)}
const share=(t)=>navigator.share?navigator.share({title:t||'PartyFlow',url:location.href}).catch(()=>{}):navigator.clipboard.writeText(location.href).then(()=>alert('Link copied!')).catch(()=>{});
async function compress(file,maxW=1600,q=0.85){const img=new Image();img.src=URL.createObjectURL(file);await new Promise(r=>img.onload=r);const s=Math.min(1,maxW/img.width),w=Math.round(img.width*s),h=Math.round(img.height*s);const c=document.createElement('canvas');c.width=w;c.height=h;const x=c.getContext('2d');x.drawImage(img,0,0,w,h);const blob=await new Promise(r=>c.toBlob(r,'image/jpeg',q));URL.revokeObjectURL(img.src);return new File([blob],`${file.name.replace(/\.[^.]+$/,'')}.jpg`,{type:'image/jpeg'})}
function tab(t){$$('.tab-section').forEach(s=>s.classList.add('hidden'));$(`#tab-${t}`).classList.remove('hidden');$$('.nav-link').forEach(a=>a.classList.remove('nav-active'));$$(`.nav-link[data-tab="${t}"]`).forEach(a=>a.classList.add('nav-active'))}
$$('.nav-link').forEach(a=>a.addEventListener('click',()=>tab(a.dataset.tab)));
$('#adminBtn').onclick=()=>{const u=localStorage.getItem('pf_admin_unlocked')==='1';$('#adminModal').classList.remove('hidden');$('#adminGate').style.display=u?'none':'block';$('#adminPanel').style.display=u?'block':'none'};$('#adminClose').onclick=()=>$('#adminModal').classList.add('hidden');$('#adminUnlock').onclick=()=>{($('#adminPassword').value.trim()===ADMIN_PASS)?(localStorage.setItem('pf_admin_unlocked','1'),$('#adminError').classList.add('hidden'),$('#adminGate').style.display='none',$('#adminPanel').style.display='block'):$('#adminError').classList.remove('hidden')};
let evCache=null;
onSnapshot(eventRef,async s=>{if(!s.exists()){await setDoc(eventRef,{title:"50th Birthday Bash",dateTime:new Date().toISOString(),timezone:"Europe/London",heroText:"Welcome! Get the details, RSVP and add your photos.",themeColor:"#7c3aed",font:"sans",meetVenue:{name:"The Crown & Anchor",address:"123 High St",mapsUrl:"https://maps.google.com",notes:"Grab a table near the back.",startTime:"19:00"},clubVenue:{name:"Club Eclipse",address:"45 Night Ave",mapsUrl:"https://maps.google.com",notes:"Bring ID.",startTime:"22:30"},whatsappInviteUrl:"https://chat.whatsapp.com/",coverImageUrl:"",logoUrl:"",allowUploads:true,chatEnabled:false,requirePhotoConsent:false,createdAt:serverTimestamp(),updatedAt:serverTimestamp()}, {merge:true});return}
const e=s.data();evCache=e;setTheme(e.themeColor,e.font);
$('#eventTitle').textContent=e.title||'PartyFlow Event';$('#eventTitleNav').textContent=e.title||'PartyFlow';$('#heroText').textContent=e.heroText||'';$('#eventDate').textContent=fmt(e.dateTime);$('#eventDateChip').textContent=new Date(e.dateTime).toLocaleDateString('en-GB',{weekday:'short',month:'short',day:'numeric'});
const lg=$('#logoImg');lg.classList.toggle('hidden',!e.logoUrl);if(e.logoUrl)lg.src=e.logoUrl;$('#coverDiv').style.backgroundImage=e.coverImageUrl?`linear-gradient(rgba(0,0,0,.35),rgba(0,0,0,.7)),url('${e.coverImageUrl}')`:'';
$('#whatsappLinkHero').href=e.whatsappInviteUrl||'#';$('#whatsappLinkSide').href=e.whatsappInviteUrl||'#';$('#shareBtn').classList.remove('hidden');
$('#directionsBtn').href=e.meetVenue?.mapsUrl||'#';$('#gmapsMeetBtn').href=e.meetVenue?.mapsUrl||'#';$('#gmapsClubBtn').href=e.clubVenue?.mapsUrl||'#';
const tl=[{t:'Meet for Drinks',time:e.meetVenue?.startTime,desc:`${e.meetVenue?.name||''} â€“ ${e.meetVenue?.address||''}`},{t:'Head to Club',time:e.clubVenue?.startTime,desc:`${e.clubVenue?.name||''} â€“ ${e.clubVenue?.address||''}`}],list=$('#timelineList');list.innerHTML='';tl.forEach(i=>{const li=document.createElement('li');li.className='p-4 rounded border border-slate-700 bg-slate-900/40';li.innerHTML=`<div class="flex items-center justify-between"><div><div class="font-semibold">${i.t}</div><div class="text-slate-300 text-sm">${i.desc}</div></div><div class="chip">${i.time||''}</div></div>`;list.appendChild(li)});
$('#meetVenueText').textContent=`${e.meetVenue?.name||''} â€“ ${e.meetVenue?.address||''}. ${e.meetVenue?.notes||''}`;$('#clubVenueText').textContent=`${e.clubVenue?.name||''} â€“ ${e.clubVenue?.address||''}. ${e.clubVenue?.notes||''}`;$('#meetMapsLink').href=e.meetVenue?.mapsUrl||'#';$('#clubMapsLink').href=e.clubVenue?.mapsUrl||'#';
$('#infoDetails').innerHTML=`<div><strong>Meet:</strong> ${e.meetVenue?.name||''}, ${e.meetVenue?.address||''} (<a class='underline' href='${e.meetVenue?.mapsUrl||'#'}' target='_blank'>Map</a>)</div><div><strong>Club:</strong> ${e.clubVenue?.name||''}, ${e.clubVenue?.address||''} (<a class='underline' href='${e.clubVenue?.mapsUrl||'#'}' target='_blank'>Map</a>)</div>${e.meetVenue?.notes?`<div class='text-slate-400'>Meet notes: ${e.meetVenue.notes}</div>`:''}${e.clubVenue?.notes?`<div class='text-slate-400'>Club notes: ${e.clubVenue.notes}</div>`:''}${e.requirePhotoConsent?`<div class='mt-2 text-amber-300'>By uploading photos, you confirm you have consent.</div>`:''}`;
$('#admTitle').value=e.title||'';$('#admDateTime').value=e.dateTime?new Date(e.dateTime).toISOString().slice(0,16):'';$('#admHero').value=e.heroText||'';$('#admTheme').value=e.themeColor||'#7c3aed';$('#admFont').value=e.font||'sans';$('#admWhats').value=e.whatsappInviteUrl||'';$('#admMeetName').value=e.meetVenue?.name||'';$('#admMeetAddr').value=e.meetVenue?.address||'';$('#admMeetMap').value=e.meetVenue?.mapsUrl||'';$('#admMeetNotes').value=e.meetVenue?.notes||'';$('#admMeetTime').value=e.meetVenue?.startTime||'';$('#admClubName').value=e.clubVenue?.name||'';$('#admClubAddr').value=e.clubVenue?.address||'';$('#admClubMap').value=e.clubVenue?.mapsUrl||'';$('#admClubNotes').value=e.clubVenue?.notes||'';$('#admClubTime').value=e.clubVenue?.startTime||'';$('#admAllowUploads').checked=!!e.allowUploads;$('#admChatEnabled').checked=!!e.chatEnabled;$('#admConsent').checked=!!e.requirePhotoConsent;
const showChat=!!e.chatEnabled;$('#chatTab').style.display=showChat?'':'none';$('#chatTabMobile').style.display=showChat?'':'none';if(showChat) initChat();
$('#uploadControls').style.display=e.allowUploads?'flex':'none';});
$('#calendarBtn').onclick=()=>evCache&&ics(evCache);$('#shareBtn').onclick=()=>share(evCache?.title);$('#shareBtn2').onclick=()=>share(evCache?.title);
const attCol=collection(db,'events',eventId,'attendees');
$('#rsvpForm').addEventListener('submit',async e=>{e.preventDefault();const name=$('#rsvpName').value.trim(),status=$('#rsvpStatus').value;if(!name)return;await addDoc(attCol,{name,status,addedAt:serverTimestamp()});$('#rsvpName').value=''});
onSnapshot(query(attCol,orderBy('addedAt','desc')),(snap)=>{const list=$('#guestList');list.innerHTML='';let cnt=0;snap.forEach(d=>{const a=d.data(),li=document.createElement('li');li.className='p-3 rounded bg-slate-900/40 border border-slate-700';const m={going:'ðŸŽ‰ Going',maybe:'ðŸ¤” Maybe',not_going:'ðŸ˜” Not going'};li.innerHTML=`<div class='flex items-center justify-between'><strong>${a.name}</strong><span class='text-slate-300 text-sm'>${m[a.status]||''}</span></div>`;list.appendChild(li);if(a.status==='going')cnt++});$('#guestCount').textContent=cnt});
async function exportCsv(){const rows=[['name','status','addedAt']];let first=true;onSnapshot(query(attCol,orderBy('addedAt','desc')),(snap)=>{if(!first)return;first=false;snap.forEach(d=>{const a=d.data();rows.push([a.name,a.status,a.addedAt?.toDate?a.addedAt.toDate().toISOString():''])});const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('
');const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='attendees.csv';a.click();setTimeout(()=>URL.revokeObjectURL(url),1e3)})}
$('#exportCsvBtn').onclick=exportCsv;$('#admExportCsv').onclick=exportCsv;
const pCol=collection(db,'events',eventId,'photos');
onSnapshot(query(pCol,orderBy('uploadedAt','desc')),(snap)=>{const grid=$('#galleryGrid');grid.innerHTML='';snap.forEach(d=>{const p=d.data(),a=document.createElement('a');a.href=p.url;a.target='_blank';a.className='block aspect-square overflow-hidden rounded-lg border border-slate-700 bg-slate-900/40';a.innerHTML=`<img src='${p.thumbUrl||p.url}' class='w-full h-full object-cover'/>`;grid.appendChild(a)})});
$('#uploadBtn').onclick=()=>$('#fileInput').click();$('#fileInput').onchange=e=>handleFiles(e.target.files);
const dz=$('#uploadDrop');['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.style.borderColor='var(--accent)'}));['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.style.borderColor='rgba(148,163,184,.35)'}));dz.addEventListener('drop',e=>handleFiles(e.dataTransfer.files));
async function handleFiles(fs){if(!evCache?.allowUploads)return alert('Uploads are disabled.');for(const f of fs){try{const c=await compress(f,1800,.9),path=`events/${eventId}/photos/${Date.now()}_${Math.random().toString(36).slice(2)}.jpg`,r=sRef(st,path);await uploadBytes(r,c,{contentType:'image/jpeg'});const url=await getDownloadURL(r);await addDoc(pCol,{url,thumbUrl:url,uploaderName:'guest',uploadedAt:serverTimestamp(),flagged:false})}catch(e){console.error(e)}}}
let chatBoot=false;function initChat(){if(chatBoot)return;chatBoot=true;$('#chatNotice').textContent='Be nice. Messages are public.';const mCol=collection(db,'events',eventId,'messages');onSnapshot(query(mCol,orderBy('createdAt','asc')),(snap)=>{const box=$('#chatBox');box.innerHTML='';snap.forEach(d=>{const m=d.data(),t=m.createdAt?.toDate?new Date(m.createdAt.toDate()).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}):'';const div=document.createElement('div');div.className='py-1 text-sm';div.innerHTML=`<span class='text-slate-400'>[${t}]</span> <strong>${m.authorName||'guest'}:</strong> ${m.text}`;box.appendChild(div)});box.scrollTop=box.scrollHeight});$('#chatForm').onsubmit=async e=>{e.preventDefault();const name=$('#chatName').value.trim()||'guest',text=clean($('#chatText').value.trim());if(!text)return;const last=Number(localStorage.getItem('pf_last_msg')||'0');if(Date.now()-last<4e3)return alert('Please wait a few seconds.');await addDoc(mCol,{authorName:name,text,createdAt:serverTimestamp()});localStorage.setItem('pf_last_msg',String(Date.now()));$('#chatText').value=''}}
$('#admSave').onclick=async()=>{const payload={title:$('#admTitle').value,dateTime:new Date($('#admDateTime').value).toISOString(),heroText:$('#admHero').value,themeColor:$('#admTheme').value,font:$('#admFont').value,whatsappInviteUrl:$('#admWhats').value,meetVenue:{name:$('#admMeetName').value,address:$('#admMeetAddr').value,mapsUrl:$('#admMeetMap').value,notes:$('#admMeetNotes').value,startTime:$('#admMeetTime').value},clubVenue:{name:$('#admClubName').value,address:$('#admClubAddr').value,mapsUrl:$('#admClubMap').value,notes:$('#admClubNotes').value,startTime:$('#admClubTime').value},allowUploads:$('#admAllowUploads').checked,chatEnabled:$('#admChatEnabled').checked,requirePhotoConsent:$('#admConsent').checked,updatedAt:serverTimestamp()};try{await updateDoc(eventRef,payload)}catch{await setDoc(eventRef,payload,{merge:true})}$('#admStatus').textContent='Saved!';setTimeout(()=>$('#admStatus').textContent='',1500)};
async function uploadBranding(file,key){const c=await compress(file,1800,.9),path=`events/${eventId}/branding/${key}_${Date.now()}.jpg`,r=sRef(st,path);await uploadBytes(r,c,{contentType:'image/jpeg'});const url=await getDownloadURL(r);const patch={};patch[key]=url;patch.updatedAt=serverTimestamp();await updateDoc(eventRef,patch);return url}
$('#admUploadLogo').onclick=async()=>{const f=$('#admLogo').files?.[0];if(!f)return alert('Choose a file');await uploadBranding(f,'logoUrl');alert('Logo uploaded!')};$('#admUploadCover').onclick=async()=>{const f=$('#admCover').files?.[0];if(!f)return alert('Choose a file');await uploadBranding(f,'coverImageUrl');alert('Cover uploaded!')};$('#admUploadBg').onclick=async()=>{const f=$('#admBg').files?.[0];if(!f)return alert('Choose a file');await uploadBranding(f,'adminBgUrl');alert('Admin BG uploaded! Reload to see changes.')};
onSnapshot(eventRef,(s)=>{const e=s.data();if(e?.adminBgUrl){const panel=$('#adminPanel').closest('.card');if(panel){panel.style.backgroundImage=`linear-gradient(rgba(15,23,42,.7),rgba(15,23,42,.85)),url('${e.adminBgUrl}')`;panel.style.backgroundSize='cover'}}});
$('#admExportJson').onclick=async()=>{const s=await getDoc(eventRef),blob=new Blob([JSON.stringify(s.data(),null,2)],{type:'application/json'}),url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='event.json';a.click();setTimeout(()=>URL.revokeObjectURL(url),1e3)};
</script>
</body></html>
