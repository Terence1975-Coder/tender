<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Bootcamp Screening Chatbot ‚Äì with Calendar, Reminders, Reports</title>

  <!-- Firebase SDKs (Compat to match your existing app) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    *{box-sizing:border-box}body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;margin:0;padding:10px;display:flex;align-items:center;justify-content:center}
    .container{width:100%;max-width:1200px;height:90vh;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.1);display:flex;flex-direction:column;overflow:hidden}
    .header{background:#2c3e50;color:#fff;padding:14px 18px}
    .main-content{display:flex;flex:1;overflow:hidden}
    .chat-section{flex:1;display:flex;flex-direction:column}
    .chat-container{flex:1;overflow:auto;background:#f8f9fa;padding:14px}
    .message{max-width:80%;margin:10px 0;padding:12px 16px;border-radius:18px}
    .bot-message{background:#e3f2fd;border:1px solid #bbdefb;margin-right:auto}
    .user-message{background:#e8f5e8;border:1px solid #c8e6c9;margin-left:auto;text-align:right}
    .input-section{padding:14px;border-top:1px solid #e0e0e0;background:#fff}
    .response-buttons{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .btn{border:none;border-radius:22px;padding:9px 14px;background:#3498db;color:#fff;cursor:pointer}
    .send-row{display:flex;gap:8px}
    .text-input{flex:1;padding:10px;border:2px solid #e0e0e0;border-radius:22px;font-size:15px}
    .send-btn{padding:10px 14px;border:none;border-radius:22px;background:#3498db;color:#fff;cursor:pointer}
    .assessment-panel{width:320px;border-left:1px solid #eee;overflow:auto}
    .assessment-header{background:#2c3e50;color:#fff;padding:12px}
    .assessment-content{padding:12px}
    .cloud-controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .cloud-btn{background:#34495e;color:#fff;border:none;border-radius:12px;padding:8px 12px;cursor:pointer;font-size:12px}
    .course-info{background:#ecf0f1;border-left:4px solid #3498db;padding:12px;border-radius:6px}
    @media (max-width: 960px){.main-content{flex-direction:column}.assessment-panel{width:100%;border-left:none;border-top:1px solid #eee}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ü§ñ AI Bootcamp Screening Assistant</h1>
      <p>Now with calendar booking, reminders, and report export</p>
    </div>
    <div class="main-content">
      <div class="chat-section">
        <div class="chat-container" id="chatContainer"></div>
        <div class="input-section">
          <div class="response-buttons" id="responseButtons"></div>
          <div class="send-row">
            <input id="textInput" class="text-input" placeholder="Type here‚Ä¶ (try: Book interview)" onkeypress="if(event.key==='Enter') window.chatBot.handleTextInput()" />
            <button class="send-btn" onclick="window.chatBot.handleTextInput()">Send</button>
          </div>
        </div>
      </div>
      <aside class="assessment-panel">
        <div class="assessment-header">üìä Controls</div>
        <div class="assessment-content">
          <div class="cloud-controls">
            <button class="cloud-btn" onclick="window.chatBot.openCalendarOptions()">üìÖ Book Interview</button>
            <button class="cloud-btn" onclick="window.chatBot.requestReminder()">‚è∞ Send Reminder</button>
            <button class="cloud-btn" onclick="window.chatBot.exportCSV()">üìÑ Export CSV</button>
            <button class="cloud-btn" onclick="window.chatBot.exportPDF()">üßæ Export PDF</button>
          </div>
          <div class="course-info">
            These buttons are safe to use without OAuth:
            <ul>
              <li>Google / Outlook web links</li>
              <li>Downloadable <code>.ics</code> (Apple/Outlook desktop)</li>
              <li>Reminders via Firebase Functions (Twilio/Nodemailer)</li>
              <li>CSV & PDF exports</li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
class ChatBot {
  constructor() {
    this.firebaseConfig = {
      apiKey: "AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
      authDomain: "prospecting-f2f42.firebaseapp.com",
      databaseURL: "https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "prospecting-f2f42",
      storageBucket: "prospecting-f2f42.firebasestorage.app",
      messagingSenderId: "292034226428",
      appId: "1:292034226428:web:878b867e3eb4d3e0098f79",
      measurementId: "G-WWB0JTX2L2"
    };

    this.candidateData = {
      name: 'Applicant',
      location: 'Cornwall',
      ukResidency: true,
      fundingStatus: 'Eligible',
      employmentStatus: 'Employed',
      availability: 'Evenings',
      responses: [],
      personalDetails: { firstName: 'Alex', surname: 'Taylor', email: 'alex@example.com', mobile: '+447000000000' }
    };
    this.score = 7;

    this.chatContainer = document.getElementById('chatContainer');
    this.responseButtons = document.getElementById('responseButtons');
    this.textInput = document.getElementById('textInput');

    try {
      if (typeof firebase !== 'undefined') {
        if (firebase.apps.length === 0) firebase.initializeApp(this.firebaseConfig);
        this.database = firebase.database();
      }
    } catch (e) { console.warn('Firebase init warning:', e.message); }

    this.addMessage('bot', `Hi ${this.candidateData.name}! Type "Book interview" to try the calendar integration, or use the buttons on the right.`);
    this.showOptions(['Book interview', 'Send reminder', 'Export CSV', 'Export PDF']);
  }

  addMessage(sender, html) {
    const div = document.createElement('div');
    div.className = `message ${sender==='bot' ? 'bot-message' : 'user-message'}`;
    div.innerHTML = html;
    this.chatContainer.appendChild(div);
    this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
  }
  showOptions(opts){
    this.responseButtons.innerHTML='';
    opts.forEach(o=>{const b=document.createElement('button');b.className='btn';b.textContent=o;b.onclick=()=>this.handleResponse(o);this.responseButtons.appendChild(b)});
  }
  handleTextInput(){
    const v=this.textInput.value.trim();
    if(!v) return; this.addMessage('user', v); this.textInput.value='';
    this.handleResponse(v);
  }
  handleResponse(text){
    const t=text.toLowerCase();
    if(t.includes('book')) return this.openCalendarOptions();
    if(t.includes('remind')) return this.requestReminder();
    if(t.includes('csv')) return this.exportCSV();
    if(t.includes('pdf')) return this.exportPDF();
    this.addMessage('bot', 'Try: Book interview / Send reminder / Export CSV / Export PDF');
  }

  // 1) Calendar Integration
  openCalendarOptions(){
    const name = this.candidateData?.name || 'Candidate';
    const start = this.suggestInterviewDate();
    const end = new Date(start.getTime()+30*60*1000);
    const { title, description, location } = this.buildInterviewDetails(name);

    const gLink = this.googleCalendarLink({title,start,end,description,location});
    const oLink = this.outlookCalendarLink({title,start,end,description,location});

    const html = `
      <div class="course-info">
        <strong>Book interview:</strong><br>
        ‚Ä¢ <a target="_blank" href="${gLink}">Add to Google Calendar</a><br>
        ‚Ä¢ <a target="_blank" href="${oLink}">Add to Outlook.com / Office 365</a><br>
        ‚Ä¢ <a href="#" id="download-ics">Download .ics (Apple/Outlook desktop)</a>
      </div>`;
    this.addMessage('bot', html);

    setTimeout(()=>{
      const a=document.getElementById('download-ics');
      if(a){a.addEventListener('click', (e)=>{e.preventDefault(); this.downloadICS({title,start,end,description,location});});}
    },0);
  }
  suggestInterviewDate(){
    const d=new Date(); d.setDate(d.getDate()+1); d.setHours(10,0,0,0);
    while([0,6].includes(d.getDay())) d.setDate(d.getDate()+1);
    return d;
  }
  buildInterviewDetails(name){
    return {
      title: `AI Bootcamp Interview ‚Äì ${name}`,
      description: `Initial screening follow‚Äëup.
Candidate: ${name}
Programme: AI Business Productivity Bootcamp
Join link: (paste Teams/Zoom link)` ,
      location: 'Online ‚Äì Microsoft Teams'
    };
  }
  formatDateForCalendar(d){
    const pad=n=>String(n).padStart(2,'0');
    return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`;
  }
  googleCalendarLink({title,start,end,description,location}){
    const base='https://calendar.google.com/calendar/render?action=TEMPLATE';
    const params=new URLSearchParams({text:title,details:description,location,dates:`${this.formatDateForCalendar(start)}/${this.formatDateForCalendar(end)}`});
    return `${base}&${params.toString()}`;
  }
  outlookCalendarLink({title,start,end,description,location}){
    const base='https://outlook.office.com/calendar/0/deeplink/compose';
    const params=new URLSearchParams({subject:title,body:description,location,startdt:start.toISOString(),enddt:end.toISOString()});
    return `${base}?${params.toString()}`;
  }
  downloadICS({title,start,end,description,location}){
    const dt=d=>this.formatDateForCalendar(d);
    const uid=`${Date.now()}@bootcamp-bot`;
    const ics=`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//BootcampBot//EN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dt(new Date())}
DTSTART:${dt(start)}
DTEND:${dt(end)}
SUMMARY:${title}
DESCRIPTION:${description.replace(/
/g,'\n')}
LOCATION:${location}
END:VEVENT
END:VCALENDAR`;
    const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='interview.ics'; a.click(); URL.revokeObjectURL(url);
  }

  // 2) Reminders via Firebase Functions (Twilio/Nodemailer)
  requestReminder(){
    const pd=this.candidateData?.personalDetails||{};
    const payload={
      name:this.candidateData?.name||'Candidate',
      mobile:pd.mobile||'+447000000000',
      email:pd.email||'candidate@example.com',
      interviewISO:this.suggestInterviewDate().toISOString(),
      channel:'both'
    };
    if(!firebase?.functions){
      this.addMessage('bot','‚ö†Ô∏è Reminders unavailable (Firebase Functions SDK not loaded or not initialised).');
      return;
    }
    try{
      const fn=firebase.functions().httpsCallable('sendInterviewReminder');
      this.addMessage('bot','‚è≥ Scheduling reminder‚Ä¶');
      fn(payload).then(()=>this.addMessage('bot','‚úÖ Reminder queued (SMS/Email).')).catch(e=>this.addMessage('bot',`‚ùå Reminder failed: ${e.message}`));
    }catch(e){
      this.addMessage('bot',`‚ùå Reminder error: ${e.message}`);
    }
  }

  // 3) Exports
  exportCSV(){
    const data=this.buildReportRows();
    if(!data.length){this.addMessage('bot','No data to export.');return;}
    const headers=Object.keys(data[0]);
    const csv=[headers.join(','),...data.map(r=>headers.map(h=>JSON.stringify(r[h]??'')).join(','))].join('
');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='candidate_report.csv'; a.click(); URL.revokeObjectURL(url);
    this.addMessage('bot','üìÑ CSV downloaded.');
  }
  buildReportRows(){
    const c=this.candidateData||{};
    const rows=[{Candidate:c.name||'Applicant',Email:c.personalDetails?.email||'',Mobile:c.personalDetails?.mobile||'',Location:c.location||'',UKResidency:c.ukResidency?'Yes':(c.ukResidency===false?'No':''),FundingStatus:c.fundingStatus||'',Employment:c.employmentStatus||'',Availability:c.availability||'',Score:this.score,Status:this.score>=8?'HIGHLY_SUITABLE':this.score>=6?'SUITABLE':'NOT_SUITABLE'}];
    (c.responses||[]).forEach((r,i)=>rows.push({Candidate:c.name,Email:'',Mobile:'',Location:'',UKResidency:'',FundingStatus:'',Employment:'',Availability:'',Score:`Q${i+1}`,Status:`${r.step}: ${r.response}`}));
    return rows;
  }
  exportPDF(){
    if(!window.jspdf||!window.jspdf.jsPDF){ this.addMessage('bot','‚ö†Ô∏è PDF export requires jsPDF (already included via CDN).'); return; }
    const { jsPDF }=window.jspdf; const doc=new jsPDF();
    const c=this.candidateData||{};
    const line=(t,y)=>{doc.text(String(t),14,y);return y+8};
    let y=14; doc.setFontSize(16); y=line('AI Bootcamp ‚Äì Candidate Report',y);
    doc.setFontSize(11);
    y=line(`Candidate: ${c.name||'Applicant'}`,y);
    y=line(`Email: ${c.personalDetails?.email||''}`,y);
    y=line(`Mobile: ${c.personalDetails?.mobile||''}`,y);
    y=line(`Location: ${c.location||''}`,y);
    y=line(`Funding: ${c.fundingStatus||''}`,y);
    y=line(`Employment: ${c.employmentStatus||''}`,y);
    y=line(`Availability: ${c.availability||''}`,y);
    y=line(`Score: ${this.score}  |  Status: ${this.score>=8?'HIGHLY_SUITABLE':this.score>=6?'SUITABLE':'NOT_SUITABLE'}`,y);
    y+=4; doc.line(14,y,196,y); y+=8; doc.setFontSize(12); y=line('Responses',y); doc.setFontSize(10);
    (c.responses||[]).forEach((r,i)=>{const text=`Q${i+1} [${r.step}]: ${r.response}`; const split=doc.splitTextToSize(text,180); split.forEach(t=>{y=line(t,y); if(y>280){doc.addPage(); y=14;}})});
    doc.save('candidate_report.pdf');
    this.addMessage('bot','üßæ PDF generated.');
  }
}

window.chatBot = new ChatBot();
</script>
</body>
</html>

