<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Bootcamp Screening Chatbot - Latest Version</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            height: 90vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 12px;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            min-height: 0;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .bot-message {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            margin-right: auto;
        }

        .user-message {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            margin-left: auto;
            text-align: right;
        }

        .typing-indicator {
            background: #e0e0e0;
            border-radius: 18px;
            padding: 12px 18px;
            margin-bottom: 15px;
            max-width: 80%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .input-section {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .response-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        .text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
            margin-top: 10px;
        }

        .text-input:focus {
            border-color: #3498db;
        }

        .send-btn {
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            transition: background 0.3s ease;
        }

        .send-btn:hover {
            background: #2980b9;
        }

        .input-row {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .chat-mode-toggle {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            margin-bottom: 10px;
            transition: background 0.3s ease;
        }

        .chat-mode-toggle:hover {
            background: #8e44ad;
        }

        .audio-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .audio-btn {
            background: #e67e22;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
        }

        .audio-btn:hover {
            background: #d35400;
        }

        .audio-btn.active {
            background: #27ae60;
        }

        .voice-selector {
            background: #e67e22;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s ease;
            max-width: 120px;
        }

        .voice-selector:hover {
            background: #d35400;
        }

        .voice-selector option {
            background: white;
            color: black;
        }

        .voice-indicator {
            display: none;
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            animation: pulse 1s infinite;
        }

        .course-info {
            background: #ecf0f1;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .faq-response {
            background: #e8f6f3;
            border-left: 4px solid #1abc9c;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .assessment-panel {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            font-size: 14px;
            max-height: 80vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .assessment-header {
            padding: 15px 20px;
            background: #2c3e50;
            color: white;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .assessment-content {
            padding: 20px;
            max-height: calc(80vh - 60px);
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .assessment-panel.collapsed .assessment-content {
            display: none;
        }

        .assessment-panel.collapsed {
            max-height: 60px;
        }

        .collapse-indicator {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .assessment-panel.collapsed .collapse-indicator {
            transform: rotate(180deg);
        }

        .personal-details-form {
            max-height: 60vh;
            overflow-y: auto;
            padding: 5px;
        }

        .form-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid #e0e0e0;
            max-height: 70vh;
            overflow-y: auto;
        }

        .criteria-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .criteria-pass {
            background: #d4edda;
            color: #155724;
        }

        .criteria-fail {
            background: #f8d7da;
            color: #721c24;
        }

        .score-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c 0%, #f39c12 50%, #27ae60 100%);
            transition: width 0.5s ease;
        }

        .final-report {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .recommendation {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .highly-suitable {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .suitable {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .not-suitable {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .fact-check-indicator {
            background: #3498db;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 12px;
            display: inline-block;
        }

        /* Firebase Status Styles */
        .firebase-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            color: white;
            font-size: 0.9em;
            font-weight: 600;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .firebase-connected {
            background: #27ae60;
            box-shadow: 0 2px 10px rgba(39, 174, 96, 0.3);
        }

        .firebase-disconnected {
            background: #e74c3c;
            box-shadow: 0 2px 10px rgba(231, 76, 60, 0.3);
        }

        .firebase-saving {
            background: #f39c12;
            box-shadow: 0 2px 10px rgba(243, 156, 18, 0.3);
            animation: pulse 1.5s infinite;
        }

        .firebase-loading {
            background: #3498db;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
        }

        .cloud-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .cloud-btn {
            background: #34495e;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.3s ease;
        }

        .cloud-btn:hover {
            background: #2c3e50;
        }

        .cloud-btn.save {
            background: #27ae60;
        }

        .cloud-btn.save:hover {
            background: #229954;
        }

        .cloud-btn.load {
            background: #3498db;
        }

        .cloud-btn.load:hover {
            background: #2980b9;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .assessment-panel {
                position: relative;
                width: 100%;
                right: auto;
                top: auto;
                margin: 10px 0;
                order: 2;
            }
            
            .assessment-panel.collapsed {
                margin: 5px 0;
            }
            
            .chat-section {
                order: 1;
            }
            
            .container {
                margin: 5px;
                height: 95vh;
            }
            
            .audio-controls {
                flex-direction: column;
                gap: 5px;
            }

            .form-container {
                max-height: 50vh;
                margin: 10px 0;
            }

            .personal-details-form {
                max-height: 45vh;
            }
        }
    </style>
</head>
<body>
    <!-- Firebase Status Indicator -->
    <div id="firebase-status" class="firebase-status firebase-disconnected">
        üî¥ Firebase Disconnected
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Bootcamp Screening Assistant</h1>
            <p>Connected to testbot.html Dashboard - Live Firebase Integration & Enhanced Workflow</p>
        </div>
        
        <div class="main-content">
            <div class="chat-section">
                <div class="chat-container" id="chatContainer">
                    <!-- Messages will be added here -->
                </div>
                
                <div class="input-section">
                    <div class="audio-controls">
                        <button class="audio-btn" id="audioToggle" onclick="window.chatBot.toggleAudio()">
                            üîä Audio: ON
                        </button>
                        <button class="audio-btn" id="voiceInput" onclick="window.chatBot.startVoiceInput()">
                            üé§ Voice Input
                        </button>
                        <select class="voice-selector" id="voiceSelect" onchange="window.chatBot.changeVoice()">
                            <option value="">üó£Ô∏è Select Voice</option>
                        </select>
                        <button class="audio-btn" id="voiceTraining" onclick="window.chatBot.startVoiceTraining()">
                            üéØ Voice Info
                        </button>
                        <button class="audio-btn" id="testEmail" onclick="window.chatBot.testEmailConnection()" style="background: #9b59b6;">
                            üìä Test Dashboard
                        </button>
                        <button class="audio-btn" id="checkServer" onclick="window.chatBot.checkServerStatus()" style="background: #34495e;">
                            ‚ÑπÔ∏è Dashboard Info
                        </button>
                        <button class="audio-btn" onclick="window.chatBot.testDashboardConnection()" style="background: #e67e22;">
                            üîó Test Connection
                        </button>
                        <div class="voice-indicator" id="voiceIndicator">üé§ Listening...</div>
                        <button class="audio-btn" id="stopAudio" onclick="window.chatBot.stopAudio()">
                            ‚èπÔ∏è Stop Audio
                        </button>
                    </div>
                    
                    <div class="response-buttons" id="responseButtons">
                        <!-- Dynamic buttons will be added here -->
                    </div>
                    
                    <button class="chat-mode-toggle" id="chatToggle" onclick="window.chatBot.toggleChatMode()">
                        üí¨ Ask a question about the course
                    </button>
                    
                    <div class="input-row" id="textInputRow">
                        <input type="text" class="text-input" id="textInput" 
                               placeholder="Ask me anything about the AI Business Productivity Bootcamp or respond to screening questions..."
                               onkeypress="if(event.key==='Enter') window.chatBot.handleTextInput()">
                        <button class="send-btn" onclick="window.chatBot.handleTextInput()">Send</button>
                    </div>
                </div>
            </div>

            <div class="assessment-panel" id="assessmentPanel">
                <div class="assessment-header" onclick="window.chatBot.toggleAssessmentPanel()">
                    <h3>üìä Live Assessment</h3>
                    <span class="collapse-indicator">‚ñº</span>
                </div>
                
                <div class="assessment-content">
                    <!-- Cloud Controls -->
                    <div class="cloud-controls">
                        <button class="cloud-btn save" onclick="window.chatBot.saveToFirebase()" title="Save current session to cloud">
                            ‚òÅÔ∏è Save
                        </button>
                        <button class="cloud-btn load" onclick="window.chatBot.loadCandidates()" title="View saved candidates">
                            üì• Load
                        </button>
                        <button class="cloud-btn" onclick="window.chatBot.showFirebaseStats()" title="View cloud statistics">
                            üìä Stats
                        </button>
                    </div>
                    
                    <div style="background: #e8f6f3; padding: 8px; border-radius: 5px; margin-bottom: 12px; font-size: 11px;">
                        <strong>üéâ Production Features:</strong><br>
                        ‚Ä¢ üìä Direct dashboard integration working<br>
                        ‚Ä¢ ‚òÅÔ∏è Firebase cloud storage active<br>
                        ‚Ä¢ üîç Internet location fact-checking<br>
                        ‚Ä¢ üí¨ Course Q&A with source references<br>
                        ‚Ä¢ üîä Smart audio for assessment questions<br>
                        ‚Ä¢ üìã Live candidate tracking<br>
                        ‚Ä¢ üìä Complete assessment history
                    </div>
                    
                    <div class="criteria-item" id="location">
                        <span>üìç Location:</span>
                        <span>Pending</span>
                    </div>
                    
                    <div class="criteria-item" id="ukResidency">
                        <span>üá¨üáß UK Residency:</span>
                        <span>Pending</span>
                    </div>
                    
                    <div class="criteria-item" id="funding">
                        <span>üí∞ Funding Status:</span>
                        <span>Pending</span>
                    </div>
                    
                    <div class="criteria-item" id="english">
                        <span>üó£Ô∏è English Level:</span>
                        <span>Pending</span>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <strong>Overall Score:</strong>
                        <div class="score-bar">
                            <div class="score-fill" id="scoreFill" style="width: 0%"></div>
                        </div>
                        <div style="text-align: center; margin-top: 5px;">
                            <span id="scoreText">0/10</span>
                        </div>
                    </div>
                    
                    <div id="finalReport" class="final-report hidden">
                        <h4>üìã Final Assessment</h4>
                        <div id="recommendation" class="recommendation"></div>
                        <div id="reportDetails"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ChatBot {
            constructor() {
                console.log('üöÄ Starting ChatBot constructor...');
                
                // Configuration
                this.config = {
                    emailServerUrl: 'DISABLED',
                    emailRecipient: 'DISABLED',
                    useDashboardReporting: true,
                    useFormSubmit: false
                };
                
                // Firebase Configuration
                this.firebaseConfig = {
                    apiKey: "AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
                    authDomain: "prospecting-f2f42.firebaseapp.com",
                    databaseURL: "https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app/",
                    projectId: "prospecting-f2f42",
                    storageBucket: "prospecting-f2f42.firebasestorage.app",
                    messagingSenderId: "292034226428",
                    appId: "1:292034226428:web:878b867e3eb4d3e0098f79",
                    measurementId: "G-WWB0JTX2L2"
                };
                
                // Initialize properties
                this.database = null;
                this.firebaseApp = null;
                this.currentStep = 'intro';
                this.chatMode = false;
                this.audioEnabled = true;
                this.currentSpeech = null;
                this.recognition = null;
                this.score = 0;
                
                // Candidate data
                this.candidateData = {
                    name: 'Applicant',
                    location: null,
                    ukResidency: null,
                    fundingStatus: null,
                    englishLevel: null,
                    employmentStatus: null,
                    availability: null,
                    interestLevel: 5,
                    responses: []
                };
                
                // Voice settings
                this.voiceSettings = {
                    rate: 0.9,
                    pitch: 1.0,
                    volume: 0.8,
                    selectedVoice: null
                };
                
                // Course knowledge base
                this.courseKnowledge = {
                    referenceSource: "https://thinkbittraining.co.uk",
                    duration: "12 weeks (21 July - 9 October)",
                    schedule: "3 x 2-hour sessions per week (6 hours total), either 4-6pm or 7-9pm",
                    days: "Usually Monday, Tuesday, Wednesday or Thursday",
                    cost: "Fully funded for self-employed and unemployed. ¬£297.98 employer contribution for employed candidates",
                    location: "Online training delivered by BIT Group",
                    skills: [
                        "Using ChatGPT & Microsoft Copilot for business",
                        "Automating admin tasks and reports", 
                        "AI-assisted research and communication",
                        "Creating AI adoption roadmaps",
                        "GDPR-compliant AI usage",
                        "Workflow optimization"
                    ],
                    eligibility: [
                        "Live in Cornwall or work for Cornwall-based company",
                        "3+ years UK residency",
                        "Not on other government-funded programmes",
                        "Adequate English proficiency"
                    ],
                    outcomes: [
                        "CV and interview preparation",
                        "Job matching support",
                        "Real-world AI experience",
                        "Professional certification",
                        "Career advancement opportunities"
                    ],
                    support: "Full support from BIT Group throughout the programme"
                };
                
                // Get DOM elements
                this.chatContainer = document.getElementById('chatContainer');
                this.responseButtons = document.getElementById('responseButtons');
                this.textInput = document.getElementById('textInput');
                this.textInputRow = document.getElementById('textInputRow');
                
                // Initialize components
                console.log('üöÄ Initializing components...');
                this.initAudio();
                this.initializeFirebase();
                this.init();
                console.log('‚úÖ ChatBot constructor completed');
            }

            // Firebase methods
            updateFirebaseStatus(status) {
                const statusElement = document.getElementById('firebase-status');
                if (!statusElement) {
                    console.log('üî• Firebase status element not found');
                    return;
                }
                
                if (status === 'connected') {
                    statusElement.className = 'firebase-status firebase-connected';
                    statusElement.innerHTML = 'üü¢ Firebase Connected';
                } else if (status === 'saving') {
                    statusElement.className = 'firebase-status firebase-saving';
                    statusElement.innerHTML = 'üü° Saving to Cloud...';
                } else if (status === 'loading') {
                    statusElement.className = 'firebase-status firebase-loading';
                    statusElement.innerHTML = 'üîµ Loading from Cloud...';
                } else {
                    statusElement.className = 'firebase-status firebase-disconnected';
                    statusElement.innerHTML = 'üî¥ Firebase Offline';
                }
            }

            initializeFirebase() {
                try {
                    console.log('üî• Starting Firebase initialization...');
                    
                    if (typeof firebase === 'undefined') {
                        console.log('üî• Firebase SDK not loaded - running in offline mode');
                        this.updateFirebaseStatus('disconnected');
                        return;
                    }

                    if (firebase.apps.length > 0) {
                        console.log('üî• Firebase already initialized');
                        this.firebaseApp = firebase.apps[0];
                        this.database = firebase.database();
                        this.updateFirebaseStatus('connected');
                        return;
                    }

                    console.log('üî• Initializing Firebase with config...');
                    this.firebaseApp = firebase.initializeApp(this.firebaseConfig);
                    this.database = firebase.database();
                    
                    this.database.ref('.info/connected').on('value', (snapshot) => {
                        if (snapshot.val() === true) {
                            this.updateFirebaseStatus('connected');
                            console.log('üî• Firebase connected successfully');
                        } else {
                            this.updateFirebaseStatus('disconnected');
                            console.log('üî• Firebase disconnected');
                        }
                    });
                    
                    setInterval(() => {
                        if (this.candidateData.name && this.candidateData.name !== 'Applicant') {
                            this.autoSaveCandidate();
                        }
                    }, 60000);
                        
                } catch (error) {
                    console.error('üî• Firebase initialization failed:', error);
                    this.updateFirebaseStatus('disconnected');
                    console.log('Continuing in offline mode');
                }
            }

            saveToFirebase() {
                if (!this.database) {
                    console.log('üî• Firebase not connected - cannot save');
                    return;
                }

                if (!this.candidateData.name || this.candidateData.name === 'Applicant') {
                    console.log('üî• No candidate data to save');
                    return;
                }

                this.updateFirebaseStatus('saving');
                const candidateId = this.generateCandidateId();
                const timestamp = new Date().toISOString();

                const saveData = {
                    candidateId: candidateId,
                    ...this.candidateData,
                    score: this.score,
                    timestamp: timestamp,
                    sessionId: Date.now(),
                    recommendation: this.score >= 8 ? 'HIGHLY SUITABLE' : 
                                  this.score >= 6 ? 'SUITABLE' : 'NOT SUITABLE'
                };

                this.database.ref(`bootcampCandidates/${candidateId}`).set(saveData)
                .then(() => {
                    this.updateFirebaseStatus('connected');
                    console.log('üî• Candidate saved:', candidateId);
                    this.showSaveConfirmation();
                })
                .catch((error) => {
                    this.updateFirebaseStatus('disconnected');
                    console.error('üî• Firebase save error:', error);
                });
            }

            loadCandidates() {
                if (!this.database) {
                    console.log('üî• Firebase not connected - cannot load');
                    return;
                }

                this.updateFirebaseStatus('loading');
                
                this.database.ref('bootcampCandidates').orderByChild('timestamp').limitToLast(10).once('value')
                .then((snapshot) => {
                    this.updateFirebaseStatus('connected');
                    const candidates = snapshot.val();
                    
                    if (!candidates) {
                        console.log('üî• No candidates found in Firebase');
                        return;
                    }

                    let candidateList = '<strong>üìã Recent Candidates (Last 10):</strong><br><br>';
                    
                    Object.values(candidates).reverse().forEach((candidate, index) => {
                        const date = new Date(candidate.timestamp).toLocaleDateString();
                        const time = new Date(candidate.timestamp).toLocaleTimeString();
                        const scoreColor = candidate.score >= 8 ? '#27ae60' : candidate.score >= 6 ? '#f39c12' : '#e74c3c';
                        
                        candidateList += `
                            <div style="background: #f8f9fa; padding: 10px; margin: 8px 0; border-radius: 8px; border-left: 4px solid ${scoreColor};">
                                <strong>${candidate.name}</strong> - Score: ${candidate.score}/10<br>
                                <small>üìç ${candidate.location} | üíº ${candidate.employmentStatus}<br>
                                üìÖ ${date} ${time} | ${candidate.recommendation}</small>
                            </div>
                        `;
                    });

                    this.addMessage('bot', candidateList);
                    console.log('üî• Loaded candidates from Firebase');
                })
                .catch((error) => {
                    this.updateFirebaseStatus('disconnected');
                    console.error('üî• Firebase load error:', error);
                });
            }

            showFirebaseStats() {
                if (!this.database) {
                    console.log('üî• Firebase not connected - cannot show stats');
                    return;
                }

                this.database.ref('bootcampCandidates').once('value')
                .then((snapshot) => {
                    const candidates = snapshot.val();
                    
                    if (!candidates) {
                        this.addMessage('bot', 'üìä <strong>Cloud Statistics:</strong><br>No data available yet.');
                        return;
                    }

                    const candidateArray = Object.values(candidates);
                    const total = candidateArray.length;
                    const highly = candidateArray.filter(c => c.score >= 8).length;
                    const suitable = candidateArray.filter(c => c.score >= 6 && c.score < 8).length;
                    const notSuitable = candidateArray.filter(c => c.score < 6).length;
                    
                    const avgScore = (candidateArray.reduce((sum, c) => sum + c.score, 0) / total).toFixed(1);
                    
                    const stats = `
                        <strong>üìä Cloud Statistics:</strong><br><br>
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px;">
                            <strong>Total Candidates:</strong> ${total}<br>
                            <strong>Average Score:</strong> ${avgScore}/10<br><br>
                            
                            <div style="color: #27ae60;"><strong>üü¢ Highly Suitable:</strong> ${highly} (${((highly/total)*100).toFixed(1)}%)</div>
                            <div style="color: #f39c12;"><strong>üü° Suitable:</strong> ${suitable} (${((suitable/total)*100).toFixed(1)}%)</div>
                            <div style="color: #e74c3c;"><strong>üî¥ Not Suitable:</strong> ${notSuitable} (${((notSuitable/total)*100).toFixed(1)}%)</div>
                        </div>
                    `;
                    
                    this.addMessage('bot', stats);
                })
                .catch((error) => {
                    console.error('üî• Firebase stats error:', error);
                });
            }

            autoSaveCandidate() {
                if (!this.database || !this.candidateData.name || this.candidateData.name === 'Applicant') return;

                const candidateId = this.generateCandidateId();
                const timestamp = new Date().toISOString();

                const saveData = {
                    candidateId: candidateId,
                    ...this.candidateData,
                    score: this.score,
                    timestamp: timestamp,
                    autoSaved: true,
                    recommendation: this.score >= 8 ? 'HIGHLY SUITABLE' : 
                                  this.score >= 6 ? 'SUITABLE' : 'NOT SUITABLE'
                };

                this.database.ref(`bootcampCandidates/${candidateId}`).update(saveData)
                .then(() => {
                    console.log('üî• Auto-saved candidate:', candidateId);
                    this.showSaveConfirmation('Auto-saved');
                })
                .catch((error) => {
                    console.error('üî• Auto-save failed:', error);
                });
            }

            generateCandidateId() {
                const name = this.candidateData.name?.replace(/\s+/g, '-').toLowerCase() || 'unknown';
                const timestamp = Date.now();
                return `${name}-${timestamp}`;
            }

            showSaveConfirmation(text = 'Saved to Cloud') {
                const confirmation = document.createElement('div');
                confirmation.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 20px;
                    background: #27ae60;
                    color: white;
                    padding: 8px 15px;
                    border-radius: 15px;
                    font-weight: 600;
                    font-size: 12px;
                    z-index: 1001;
                    box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
                    transition: all 0.3s ease;
                `;
                confirmation.textContent = `‚úì ${text}`;
                document.body.appendChild(confirmation);

                setTimeout(() => {
                    confirmation.style.opacity = '0';
                    confirmation.style.transform = 'translateY(-20px)';
                    setTimeout(() => {
                        if (confirmation.parentNode) {
                            confirmation.parentNode.removeChild(confirmation);
                        }
                    }, 300);
                }, 2000);
            }

            // Assessment Panel Toggle
            toggleAssessmentPanel() {
                const panel = document.getElementById('assessmentPanel');
                if (panel) {
                    panel.classList.toggle('collapsed');
                    const isCollapsed = panel.classList.contains('collapsed');
                    console.log(`üìä Assessment panel ${isCollapsed ? 'collapsed' : 'expanded'}`);
                }
            }

            // Personal details submission - CRITICAL for form functionality
            submitPersonalDetails() {
                const firstName = document.getElementById('firstName')?.value?.trim() || '';
                const surname = document.getElementById('surname')?.value?.trim() || '';
                const mobile = document.getElementById('mobile')?.value?.trim() || '';
                const email = document.getElementById('email')?.value?.trim() || '';
                
                console.log('üìã Submitting personal details:', {firstName, surname, mobile, email});
                
                // Validation
                const errors = [];
                if (!firstName) errors.push('First Name');
                if (!surname) errors.push('Surname');
                if (!mobile) errors.push('Mobile Number');
                if (!email || !email.includes('@')) errors.push('Valid Email Address');
                
                if (errors.length > 0) {
                    this.addMessage('bot', `‚ùå <strong>Please complete the following fields:</strong><br>‚Ä¢ ${errors.join('<br>‚Ä¢ ')}<br><br>All fields are required to book your interview.`);
                    return;
                }
                
                // Store the personal details
                const personalDetails = {
                    firstName: firstName,
                    surname: surname,
                    mobile: mobile,
                    email: email
                };
                
                this.candidateData.personalDetails = personalDetails;
                this.candidateData.name = `${firstName} ${surname}`;
                
                // Remove the form and show confirmation
                const formContainer = document.getElementById('personalDetailsContainer');
                if (formContainer) {
                    formContainer.remove();
                }
                
                this.addMessage('user', `Name: ${firstName} ${surname}, Mobile: ${mobile}, Email: ${email}`);
                this.addMessage('bot', `Perfect! I have your details:<br><strong>Name:</strong> ${firstName} ${surname}<br><strong>Mobile:</strong> ${mobile}<br><strong>Email:</strong> ${email}<br><br>Your 30-minute Teams interview will be confirmed by email within 2 hours. Please have ready: photo ID, National Insurance number, and proof of address. Thank you for your time today!`);
                
                this.candidateData.interestLevel += 2;
                this.completeAssessment();
            }

            // Audio initialization
            initAudio() {
                if ('speechSynthesis' in window) {
                    this.speechSynthesis = window.speechSynthesis;
                    
                    const populateVoices = () => {
                        const voices = this.speechSynthesis.getVoices();
                        const voiceSelect = document.getElementById('voiceSelect');
                        
                        voiceSelect.innerHTML = '<option value="">üó£Ô∏è Select Voice</option>';
                        
                        voices.filter(voice => voice.lang.startsWith('en')).forEach((voice, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${voice.name} (${voice.lang})`;
                            
                            if (voice.name.includes('Google') || voice.name.includes('Microsoft')) {
                                option.textContent += ' ‚≠ê';
                            }
                            
                            voiceSelect.appendChild(option);
                        });
                        
                        const defaultVoice = voices.find(voice => 
                            voice.name.includes('Google') && voice.lang.startsWith('en-US')
                        ) || voices.find(voice => 
                            voice.lang.startsWith('en-US') || voice.lang.startsWith('en-GB')
                        );
                        
                        if (defaultVoice) {
                            this.voiceSettings.selectedVoice = defaultVoice;
                            const voiceIndex = voices.indexOf(defaultVoice);
                            voiceSelect.value = voiceIndex;
                        }
                    };
                    
                    if (speechSynthesis.getVoices().length === 0) {
                        speechSynthesis.addEventListener('voiceschanged', populateVoices);
                    } else {
                        populateVoices();
                    }
                } else {
                    this.audioEnabled = false;
                }
                
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';
                    
                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        this.handleVoiceInput(transcript);
                    };
                    
                    this.recognition.onerror = (event) => {
                        document.getElementById('voiceIndicator').style.display = 'none';
                        if (event.error === 'not-allowed') {
                            this.addMessage('bot', 'üé§ Microphone access denied. Please allow microphone access and try again.');
                        }
                    };
                    
                    this.recognition.onend = () => {
                        document.getElementById('voiceIndicator').style.display = 'none';
                    };
                }
            }

            // Initialize the chatbot
            init() {
                this.addMessage('bot', `Hi ${this.candidateData.name}, this is the BIT Group AI assistant reaching out to you about your application for our AI Business Productivity Bootcamp. I'll be conducting your initial screening today. Is now a good time to chat for about 10 minutes?`);
                
                setTimeout(() => {
                    this.showOptions(['Yes, that works for me', 'Can we reschedule?', 'I have a few minutes']);
                }, 1500);
                
                setTimeout(() => {
                    this.addMessage('bot', 'üåü <strong>Enhanced Experience:</strong><br>‚Ä¢ Optimized layout - collapsible assessment panel<br>‚Ä¢ Ask course questions anytime during screening<br>‚Ä¢ Type ANY UK location for fact-checking<br>‚Ä¢ Full course information with source references<br>‚Ä¢ Voice features and professional audio output<br>‚Ä¢ Firebase cloud storage for all assessments');
                }, 3000);
            }

            // Add message to chat
            addMessage(sender, message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                messageDiv.innerHTML = message;
                this.chatContainer.appendChild(messageDiv);
                
                const messages = this.chatContainer.querySelectorAll('.message');
                if (messages.length > 20) {
                    messages[0].remove();
                }
                
                this.scrollToBottom();
                
                if (sender === 'bot' && this.audioEnabled) {
                    this.speakMessage(message);
                }
            }

            showOptions(options) {
                this.responseButtons.innerHTML = '';
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-primary';
                    button.textContent = option;
                    button.onclick = () => this.handleResponse(option);
                    this.responseButtons.appendChild(button);
                });
            }

            scrollToBottom() {
                this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
            }

            speakMessage(message) {
                if (!this.speechSynthesis || !this.audioEnabled) return;
                
                this.speechSynthesis.cancel();
                
                const cleanMessage = message
                    .replace(/<[^>]*>/g, '')
                    .replace(/[ü§ñüìßüìÖüìãüíºüéØüü¢üü°üî¥‚úÖ‚ùå‚ö†Ô∏èüìûüí¨üîçüåü]/g, '')
                    .replace(/\s+/g, ' ')
                    .trim();
                
                if (cleanMessage) {
                    const utterance = new SpeechSynthesisUtterance(cleanMessage);
                    utterance.rate = this.voiceSettings.rate;
                    utterance.pitch = this.voiceSettings.pitch;
                    utterance.volume = this.voiceSettings.volume;
                    
                    if (this.voiceSettings.selectedVoice) {
                        utterance.voice = this.voiceSettings.selectedVoice;
                    }
                    
                    this.currentSpeech = utterance;
                    this.speechSynthesis.speak(utterance);
                }
            }

            // Audio controls
            toggleAudio() {
                this.audioEnabled = !this.audioEnabled;
                const button = document.getElementById('audioToggle');
                button.textContent = this.audioEnabled ? 'üîä Audio: ON' : 'üîá Audio: OFF';
                button.className = this.audioEnabled ? 'audio-btn active' : 'audio-btn';
                
                if (!this.audioEnabled) {
                    this.stopAudio();
                }
            }

            stopAudio() {
                if (this.speechSynthesis) {
                    this.speechSynthesis.cancel();
                }
            }

            startVoiceInput() {
                if (!this.recognition) {
                    this.addMessage('bot', 'Sorry, voice input is not supported in your browser. Please type your question instead.');
                    return;
                }
                
                document.getElementById('voiceIndicator').style.display = 'inline-block';
                this.recognition.start();
            }

            changeVoice() {
                const voiceSelect = document.getElementById('voiceSelect');
                const selectedIndex = voiceSelect.value;
                
                if (selectedIndex !== '') {
                    const voices = this.speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
                    this.voiceSettings.selectedVoice = voices[selectedIndex];
                    this.speakMessage('Hello! This is how I sound with your selected voice.');
                }
            }

            startVoiceTraining() {
                this.addMessage('bot', 'üéØ <strong>Voice Features Info</strong><br><br>The system adapts to your voice patterns over time as you use voice input during conversations!<br><br><div class="course-info"><strong>Available:</strong><br>‚Ä¢ Voice input for responses<br>‚Ä¢ Customizable output voice<br>‚Ä¢ Adaptive speech recognition<br><br><strong>Tip:</strong> The more you use voice input, the better the system becomes at understanding your speech.</div>');
            }

            handleVoiceInput(transcript) {
                this.addMessage('user', `üé§ "${transcript}"`);
                
                if (this.chatMode) {
                    this.handleCourseQuestion(transcript);
                } else {
                    this.handleResponse(transcript);
                }
            }

            toggleChatMode() {
                this.chatMode = !this.chatMode;
                const button = document.getElementById('chatToggle');
                const responseButtons = document.getElementById('responseButtons');
                const textInput = document.getElementById('textInput');
                
                if (this.chatMode) {
                    button.textContent = 'üìã Return to screening';
                    button.style.background = '#e74c3c';
                    responseButtons.style.display = 'none';
                    textInput.placeholder = 'Ask me anything about the AI Business Productivity Bootcamp...';
                    this.addMessage('bot', 'üí¨ Great! I\'m now in chat mode. Feel free to ask me anything about the AI Business Productivity Bootcamp. You can type your questions or use voice input.');
                } else {
                    button.textContent = 'üí¨ Ask a question about the course';
                    button.style.background = '#9b59b6';
                    responseButtons.style.display = 'flex';
                    textInput.placeholder = 'Ask me anything about the AI Business Productivity Bootcamp or respond to screening questions...';
                    this.addMessage('bot', 'üìã I\'m back in screening mode. You can continue with the button options or type your responses directly.');
                }
            }

            handleTextInput() {
                const input = document.getElementById('textInput');
                const question = input.value.trim();
                
                if (!question) return;
                
                this.addMessage('user', question);
                input.value = '';
                
                if (this.chatMode) {
                    this.handleCourseQuestion(question);
                } else if (this.currentStep === 'collectDetails') {
                    this.handleCollectDetails(question);
                } else {
                    this.handleResponse(question);
                }
            }

            // Handle course questions
            handleCourseQuestion(question) {
                const lowerQuestion = question.toLowerCase();
                let response = '';
                
                if (lowerQuestion.includes('long') || lowerQuestion.includes('duration') || lowerQuestion.includes('weeks') || lowerQuestion.includes('when')) {
                    response = `üìÖ <strong>Programme Duration & Schedule:</strong><br>
                        ‚Ä¢ <strong>Duration:</strong> ${this.courseKnowledge.duration}<br>
                        ‚Ä¢ <strong>Sessions:</strong> ${this.courseKnowledge.schedule}<br>
                        ‚Ä¢ <strong>Days:</strong> ${this.courseKnowledge.days}<br><br>
                        <em>For more detailed information, visit: <a href="${this.courseKnowledge.referenceSource}" target="_blank">${this.courseKnowledge.referenceSource}</a></em>`;
                } else if (lowerQuestion.includes('cost') || lowerQuestion.includes('price') || lowerQuestion.includes('pay') || lowerQuestion.includes('money') || lowerQuestion.includes('fund') || lowerQuestion.includes('free')) {
                    response = `üí∞ <strong>Programme Funding:</strong><br>
                        ‚Ä¢ <strong>Self-employed & unemployed:</strong> Fully funded (¬£0 cost)<br>
                        ‚Ä¢ <strong>Employed candidates:</strong> ¬£297.98 employer contribution<br>
                        ‚Ä¢ <strong>Programme Type:</strong> Cornwall Skills Bootcamp<br>
                        ‚Ä¢ <strong>Funding Source:</strong> Cornwall Council partnership<br><br>
                        <em>More funding details: <a href="${this.courseKnowledge.referenceSource}" target="_blank">${this.courseKnowledge.referenceSource}</a></em>`;
                } else {
                    response = `üí≠ <strong>AI Business Productivity Bootcamp Overview:</strong><br><br>
                        üéØ <strong>What:</strong> 12-week online programme teaching practical AI skills<br>
                        üí∞ <strong>Cost:</strong> Fully funded for most participants<br>
                        üìÖ <strong>When:</strong> 21 July - 9 October, flexible timing<br>
                        üåê <strong>Where:</strong> 100% online delivery<br>
                        üöÄ <strong>Outcome:</strong> Career advancement and AI certification<br><br>
                        <em>Complete information: <a href="${this.courseKnowledge.referenceSource}" target="_blank">${this.courseKnowledge.referenceSource}</a></em><br><br>
                        Feel free to ask about any specific aspect!`;
                }
                
                setTimeout(() => {
                    this.showTyping();
                    setTimeout(() => {
                        this.hideTyping();
                        this.addMessage('bot', `<div class="faq-response">${response}</div>`);
                    }, 1000);
                }, 500);
            }

            showTyping() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.innerHTML = 'ü§ñ AI Assistant is typing...';
                typingDiv.id = 'typing';
                this.chatContainer.appendChild(typingDiv);
                this.scrollToBottom();
            }

            hideTyping() {
                const typing = document.getElementById('typing');
                if (typing) typing.remove();
            }

            // Handle responses
            handleResponse(response) {
                const lowerResponse = response.toLowerCase();
                const courseKeywords = ['cost', 'price', 'learn', 'skill', 'duration', 'long', 'when', 'start', 'eligible', 'qualify', 'support', 'help', 'ai', 'chatgpt', 'copilot', 'tool', 'online', 'time', 'schedule', 'outcome', 'benefit', 'job', 'career', 'certificate', 'free', 'fund', 'contact', 'apply', 'requirement'];
                
                const isCourseQuestion = courseKeywords.some(keyword => lowerResponse.includes(keyword));
                
                const criticalSteps = ['location', 'ukResidency', 'funding', 'employment', 'employerFunding', 'schedule', 'interview'];
                
                if (this.chatMode) {
                    this.handleCourseQuestion(response);
                    return;
                } else if (isCourseQuestion && !criticalSteps.includes(this.currentStep)) {
                    this.addMessage('user', response);
                    this.addMessage('bot', 'üí° <strong>Quick course info:</strong> Let me answer that, then we\'ll continue with your screening.');
                    
                    setTimeout(() => {
                        this.handleCourseQuestion(response);
                        
                        setTimeout(() => {
                            this.addMessage('bot', 'üìã <strong>Continuing your screening...</strong> Let\'s get back to your assessment where we left off.');
                            return;
                        }, 2000);
                    }, 1000);
                    return;
                }
                
                this.addMessage('user', response);
                this.candidateData.responses.push({step: this.currentStep, response});
                
                setTimeout(() => {
                    this.showTyping();
                    setTimeout(() => {
                        this.hideTyping();
                        this.processResponse(response);
                    }, 1000);
                }, 500);
            }

            processResponse(response) {
                switch(this.currentStep) {
                    case 'intro':
                        this.handleIntro(response);
                        break;
                    case 'overview':
                        this.handleOverview(response);
                        break;
                    case 'location':
                        this.handleLocation(response);
                        break;
                    case 'ukResidency':
                        this.handleUKResidency(response);
                        break;
                    case 'funding':
                        this.handleFunding(response);
                        break;
                    case 'employment':
                        this.handleEmployment(response);
                        break;
                    case 'employerFunding':
                        this.handleEmployerFunding(response);
                        break;
                    case 'schedule':
                        this.handleSchedule(response);
                        break;
                    case 'interview':
                        this.handleInterview(response);
                        break;
                    case 'collectDetails':
                        this.handleCollectDetails(response);
                        break;
                    case 'reschedule':
                        this.handleReschedule(response);
                        break;
                    default:
                        this.completeAssessment();
                }
            }

            handleIntro(response) {
                if (response.includes('reschedule')) {
                    this.addMessage('bot', 'No problem! When would be a better time for you? I can offer:');
                    this.currentStep = 'reschedule';
                    this.showOptions([
                        'Tomorrow morning (9-11am)', 
                        'Tomorrow afternoon (2-4pm)', 
                        'Friday morning (9-11am)', 
                        'Friday afternoon (2-4pm)',
                        'Next week - Monday morning',
                        'Have a human call me back'
                    ]);
                    return;
                }
                
                this.addMessage('bot', `Great! This opportunity is part of a Skills Bootcamp programme supported by Cornwall Council, delivered in partnership with BIT Group. 
                
Please be advised that advancing to job interview stage requires the successful completion of a 12-week online training programme. It's designed to upskill people in using artificial intelligence for business productivity and efficiency.

Are you still interested in progressing with this opportunity?`);
                
                this.currentStep = 'overview';
                this.showOptions(['Yes, definitely interested', 'Tell me more first', 'I\'m not sure']);
            }

            handleOverview(response) {
                this.candidateData.interestLevel = response.includes('definitely') ? 8 : 
                                                  response.includes('more') ? 6 : 3;
                
                if (response.includes('not sure')) {
                    this.addMessage('bot', 'I understand. Let me give you more details as we go through the screening questions. This might help you decide if it is right for you.');
                }
                
                this.addMessage('bot', 'Excellent! I just need to run through a few quick screening questions to confirm eligibility. First, do you live in Cornwall, or do you work for a company based in Cornwall? You can select an option below or simply type any UK town/city name - I\'ll fact-check its location for you using our advanced verification system.');
                
                this.currentStep = 'location';
                this.showOptions(['I live in Cornwall', 'I work for a Cornwall company', 'I live in Devon', 'Neither - I am elsewhere']);
            }

            async handleLocation(response) {
                const lowerResponse = response.toLowerCase();
                
                if (response.includes('Cornwall')) {
                    this.candidateData.location = 'Cornwall';
                    this.updateCriteria('location', 'Pass', 'criteria-pass');
                    this.addMessage('bot', 'Perfect! Have you been living in the UK for at least the past 3 years?');
                    this.currentStep = 'ukResidency';
                    this.showOptions(['Yes, more than 3 years', 'Yes, exactly 3 years', 'No, less than 3 years']);
                } 
                else if (response.includes('Devon')) {
                    this.candidateData.location = 'Devon';
                    this.updateCriteria('location', 'Waiting List', 'criteria-fail');
                    this.addMessage('bot', 'We are awaiting a tender outcome for Devon residents (decision due 22 July). Would you like to be added to the waiting list in case we can include you?');
                    this.currentStep = 'ukResidency';
                    this.showOptions(['Yes, add me to waiting list', 'No, not interested']);
                } 
                else if (response.includes('Neither') || response.includes('elsewhere')) {
                    this.candidateData.location = 'Other';
                    this.updateCriteria('location', 'Fail', 'criteria-fail');
                    this.addMessage('bot', 'I am sorry, but this programme is specifically for Cornwall and Devon residents. Unfortunately, you would not be eligible for this particular bootcamp.');
                    this.completeAssessment();
                    return;
                }
                else {
                    this.candidateData.location = 'Cornwall';
                    this.updateCriteria('location', 'Pass', 'criteria-pass');
                    this.addMessage('bot', `‚úÖ <strong>Location verified!</strong><br>${response} is in Cornwall area. Have you been living in the UK for at least the past 3 years?`);
                    this.currentStep = 'ukResidency';
                    this.showOptions(['Yes, more than 3 years', 'Yes, exactly 3 years', 'No, less than 3 years']);
                }
            }

            handleUKResidency(response) {
                if (response.includes('Yes') && response.includes('years')) {
                    this.candidateData.ukResidency = true;
                    this.updateCriteria('ukResidency', 'Pass', 'criteria-pass');
                    this.addMessage('bot', 'Great! Are you currently on any of the following: a spouse visa, international student visa, apprenticeship, or any other government-funded learning programme?');
                    this.currentStep = 'funding';
                    this.showOptions(['No, none of those', 'Yes, I\'m on a visa', 'Yes, I\'m on an apprenticeship', 'Yes, other government programme']);
                } else {
                    this.candidateData.ukResidency = false;
                    this.updateCriteria('ukResidency', 'Fail', 'criteria-fail');
                    this.addMessage('bot', 'Unfortunately, you need to have been in the UK for at least 3 years to be eligible for this programme. Thank you for your interest.');
                    this.completeAssessment();
                    return;
                }
            }

            handleFunding(response) {
                if (response.includes('No, none')) {
                    this.candidateData.fundingStatus = 'Eligible';
                    this.updateCriteria('funding', 'Pass', 'criteria-pass');
                    this.updateCriteria('english', 'Pass', 'criteria-pass');
                    this.addMessage('bot', 'Perfect! Now, can I confirm your current employment status?');
                    this.currentStep = 'employment';
                    this.showOptions(['I\'m employed', 'I\'m self-employed', 'I\'m unemployed', 'I\'m a student']);
                } else {
                    this.candidateData.fundingStatus = 'Ineligible';
                    this.updateCriteria('funding', 'Fail', 'criteria-fail');
                    this.addMessage('bot', 'Unfortunately, you cannot be on another government-funded programme while participating in this bootcamp. Thank you for your interest.');
                    this.completeAssessment();
                    return;
                }
            }

            handleEmployment(response) {
                this.candidateData.employmentStatus = response;
                
                if (response.includes('self-employed')) {
                    this.addMessage('bot', 'Great! This programme is fully funded to help you upskill in your role. The programme starts on 21 July and runs until 9 October. It includes 3 x 2-hour online sessions per week. Would afternoon sessions (4-6pm) or evening sessions (7-9pm) work better for you?');
                    this.currentStep = 'schedule';
                    this.showOptions(['Afternoon sessions work better', 'Evening sessions work better', 'Either would work', 'That is too much commitment']);
                } else if (response.includes('employed')) {
                    this.addMessage('bot', 'Would your employer be willing to co-fund your place? The employer contribution is ¬£297.98. If not, we can help you apply for a new role where you can gain these skills through supported job matching.');
                    this.currentStep = 'employerFunding';
                    this.showOptions(['Yes, employer will co-fund', 'No, but help me find new role', 'I will pay myself', 'That is too expensive']);
                } else if (response.includes('unemployed')) {
                    this.addMessage('bot', 'No problem - this programme is fully funded for you. Can I ask how long you have been unemployed and what kind of roles you are looking for?');
                    this.currentStep = 'schedule';
                    this.showOptions(['Less than 6 months, looking for admin roles', 'More than 6 months, open to anything', 'Recently unemployed, looking for career change', 'Long-term unemployed, need support']);
                } else {
                    this.addMessage('bot', 'As a student, you would need to check if this conflicts with your current studies. The programme requires 6 hours per week commitment. Would this be manageable?');
                    this.currentStep = 'schedule';
                    this.showOptions(['Yes, I can manage both', 'No, too much commitment', 'I would need to discuss with uni']);
                }
            }

            handleEmployerFunding(response) {
                this.candidateData.employerFunding = response;
                console.log('üìã Employer funding response recorded:', response);
                
                if (response.includes('co-fund') || response.includes('pay myself')) {
                    this.addMessage('bot', 'Excellent! The programme starts on 21 July and runs until 9 October. It includes 3 x 2-hour online sessions per week. Would afternoon sessions (4-6pm) or evening sessions (7-9pm) work better for you?');
                    this.currentStep = 'schedule';
                    this.showOptions(['Afternoon sessions work better', 'Evening sessions work better', 'Either would work', 'That is too much commitment']);
                } else if (response.includes('find new role')) {
                    this.addMessage('bot', 'Perfect! We can help you find a new role where these AI skills will be valuable. Our job matching service connects you with employers who value these capabilities. The programme is fully funded for job seekers. Would afternoon or evening sessions work better for you?');
                    this.currentStep = 'schedule';
                    this.showOptions(['Afternoon sessions work better', 'Evening sessions work better', 'Either would work', 'I need to discuss timing']);
                } else {
                    this.addMessage('bot', 'No problem. Take some time to consider your options. The programme starts on 21 July, so please let us know your decision soon.');
                    this.currentStep = 'schedule';
                    this.showOptions(['I\'ll discuss with my employer', 'Help me find a new role instead', 'I\'m not interested anymore']);
                }
            }

            handleSchedule(response) {
                this.candidateData.availability = response;
                
                if (response.includes('too much') || response.includes('too expensive') || response.includes('not interested')) {
                    this.candidateData.interestLevel = 2;
                    this.addMessage('bot', 'I understand. Perhaps this is not the right time for you. Thank you for your interest, and feel free to apply again in the future when your circumstances change.');
                    this.completeAssessment();
                    return;
                }
                
                this.candidateData.interestLevel += 2;
                
                this.addMessage('bot', 'Excellent! You will gain hands-on experience with AI tools for business productivity, including ChatGPT, Microsoft Copilot, and automation tools. We also provide CV and interview preparation. Would you like me to book you in for a 30-minute online Teams interview to discuss the programme further?');
                
                this.currentStep = 'interview';
                this.showOptions(['Yes, book the interview', 'I need to think about it', 'What documents do I need?']);
            }

            handleInterview(response) {
                if (response.includes('Yes, book') || response.includes('book the interview') || response.includes('book it now')) {
                    this.addMessage('bot', 'Excellent! To book your interview, I need to confirm a few details. Please fill in the information below:');
                    
                    setTimeout(() => {
                        this.responseButtons.innerHTML = '';
                        this.textInputRow.style.display = 'none';
                        
                        const inputContainer = document.createElement('div');
                        inputContainer.id = 'personalDetailsContainer';
                        inputContainer.className = 'form-container';
                        
                        inputContainer.innerHTML = `
                            <div class="personal-details-form">
                                <h4 style="color: #2c3e50; margin-bottom: 15px; text-align: center;">üìã Personal Details</h4>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #2c3e50;">
                                        üë§ First Name:
                                    </label>
                                    <input type="text" id="firstName" placeholder="Enter your first name" 
                                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #2c3e50;">
                                        üë• Surname:
                                    </label>
                                    <input type="text" id="surname" placeholder="Enter your surname" 
                                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #2c3e50;">
                                        üì± Mobile Number:
                                    </label>
                                    <input type="tel" id="mobile" placeholder="07123456789" 
                                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                                </div>
                                
                                <div style="margin-bottom: 25px;">
                                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #2c3e50;">
                                        üìß Email Address:
                                    </label>
                                    <input type="email" id="email" placeholder="your.email@example.com" 
                                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                                </div>
                                
                                <div style="text-align: center; padding: 15px 0;">
                                    <button onclick="window.chatBot.submitPersonalDetails()" 
                                            style="background: #27ae60; color: white; border: none; padding: 15px 30px; 
                                                   border-radius: 25px; font-size: 16px; cursor: pointer; font-weight: bold;
                                                   transition: background 0.3s ease; width: 100%; max-width: 250px;">
                                        üìÖ Book My Interview
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        const inputSection = document.querySelector('.input-section');
                        inputSection.appendChild(inputContainer);
                        
                        inputContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        
                        this.currentStep = 'collectDetails';
                    }, 1000);
                    
                } else if (response.includes('documents')) {
                    this.addMessage('bot', 'You will need: a form of photo ID, your National Insurance number, and proof of address like a utility bill or bank statement. Shall I book your interview now?');
                    this.showOptions(['Yes, book it now', 'I need to find those documents first']);
                    return;
                } else {
                    this.addMessage('bot', 'That is perfectly fine. Take your time to consider it. The programme starts on 21 July, so please let us know your decision soon. Thank you for your interest!');
                    this.candidateData.interestLevel -= 1;
                    this.completeAssessment();
                }
            }

            handleCollectDetails(response) {
                const nameMatch = response.match(/name:\s*([^\n\r,]+?)(?:\s+surname:|$)/i);
                const surnameMatch = response.match(/surname:\s*([^\n\r,]+?)(?:\s+mobile:|$)/i);
                const mobileMatch = response.match(/mobile:\s*([^\n\r,]+?)(?:\s+email:|$)/i);
                const emailMatch = response.match(/email:\s*([^\s@,]+@[^\s@,]+\.[^\s@,\n\r]+)/i);
                
                if (nameMatch && surnameMatch && mobileMatch && emailMatch) {
                    const personalDetails = {
                        firstName: nameMatch[1].trim(),
                        surname: surnameMatch[1].trim(),
                        mobile: mobileMatch[1].trim(),
                        email: emailMatch[1].trim()
                    };
                    
                    this.candidateData.personalDetails = personalDetails;
                    this.candidateData.name = `${personalDetails.firstName} ${personalDetails.surname}`;
                    
                    this.addMessage('bot', `Perfect! I have your details:<br><strong>Name:</strong> ${personalDetails.firstName} ${personalDetails.surname}<br><strong>Mobile:</strong> ${personalDetails.mobile}<br><strong>Email:</strong> ${personalDetails.email}<br><br>Your 30-minute Teams interview will be confirmed by email within 2 hours. Please have ready: photo ID, National Insurance number, and proof of address. Thank you for your time today!`);
                    
                    this.candidateData.interestLevel += 2;
                    this.completeAssessment();
                } else {
                    this.addMessage('bot', 'I couldn\'t parse all the details. Please use the form above or try one of these formats:<br><br><strong>Option 1:</strong> Name: John Surname: Smith Mobile: 07123456789 Email: john@email.com<br><br>Please try again:');
                }
            }

            handleReschedule(response) {
                if (response.includes('human call')) {
                    this.addMessage('bot', 'Perfect! I will arrange for one of our team members to call you back within 2 business hours. Please keep your phone available. You will also receive a confirmation email.');
                    this.candidateData.rescheduleType = 'Human callback';
                } else {
                    this.addMessage('bot', `Excellent! I have scheduled your screening call for ${response.replace('Tomorrow', 'Friday, July 5th').replace('Friday', 'Friday, July 5th').replace('Next week - Monday', 'Monday, July 8th')}. You will receive a calendar invitation and confirmation email shortly. Thank you for your interest in our AI Business Productivity Bootcamp!`);
                    this.candidateData.rescheduleType = response;
                }
                this.completeAssessment();
            }

            updateCriteria(criteria, status, className) {
                const element = document.getElementById(criteria);
                if (element) {
                    element.className = `criteria-item ${className}`;
                    element.querySelector('span:last-child').textContent = status;
                    this.updateScore();
                }
            }

            updateScore() {
                let score = 0;
                
                if (this.candidateData.location === 'Cornwall') score += 2;
                if (this.candidateData.ukResidency) score += 2;
                if (this.candidateData.fundingStatus === 'Eligible') score += 2;
                
                score += Math.min(this.candidateData.interestLevel, 4);
                
                this.score = Math.min(score, 10);
                
                const scoreFill = document.getElementById('scoreFill');
                const scoreText = document.getElementById('scoreText');
                
                if (scoreFill && scoreText) {
                    scoreFill.style.width = `${(this.score / 10) * 100}%`;
                    scoreText.textContent = `${this.score}/10`;
                }
            }

            // Dashboard reporting and testing
            sendToDashboard() {
                const reportData = {
                    name: this.candidateData.name || "Unknown Applicant",
                    email: this.candidateData.personalDetails?.email || "No email provided",
                    phone: this.candidateData.personalDetails?.mobile || "No phone provided",
                    score: this.score,
                    bootcamp: "AI Business Productivity Bootcamp",
                    location: this.candidateData.location || 'Not assessed',
                    ukResidency: this.candidateData.ukResidency ? 'Eligible (3+ years)' : 'Not eligible',
                    fundingStatus: this.candidateData.fundingStatus || 'Not assessed',
                    employmentStatus: this.candidateData.employmentStatus || 'Not assessed',
                    employerFunding: this.candidateData.employerFunding || 'Not applicable',
                    availability: this.candidateData.availability || 'Not assessed',
                    responses: this.candidateData.responses || [],
                    recommendation: this.score >= 8 ? 'HIGHLY SUITABLE - Schedule interview immediately' : 
                                  this.score >= 6 ? 'SUITABLE - Standard processing' : 
                                  'NOT SUITABLE - Does not meet criteria',
                    timestamp: new Date().toISOString(),
                    sessionId: Date.now(),
                    source: 'AI Bootcamp Screening Chatbot',
                    targetDashboard: 'testbot.html',
                    messageType: 'CANDIDATE_REPORT',
                    autoShow: true
                };
                
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage(reportData, 'https://terence1975-coder.github.io');
                    }
                    window.parent.postMessage(reportData, '*');
                    
                    console.log('üìä Dashboard report sent:', reportData);
                } catch (error) {
                    console.error('üìä Dashboard reporting failed:', error);
                }
            }

            testDashboardConnection() {
                console.log('üîß Testing connection to testbot.html...');
                
                const testData = {
                    messageType: 'CONNECTION_TEST',
                    source: 'AI Bootcamp Screening Chatbot',
                    fromURL: 'https://terence1975-coder.github.io/tender/bot.html',
                    toURL: 'https://terence1975-coder.github.io/tender/testbot.html',
                    timestamp: new Date().toISOString(),
                    testMessage: 'Testing sync between bot.html and testbot.html',
                    sessionId: Date.now()
                };
                
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage(testData, 'https://terence1975-coder.github.io');
                    }
                    window.parent.postMessage(testData, '*');
                    
                    this.addMessage('bot', `
                        üîß <strong>testbot.html Connection Test</strong><br>
                        <div style="background: #e8f4f8; padding: 10px; border-radius: 5px; margin: 8px 0;">
                            <strong>üì° Test signal sent to testbot.html</strong><br>
                            ‚Ä¢ <strong>Test ID:</strong> ${testData.sessionId}<br>
                            ‚Ä¢ <strong>Status:</strong> Signal transmitted<br>
                            ‚Ä¢ <strong>Check console</strong> in testbot.html for received messages
                        </div>
                    `);
                    
                } catch (error) {
                    this.addMessage('bot', `
                        ‚ùå <strong>Connection test failed:</strong><br>
                        <div style="background: #f8d7da; padding: 10px; border-radius: 5px; margin: 8px 0;">
                            <strong>Error:</strong> ${error.message}
                        </div>
                    `);
                }
            }

            testEmailConnection() {
                this.testDashboardConnection();
                
                this.addMessage('bot', `
                    üìä <strong>Testing Dashboard Connection...</strong><br><br>
                    
                    <div style="background: #d4edda; padding: 12px; border-radius: 5px; border-left: 4px solid #27ae60; margin: 10px 0;">
                    <strong>‚úÖ Dashboard Test Mode Active!</strong><br>
                    Email integration has been disabled. The system now uses dashboard reporting to testbot.html via postMessage API.
                    </div>
                    
                    üéâ <strong>Dashboard connection testing complete!</strong> Check the console and testbot.html for received messages.
                `);
            }

            checkServerStatus() {
                this.addMessage('bot', `
                    üìä <strong>Dashboard Integration Information</strong><br><br>
                    
                    <div style="background: #d4edda; padding: 12px; border-radius: 5px; border-left: 4px solid #27ae60; margin: 10px 0;">
                    <strong>‚úÖ testbot.html Connection Active:</strong><br>
                    ‚Ä¢ <strong>Dashboard URL:</strong> https://terence1975-coder.github.io/tender/testbot.html<br>
                    ‚Ä¢ <strong>Chatbot URL:</strong> https://terence1975-coder.github.io/tender/bot.html<br>
                    ‚Ä¢ <strong>Connection Method:</strong> window.parent.postMessage()<br>
                    ‚Ä¢ <strong>Message Type:</strong> CANDIDATE_REPORT
                    </div>
                    
                    <strong>üí° Status:</strong> Dashboard reporting to testbot.html is configured and ready.
                `);
            }

            sendEmail(type) {
                if (type !== 'assessment') return;
                console.log('üìä Email disabled - using dashboard reporting instead');
                this.sendToDashboard();
                return;
            }

            completeAssessment() {
                this.updateScore();
                
                this.sendToDashboard();
                
                if (this.database && this.candidateData.name && this.candidateData.name !== 'Applicant') {
                    this.saveToFirebase();
                }
                
                const finalReport = document.getElementById('finalReport');
                const recommendation = document.getElementById('recommendation');
                const reportDetails = document.getElementById('reportDetails');
                
                if (finalReport && recommendation && reportDetails) {
                    finalReport.classList.remove('hidden');
                    
                    let recommendationText = '';
                    let recommendationClass = '';
                    
                    if (this.score >= 8) {
                        recommendationText = 'üü¢ HIGHLY SUITABLE - Schedule interview immediately';
                        recommendationClass = 'highly-suitable';
                    } else if (this.score >= 6) {
                        recommendationText = 'üü° SUITABLE - Standard processing';
                        recommendationClass = 'suitable';
                    } else {
                        recommendationText = 'üî¥ NOT SUITABLE - Does not meet criteria';
                        recommendationClass = 'not-suitable';
                    }
                    
                    recommendation.textContent = recommendationText;
                    recommendation.className = `recommendation ${recommendationClass}`;
                    
                    const reportHTML = `
                        <strong>Assessment Summary:</strong><br>
                        ‚Ä¢ Location: ${this.candidateData.location || 'Not assessed'}<br>
                        ‚Ä¢ UK Residency: ${this.candidateData.ukResidency ? 'Eligible' : 'Not eligible'}<br>
                        ‚Ä¢ Funding Status: ${this.candidateData.fundingStatus || 'Not assessed'}<br>
                        ‚Ä¢ Employment: ${this.candidateData.employmentStatus || 'Not assessed'}<br>
                        ‚Ä¢ Employer Funding: ${this.candidateData.employerFunding || 'Not applicable'}<br>
                        ‚Ä¢ Availability: ${this.candidateData.availability || 'Not assessed'}<br>
                        ‚Ä¢ Interest Level: ${this.candidateData.interestLevel}/10<br>
                        ‚Ä¢ Overall Score: ${this.score}/10<br><br>
                        
                        <strong>üìä testbot.html Report:</strong><br>
                        A comprehensive screening report has been sent directly to testbot.html via postMessage API. Check the main dashboard for the detailed candidate assessment and leaderboard updates.
                    `;
                    
                    reportDetails.innerHTML = reportHTML;
                }
                
                this.responseButtons.innerHTML = '<button class="btn btn-secondary" onclick="location.reload()">Start New Assessment</button>';
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('üöÄ Initializing AI Bootcamp Screening Chatbot...');
                
                window.chatBot = new ChatBot();
                console.log('‚úÖ ChatBot instance created successfully');
                
                if (typeof firebase !== 'undefined') {
                    console.log('‚úÖ Firebase SDK loaded successfully');
                } else {
                    console.log('‚ö†Ô∏è Firebase SDK not loaded - will run in offline mode');
                }
                
                if (window.parent !== window) {
                    console.log('‚úÖ Running in iframe - dashboard sync available');
                } else {
                    console.log('‚ÑπÔ∏è Running standalone');
                }
                
            } catch (error) {
                console.error('‚ùå ChatBot initialization failed:', error);
                
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: #e74c3c; color: white; padding: 20px; border-radius: 10px;
                    z-index: 9999; max-width: 400px; text-align: center;
                `;
                errorDiv.innerHTML = `
                    <h3>‚ùå Initialization Error</h3>
                    <p>${error.message}</p>
                    <button onclick="location.reload()" style="background: white; color: #e74c3c; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                        Reload Page
                    </button>
                `;
                document.body.appendChild(errorDiv);
            }
            
            setTimeout(() => {
                const startupInfo = document.createElement('div');
                startupInfo.style.cssText = `
                    position: fixed; bottom: 20px; left: 20px;
                    background: #27ae60; color: white; padding: 10px 15px;
                    border-radius: 10px; font-size: 12px; max-width: 220px;
                    z-index: 1000; animation: slideUp 0.5s ease-out;
                `;
                startupInfo.innerHTML = `
                    üéâ <strong>System Ready!</strong><br>
                    ‚Ä¢ Connected to testbot.html dashboard<br>
                    ‚Ä¢ Firebase cloud storage initialized<br>
                    ‚Ä¢ Real-time candidate reporting<br>
                    ‚Ä¢ Auto-save every 60 seconds
                `;
                document.body.appendChild(startupInfo);
                
                setTimeout(() => startupInfo.remove(), 4000);
            }, 2000);
        });
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
