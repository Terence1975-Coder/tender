<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation Flow Management Form</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 2;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        .form-container {
            padding: 40px;
        }

        .section {
            margin-bottom: 30px;
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 25px;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(135deg, #667eea, #764ba2) border-box;
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '‚öôÔ∏è';
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .screenshot-section {
            margin-top: 20px;
        }

        .screenshot-upload {
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.05), rgba(155, 89, 182, 0.05));
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .screenshot-upload:hover {
            border-color: #2980b9;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1));
            transform: scale(1.02);
        }

        .screenshot-upload::before {
            content: 'üì∏';
            font-size: 3rem;
            display: block;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .images-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-item {
            position: relative;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            overflow: hidden;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .image-item:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .image-item img {
            width: 100%;
            height: auto;
            max-height: 150px;
            object-fit: cover;
            display: block;
        }

        .image-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-item:hover .remove-btn {
            opacity: 1;
        }

        .image-item .remove-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .paste-indicator {
            border: 3px dashed #27ae60 !important;
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.1), rgba(46, 204, 113, 0.1)) !important;
        }

        .paste-indicator::before {
            content: 'üìã Ready to paste!' !important;
            animation: pulse 1s infinite !important;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .step-container {
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            position: relative;
        }

        .step-number {
            position: absolute;
            top: -15px;
            left: 20px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .add-step-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }

        .add-step-btn:hover {
            background: linear-gradient(135deg, #219a52, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
        }

        .add-step-btn::before {
            content: '+';
            font-size: 1.2em;
            font-weight: bold;
        }

        .generate-pdf-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 30px auto 0;
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }

        .import-pdf-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;
            color: white !important;
            border: none !important;
            padding: 12px 25px !important;
            border-radius: 25px !important;
            cursor: pointer !important;
            font-size: 1rem !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
            display: inline-block !important;
            margin: 10px 0 !important;
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.3) !important;
            position: relative !important;
            z-index: 1000 !important;
            pointer-events: auto !important;
            text-decoration: none !important;
        }

        .import-pdf-btn:hover {
            background: linear-gradient(135deg, #8e44ad, #7d3c98) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 25px rgba(155, 89, 182, 0.4) !important;
        }

        .import-pdf-btn:active {
            transform: translateY(0) !important;
            box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3) !important;
        }

        .import-pdf-btn:disabled {
            opacity: 0.6 !important;
            cursor: not-allowed !important;
            transform: none !important;
        }

        .clear-form-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 10px 10px 10px 0;
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.3);
        }

        .clear-form-btn:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4);
        }

        .generate-pdf-btn::before {
            content: 'üìÑ';
            font-size: 1.3em;
        }

        .priority-select {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
        }

        .priority-select option {
            background: white;
            color: #333;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .form-container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Automation Flow Manager</h1>
            <p>Document and manage your automation workflows with ease</p>
            <div style="margin-top: 20px;">
                <button type="button" class="import-pdf-btn" id="importPdfBtn">
                    üìÇ Import Previous PDF
                </button>
                <input type="file" id="pdfImport" accept=".pdf" style="display: none;">
            </div>
        </div>

        <div class="form-container">
            <form id="automationForm">
                <!-- Basic Information Section -->
                <div class="section">
                    <h2 class="section-title">Basic Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="flowName">Automation Flow Name</label>
                            <input type="text" id="flowName" placeholder="Enter automation name">
                        </div>
                        <div class="form-group">
                            <label for="version">Version</label>
                            <input type="text" id="version" placeholder="v1.0.0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="author">Created By</label>
                            <input type="text" id="author" placeholder="Your name">
                        </div>
                        <div class="form-group">
                            <label for="date">Date Created</label>
                            <input type="date" id="date">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="priority">Priority Level</label>
                            <select id="priority" class="priority-select">
                                <option value="Low">üü¢ Low</option>
                                <option value="Medium">üü° Medium</option>
                                <option value="High">üü† High</option>
                                <option value="Critical">üî¥ Critical</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status">
                                <option value="Planning">Planning</option>
                                <option value="In Development">In Development</option>
                                <option value="Testing">Testing</option>
                                <option value="Live">Live</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" placeholder="Describe the purpose and goals of this automation flow"></textarea>
                    </div>
                </div>

                <!-- Technical Details Section -->
                <div class="section">
                    <h2 class="section-title">Technical Details</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="platform">Platform/Tool</label>
                            <input type="text" id="platform" placeholder="e.g., Power Automate, Zapier, Python">
                        </div>
                        <div class="form-group">
                            <label for="trigger">Trigger Type</label>
                            <input type="text" id="trigger" placeholder="e.g., Schedule, Webhook, Email">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="dependencies">Dependencies</label>
                        <textarea id="dependencies" placeholder="List any dependencies, APIs, or external services"></textarea>
                    </div>
                </div>

                <!-- Workflow Steps Section -->
                <div class="section">
                    <h2 class="section-title">Workflow Steps</h2>
                    <div id="stepsContainer">
                        <!-- Steps will be added dynamically -->
                    </div>
                    <button type="button" class="add-step-btn" onclick="addStep()">Add Step</button>
                </div>

                <!-- Screenshots Section -->
                <div class="section">
                    <h2 class="section-title">Screenshots & Documentation</h2>
                    <div class="screenshot-section">
                        <label for="screenshot1">Flow Overview Screenshots</label>
                        <div class="screenshot-upload" onclick="document.getElementById('screenshot1').click()" onpaste="handlePaste(event, 'overview')">
                            <input type="file" id="screenshot1" accept="image/*" multiple style="display: none;" onchange="previewMultipleImages(this, 'overviewImages')">
                            <p>Click to upload flow overview screenshots or paste from snipping tool (Ctrl+V)</p>
                            <small style="color: #666; font-size: 0.9em;">Supports multiple images - hold Ctrl to select multiple files</small>
                        </div>
                        <div id="overviewImages" class="images-container"></div>
                    </div>
                    
                    <div class="screenshot-section">
                        <label for="screenshot2">Configuration Screenshots</label>
                        <div class="screenshot-upload" onclick="document.getElementById('screenshot2').click()" onpaste="handlePaste(event, 'config')">
                            <input type="file" id="screenshot2" accept="image/*" multiple style="display: none;" onchange="previewMultipleImages(this, 'configImages')">
                            <p>Click to upload configuration screenshots or paste from snipping tool (Ctrl+V)</p>
                            <small style="color: #666; font-size: 0.9em;">Supports multiple images - hold Ctrl to select multiple files</small>
                        </div>
                        <div id="configImages" class="images-container"></div>
                    </div>
                </div>

                <!-- Testing & Validation Section -->
                <div class="section">
                    <h2 class="section-title">Testing & Validation</h2>
                    <div class="form-group">
                        <label for="testScenarios">Test Scenarios</label>
                        <textarea id="testScenarios" placeholder="Describe test cases and validation scenarios"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="lastTested">Last Tested</label>
                            <input type="date" id="lastTested">
                        </div>
                        <div class="form-group">
                            <label for="testResult">Test Result</label>
                            <select id="testResult">
                                <option value="Passed">‚úÖ Passed</option>
                                <option value="Failed">‚ùå Failed</option>
                                <option value="Partial">‚ö†Ô∏è Partial</option>
                                <option value="Not Tested">‚è≥ Not Tested</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Notes & Issues Section -->
                <div class="section">
                    <h2 class="section-title">Notes & Issues</h2>
                    <div class="form-group">
                        <label for="notes">Additional Notes</label>
                        <textarea id="notes" placeholder="Any additional notes, observations, or comments"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="knownIssues">Known Issues</label>
                        <textarea id="knownIssues" placeholder="Document any known issues or limitations"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="futureEnhancements">Future Enhancements</label>
                        <textarea id="futureEnhancements" placeholder="Ideas for future improvements"></textarea>
                    </div>
                </div>

                <button type="button" class="clear-form-btn" onclick="clearForm()">üóëÔ∏è Clear Form</button>
                <button type="button" class="generate-pdf-btn" onclick="generatePDF()">Generate PDF with Images</button>
            </form>
        </div>
    </div>

    <script>
        // IMMEDIATE SETUP - No waiting for DOM
        let stepCounter = 0;
        let imageCounters = {
            overview: 0,
            config: 0
        };

        // Set current date immediately
        setTimeout(() => {
            const dateInput = document.getElementById('date');
            if (dateInput) {
                dateInput.valueAsDate = new Date();
            }
        }, 50);

        // CRITICAL: Set up import functionality immediately
        function setupImportButton() {
            const importBtn = document.getElementById('importPdfBtn');
            const fileInput = document.getElementById('pdfImport');
            
            console.log('Setting up import button...', { importBtn, fileInput });
            
            if (importBtn && fileInput) {
                // Remove any existing listeners
                importBtn.onclick = null;
                fileInput.onchange = null;
                
                // Add click handler
                importBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Import button clicked!');
                    fileInput.click();
                });
                
                // Add file change handler
                fileInput.addEventListener('change', function() {
                    console.log('File selected:', this.files[0]);
                    if (this.files[0]) {
                        importPDF(this);
                    }
                });
                
                console.log('Import button setup complete!');
                return true;
            }
            console.log('Import button elements not found yet');
            return false;
        }

        // Try setup immediately and keep retrying
        let setupAttempts = 0;
        function trySetupImport() {
            setupAttempts++;
            if (setupImportButton() || setupAttempts > 20) {
                return;
            }
            setTimeout(trySetupImport, 100);
        }
        
        // Start setup attempts immediately
        trySetupImport();

        // Global paste event listener
        document.addEventListener('paste', function(e) {
            const activeElement = document.activeElement;
            const uploadArea = activeElement.closest('.screenshot-upload');
            if (uploadArea) {
                handlePaste(e, uploadArea.getAttribute('data-target') || 'global');
            }
        });

        function addStep() {
            stepCounter++;
            imageCounters[`step${stepCounter}`] = 0;
            const stepsContainer = document.getElementById('stepsContainer');
            
            const stepDiv = document.createElement('div');
            stepDiv.className = 'step-container';
            stepDiv.innerHTML = `
                <div class="step-number">${stepCounter}</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Step ${stepCounter} Name</label>
                        <input type="text" placeholder="Enter step name">
                    </div>
                    <div class="form-group">
                        <label>Action Type</label>
                        <select>
                            <option value="Data Input">Data Input</option>
                            <option value="Data Processing">Data Processing</option>
                            <option value="API Call">API Call</option>
                            <option value="Email">Send Email</option>
                            <option value="Database">Database Operation</option>
                            <option value="File Operation">File Operation</option>
                            <option value="Condition">Conditional Logic</option>
                            <option value="Loop">Loop/Iteration</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Step Description</label>
                    <textarea placeholder="Describe what this step does"></textarea>
                </div>
                <div class="screenshot-section">
                    <label>Step Screenshots</label>
                    <div class="screenshot-upload" onclick="document.getElementById('stepScreenshot${stepCounter}').click()" onpaste="handlePaste(event, 'step${stepCounter}')" data-target="step${stepCounter}" tabindex="0">
                        <input type="file" id="stepScreenshot${stepCounter}" accept="image/*" multiple style="display: none;" onchange="previewMultipleImages(this, 'stepImages${stepCounter}', 'step${stepCounter}')">
                        <p>Click to upload screenshots or paste from snipping tool (Ctrl+V)</p>
                        <small style="color: #666; font-size: 0.9em;">Supports multiple images - hold Ctrl to select multiple files</small>
                    </div>
                    <div id="stepImages${stepCounter}" class="images-container"></div>
                </div>
            `;
            
            stepsContainer.appendChild(stepDiv);
        }

        function handlePaste(event, target) {
            event.preventDefault();
            const items = event.clipboardData.items;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        addImageToContainer(e.target.result, target);
                    };
                    reader.readAsDataURL(blob);
                    
                    // Visual feedback
                    const uploadArea = event.target.closest('.screenshot-upload');
                    if (uploadArea) {
                        uploadArea.classList.add('paste-indicator');
                        setTimeout(() => {
                            uploadArea.classList.remove('paste-indicator');
                        }, 1000);
                    }
                    break;
                }
            }
        }

        function addImageToContainer(imageSrc, target) {
            let containerId;
            if (target === 'overview') {
                containerId = 'overviewImages';
            } else if (target === 'config') {
                containerId = 'configImages';
            } else if (target.startsWith('step')) {
                containerId = `stepImages${target.replace('step', '')}`;
            }

            if (!containerId) return;

            const container = document.getElementById(containerId);
            if (!container) return;

            imageCounters[target] = (imageCounters[target] || 0) + 1;
            const imageId = `${target}_img_${imageCounters[target]}`;

            const imageDiv = document.createElement('div');
            imageDiv.className = 'image-item';
            imageDiv.innerHTML = `
                <img id="${imageId}" src="${imageSrc}" alt="Screenshot">
                <button class="remove-btn" onclick="removeImage('${imageId}')" title="Remove image">√ó</button>
            `;

            container.appendChild(imageDiv);

            // Hide upload text when images are added
            const uploadArea = container.previousElementSibling;
            if (uploadArea && uploadArea.classList.contains('screenshot-upload')) {
                const text = uploadArea.querySelector('p');
                if (text && container.children.length === 1) {
                    text.style.display = 'none';
                }
            }
        }

        function removeImage(imageId) {
            const imageElement = document.getElementById(imageId);
            if (imageElement) {
                const container = imageElement.closest('.images-container');
                imageElement.closest('.image-item').remove();
                
                // Show upload text if no images left
                if (container.children.length === 0) {
                    const uploadArea = container.previousElementSibling;
                    if (uploadArea && uploadArea.classList.contains('screenshot-upload')) {
                        const text = uploadArea.querySelector('p');
                        if (text) text.style.display = 'block';
                    }
                }
            }
        }

        function previewMultipleImages(input, containerId, target) {
            const files = input.files;
            const container = document.getElementById(containerId);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    addImageToContainer(e.target.result, target);
                };
                reader.readAsDataURL(file);
            }
        }

        function previewImage(input, previewId) {
            const file = input.files[0];
            const preview = document.getElementById(previewId);
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    input.parentElement.querySelector('p').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Get form data
            const formData = {
                flowName: document.getElementById('flowName').value,
                version: document.getElementById('version').value,
                author: document.getElementById('author').value,
                date: document.getElementById('date').value,
                priority: document.getElementById('priority').value,
                status: document.getElementById('status').value,
                description: document.getElementById('description').value,
                platform: document.getElementById('platform').value,
                trigger: document.getElementById('trigger').value,
                dependencies: document.getElementById('dependencies').value,
                testScenarios: document.getElementById('testScenarios').value,
                lastTested: document.getElementById('lastTested').value,
                testResult: document.getElementById('testResult').value,
                notes: document.getElementById('notes').value,
                knownIssues: document.getElementById('knownIssues').value,
                futureEnhancements: document.getElementById('futureEnhancements').value
            };

            // Helper function to add images to PDF
            const addImageToPDF = async (imgElement, title, doc, yPos) => {
                if (imgElement && imgElement.src && imgElement.style.display !== 'none') {
                    // Add title for the image
                    doc.setFontSize(12);
                    doc.setFont("helvetica", "bold");
                    doc.text(title, 20, yPos);
                    yPos += 10;

                    try {
                        // Calculate image dimensions to fit within page
                        const maxWidth = 170; // Max width for image
                        const maxHeight = 100; // Max height for image
                        
                        // Create a temporary canvas to get image dimensions
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const tempImg = new Image();
                        
                        return new Promise((resolve) => {
                            tempImg.onload = function() {
                                let { width, height } = this;
                                
                                // Calculate scaling to fit within bounds
                                const widthRatio = maxWidth / width;
                                const heightRatio = maxHeight / height;
                                const scale = Math.min(widthRatio, heightRatio, 1);
                                
                                const finalWidth = width * scale;
                                const finalHeight = height * scale;
                                
                                // Check if image fits on current page
                                if (yPos + finalHeight > 270) {
                                    doc.addPage();
                                    yPos = 20;
                                    doc.setFontSize(12);
                                    doc.setFont("helvetica", "bold");
                                    doc.text(title, 20, yPos);
                                    yPos += 10;
                                }
                                
                                // Add image to PDF
                                doc.addImage(imgElement.src, 'JPEG', 20, yPos, finalWidth, finalHeight);
                                resolve(yPos + finalHeight + 15);
                            };
                            tempImg.src = imgElement.src;
                        });
                    } catch (error) {
                        console.warn('Could not add image to PDF:', error);
                        return yPos + 5;
                    }
                }
                return yPos;
            };

            // PDF Generation
            let yPosition = 20;
            
            // Title
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.text("Automation Flow Documentation", 20, yPosition);
            yPosition += 20;

            // Basic Information
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("Basic Information", 20, yPosition);
            yPosition += 10;

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Flow Name: ${formData.flowName}`, 20, yPosition);
            yPosition += 8;
            doc.text(`Version: ${formData.version}`, 20, yPosition);
            yPosition += 8;
            doc.text(`Author: ${formData.author}`, 20, yPosition);
            yPosition += 8;
            doc.text(`Date: ${formData.date}`, 20, yPosition);
            yPosition += 8;
            doc.text(`Priority: ${formData.priority}`, 20, yPosition);
            yPosition += 8;
            doc.text(`Status: ${formData.status}`, 20, yPosition);
            yPosition += 15;

            // Description
            if (formData.description) {
                doc.setFont("helvetica", "bold");
                doc.text("Description:", 20, yPosition);
                yPosition += 8;
                doc.setFont("helvetica", "normal");
                const descLines = doc.splitTextToSize(formData.description, 170);
                doc.text(descLines, 20, yPosition);
                yPosition += descLines.length * 6 + 10;
            }

            // Technical Details
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("Technical Details", 20, yPosition);
            yPosition += 10;

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Platform: ${formData.platform}`, 20, yPosition);
            yPosition += 8;
            doc.text(`Trigger: ${formData.trigger}`, 20, yPosition);
            yPosition += 15;

            if (formData.dependencies) {
                doc.setFont("helvetica", "bold");
                doc.text("Dependencies:", 20, yPosition);
                yPosition += 8;
                doc.setFont("helvetica", "normal");
                const depLines = doc.splitTextToSize(formData.dependencies, 170);
                doc.text(depLines, 20, yPosition);
                yPosition += depLines.length * 6 + 15;
            }

            // Check if we need a new page
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 20;
            }

            // Add main screenshots first
            const overviewImages = document.querySelectorAll('#overviewImages img');
            for (let i = 0; i < overviewImages.length; i++) {
                yPosition = await addImageToPDF(overviewImages[i], `Flow Overview Screenshot ${i + 1}`, doc, yPosition);
            }

            const configImages = document.querySelectorAll('#configImages img');
            for (let i = 0; i < configImages.length; i++) {
                yPosition = await addImageToPDF(configImages[i], `Configuration Screenshot ${i + 1}`, doc, yPosition);
            }

            // Check if we need a new page before workflow steps
            if (yPosition > 240) {
                doc.addPage();
                yPosition = 20;
            }

            // Workflow Steps
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("Workflow Steps", 20, yPosition);
            yPosition += 10;

            // Get all steps
            const steps = document.querySelectorAll('.step-container');
            for (let index = 0; index < steps.length; index++) {
                const step = steps[index];
                const stepName = step.querySelector('input[type="text"]').value;
                const actionType = step.querySelector('select').value;
                const stepDesc = step.querySelector('textarea').value;

                // Check if we need a new page
                if (yPosition > 240) {
                    doc.addPage();
                    yPosition = 20;
                }

                doc.setFont("helvetica", "bold");
                doc.text(`Step ${index + 1}: ${stepName}`, 20, yPosition);
                yPosition += 8;
                doc.setFont("helvetica", "normal");
                doc.text(`Action Type: ${actionType}`, 30, yPosition);
                yPosition += 8;
                if (stepDesc) {
                    const stepLines = doc.splitTextToSize(stepDesc, 160);
                    doc.text(stepLines, 30, yPosition);
                    yPosition += stepLines.length * 6 + 8;
                }
                yPosition += 5;

                // Add step screenshots if available
                const stepImages = document.querySelectorAll(`#stepImages${index + 1} img`);
                for (let imgIndex = 0; imgIndex < stepImages.length; imgIndex++) {
                    const stepImg = stepImages[imgIndex];
                    yPosition = await addImageToPDF(stepImg, `Step ${index + 1} Screenshot ${imgIndex + 1}`, doc, yPosition);
                }
            }

            // Testing & Validation
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("Testing & Validation", 20, yPosition);
            yPosition += 10;

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text(`Last Tested: ${formData.lastTested}`, 20, yPosition);
            yPosition += 8;
            doc.text(`Test Result: ${formData.testResult}`, 20, yPosition);
            yPosition += 15;

            if (formData.testScenarios) {
                doc.setFont("helvetica", "bold");
                doc.text("Test Scenarios:", 20, yPosition);
                yPosition += 8;
                doc.setFont("helvetica", "normal");
                const testLines = doc.splitTextToSize(formData.testScenarios, 170);
                doc.text(testLines, 20, yPosition);
                yPosition += testLines.length * 6 + 15;
            }

            // Notes & Issues
            if (yPosition > 220) {
                doc.addPage();
                yPosition = 20;
            }

            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("Notes & Issues", 20, yPosition);
            yPosition += 10;

            if (formData.notes) {
                doc.setFont("helvetica", "bold");
                doc.text("Notes:", 20, yPosition);
                yPosition += 8;
                doc.setFont("helvetica", "normal");
                const notesLines = doc.splitTextToSize(formData.notes, 170);
                doc.text(notesLines, 20, yPosition);
                yPosition += notesLines.length * 6 + 10;
            }

            if (formData.knownIssues) {
                doc.setFont("helvetica", "bold");
                doc.text("Known Issues:", 20, yPosition);
                yPosition += 8;
                doc.setFont("helvetica", "normal");
                const issuesLines = doc.splitTextToSize(formData.knownIssues, 170);
                doc.text(issuesLines, 20, yPosition);
                yPosition += issuesLines.length * 6 + 10;
            }

            if (formData.futureEnhancements) {
                doc.setFont("helvetica", "bold");
                doc.text("Future Enhancements:", 20, yPosition);
                yPosition += 8;
                doc.setFont("helvetica", "normal");
                const enhancementsLines = doc.splitTextToSize(formData.futureEnhancements, 170);
                doc.text(enhancementsLines, 20, yPosition);
            }

            // Save the PDF
            const fileName = formData.flowName ? `${formData.flowName.replace(/\s+/g, '_')}_Flow_Documentation.pdf` : 'Automation_Flow_Documentation.pdf';
            doc.save(fileName);
        }

        async function importPDF(input) {
            console.log('importPDF called with:', input.files[0]);
            const file = input.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            // Show loading indicator
            const importBtn = document.getElementById('importPdfBtn');
            const originalText = importBtn.innerHTML;
            importBtn.innerHTML = '‚è≥ Loading PDF...';
            importBtn.disabled = true;

            try {
                console.log('Attempting to read PDF...');
                
                // Simple approach: just show the manual import dialog
                showManualImportDialog();
                showNotification('Please copy and paste your PDF content in the dialog that opened.', 'info');
                
            } catch (error) {
                console.error('Error importing PDF:', error);
                showManualImportDialog();
            } finally {
                // Restore button
                importBtn.innerHTML = originalText;
                importBtn.disabled = false;
                input.value = ''; // Clear file input
            }
        }

        function showManualImportDialog() {
            const dialog = document.createElement('div');
            dialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            dialog.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                ">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">Manual PDF Import</h3>
                    <p style="margin-bottom: 20px; color: #666;">
                        Automatic PDF text extraction isn't available. Please copy and paste the text content from your PDF below:
                    </p>
                    <textarea id="manualPdfText" placeholder="Paste your PDF content here..." style="
                        width: 100%;
                        height: 300px;
                        padding: 15px;
                        border: 2px solid #e1e8ed;
                        border-radius: 10px;
                        font-family: monospace;
                        font-size: 14px;
                        resize: vertical;
                    "></textarea>
                    <div style="margin-top: 20px; text-align: right;">
                        <button onclick="closeManualImport()" style="
                            background: #95a5a6;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            margin-right: 10px;
                            cursor: pointer;
                        ">Cancel</button>
                        <button onclick="processManualImport()" style="
                            background: linear-gradient(135deg, #3498db, #2980b9);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                        ">Import Text</button>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);
            window.currentDialog = dialog;

            // Focus on textarea
            setTimeout(() => {
                const textarea = document.getElementById('manualPdfText');
                if (textarea) textarea.focus();
            }, 100);
        }

        function closeManualImport() {
            if (window.currentDialog) {
                document.body.removeChild(window.currentDialog);
                window.currentDialog = null;
            }
        }

        function processManualImport() {
            const textarea = document.getElementById('manualPdfText');
            if (textarea && textarea.value.trim()) {
                parseAndPopulateForm(textarea.value);
                showNotification('Text imported successfully! Form has been populated.', 'success');
                closeManualImport();
            } else {
                showNotification('Please paste some text content first.', 'error');
            }
        }

        function parseAndPopulateForm(text) {
            // Clear existing form first
            clearForm();

            // Define parsing patterns
            const patterns = {
                flowName: /Flow Name:\s*([^\n]+)/i,
                version: /Version:\s*([^\n]+)/i,
                author: /Author:\s*([^\n]+)/i,
                date: /Date:\s*([^\n]+)/i,
                priority: /Priority:\s*([^\n]+)/i,
                status: /Status:\s*([^\n]+)/i,
                platform: /Platform:\s*([^\n]+)/i,
                trigger: /Trigger:\s*([^\n]+)/i,
                lastTested: /Last Tested:\s*([^\n]+)/i,
                testResult: /Test Result:\s*([^\n]+)/i
            };

            // Extract and populate basic fields
            Object.keys(patterns).forEach(field => {
                const match = text.match(patterns[field]);
                if (match && match[1]) {
                    const element = document.getElementById(field);
                    if (element) {
                        element.value = match[1].trim();
                    }
                }
            });

            // Extract multi-line fields
            const descriptionMatch = text.match(/Description:\s*([^]*?)(?=Technical Details|$)/i);
            if (descriptionMatch) {
                document.getElementById('description').value = descriptionMatch[1].trim();
            }

            const dependenciesMatch = text.match(/Dependencies:\s*([^]*?)(?=Workflow Steps|$)/i);
            if (dependenciesMatch) {
                document.getElementById('dependencies').value = dependenciesMatch[1].trim();
            }

            const testScenariosMatch = text.match(/Test Scenarios:\s*([^]*?)(?=Notes|$)/i);
            if (testScenariosMatch) {
                document.getElementById('testScenarios').value = testScenariosMatch[1].trim();
            }

            const notesMatch = text.match(/Notes:\s*([^]*?)(?=Known Issues|$)/i);
            if (notesMatch) {
                document.getElementById('notes').value = notesMatch[1].trim();
            }

            const knownIssuesMatch = text.match(/Known Issues:\s*([^]*?)(?=Future Enhancements|$)/i);
            if (knownIssuesMatch) {
                document.getElementById('knownIssues').value = knownIssuesMatch[1].trim();
            }

            const futureEnhancementsMatch = text.match(/Future Enhancements:\s*([^]*?)$/i);
            if (futureEnhancementsMatch) {
                document.getElementById('futureEnhancements').value = futureEnhancementsMatch[1].trim();
            }

            // Extract workflow steps
            const stepsSection = text.match(/Workflow Steps\s*([^]*?)(?=Testing & Validation|$)/i);
            if (stepsSection) {
                const stepMatches = stepsSection[1].match(/Step \d+:\s*([^]*?)(?=Step \d+:|$)/gi);
                if (stepMatches) {
                    stepMatches.forEach((stepText, index) => {
                        const stepNameMatch = stepText.match(/Step \d+:\s*([^\n]+)/i);
                        const actionTypeMatch = stepText.match(/Action Type:\s*([^\n]+)/i);
                        const stepDescMatch = stepText.match(/Action Type:[^\n]+\s*([^]*?)(?=Step \d+ Screenshot|$)/i);

                        if (stepNameMatch) {
                            addStep();
                            const currentStep = document.querySelector(`.step-container:nth-last-child(2)`);
                            if (currentStep) {
                                const nameInput = currentStep.querySelector('input[type="text"]');
                                const actionSelect = currentStep.querySelector('select');
                                const descTextarea = currentStep.querySelector('textarea');

                                if (nameInput) nameInput.value = stepNameMatch[1].trim();
                                if (actionSelect && actionTypeMatch) {
                                    const actionValue = actionTypeMatch[1].trim();
                                    const option = Array.from(actionSelect.options).find(opt => 
                                        opt.text.toLowerCase().includes(actionValue.toLowerCase())
                                    );
                                    if (option) actionSelect.value = option.value;
                                }
                                if (descTextarea && stepDescMatch) {
                                    descTextarea.value = stepDescMatch[1].trim();
                                }
                            }
                        }
                    });
                }
            }
        }

        function clearForm() {
            // Clear all input fields
            document.querySelectorAll('input[type="text"], input[type="date"], textarea, select').forEach(field => {
                if (field.id !== 'date') { // Keep current date
                    field.value = '';
                }
            });

            // Clear all image containers
            document.querySelectorAll('.images-container').forEach(container => {
                container.innerHTML = '';
            });

            // Remove all steps except the first one
            const stepsContainer = document.getElementById('stepsContainer');
            stepsContainer.innerHTML = '';
            stepCounter = 0;
            imageCounters = { overview: 0, config: 0 };

            // Show upload text again
            document.querySelectorAll('.screenshot-upload p').forEach(p => {
                p.style.display = 'block';
            });

            // Add one initial step
            addStep();
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                opacity: 0;
                transform: translateX(100px);
                transition: all 0.3s ease;
                max-width: 300px;
            `;

            // Set background color based on type
            if (type === 'success') {
                notification.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
            } else if (type === 'error') {
                notification.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            } else {
                notification.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);

            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>
