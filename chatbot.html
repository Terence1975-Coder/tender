<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIT Training Chatbot - Screen for Bootcamps</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web-speech-api/1.0.0/webspeechapi.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #003366;
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .status-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .status-dot.connected {
            background: #28a745;
            box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
        }

        .status-dot.disconnected {
            background: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }

        .status-dot.syncing {
            background: #ffc107;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-container {
            flex: 1;
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
        }

        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .voice-control-btn {
            background: rgba(255, 204, 0, 0.9);
            border: none;
            border-radius: 20px;
            padding: 0.4rem 0.8rem;
            color: #003366;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .voice-control-btn:hover {
            background: #FFCC00;
            transform: scale(1.05);
        }

        .voice-control-btn.active {
            background: #dc3545;
            color: white;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.emily {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 1rem 1.5rem;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
        }

        .message.emily .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .message.user .message-bubble {
            background: #003366;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message.emily .avatar {
            background: #FFCC00;
            color: #003366;
            order: -1;
        }

        .message.user .avatar {
            background: #003366;
            color: white;
        }

        .typing-indicator {
            display: none;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            max-width: 70%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .input-area {
            background: white;
            border-radius: 25px;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: auto;
        }

        .chat-input {
            flex: 1;
            border: none;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border-radius: 20px;
            outline: none;
        }

        .voice-button {
            background: #f8f9fa;
            border: 2px solid #FFCC00;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            margin-left: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #003366;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .voice-button:hover {
            background: #FFCC00;
            color: #003366;
        }

        .voice-button.recording {
            background: #dc3545;
            border-color: #dc3545;
            color: white;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .send-button {
            background: #FFCC00;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            margin-left: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #003366;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .send-button:hover {
            background: #003366;
            color: #FFCC00;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .option-button {
            background: #f8f9fa;
            border: 2px solid #FFCC00;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .option-button:hover {
            background: #FFCC00;
            color: #003366;
        }

        .contact-form {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin-top: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #003366;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #FFCC00;
        }

        .submit-button {
            background: #003366;
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .submit-button:hover {
            background: #004080;
        }

        .hidden {
            display: none;
        }

        .success-message {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 15px;
            margin-top: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .success-icon {
            font-size: 3rem;
            color: #28a745;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .chat-container {
                padding: 0.5rem;
                height: calc(100vh - 100px);
            }
            
            .voice-controls {
                margin-bottom: 0.3rem;
                gap: 0.3rem;
            }
            
            .voice-control-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.7rem;
            }
            
            .message-bubble {
                max-width: 90%;
                padding: 0.8rem 1.2rem;
                font-size: 0.9rem;
            }
            
            .header {
                padding: 0.75rem 0.5rem;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .subtitle {
                font-size: 0.8rem;
            }
            
            .chat-input {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
            
            .voice-button, .send-button {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .options-container {
                gap: 0.3rem;
            }
            
            .option-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
            
            .contact-form {
                padding: 1rem;
                margin-top: 0.5rem;
            }
            
            .form-input {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            
            .submit-button {
                padding: 0.6rem 1.5rem;
                font-size: 0.9rem;
            }
            
            .success-message {
                padding: 1.5rem 1rem;
                margin-top: 0.5rem;
            }
            
            .success-icon {
                font-size: 2.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .chat-container {
                padding: 0.25rem;
                height: calc(100vh - 90px);
            }
            
            .voice-controls {
                margin-bottom: 0.2rem;
                gap: 0.2rem;
            }
            
            .voice-control-btn {
                padding: 0.2rem 0.4rem;
                font-size: 0.6rem;
            }
            
            .header {
                padding: 0.5rem;
            }
            
            .logo {
                font-size: 1.1rem;
            }
            
            .subtitle {
                font-size: 0.75rem;
            }
            
            .message-bubble {
                max-width: 95%;
                padding: 0.7rem 1rem;
                font-size: 0.85rem;
            }
            
            .avatar {
                width: 35px;
                height: 35px;
                font-size: 1rem;
                margin: 0 8px;
            }
            
            .chat-input {
                padding: 0.5rem 0.7rem;
                font-size: 0.85rem;
            }
            
            .voice-button, .send-button {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
                margin-left: 0.3rem;
            }
            
            .option-button {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
            
            .contact-form {
                padding: 0.8rem;
            }
            
            .form-input {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            .submit-button {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="status-indicator">
            <div class="status-dot disconnected" id="statusDot"></div>
            <span id="statusText">Connecting...</span>
        </div>
        <div class="logo">üéì BIT Training</div>
        <div class="subtitle">Government-Funded Skills Bootcamps</div>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be inserted here -->
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <div class="avatar">
                <i class="fas fa-user-tie"></i>
            </div>
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="voice-controls">
            <button class="voice-control-btn" id="stopSpeechBtn">‚èπÔ∏è Stop</button>
            <button class="voice-control-btn" id="skipSpeechBtn">‚è≠Ô∏è Skip</button>
        </div>

        <div class="input-area" id="inputArea">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type your message here..." aria-label="Chat input">
            <button class="voice-button" id="voiceButton" aria-label="Voice input" title="Click to speak">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="send-button" id="sendButton" aria-label="Send message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        class BITChatbot {
            constructor() {
                this.chatMessages = document.getElementById('chatMessages');
                this.chatInput = document.getElementById('chatInput');
                this.sendButton = document.getElementById('sendButton');
                this.voiceButton = document.getElementById('voiceButton');
                this.stopSpeechBtn = document.getElementById('stopSpeechBtn');
                this.skipSpeechBtn = document.getElementById('skipSpeechBtn');
                this.inputArea = document.getElementById('inputArea');
                this.typingIndicator = document.getElementById('typingIndicator');
                
                this.currentStep = 'welcome';
                this.userData = {
                    responses: {},
                    candidate: {}
                };
                
                // Voice recognition setup
                this.isListening = false;
                this.recognition = null;
                this.initializeVoiceRecognition();
                
                // Text-to-speech setup
                this.speechSynthesis = window.speechSynthesis;
                this.voiceEnabled = true;
                this.isSpeaking = false;
                this.speechQueue = [];
                this.currentUtterance = null;
                this.speechSkipped = false;
                
                // Session tracking
                this.sessionStartTime = Date.now();
                
                // Ensure voices are loaded
                if (this.speechSynthesis.getVoices().length === 0) {
                    this.speechSynthesis.addEventListener('voiceschanged', () => {
                        console.log('Voices loaded:', this.speechSynthesis.getVoices().length);
                    });
                }
                
                this.questions = [
                    {
                        id: 'age_19_plus',
                        text: "First things first - are you aged 19 or over? This is just for eligibility purposes, no bother!",
                        type: 'boolean',
                        options: ['Yes, I am', 'No, I\'m not'],
                        scoring: { 'Yes, I am': 1, 'No, I\'m not': 0 }
                    },
                    {
                        id: 'resides_in_devon_cornwall',
                        text: "And do you live in Devon, Cornwall, or somewhere else? Our funding covers these specific areas.",
                        type: 'choice',
                        options: ['Devon', 'Cornwall', 'Neither'],
                        scoring: { 'Devon': 1, 'Cornwall': 1, 'Neither': 0 }
                    },
                    {
                        id: 'employment_status',
                        text: "What's your current employment situation? Don't worry, there's no wrong answer here!",
                        type: 'choice',
                        options: ['Currently employed', 'Unemployed', 'Self-employed', 'Student', 'Other'],
                        scoring: { 'Currently employed': 1, 'Unemployed': 1, 'Self-employed': 1, 'Student': 0.5, 'Other': 0.5 }
                    },
                    {
                        id: 'bootcamp_interest',
                        text: "What area interests you most? We've got some fantastic options!",
                        type: 'choice',
                        options: ['Project Management (PRINCE2¬Æ)', 'AI & Data Skills', 'Microsoft Cloud (MS-900, AZ-900)', 'ITIL¬Æ4 Service Management', 'Not sure yet'],
                        scoring: { 'Project Management (PRINCE2¬Æ)': 1, 'AI & Data Skills': 1, 'Microsoft Cloud (MS-900, AZ-900)': 1, 'ITIL¬Æ4 Service Management': 1, 'Not sure yet': 0.5 }
                    },
                    {
                        id: 'prior_experience',
                        text: "Have you worked in project management, IT, or related fields before? Just helps me understand your background!",
                        type: 'choice',
                        options: ['Yes, plenty of experience', 'Some experience', 'A little bit', 'No experience at all', 'Prefer not to say'],
                        scoring: { 'Yes, plenty of experience': 1, 'Some experience': 1, 'A little bit': 0.8, 'No experience at all': 0.6, 'Prefer not to say': 0.5 }
                    },
                    {
                        id: 'motivation',
                        text: "Last one, I promise! What's driving you to consider this bootcamp? Feel free to tell me in your own words.",
                        type: 'text',
                        scoring: null // Text responses don't contribute to pass/fail score
                    }
                ];
                
                this.currentQuestionIndex = 0;
                this.assessmentScore = 0;
                this.maxPossibleScore = 5; // 5 scored questions
                
                this.knowledgeBase = {
                    'schedule': 'Our bootcamps run part-time over 8-12 weeks, typically evenings and weekends to fit around your current commitments.',
                    'cost': 'These are government-funded bootcamps - fully or partially funded depending on your situation, so they could be completely free or low-cost for eligible candidates!',
                    'location': 'We cover Devon and Cornwall residents. Sessions are delivered online with some optional face-to-face workshops.',
                    'requirements': 'You need to be 19 or over and living in Devon or Cornwall. No prior experience needed - we\'ll get you sorted!',
                    'certifications': 'You\'ll work towards industry-recognized certifications like PRINCE2¬Æ, ITIL¬Æ4, Microsoft Azure fundamentals, and more.',
                    'duration': 'Most bootcamps run for 8-12 weeks part-time, so you can keep working or manage other commitments.',
                    'support': 'You\'ll have full support from our trainers, plus career guidance and job placement assistance.',
                    'eligibility': 'Anyone 19+ living in Devon or Cornwall. Perfect for career changers, unemployed folks looking to upskill, or employed people wanting to advance.'
                };
                
                this.init();
            }
            
            init() {
                this.sendButton.addEventListener('click', () => this.handleSend());
                this.voiceButton.addEventListener('click', () => this.toggleVoiceRecognition());
                this.stopSpeechBtn.addEventListener('click', () => this.stopSpeech());
                this.skipSpeechBtn.addEventListener('click', () => this.skipSpeech());
                this.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleSend();
                });
                
                // Start the conversation
                setTimeout(() => this.showWelcomeMessage(), 1000);
            }
            
            stopSpeech() {
                if (this.speechSynthesis.speaking) {
                    this.speechSynthesis.cancel();
                    this.isSpeaking = false;
                    this.currentUtterance = null;
                }
            }
            
            skipSpeech() {
                this.speechSkipped = true;
                this.stopSpeech();
            }
            
            initializeVoiceRecognition() {
                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                } else if ('SpeechRecognition' in window) {
                    this.recognition = new SpeechRecognition();
                } else {
                    console.log('Speech recognition not supported');
                    this.voiceButton.style.display = 'none';
                    return;
                }
                
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.lang = 'en-IE'; // Irish English
                
                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.voiceButton.classList.add('recording');
                    this.voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
                    this.chatInput.placeholder = 'Listening... speak now!';
                };
                
                this.recognition.onend = () => {
                    this.isListening = false;
                    this.voiceButton.classList.remove('recording');
                    this.voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                    this.chatInput.placeholder = 'Type your message here...';
                };
                
                this.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    this.chatInput.value = transcript;
                    this.chatInput.focus();
                };
                
                this.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    this.isListening = false;
                    this.voiceButton.classList.remove('recording');
                    this.voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                    this.chatInput.placeholder = 'Type your message here...';
                };
            }
            
            toggleVoiceRecognition() {
                if (!this.recognition) return;
                
                if (this.isListening) {
                    this.recognition.stop();
                } else {
                    this.recognition.start();
                }
            }
            
            speakText(text) {
                if (!this.voiceEnabled || !this.speechSynthesis) return Promise.resolve();
                
                return new Promise((resolve) => {
                    // Cancel any ongoing speech
                    this.speechSynthesis.cancel();
                    this.isSpeaking = true;
                    this.speechSkipped = false;
                    
                    // Remove emojis and clean text for speech
                    const cleanText = text.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
                    
                    const utterance = new SpeechSynthesisUtterance(cleanText);
                    utterance.rate = 1.2; // Faster speech rate
                    utterance.pitch = 1.2; // Higher pitch for female voice
                    utterance.volume = 0.9;
                    
                    this.currentUtterance = utterance;
                    
                    utterance.onend = () => {
                        this.isSpeaking = false;
                        this.currentUtterance = null;
                        if (!this.speechSkipped) {
                            resolve();
                        }
                    };
                    
                    utterance.onerror = () => {
                        this.isSpeaking = false;
                        this.currentUtterance = null;
                        resolve();
                    };
                    
                    // If speech was skipped, resolve immediately
                    if (this.speechSkipped) {
                        resolve();
                        return;
                    }
                    
                    // Wait for voices to load if needed
                    this.selectIrishFemaleVoice(utterance);
                });
            }
            
            selectIrishFemaleVoice(utterance) {
                const setVoice = () => {
                    const voices = this.speechSynthesis.getVoices();
                    
                    if (voices.length === 0) {
                        // Voices not loaded yet, try again
                        setTimeout(() => this.selectIrishFemaleVoice(utterance), 100);
                        return;
                    }
                    
                    // Priority order for voice selection - explicitly exclude male voices
                    let selectedVoice = 
                        // First try: Irish female voices (exclude Connor and other male names)
                        voices.find(voice => 
                            voice.lang.includes('en-IE') && 
                            !voice.name.toLowerCase().includes('connor') &&
                            !voice.name.toLowerCase().includes('cian') &&
                            !voice.name.toLowerCase().includes('colm') &&
                            !voice.name.toLowerCase().includes('male') &&
                            (voice.name.toLowerCase().includes('female') || 
                             voice.name.toLowerCase().includes('moira') ||
                             voice.name.toLowerCase().includes('aoife') ||
                             voice.name.toLowerCase().includes('siobhan') ||
                             voice.name.toLowerCase().includes('orla') ||
                             voice.name.toLowerCase().includes('emer') ||
                             voice.name.toLowerCase().includes('niamh') ||
                             voice.name.toLowerCase().includes('emily'))
                        ) ||
                        // Second try: Microsoft Irish female voices specifically
                        voices.find(voice => 
                            voice.lang.includes('en-IE') && 
                            voice.name.toLowerCase().includes('microsoft') &&
                            !voice.name.toLowerCase().includes('connor') &&
                            (voice.name.toLowerCase().includes('emily') ||
                             voice.name.toLowerCase().includes('orla'))
                        ) ||
                        // Third try: British female voices (exclude male names)
                        voices.find(voice => 
                            voice.lang.includes('en-GB') && 
                            !voice.name.toLowerCase().includes('george') &&
                            !voice.name.toLowerCase().includes('daniel') &&
                            !voice.name.toLowerCase().includes('ryan') &&
                            !voice.name.toLowerCase().includes('male') &&
                            (voice.name.toLowerCase().includes('female') ||
                             voice.name.toLowerCase().includes('kate') ||
                             voice.name.toLowerCase().includes('serena') ||
                             voice.name.toLowerCase().includes('stephanie') ||
                             voice.name.toLowerCase().includes('hazel') ||
                             voice.name.toLowerCase().includes('susan'))
                        ) ||
                        // Fourth try: Any English female voice (exclude common male names)
                        voices.find(voice => 
                            voice.lang.startsWith('en') && 
                            !voice.name.toLowerCase().includes('david') &&
                            !voice.name.toLowerCase().includes('mark') &&
                            !voice.name.toLowerCase().includes('connor') &&
                            !voice.name.toLowerCase().includes('male') &&
                            (voice.name.toLowerCase().includes('female') ||
                             voice.name.toLowerCase().includes('zira') ||
                             voice.name.toLowerCase().includes('susan') ||
                             voice.name.toLowerCase().includes('samantha') ||
                             voice.name.toLowerCase().includes('cortana') ||
                             voice.name.toLowerCase().includes('siri'))
                        ) ||
                        // Fifth try: Default to first non-Connor Irish voice
                        voices.find(voice => 
                            voice.lang.includes('en-IE') && 
                            !voice.name.toLowerCase().includes('connor')
                        ) ||
                        // Last resort: First available English voice that's not obviously male
                        voices.find(voice => 
                            voice.lang.startsWith('en') &&
                            !voice.name.toLowerCase().includes('connor') &&
                            !voice.name.toLowerCase().includes('david') &&
                            !voice.name.toLowerCase().includes('mark')
                        ) ||
                        voices[0];
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        console.log('Selected voice:', selectedVoice.name, selectedVoice.lang);
                        
                        // If we ended up with Connor or another male voice, try to adjust pitch higher
                        if (selectedVoice.name.toLowerCase().includes('connor') || 
                            selectedVoice.name.toLowerCase().includes('male')) {
                            utterance.pitch = 1.5; // Much higher pitch to feminize
                            console.log('Applied higher pitch for male voice');
                        }
                    }
                    
                    this.speechSynthesis.speak(utterance);
                };
                
                setVoice();
            }
            
            showWelcomeMessage() {
                const welcomeText = "Hi there! I'm Emily. How's your day going? I'm here to help you learn about our brilliant government-funded bootcamps and see if they might be perfect for you! We've got courses in Project Management, AI, Microsoft Cloud, and more. Fully or partially government funded depending on your situation. Would you like to ask me some questions about the courses first, or shall we dive straight into a quick chat about your background? No pressure at all!";
                
                this.showTypingIndicator();
                this.deliverMessages([welcomeText], 0, () => {
                    // Show options immediately after text appears, don't wait for speech
                    this.showOptionsAfterDelay();
                });
            }
            
            showOptionsAfterDelay() {
                // Show options immediately when text appears
                setTimeout(() => {
                    this.showOptions([
                        { text: "Tell me about the courses first", action: 'questions' },
                        { text: "Let's start the screening", action: 'screening' }
                    ]);
                }, 500); // Small delay to let text render
            }
            
            async deliverMessages(messages, index, callback) {
                if (index >= messages.length) {
                    this.hideTypingIndicator();
                    if (callback) callback();
                    return;
                }
                
                // Wait a moment, then add the message
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Add message to chat
                const messageDiv = document.createElement('div');
                messageDiv.className = `message emily`;
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.innerHTML = '<i class="fas fa-user-tie"></i>';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = messages[index];
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(bubble);
                
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
                this.hideTypingIndicator();
                
                // Start speaking in parallel, don't wait for it
                if (!this.speechSkipped) {
                    this.speakText(messages[index]);
                }
                
                // Continue with next message or callback
                this.deliverMessages(messages, index + 1, callback);
            }
            
            showTypingIndicator() {
                this.typingIndicator.style.display = 'flex';
                this.scrollToBottom();
            }
            
            hideTypingIndicator() {
                this.typingIndicator.style.display = 'none';
            }
            
            async addMessage(sender, text) {
                this.hideTypingIndicator();
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.innerHTML = sender === 'emily' ? '<i class="fas fa-user-tie"></i>' : '<i class="fas fa-user"></i>';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = text;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(bubble);
                
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
                
                // Speak Emily's messages and wait for completion
                if (sender === 'emily') {
                    await new Promise(resolve => setTimeout(resolve, 500)); // Brief pause before speaking
                    await this.speakText(text);
                    await new Promise(resolve => setTimeout(resolve, 300)); // Brief pause after speaking
                }
            }
            
            showOptions(options) {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = option.text;
                    button.addEventListener('click', () => {
                        this.addMessage('user', option.text);
                        optionsContainer.remove();
                        this.handleOptionClick(option.action, option.value);
                    });
                    optionsContainer.appendChild(button);
                });
                
                this.chatMessages.appendChild(optionsContainer);
                this.scrollToBottom();
            }
            
            async handleOptionClick(action, value) {
                if (action === 'questions') {
                    this.currentStep = 'questions';
                    this.showTypingIndicator();
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    await this.addMessage('emily', "Perfect! Ask me anything about our bootcamps. I know all about the courses, schedules, costs, requirements - you name it! Fire away with your questions and I'll get you all the info you need.");
                    this.enableTextInput();
                } else if (action === 'screening') {
                    this.startScreening();
                } else if (action === 'answer') {
                    this.recordAnswer(value);
                } else if (action === 'proceed') {
                    if (value === 'yes') {
                        this.showContactForm();
                    } else {
                        this.showFarewellMessage();
                    }
                }
            }
            
            async startScreening() {
                this.currentStep = 'screening';
                this.showTypingIndicator();
                await new Promise(resolve => setTimeout(resolve, 1500));
                await this.addMessage('emily', "Brilliant! Let's have a quick friendly chat then. I'll ask you a few questions to understand your background and see if our bootcamp would be a perfect match for you. Nothing too intense, I promise - just helps me figure out the best way to support your goals!");
                setTimeout(() => this.askNextQuestion(), 1500);
            }
            
            async askNextQuestion() {
                if (this.currentQuestionIndex >= this.questions.length) {
                    this.finishScreening();
                    return;
                }
                
                const question = this.questions[this.currentQuestionIndex];
                this.showTypingIndicator();
                
                // Add message to chat immediately
                const messageDiv = document.createElement('div');
                messageDiv.className = `message emily`;
                
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.innerHTML = '<i class="fas fa-user-tie"></i>';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = question.text;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(bubble);
                
                // Wait briefly then show message and options together
                await new Promise(resolve => setTimeout(resolve, 1500));
                this.hideTypingIndicator();
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
                
                // Start speaking in parallel
                if (!this.speechSkipped) {
                    this.speakText(question.text);
                }
                
                // Show options immediately after message appears
                if (question.type === 'text') {
                    this.enableTextInput();
                } else {
                    const options = question.options.map((option) => ({
                        text: option,
                        action: 'answer',
                        value: option
                    }));
                    this.showOptions(options);
                }
            }
            
            async recordAnswer(value) {
                const question = this.questions[this.currentQuestionIndex];
                this.userData.responses[question.id] = value;
                
                // Calculate score for this answer
                if (question.scoring && question.scoring[value] !== undefined) {
                    this.assessmentScore += question.scoring[value];
                }
                
                this.currentQuestionIndex++;
                
                // Show encouraging response with variety but more natural
                const encouragements = [
                    "Grand, got it! That gives me a good picture of your situation.",
                    "Lovely, that's noted! I'm getting a clearer sense of what might work best for you.",
                    "Brilliant, thanks a million! This information will help me understand your needs better.",
                    "Sure thing, got that down! Your background is becoming much clearer now.",
                    "Thank you."
                ];
                
                this.showTypingIndicator();
                await new Promise(resolve => setTimeout(resolve, 500)); // Reduced from 1000ms
                await this.addMessage('emily', encouragements[Math.floor(Math.random() * encouragements.length)]);
                await new Promise(resolve => setTimeout(resolve, 500)); // Reduced from 1000ms
                this.askNextQuestion();
            }
            
            async finishScreening() {
                // Calculate final assessment
                const scorePercentage = (this.assessmentScore / this.maxPossibleScore) * 100;
                const passThreshold = 60; // 60% pass rate
                const assessmentResult = scorePercentage >= passThreshold ? 'PASS' : 'FAIL';
                
                // Store assessment results
                this.userData.assessment = {
                    score: this.assessmentScore,
                    maxScore: this.maxPossibleScore,
                    percentage: Math.round(scorePercentage),
                    result: assessmentResult
                };
                
                this.showTypingIndicator();
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                if (assessmentResult === 'PASS') {
                    await this.addMessage('emily', "That's all sorted! Thanks so much for taking the time to chat with me and sharing your background. Based on everything you've told me, I genuinely think our bootcamp could be absolutely perfect for helping you achieve your goals and advance your career. The combination of your situation and what we offer seems like it could be a brilliant match!");
                } else {
                    await this.addMessage('emily', "That's all sorted! Thanks so much for taking the time to chat with me and sharing your background. While our current bootcamp programs might not be the perfect fit right now based on the eligibility requirements, I'd still encourage you to stay in touch as we're always developing new programs and opportunities.");
                }
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (assessmentResult === 'PASS') {
                    await this.addMessage('emily', "Would you like to go ahead and get the ball rolling? I'll just need a few contact details and then someone from our lovely team will be in touch soon to discuss the next steps and answer any specific questions you might have about the program.");
                    
                    this.showOptions([
                        { text: "Yes, let's do it!", action: 'proceed', value: 'yes' },
                        { text: "Not right now, thanks", action: 'proceed', value: 'no' }
                    ]);
                } else {
                    await this.addMessage('emily', "Would you like us to keep your details on file for future opportunities, or would you prefer to explore other options that might be available? Either way, feel free to reach out to us at bootcamp@thinkbitgroup.co.uk if your situation changes.");
                    
                    this.showOptions([
                        { text: "Keep my details on file", action: 'proceed', value: 'yes' },
                        { text: "No thanks, I'll explore other options", action: 'proceed', value: 'no' }
                    ]);
                }
            }
            
            async showContactForm() {
                this.showTypingIndicator();
                await new Promise(resolve => setTimeout(resolve, 2000));
                await this.addMessage('emily', "Fantastic! Just pop your details in the form below and we'll get you all sorted. It's dead easy - just your name, phone number, and email address so our team can reach out to you with all the specific details about enrollment, schedules, and what to expect next.");
                
                const formHTML = `
                    <div class="contact-form">
                        <div class="form-group">
                            <label class="form-label" for="fullName">Full Name</label>
                            <input type="text" class="form-input" id="fullName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="phoneNumber">Phone Number</label>
                            <input type="tel" class="form-input" id="phoneNumber" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="email">Email Address</label>
                            <input type="email" class="form-input" id="email" required>
                        </div>
                        <button type="submit" class="submit-button" id="submitDetails">Send My Details</button>
                    </div>
                `;
                
                this.chatMessages.innerHTML += formHTML;
                this.scrollToBottom();
                
                document.getElementById('submitDetails').addEventListener('click', () => {
                    this.submitContactDetails();
                });
                
                this.inputArea.style.display = 'none';
            }
            
            submitContactDetails() {
                const name = document.getElementById('fullName').value.trim();
                const phone = document.getElementById('phoneNumber').value.trim();
                const email = document.getElementById('email').value.trim();
                
                if (!name || !phone || !email) {
                    alert("Please fill in all fields, love!");
                    return;
                }
                
                this.userData.candidate = { name, phone, email };
                this.userData.timestamp = new Date().toISOString();
                this.userData.source = "chatbot-screening-v1";
                
                this.sendToWebhook();
            }
            
            async sendToWebhook() {
                // Prepare comprehensive data payload
                const payload = {
                    candidate: this.userData.candidate,
                    responses: this.userData.responses,
                    assessment: this.userData.assessment,
                    timestamp: new Date().toISOString(),
                    source: "chatbot-screening-v1",
                    sessionData: {
                        userAgent: navigator.userAgent,
                        screenResolution: `${screen.width}x${screen.height}`,
                        chatDuration: Date.now() - this.sessionStartTime
                    }
                };
                
                console.log('Sending payload to webhook:', JSON.stringify(payload, null, 2));
                
                try {
                    const response = await fetch('http://localhost:5678/webhook-test/tender/chatbot', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    console.log('Webhook response status:', response.status);
                    
                    if (response.ok) {
                        const responseData = await response.text();
                        console.log('Webhook response:', responseData);
                        this.showSuccessMessage();
                    } else {
                        console.error('Webhook error response:', response.status, response.statusText);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error sending to webhook:', error);
                    // Show success anyway for demo purposes, but log the error
                    console.log('Falling back to success message despite webhook error');
                    this.showSuccessMessage();
                }
            }
            
            showSuccessMessage() {
                const successHTML = `
                    <div class="success-message">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3>You're all set, ${this.userData.candidate.name}!</h3>
                        <p>Thanks a million for taking the time to chat with me today! Someone from our brilliant team will be in touch within the next 24-48 hours to discuss your application and answer any specific questions you might have about the program.</p>
                        <p>If you think of any other questions before then, feel free to drop us a line at <strong>bootcamp@thinkbitgroup.co.uk</strong> - we're always happy to help!</p>
                    </div>
                `;
                
                this.chatMessages.innerHTML += successHTML;
                this.scrollToBottom();
                
                // Speak the success message
                this.speakText(`You're all set, ${this.userData.candidate.name}! Thanks a million for taking the time to chat with me today! Someone from our brilliant team will be in touch within the next day or two to discuss your application.`);
            }
            
            showFarewellMessage() {
                this.showTypingIndicator();
                setTimeout(() => {
                    this.addMessage('emily', "No bother at all! Thanks for taking the time to chat with me today - it's been lovely getting to know a bit about your background and goals. If you change your mind later or have any questions about our programs, feel free to come back for another chat or email us directly at bootcamp@thinkbitgroup.co.uk. Best of luck with whatever path you choose!");
                }, 1500);
            }
            
            enableTextInput() {
                this.inputArea.style.display = 'flex';
                this.chatInput.focus();
            }
            
            handleSend() {
                const message = this.chatInput.value.trim();
                if (!message) return;
                
                this.addMessage('user', message);
                this.chatInput.value = '';
                
                if (this.currentStep === 'questions') {
                    this.handleQuestion(message);
                } else if (this.currentStep === 'screening' && this.questions[this.currentQuestionIndex]?.type === 'text') {
                    this.recordAnswer(message);
                    this.inputArea.style.display = 'none';
                }
            }
            
            async handleQuestion(question) {
                const lowerQuestion = question.toLowerCase();
                let response = "That's a great question! ";
                
                // Simple keyword matching for knowledge base
                if (lowerQuestion.includes('schedule') || lowerQuestion.includes('time') || lowerQuestion.includes('when')) {
                    response += this.knowledgeBase.schedule;
                } else if (lowerQuestion.includes('cost') || lowerQuestion.includes('price') || lowerQuestion.includes('fee')) {
                    response += this.knowledgeBase.cost;
                } else if (lowerQuestion.includes('location') || lowerQuestion.includes('where')) {
                    response += this.knowledgeBase.location;
                } else if (lowerQuestion.includes('requirement') || lowerQuestion.includes('eligible') || lowerQuestion.includes('qualify')) {
                    response += this.knowledgeBase.requirements;
                } else if (lowerQuestion.includes('certificate') || lowerQuestion.includes('qualification')) {
                    response += this.knowledgeBase.certifications;
                } else if (lowerQuestion.includes('duration') || lowerQuestion.includes('long')) {
                    response += this.knowledgeBase.duration;
                } else if (lowerQuestion.includes('support') || lowerQuestion.includes('help')) {
                    response += this.knowledgeBase.support;
                } else {
                    response += "I'd love to help with that! Our bootcamps are government-funded, part-time programs perfect for anyone looking to upskill in Project Management, AI, or Microsoft Cloud technologies. Each course is designed to fit around your existing commitments while giving you industry-recognized qualifications that employers really value. What specifically would you like to know more about?";
                }
                
                this.showTypingIndicator();
                await new Promise(resolve => setTimeout(resolve, 1500));
                await this.addMessage('emily', response);
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                await this.addMessage('emily', "Feel free to ask me anything else about the courses, or if you're ready, we can move on to the quick screening questions to see which program might be the best fit for your goals and situation.");
                
                this.showOptions([
                    { text: "I have more questions", action: 'questions' },
                    { text: "Let's start the screening", action: 'screening' }
                ]);
            }
            
            scrollToBottom() {
                setTimeout(() => {
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                }, 100);
            }
        }
        
        // Initialize the chatbot when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyChiAlrD-JLtBSDN3sOyxYiLGig-6Cy3GM",
                authDomain: "prospecting-f2f42.firebaseapp.com",
                databaseURL: "https://prospecting-f2f42-default-rtdb.europe-west1.firebasedatabase.app/",
                projectId: "prospecting-f2f42",
                storageBucket: "prospecting-f2f42.firebasestorage.app",
                messagingSenderId: "292034226428",
                appId: "1:292034226428:web:878b867e3eb4d3e0098f79",
                measurementId: "G-WWB0JTX2L2"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            
            new BITChatbot();
        });
    </script>
</body>
</html>
